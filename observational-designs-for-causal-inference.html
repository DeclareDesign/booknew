<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 16 Observational designs for causal inference | Research Design: Declare, Diagnose, Redesign</title>
<meta name="author" content="Graeme Blair, Jasper Cooper, Alexander Coppock, and Macartan Humphreys">
<!-- CSS --><!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.2.9000/tabs.js"></script><script src="libs/bs3compat-0.2.2.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<link href="libs/bs4_book-1.0.0/dd_imgpopup.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/bs4_book-1.0.0/dd_imgpopup.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="https://hypothes.is/embed.js" async></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Research Design: Declare, Diagnose, Redesign</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li class="book-part">Introduction</li>
<li><a class="" href="preamble.html"><span class="header-section-number">1</span> Preamble</a></li>
<li><a class="" href="improving-research-designs.html"><span class="header-section-number">2</span> Improving research designs</a></li>
<li><a class="" href="primer.html"><span class="header-section-number">3</span> Software primer</a></li>
<li><a class="" href="part-i-exercises.html"><span class="header-section-number">4</span> Part I Exercises</a></li>
<li class="book-part">Declaration, Diagnosis, Redesign</li>
<li><a class="" href="declaration.html"><span class="header-section-number">5</span> Declaration</a></li>
<li><a class="" href="specifying-the-model.html"><span class="header-section-number">6</span> Specifying the model</a></li>
<li><a class="" href="defining-the-inquiry.html"><span class="header-section-number">7</span> Defining the inquiry</a></li>
<li><a class="" href="crafting-a-data-strategy.html"><span class="header-section-number">8</span> Crafting a data strategy</a></li>
<li><a class="" href="choosing-an-answer-strategy.html"><span class="header-section-number">9</span> Choosing an answer strategy</a></li>
<li><a class="" href="p2diagnosis.html"><span class="header-section-number">10</span> Diagnosis</a></li>
<li><a class="" href="redesign-1.html"><span class="header-section-number">11</span> Redesign</a></li>
<li><a class="" href="part-ii-exercises.html"><span class="header-section-number">12</span> Part II Exercises</a></li>
<li class="book-part">Research Design Library</li>
<li><a class="" href="research-design-library.html"><span class="header-section-number">13</span> Research Design Library</a></li>
<li><a class="" href="observational-designs-for-descriptive-inference.html"><span class="header-section-number">14</span> Observational designs for descriptive inference</a></li>
<li><a class="" href="experimental-designs-for-descriptive-inference.html"><span class="header-section-number">15</span> Experimental designs for descriptive inference</a></li>
<li><a class="active" href="observational-designs-for-causal-inference.html"><span class="header-section-number">16</span> Observational designs for causal inference</a></li>
<li><a class="" href="experimental-designs-for-causal-inference.html"><span class="header-section-number">17</span> Experimental designs for causal inference</a></li>
<li><a class="" href="multi-study-designs.html"><span class="header-section-number">18</span> Multi-study designs</a></li>
<li><a class="" href="part-iii-exercises.html"><span class="header-section-number">19</span> Part III Exercises</a></li>
<li class="book-part">Research Design Lifecycle</li>
<li><a class="" href="research-design-lifecycle.html"><span class="header-section-number">20</span> Research Design Lifecycle</a></li>
<li><a class="" href="part-iv-exercises.html"><span class="header-section-number">21</span> Part IV Exercises</a></li>
<li><a class="" href="references-4.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="observational-designs-for-causal-inference" class="section level1">
<h1>
<span class="header-section-number">16</span> Observational designs for causal inference<a class="anchor" aria-label="anchor" href="#observational-designs-for-causal-inference"><i class="fas fa-link"></i></a>
</h1>
<p>section introduction</p>
<p>cite <span class="citation">Dunning (<a href="references-4.html#ref-dunning2012natural" role="doc-biblioref">2012</a>)</span>, <span class="citation">Angrist and Pischke (<a href="references-4.html#ref-angrist2008mostly" role="doc-biblioref">2008</a>)</span></p>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
<div id="selection-on-observables" class="section level2">
<h2>
<span class="header-section-number">16.1</span> Selection on observables<a class="anchor" aria-label="anchor" href="#selection-on-observables"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-10" class="section level3">
<h3>
<span class="header-section-number">16.1.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-10"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, 
                     X_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     X_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     Z <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">X_1</span> <span class="op">+</span> <span class="va">X_2</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                     U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X_1</span> <span class="op">+</span> <span class="va">X_2</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X_1</span> <span class="op">+</span> <span class="va">X_2</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"LATE"</span><span class="op">)</span> </code></pre></div>
</div>
<div id="dag-8" class="section level3">
<h3>
<span class="header-section-number">16.1.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-8"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-227-1.svg" width="100%"></div>
</div>
<div id="example-11" class="section level3">
<h3>
<span class="header-section-number">16.1.3</span> Example<a class="anchor" aria-label="anchor" href="#example-11"><i class="fas fa-link"></i></a>
</h3>
<p>(matching and regression etc.)
<!-- make sure to rename the section title below --></p>
</div>
<div id="classic-confounding" class="section level3">
<h3>
<span class="header-section-number">16.1.4</span> Classic Confounding<a class="anchor" aria-label="anchor" href="#classic-confounding"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>We want to know the effect of Z on Y, but it’s confounded by X</li>
<li>DIM is biased, OLS is unbiased because we happen to get the functional forms right enough.</li>
</ul>
<div class="figure" style="text-align: center">
<span id="fig:unnamed-chunk-229"></span>
<img src="figures/regression_dag_1.png" alt="DAG with one observed confounder" width="40%"><p class="caption">
Figure 16.1: DAG with one observed confounder
</p>
</div>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design_1</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, 
                     U_z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     U_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     U_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     X <span class="op">=</span> <span class="va">U_x</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">Z</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U_y</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob_unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">U_z</span> <span class="op">+</span> <span class="va">U_x</span><span class="op">)</span>, simple <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"DIM"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span>, model <span class="op">=</span> <span class="va">lm</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"OLS"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dx_1</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">design_1</span>, sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span>
<span class="va">dx_1</span></code></pre></div>
<pre><code>## 
## Research design diagnosis based on 100 simulations. Diagnosand estimates with bootstrapped standard errors in parentheses (20 replicates).
## 
##  Design Label Estimand Label Estimator Label Term N Sims   Bias   RMSE  Power
##      design_1            ATE             DIM    Z    100   0.94   0.96   1.00
##                                                          (0.02) (0.02) (0.00)
##      design_1            ATE             OLS    Z    100   0.01   0.23   0.55
##                                                          (0.02) (0.01) (0.04)
##  Coverage Mean Estimate SD Estimate Mean Se Type S Rate Mean Estimand
##      0.06          1.44        0.24    0.27        0.00          0.50
##    (0.02)        (0.02)      (0.02)  (0.00)      (0.00)        (0.00)
##      0.95          0.51        0.23    0.23        0.00          0.50
##    (0.02)        (0.02)      (0.01)  (0.00)      (0.00)        (0.00)</code></pre>
</div>
<div id="what-if-the-functional-form-is-wrong" class="section level3">
<h3>
<span class="header-section-number">16.1.5</span> What if the functional form is wrong?<a class="anchor" aria-label="anchor" href="#what-if-the-functional-form-is-wrong"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Oh no, the functional form is wrong, so even though we’re controlling for all confounders, there’s still bias.</li>
<li>Solution: matching might do a better job since it’s sort of a “nonparametric” form of covariate control.</li>
</ul>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design_2</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, 
                     U_z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     U_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     U_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     X <span class="op">=</span> <span class="va">U_x</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">Z</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="va">X</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">U_y</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob_unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">U_z</span> <span class="op">+</span> <span class="va">U_x</span> <span class="op">+</span> <span class="va">U_x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, simple <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"DIM"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span>, model <span class="op">=</span> <span class="va">lm</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"OLS"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dx_2</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">design_2</span>, sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span>
<span class="va">dx_2</span></code></pre></div>
<pre><code>## 
## Research design diagnosis based on 100 simulations. Diagnosand estimates with bootstrapped standard errors in parentheses (20 replicates).
## 
##  Design Label Estimand Label Estimator Label Term N Sims   Bias   RMSE  Power
##      design_2            ATE             DIM    Z    100   1.32   1.36   1.00
##                                                          (0.03) (0.03) (0.00)
##      design_2            ATE             OLS    Z    100   0.87   0.93   0.95
##                                                          (0.03) (0.03) (0.02)
##  Coverage Mean Estimate SD Estimate Mean Se Type S Rate Mean Estimand
##      0.01          1.82        0.34    0.33        0.00          0.50
##    (0.01)        (0.03)      (0.02)  (0.00)      (0.00)        (0.00)
##      0.24          1.37        0.33    0.35        0.00          0.50
##    (0.04)        (0.03)      (0.02)  (0.00)      (0.00)        (0.00)</code></pre>
</div>
<div id="what-if-you-have-unobserved-confounding" class="section level3">
<h3>
<span class="header-section-number">16.1.6</span> What if you have unobserved confounding?<a class="anchor" aria-label="anchor" href="#what-if-you-have-unobserved-confounding"><i class="fas fa-link"></i></a>
</h3>
<div class="figure" style="text-align: center">
<span id="fig:unnamed-chunk-234"></span>
<img src="figures/regression_dag_2.png" alt="DAG with unobserved confounding" width="40%"><p class="caption">
Figure 16.2: DAG with unobserved confounding
</p>
</div>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design_3</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, 
                     U_z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     U_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     U_y <span class="op">=</span> <span class="fu">correlate</span><span class="op">(</span><span class="va">rnorm</span>, given <span class="op">=</span> <span class="va">U_z</span>, rho <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>,
                     X <span class="op">=</span> <span class="va">U_x</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">Z</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U_y</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob_unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">U_z</span> <span class="op">+</span> <span class="va">U_x</span><span class="op">)</span>, simple <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"DIM"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span>, model <span class="op">=</span> <span class="va">lm</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"OLS"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dx_3</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">design_3</span>, sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span>
<span class="va">dx_3</span></code></pre></div>
<pre><code>## 
## Research design diagnosis based on 100 simulations. Diagnosand estimates with bootstrapped standard errors in parentheses (20 replicates).
## 
##  Design Label Estimand Label Estimator Label Term N Sims   Bias   RMSE  Power
##      design_3            ATE             DIM    Z    100   1.72   1.74   1.00
##                                                          (0.02) (0.02) (0.00)
##      design_3            ATE             OLS    Z    100   1.02   1.04   1.00
##                                                          (0.02) (0.02) (0.00)
##  Coverage Mean Estimate SD Estimate Mean Se Type S Rate Mean Estimand
##      0.00          2.22        0.21    0.22        0.00          0.50
##    (0.00)        (0.02)      (0.01)  (0.00)      (0.00)        (0.00)
##      0.00          1.52        0.17    0.19        0.00          0.50
##    (0.00)        (0.02)      (0.01)  (0.00)      (0.00)        (0.00)</code></pre>
</div>
<div id="what-if-the-observed-covariate-is-post-treatment" class="section level3">
<h3>
<span class="header-section-number">16.1.7</span> What if the observed covariate is post-treatment?<a class="anchor" aria-label="anchor" href="#what-if-the-observed-covariate-is-post-treatment"><i class="fas fa-link"></i></a>
</h3>
<div class="figure" style="text-align: center">
<span id="fig:unnamed-chunk-237"></span>
<img src="figures/regression_dag_3.png" alt="DAG with one observed mediator" width="40%"><p class="caption">
Figure 16.3: DAG with one observed mediator
</p>
</div>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design_4</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, 
                     U_z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     U_m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                     U_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">M</span> <span class="op">~</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">Z</span> <span class="op">+</span> <span class="va">U_m</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">Z</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0.5</span><span class="op">*</span><span class="va">Z</span> <span class="op">+</span> <span class="va">U_m</span><span class="op">)</span> <span class="op">+</span> <span class="va">U_y</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob_unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">U_z</span><span class="op">)</span>, simple <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">M</span>, <span class="va">Y</span><span class="op">)</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"DIM"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">M</span>, model <span class="op">=</span> <span class="va">lm</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"OLS"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dx_4</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">design_4</span>, sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span>
<span class="va">dx_4</span></code></pre></div>
<pre><code>## 
## Research design diagnosis based on 100 simulations. Diagnosand estimates with bootstrapped standard errors in parentheses (20 replicates).
## 
##  Design Label Estimand Label Estimator Label Term N Sims   Bias   RMSE  Power
##      design_4            ATE             DIM    Z    100  -0.01   0.26   0.93
##                                                          (0.02) (0.02) (0.03)
##      design_4            ATE             OLS    Z    100  -0.49   0.52   0.64
##                                                          (0.02) (0.02) (0.05)
##  Coverage Mean Estimate SD Estimate Mean Se Type S Rate Mean Estimand
##      0.96          0.99        0.26    0.28        0.00          1.00
##    (0.02)        (0.02)      (0.02)  (0.00)      (0.00)        (0.00)
##      0.32          0.51        0.18    0.21        0.00          1.00
##    (0.05)        (0.02)      (0.01)  (0.00)      (0.00)        (0.00)</code></pre>
</div>
</div>
<div id="further-reading-6" class="section level2">
<h2>
<span class="header-section-number">16.2</span> Further reading<a class="anchor" aria-label="anchor" href="#further-reading-6"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>
<span class="citation">Rosenbaum (<a href="references-4.html#ref-rosenbaum2002observational" role="doc-biblioref">2002</a>)</span> on matching</li>
</ul>
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- start post here, do not edit above --><!-- make sure to rename the section title below -->
</div>
<div id="p3iv" class="section level2">
<h2>
<span class="header-section-number">16.3</span> Instrumental variables<a class="anchor" aria-label="anchor" href="#p3iv"><i class="fas fa-link"></i></a>
</h2>
<p>In many observational settings, researchers would</p>
<div id="declaration-11" class="section level3">
<h3>
<span class="header-section-number">16.3.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-11"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">D</span> <span class="op">~</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">Z</span> <span class="op">+</span> <span class="va">U</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, assignment_variables <span class="op">=</span> <span class="va">Z</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">+</span> <span class="va">U</span>, assignment_variables <span class="op">=</span> <span class="va">D</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>LATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_D_1</span><span class="op">[</span><span class="va">D_Z_1</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">D_Z_0</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_D_0</span><span class="op">[</span><span class="va">D_Z_1</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">D_Z_0</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">D</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>, <span class="va">D</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">|</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">iv_robust</span>, estimand <span class="op">=</span> <span class="st">"LATE"</span><span class="op">)</span> </code></pre></div>
<ul>
<li>explain the IV estimator is the ratio of <span class="math inline">\(\widehat{ITT_y} / \widehat{ITT_d}\)</span>
</li>
<li>identical to noncompliance in an experiment</li>
</ul>
</div>
<div id="dag-9" class="section level3">
<h3>
<span class="header-section-number">16.3.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-9"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-246-1.svg" width="100%"></div>
</div>
<div id="redesign-2" class="section level3">
<h3>
<span class="header-section-number">16.3.3</span> Redesign<a class="anchor" aria-label="anchor" href="#redesign-2"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>excludability violations</li>
<li>if you do, go <span class="math inline">\(ITT_d\)</span> and <span class="math inline">\(ITT_y\)</span>
</li>
</ul>
</div>
<div id="suggested-readings" class="section level3">
<h3>
<span class="header-section-number">16.3.4</span> Suggested readings<a class="anchor" aria-label="anchor" href="#suggested-readings"><i class="fas fa-link"></i></a>
</h3>
<p>Applications
- Mo, Cecilia Hyunjung, Katherine Conn, Georgia Anderson-Nilsson. 2019. “Can National Service Activism Activate Women’s Political Ambition? Evidence from Teach For America.” Politics, Groups, and Identities 7(4): 864-877.</p>
<p>Methodological literature
- <span class="citation">Angrist and Pischke (<a href="references-4.html#ref-angrist2008mostly" role="doc-biblioref">2008</a>)</span> ch. 4 on instrumental variables estimation
- <span class="citation">Gerber and Green (<a href="references-4.html#ref-Gerber2012" role="doc-biblioref">2012</a>)</span> ch. 5 and ch. 6 on the connection between IV and noncompliance in an experiment
<!-- - @heckman2006understanding -->
- <span class="citation">Deaton (<a href="references-4.html#ref-deaton2009instruments" role="doc-biblioref">2010</a>)</span> for a critique of the LATE as an estimand and <span class="citation">Imbens (<a href="references-4.html#ref-imbens2010better" role="doc-biblioref">2010</a>)</span> for a rejoinder.</p>
</div>
<div id="example-12" class="section level3">
<h3>
<span class="header-section-number">16.3.5</span> Example<a class="anchor" aria-label="anchor" href="#example-12"><i class="fas fa-link"></i></a>
</h3>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
<div id="difference-in-differences" class="section level2">
<h2>
<span class="header-section-number">16.4</span> Difference-in-differences<a class="anchor" aria-label="anchor" href="#difference-in-differences"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-12" class="section level3">
<h3>
<span class="header-section-number">16.4.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-12"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>
    unit <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">2</span>, X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,
    period <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">2</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
    unit_period <span class="op">=</span> <span class="fu">cross_levels</span><span class="op">(</span>by <span class="op">=</span> <span class="fu">join</span><span class="op">(</span><span class="va">unit</span>, <span class="va">period</span><span class="op">)</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span>, subset <span class="op">=</span> <span class="va">period</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_step</span><span class="op">(</span>Z <span class="op">=</span> <span class="va">X</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, handler <span class="op">=</span> <span class="va">mutate</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_reveal</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">period</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">Y_Z_0</span>, <span class="va">Y_Z_1</span><span class="op">)</span>, handler <span class="op">=</span> <span class="va">mutate</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">period</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, se_type <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag-10" class="section level3">
<h3>
<span class="header-section-number">16.4.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-10"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-252-1.svg" width="100%"></div>
</div>
<div id="example-13" class="section level3">
<h3>
<span class="header-section-number">16.4.3</span> Example<a class="anchor" aria-label="anchor" href="#example-13"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="two-period-two-group-setting" class="section level3">
<h3>
<span class="header-section-number">16.4.4</span> Two-period two-group setting<a class="anchor" aria-label="anchor" href="#two-period-two-group-setting"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Show that comparison of T and C in period 2 is biased and comparison of T between period 1 and 2 is biased, but DiD unbiased in presence of confounding in treatment assignment (unit with higher unit shock is always treated) and time trends</li>
</ul>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N_units</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">N_time_periods</span> <span class="op">&lt;-</span> <span class="fl">2</span>

<span class="va">two_period_two_group_design</span> <span class="op">&lt;-</span> 
  
  <span class="fu">declare_population</span><span class="op">(</span>
    units <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N_units</span>, unit_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,
    periods <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N_time_periods</span>, nest <span class="op">=</span> <span class="cn">FALSE</span>,
                        time <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N_time_periods</span><span class="op">)</span> <span class="op">-</span> <span class="va">N_time_periods</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>,
    unit_period <span class="op">=</span> <span class="fu">cross_levels</span><span class="op">(</span>by <span class="op">=</span> <span class="fu">join</span><span class="op">(</span><span class="va">units</span>, <span class="va">periods</span><span class="op">)</span>, unit_time_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  
  <span class="co"># internal note: the unbiasedness obtains whether or not there is a unit-time shock</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    Y_Z_0 <span class="op">=</span> <span class="va">unit_shock</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">time</span> <span class="op">+</span> <span class="va">unit_time_shock</span>, <span class="co"># common pretreatment trend</span>
    Y_Z_1 <span class="op">=</span> <span class="va">Y_Z_0</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span>, subset <span class="op">=</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="va">unit_shock</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">unit_shock</span><span class="op">)</span>, handler <span class="op">=</span> <span class="va">mutate</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu">declare_reveal</span><span class="op">(</span>
    Y <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">time</span> <span class="op">&lt;</span> <span class="fl">1</span> <span class="op">~</span> <span class="va">Y_Z_0</span>, <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">Y_Z_1</span><span class="op">)</span>, handler <span class="op">=</span> <span class="va">mutate</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">declare_estimator</span><span class="op">(</span>estimate <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span>
                      <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,
                    estimator_label <span class="op">=</span> <span class="st">"DiD"</span>, handler <span class="op">=</span> <span class="va">summarize</span>, label <span class="op">=</span> <span class="st">"DiD"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">declare_estimator</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span>,
                    estimator_label <span class="op">=</span> <span class="st">"Diff"</span>, handler <span class="op">=</span> <span class="va">summarize</span>, label <span class="op">=</span> <span class="st">"Over-Time"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">declare_estimator</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
                    estimator_label <span class="op">=</span> <span class="st">"DiM"</span>, handler <span class="op">=</span> <span class="va">summarize</span>, label <span class="op">=</span> <span class="st">"DiM"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diagnosis_two_period_two_group</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span>
  <span class="va">two_period_two_group_design</span>, diagnosands <span class="op">=</span> <span class="fu">declare_diagnosands</span><span class="op">(</span>select <span class="op">=</span> <span class="va">bias</span><span class="op">)</span>,
  sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">kable</span><span class="op">(</span><span class="fu">get_diagnosands</span><span class="op">(</span><span class="va">diagnosis_two_period_two_group</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
design_label
</th>
<th style="text-align:left;">
estimand_label
</th>
<th style="text-align:left;">
estimator_label
</th>
<th style="text-align:right;">
bias
</th>
<th style="text-align:right;">
se(bias)
</th>
<th style="text-align:right;">
n_sims
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
two_period_design
</td>
<td style="text-align:left;">
ATE
</td>
<td style="text-align:left;">
DiD
</td>
<td style="text-align:right;">
-0.0421836
</td>
<td style="text-align:right;">
0.0671367
</td>
<td style="text-align:right;">
1000
</td>
</tr>
<tr>
<td style="text-align:left;">
two_period_design
</td>
<td style="text-align:left;">
ATE
</td>
<td style="text-align:left;">
Diff
</td>
<td style="text-align:right;">
0.4619315
</td>
<td style="text-align:right;">
0.0487573
</td>
<td style="text-align:right;">
1000
</td>
</tr>
<tr>
<td style="text-align:left;">
two_period_design
</td>
<td style="text-align:left;">
ATE
</td>
<td style="text-align:left;">
DiM
</td>
<td style="text-align:right;">
1.1511461
</td>
<td style="text-align:right;">
0.0547887
</td>
<td style="text-align:right;">
1000
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="parallel-trends-assumption" class="section level3">
<h3>
<span class="header-section-number">16.4.5</span> Parallel trends assumption<a class="anchor" aria-label="anchor" href="#parallel-trends-assumption"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Introduce assumption and visual test</li>
</ul>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># add an additional pretreatment time period in order to visually test for parallel pre-trends</span>
<span class="va">three_period_two_group_design</span> <span class="op">&lt;-</span> <span class="fu">redesign</span><span class="op">(</span><span class="va">two_period_two_group_design</span>, N_time_periods <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">draw_data</span><span class="op">(</span><span class="va">three_period_two_group_design</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">Z</span>, <span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>Z_color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Z</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Untreated"</span>, <span class="st">"Treated"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">time</span>, <span class="va">Y</span>, color <span class="op">=</span> <span class="va">Z_color</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_color_discrete</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_discrete</span><span class="op">(</span><span class="st">"Time"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-259-1.svg" width="100%"></div>
<ul>
<li>Formal test (DID on T = -1 and T = 0 periods, i.e. a year backward from the DiD)</li>
<li>There is a result that shows that the two-step procedure of the parallel trends assumption then DID if test passes that shows poor coverage of SEs in final DID (<a href="https://arxiv.org/abs/1804.01208" class="uri">https://arxiv.org/abs/1804.01208</a>). Cite here.</li>
</ul>
</div>
<div id="multi-period-design" class="section level3">
<h3>
<span class="header-section-number">16.4.6</span> Multi-period design<a class="anchor" aria-label="anchor" href="#multi-period-design"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Switch to regression context with 20 periods, 100 units and show same results hold with two-way FE (controlling for one period before T is insufficient to remove bias)</li>
</ul>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N_units</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="va">N_time_periods</span> <span class="op">&lt;-</span> <span class="fl">20</span>

<span class="va">multi_period_design</span> <span class="op">&lt;-</span> 
  
  <span class="fu">declare_population</span><span class="op">(</span>
    units <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N_units</span>, 
                      unit_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, 
                      unit_treated <span class="op">=</span> <span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="va">unit_shock</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">unit_shock</span><span class="op">)</span><span class="op">)</span>, 
                      unit_treatment_start <span class="op">=</span> 
                        <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">N_time_periods</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="va">N_time_periods</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
    periods <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N_time_periods</span>, nest <span class="op">=</span> <span class="cn">FALSE</span>, 
                        time <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N_time_periods</span><span class="op">)</span> <span class="op">-</span> <span class="va">N_time_periods</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>,
    unit_period <span class="op">=</span> <span class="fu">cross_levels</span><span class="op">(</span>by <span class="op">=</span> <span class="fu">join</span><span class="op">(</span><span class="va">units</span>, <span class="va">periods</span><span class="op">)</span>,
                               noise <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, 
                               pretreatment <span class="op">=</span> <span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;</span> <span class="va">unit_treatment_start</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    Y_Z_0 <span class="op">=</span> <span class="va">unit_shock</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">time</span> <span class="op">+</span> <span class="va">noise</span>, <span class="co"># common pretreatment trend</span>
    Y_Z_1 <span class="op">=</span> <span class="va">Y_Z_0</span> <span class="op">+</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span>, subset <span class="op">=</span> <span class="va">time</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="va">unit_treated</span> <span class="op">&amp;</span> <span class="va">pretreatment</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span>, handler <span class="op">=</span> <span class="va">fabricate</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">time</span>, fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">units</span> <span class="op">+</span> <span class="va">periods</span>, 
                    model <span class="op">=</span> <span class="va">lm_robust</span>, label <span class="op">=</span> <span class="st">"twoway-fe"</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span> </code></pre></div>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diagnosis_multi_period_multi_group</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">multi_period_design</span>, diagnosands <span class="op">=</span> <span class="fu">declare_diagnosands</span><span class="op">(</span>select <span class="op">=</span> <span class="va">bias</span><span class="op">)</span>, sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">kable</span><span class="op">(</span><span class="fu">get_diagnosands</span><span class="op">(</span><span class="va">diagnosis_multi_period_multi_group</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
design_label
</th>
<th style="text-align:left;">
estimand_label
</th>
<th style="text-align:left;">
estimator_label
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
bias
</th>
<th style="text-align:right;">
se(bias)
</th>
<th style="text-align:right;">
n_sims
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
multi_period_design
</td>
<td style="text-align:left;">
ATE
</td>
<td style="text-align:left;">
twoway-fe
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
-0.0005784
</td>
<td style="text-align:right;">
0.0066689
</td>
<td style="text-align:right;">
1000
</td>
</tr></tbody>
</table></div>
<ul>
<li>Show that in case where some units switch back and forth between T and C during panel there is bias (point to Imai and Kim appear with weighted FE estimator to fix this)</li>
</ul>
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- start post here, do not edit above -->
</div>
</div>
<div id="RDD" class="section level2">
<h2>
<span class="header-section-number">16.5</span> Regression Discontinuity<a class="anchor" aria-label="anchor" href="#RDD"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-13" class="section level3">
<h3>
<span class="header-section-number">16.5.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-13"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cutoff</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>
<span class="va">control</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">4</span>, raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.7</span>, <span class="op">-</span><span class="fl">.8</span>, <span class="fl">.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>
<span class="va">treatment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">4</span>, raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="fl">.5</span>, <span class="fl">.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">.15</span><span class="op">}</span>

<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    N <span class="op">=</span> <span class="fl">1000</span>,
    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span>,
    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="va">U</span> <span class="op">-</span> <span class="va">cutoff</span>,
    Z <span class="op">=</span> <span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="va">X</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="fu">treatment</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Z</span><span class="op">)</span> <span class="op">*</span> <span class="fu">control</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>LATE <span class="op">=</span> <span class="fu">treatment</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> <span class="op">-</span> <span class="fu">control</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">4</span><span class="op">)</span> <span class="op">*</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"LATE"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag-11" class="section level3">
<h3>
<span class="header-section-number">16.5.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-11"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-269-1.svg" width="100%"></div>
</div>
<div id="example-14" class="section level3">
<h3>
<span class="header-section-number">16.5.3</span> Example<a class="anchor" aria-label="anchor" href="#example-14"><i class="fas fa-link"></i></a>
</h3>
<p>Regression discontinuity designs exploit substantive knowledge that treatment is assigned in a particular way: everyone above a threshold is assigned to treatment and everyone below it is not. Even though researchers do not control the assignment, substantive knowledge about the threshold serves as a basis for a strong identification claim.</p>
<p>Thistlewhite and Campbell introduced the regression discontinuity design in the 1960s to study the impact of scholarships on academic success. Their insight was that students with a test score just above a scholarship cutoff were plausibly comparable to students whose scores were just below the cutoff, so any differences in future academic success could be attributed to the scholarship itself.</p>
<p>Regression discontinuity designs identify a <em>local</em> average treatment effect: the average effect of treatment <em>exactly at the cutoff</em>. The main trouble with the design is that there is vanishingly little data exactly at the cutoff, so any answer strategy needs to use data that is some distance away from the cutoff. The further away from the cutoff we move, the larger the threat of bias.</p>
<p>We’ll consider an application of the regression discontinuity design that examines party incumbency advantage – the effect of a party winning an election on its vote margin in the next election.</p>
</div>
<div id="design-declaration-3" class="section level3">
<h3>
<span class="header-section-number">16.5.4</span> Design Declaration<a class="anchor" aria-label="anchor" href="#design-declaration-3"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>
<p><strong>M</strong>odel: Regression discontinuity designs have four components: A running variable, a cutoff, a treatment variable, and an outcome. The cutoff determines which units are treated depending on the value of the running variable.</p>
<p>In our example, the running variable <span class="math inline">\(X\)</span> is the Democratic party’s margin of victory at time <span class="math inline">\(t-1\)</span>; and the treatment, <span class="math inline">\(Z\)</span>, is whether the Democratic party won the election in time <span class="math inline">\(t-1\)</span>. The outcome, <span class="math inline">\(Y\)</span>, is the Democratic vote margin at time <span class="math inline">\(t\)</span>. We’ll consider a population of 1,000 of these pairs of elections.</p>
<p>A major assumption required for regression discontinuity is that the conditional expectation functions for both treatment and control potential outcomes are continuous at the cutoff.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;An alternative motivation for some designs that do not rely on continuity at the cutoff is “local randomization”.&lt;/p&gt;"><sup>24</sup></a> To satisfy this assumption, we specify two smooth conditional expectation functions, one for each potential outcome. The figure plots <span class="math inline">\(Y\)</span> (the Democratic vote margin at time <span class="math inline">\(t\)</span>) against <span class="math inline">\(X\)</span> (the margin at time <span class="math inline">\(t-1\)</span>). We’ve also plotted the true conditional expectation functions for the treated and control potential outcomes. The solid lines correspond to the observed data and the dashed lines correspond to the unobserved data.</p>
</li>
</ul>
<!-- make sure to rename the section title below --><div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cutoff</span> <span class="op">&lt;-</span> <span class="fl">.5</span>
<span class="va">control</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">4</span>, raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.7</span>, <span class="op">-</span><span class="fl">.8</span>, <span class="fl">.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>
<span class="va">treatment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">4</span>, raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="fl">.5</span>, <span class="fl">.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">.15</span><span class="op">}</span>

<span class="va">rd_design</span> <span class="op">&lt;-</span>
  <span class="co"># Model -------------------------------------------------------------------</span>
<span class="fu">declare_population</span><span class="op">(</span>
  N <span class="op">=</span> <span class="fl">1000</span>,
  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="va">cutoff</span>,
  noise <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">.1</span><span class="op">)</span>,
  Z <span class="op">=</span> <span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="va">X</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
<span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="fu">treatment</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Z</span><span class="op">)</span> <span class="op">*</span> <span class="fu">control</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Inquiry -----------------------------------------------------------------</span>
<span class="fu">declare_estimand</span><span class="op">(</span>LATE <span class="op">=</span> <span class="fu">treatment</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> <span class="op">-</span> <span class="fu">control</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Data Strategy -----------------------------------------------------------------</span>
<span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Answer Strategy ---------------------------------------------------------</span>
<span class="fu">declare_estimator</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">4</span><span class="op">)</span> <span class="op">*</span> <span class="va">Z</span>,
                  model <span class="op">=</span> <span class="va">lm_robust</span>,
                  estimand <span class="op">=</span> <span class="st">"LATE"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-273-1.svg" width="100%"></div>
<ul>
<li><p><strong>I</strong>nquiry: Our estimand is the effect of a Democratic win in an election on the Democratic vote margin of the next election, when the Democratic vote margin of the first election is zero. Formally, it is the difference in the conditional expectation functions of the control and treatment potential outcomes when the running variable is exactly zero. The black vertical line in the plot shows this difference.</p></li>
<li><p><strong>D</strong>ata strategy: We collect data on the Democratic vote share at time <span class="math inline">\(t-1\)</span> and time <span class="math inline">\(t\)</span> for all 1,000 pairs of elections. There is no sampling or random assignment.</p></li>
<li><p><strong>A</strong>nswer strategy: We will approximate the treated and untreated conditional expectation functions to the left and right of the cutoff using a flexible regression specification estimated via OLS. In particular, we fit each regression using a fourth-order polynomial. Much of the literature on regression discontinuity designs focuses on the tradeoffs among answer strategies, with many analysts recommending against higher-order polynomial regression specifications. We use one here to highlight how well such an answer strategy does when it matches the functional form in the model. We discuss alternative estimators in the exercises.</p></li>
</ul>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rd_diagnosis</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">rd_design</span>, sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span></code></pre></div>
<p>Now all that simulating, saving, and loading is done, and we can use the simulations for whatever you want.</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rd_diagnosis</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Research design diagnosis based on 100 simulations. Diagnosand estimates with bootstrapped standard errors in parentheses (20 replicates).
## 
##  Design Label Estimand Label Estimator Label        Term N Sims   Bias   RMSE
##     rd_design           LATE       estimator poly(X, 4)1    100   2.08  24.82
##                                                                 (2.36) (1.50)
##   Power Coverage Mean Estimate SD Estimate Mean Se Type S Rate Mean Estimand
##    0.06     0.95          2.23       24.85   26.52        0.33          0.15
##  (0.02)   (0.02)        (2.36)      (1.54)  (0.28)      (0.21)        (0.00)</code></pre>
</div>
<div id="takeaways-3" class="section level3">
<h3>
<span class="header-section-number">16.5.5</span> Takeaways<a class="anchor" aria-label="anchor" href="#takeaways-3"><i class="fas fa-link"></i></a>
</h3>
<p>We highlight three takeaways. First, the power of this design is very low: with 1,000 units we do not achieve even 10% statistical power. However, our estimates of the uncertainty are not too wide: the coverage probability indicates that our confidence intervals indeed contain the estimand 95% of the time as they should. Our answer strategy is highly uncertain because the fourth-order polynomial specification in regression model gives weights to the data that greatly increase the variance of the estimator (<span class="citation">Gelman and Imbens (<a href="references-4.html#ref-gelman2017high" role="doc-biblioref">2017</a>)</span>). In the exercises we explore alternative answer strategies that perform better.</p>
<p>Second, the design is biased because polynomial approximations of the average effect at exactly the point of the threshold will be inaccurate in small samples (<span class="citation">Sekhon and Titiunik (<a href="references-4.html#ref-sekhontitiunik2017" role="doc-biblioref">2017</a>)</span>), especially as units farther away from the cutoff are incorporated into the answer strategy. We know that the estimated bias is not due to simulation error by examining the bootstrapped standard error of the bias estimates.</p>
<p>Finally, from the figure, we can see how poorly the average effect at the threshold approximates the average effect for all units. The average treatment effect among the treated (to the right of the threshold in the figure) is negative, whereas at the threshold it is positive. This clarifies that the estimand of the regression discontinuity design, the difference at the cutoff, is only relevant for a small – and possibly empty – set of units very close to the cutoff.</p>
</div>
<div id="further-reading-7" class="section level3">
<h3>
<span class="header-section-number">16.5.6</span> Further Reading<a class="anchor" aria-label="anchor" href="#further-reading-7"><i class="fas fa-link"></i></a>
</h3>
<p>Since its rediscovery by social scientists in the late 1990s, the regression discontinuity design has been widely used to study diverse causal effects such as: prison on recidivism (<span class="citation">Mitchell et al. (<a href="references-4.html#ref-Ojmarrh2017" role="doc-biblioref">2017</a>)</span>); China’s one child policy on human capital (<span class="citation">Qin, Zhuang, and Yang (<a href="references-4.html#ref-qin2017" role="doc-biblioref">2017</a>)</span>); eligibility for World Bank loans on political liberalization (<span class="citation">Carnegie and Samii (<a href="references-4.html#ref-carnegie2017international" role="doc-biblioref">2017</a>)</span>); and anti-discrimination laws on minority employment (<span class="citation">Hahn, Todd, and Van der Klaauw (<a href="references-4.html#ref-hahn1999evaluating" role="doc-biblioref">1999</a>)</span>).</p>
<p>We’ve discussed a “sharp” regression discontinuity design in which all units above the threshold were treated and all units below were untreated. In fuzzy regression discontinuity designs, some units above the cutoff remain untreated or some units below take treatment. This setting is analogous to experiments that experience noncompliance and may require instrumental variables approaches to the answer strategy (see <strong>Compliance is a Potential Outcome</strong>).</p>
<p>Geographic regression discontinuity designs use distance to a border as the running variable: units on one side of the border are treated and units on the other are untreated. <span class="citation">Keele and Titiunik (<a href="references-4.html#ref-keele2016natural" role="doc-biblioref">2016</a>)</span> use such a design to study whether voters are more likely to turn out when they have the opportunity to vote directly on legislation on so-called ballot initiatives. A complication of this design is how to measure distance to the border in two dimensions.</p>
<ul>
<li><span class="citation">Sekhon and Titiunik (<a href="references-4.html#ref-sekhon2016understanding" role="doc-biblioref">2016</a>)</span></li>
<li><span class="citation">De la Cuesta and Imai (<a href="references-4.html#ref-delacuesta2016" role="doc-biblioref">2016</a>)</span></li>
</ul>
</div>
<div id="exercises-3" class="section level3">
<h3>
<span class="header-section-number">16.5.7</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-3"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p><span class="citation">Gelman and Imbens (<a href="references-4.html#ref-gelman2017high" role="doc-biblioref">2017</a>)</span> point out that higher order polynomial regression specifications lead to extreme regression weights. One approach to obtaining better estimates is to select a bandwidth, <span class="math inline">\(h\)</span>, around the cutoff, and run a linear regression. Declare a sampling procedure that subsets the data to a bandwidth around the threshold, as well as a first order linear regression specification, and analyze how the power, bias, RMSE, and coverage of the design vary as a function of the bandwidth.</p></li>
<li><p>The <code>rdrobust</code> estimator in the <code>rdrobust</code> package implements a local polynomial estimator that automatically selects a bandwidth for the RD analysis and bias-corrected confidence intervals. Declare another estimator using the <code>rdrobust</code> function and add it to the design. How does the coverage and bias of this estimator compare to the regression approaches declared above?</p></li>
<li><p>Reduce the number of polynomial terms of the the <code>treatment()</code> and <code>control()</code> functions and assess how the bias of the design changes as the potential outcomes become increasingly linear as a function of the running variable.</p></li>
<li><p>Redefine the population function so that units with higher potential outcome are more likely to locate just above the cutoff than below it. Assess whether and how this affects the bias of the design.</p></li>
</ol>
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- make sure to rename the section title below --><!-- start post here, do not edit above -->
</div>
</div>
<div id="bayesianprocesstracing" class="section level2">
<h2>
<span class="header-section-number">16.6</span> Bayesian process-tracing<a class="anchor" aria-label="anchor" href="#bayesianprocesstracing"><i class="fas fa-link"></i></a>
</h2>
<p>Process-tracing is a qualitative method that uses evidence from in-depth interviews and written records to test causal theories. Process-tracing designs often focus on “causes-of-effects” inquiries (e.g., did the presence of a strong middle class cause a revolution?), rather than on “effects-of-causes” inquiries (e.g., what is the average effect of a strong middle class on the probability of a revolution happening?) <span class="citation">Goertz and Mahoney (<a href="references-4.html#ref-goertz2012tale" role="doc-biblioref">2012</a>)</span>.</p>
<p>Causes-of-effects inquiries imply a hypothesis – “the strong middle class caused the revolution,” say. One widely-promoted answer strategy suggests evaluating whether such hypotheses are correct given the presence or absence of different “clues” found in the archives or interviews [<span class="citation">Collier, Brady, and Seawright (<a href="references-4.html#ref-collier2004sources" role="doc-biblioref">2004</a>)</span>; <span class="citation">Mahoney (<a href="references-4.html#ref-Mahony:Logic:2012" role="doc-biblioref">2012</a>)</span>; <span class="citation">Bennett and Checkel (<a href="references-4.html#ref-bennett2014process" role="doc-biblioref">2015</a>)</span>; fairfield2013going]. <span class="citation">Van Evera (<a href="references-4.html#ref-VanEvera1997" role="doc-biblioref">1997</a>)</span> categorizes different kinds of clues according to whether one would only believe the hypothesis if one observed the clue (necessity) and whether observing the clue would suffice to infer the hypothesis was correct (sufficiency).<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;“Smoking guns” are well-known: observing them is sufficient to infer the hypothesis is true, but not necessary (as they are quite rare). “Hoop tests,” on the other hand, are pieces of evidence that one would expect to find if the hypothesis is correct (necessary), but do not necessarily prove it (not sufficient). “Straw-in-the-wind” tests are neither necessary nor sufficient, while “doubly-decisive” pieces of evidence are fully informative: you should expect to find them if you are correct and if you do, you have proven your theory.&lt;/p&gt;"><sup>25</sup></a></p>
<p>Of course, it is rare to have such certainty—we typically attach varying degrees of belief to statements of truth. Bayesian process-tracing uses probability theory to form a posterior belief about a hypothesis, given our <em>beliefs</em> about whether we would observe different pieces of evidence if we are right or wrong~. Extending <span class="citation">Van Evera (<a href="references-4.html#ref-VanEvera1997" role="doc-biblioref">1997</a>)</span>, “hoop tests”" are clues that are nearly certain to be seen if the hypothesis is true, but likely either way, “smoking-guns” are unlikely to be seen in general but are extremely unlikely if a hypothesis is false, “straws-in-the-wind” are more likely when the hypothesis is true but still somewhat likely when it is not, and ``doubly-decisive’’ clues are very likely to be seen if a hypothesis is true and very unlikely if it is false.</p>
<div id="declaration-14" class="section level3">
<h3>
<span class="header-section-number">16.6.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-14"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>
<p><span class="math inline">\(M\)</span> <em>Model</em>: We posit a population of 195 cases, each of which does or does not exhibit the presence of an outcome, <span class="math inline">\(Y \in \{0,1\}\)</span>. For the sake of illustration, we will suppose that <span class="math inline">\(Y\)</span> represents the presence or absence of a civil war. Each case also exhibits the presence or absence of a potential cause, <span class="math inline">\(Z \in \{0,1\}\)</span>. For example, we might suppose that <span class="math inline">\(Z\)</span> represents the presence or absence of natural resources. At random, 30% of the cases get <span class="math inline">\(Z=1\)</span>. We also assume researchers observe a clue, <span class="math inline">\(C\)</span>, that is informative for whether <span class="math inline">\(Z\)</span> does or does not have a causal relationship with <span class="math inline">\(Y\)</span>.</p>
<p>The potential outcomes of <span class="math inline">\(Y\)</span> depend both on whether the cause, <span class="math inline">\(Z\)</span>, is present in a case and what “type” of causal relation the case exhibits. Conceptually, there are exactly four distinct types of causal relations. First, the presence of <span class="math inline">\(Z\)</span> might cause <span class="math inline">\(Y\)</span>: if <span class="math inline">\(Z = 0\)</span>, then <span class="math inline">\(Y = 0\)</span> and if <span class="math inline">\(Z = 1\)</span> then <span class="math inline">\(Y = 1\)</span>. In other words, civil wars happen in such cases <em>because</em> the country has natural resources. Second, the absence of <span class="math inline">\(Z\)</span> might cause <span class="math inline">\(Y\)</span>: if <span class="math inline">\(Z = 0\)</span> then <span class="math inline">\(Y = 1\)</span> and if <span class="math inline">\(Z = 1\)</span> then <span class="math inline">\(Y = 0\)</span>. In such cases, civil war breaks out <em>because</em> the country does not have natural resources, and would not break out if the country had natural resources. Finally, <span class="math inline">\(Y\)</span> might be present irrespective of <span class="math inline">\(Z\)</span> or <span class="math inline">\(Y\)</span> might be absent irrespective of <span class="math inline">\(Z\)</span>. Continuing our analogy, such countries would have had civil war or peace, irrespective of whether they also had natural resources (i.e., because war is related to some other causal process). We specify a model in which civil war is governed by causal pathway 1 (<span class="math inline">\(Z\)</span> causes <span class="math inline">\(Y\)</span>) in roughly 20% of cases, by pathway 2 (<span class="math inline">\(\neg Z\)</span> causes <span class="math inline">\(Y\)</span>) in only 10% of cases, by pathway 3 (<span class="math inline">\(Y\)</span> irrespective of <span class="math inline">\(z\)</span>) in 20% of countries, and by pathway 4 (<span class="math inline">\(\neg Y\)</span> irrespective of <span class="math inline">\(Z\)</span>) in half of all countries.</p>
<p>There are also potential outcomes for the clue, <span class="math inline">\(C\)</span>. These depend on the case’s causal type. Specifically, the clue appears with .25 probability if the case is one in which <span class="math inline">\(Z\)</span> causes <span class="math inline">\(Y\)</span>, and with probability .005 if it is one where <span class="math inline">\(Y\)</span> occurs regardless. The clue does not appear in the other types of cases. Crucially, while the outcome, cause, and clue are observable to the researcher, the type is not.</p>
</li>
<li><p><span class="math inline">\(I\)</span> <em>Inquiry</em>: We wish to know the answer to a sample-specific “cause of effects” question: given the specific case we sampled, what is the probability that <span class="math inline">\(Z\)</span> caused <span class="math inline">\(Y\)</span>? More formally, we want to know <span class="math inline">\(\Pr(Y_i(Z_i=0)=0| Z_i=1, Y_i(Z_i=1)=1)\)</span>—that is, what are the chances that <span class="math inline">\(Y\)</span> would have been 0 if <span class="math inline">\(Z\)</span> were 0 for a unit <span class="math inline">\(i\)</span> for which <span class="math inline">\(Z\)</span> was 1 and <span class="math inline">\(Y\)</span> was 1. This is equivalent to asking the probability that the case is of type 1. The inquiry thus takes the value 0 or 1 depending on the type of case.</p></li>
<li><p><span class="math inline">\(D\)</span> <em>Data Strategy</em>: The fundamental problem that the researcher faces is that of observational equivalence: different causal types can cause the same data patterns. The issue is mitigated by following a controversial sampling strategy: selecting on <span class="math inline">\(Y\)</span>. By selecting at random one case in which both <span class="math inline">\(Z\)</span> and <span class="math inline">\(Y\)</span> are present, the researcher can narrow her uncertainty to two candidate types: the second and fourth causal types are incapable of producing the data <span class="math inline">\(Z = 1, Y = 1\)</span>. It cannot be that natural resources were the cause of peace (type 2), or that peace would have happened irrespective of natural resources (type 4), in a country that had a civil war and natural resources.</p></li>
<li><p><span class="math inline">\(A\)</span> <em>Answer Strategy</em>: The researcher uses Bayes’ rule to update about the probability that <span class="math inline">\(Z\)</span> caused <span class="math inline">\(Y\)</span> given <span class="math inline">\(C\)</span>.</p></li>
</ul>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Z_caused_Y'</span>, <span class="st">'Z_caused_not_Y'</span>, <span class="st">'always_Y'</span>, <span class="st">'always_not_Y'</span><span class="op">)</span>

<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">195</span>,
                     Z <span class="op">=</span> <span class="fu">draw_binary</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">.3</span>, N <span class="op">=</span> <span class="va">N</span><span class="op">)</span>,
                     type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">types</span>, size <span class="op">=</span> <span class="va">N</span>, 
                                   replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.2</span>, <span class="fl">.1</span>, <span class="fl">.2</span>, <span class="fl">.5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Z_caused_Y"</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Z</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Z_caused_not_Y"</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"always_Y"</span><span class="op">)</span>,
    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, type <span class="op">=</span> <span class="va">types</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">pr_C_1</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="op">(</span><span class="fl">.25</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Z_caused_Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fl">.005</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"always_Y"</span><span class="op">)</span><span class="op">)</span>,
    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, type <span class="op">=</span> <span class="va">types</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">pr_C_1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_measurement</span><span class="op">(</span>C <span class="op">=</span> <span class="fu">draw_binary</span><span class="op">(</span>prob <span class="op">=</span> <span class="va">pr_C_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_sampling</span><span class="op">(</span>handler <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Z</span><span class="op">==</span><span class="fl">1</span> <span class="op">&amp;</span> <span class="va">Y</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">sample_n</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>did_Z_cause_Y <span class="op">=</span> <span class="va">type</span> <span class="op">==</span> <span class="st">'Z_caused_Y'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    pr_type_Z_caused_Y <span class="op">=</span> <span class="fl">.5</span>,
    pr_C_1_type_Z_caused_Y <span class="op">=</span> <span class="fl">.25</span>,
    pr_C_1_type_always_Y <span class="op">=</span> <span class="fl">.005</span>,
    pr_C_type_Z_caused_Y <span class="op">=</span> <span class="va">C</span> <span class="op">*</span> <span class="va">pr_C_1_type_Z_caused_Y</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">C</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_C_1_type_Z_caused_Y</span><span class="op">)</span>,
    pr_C_type_always_Y <span class="op">=</span> <span class="va">C</span> <span class="op">*</span> <span class="va">pr_C_1_type_always_Y</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">C</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_C_1_type_always_Y</span><span class="op">)</span>,
    posterior <span class="op">=</span>
      <span class="va">pr_type_Z_caused_Y</span> <span class="op">*</span> <span class="va">pr_C_type_Z_caused_Y</span> <span class="op">/</span> <span class="op">(</span><span class="va">pr_type_Z_caused_Y</span> <span class="op">*</span> <span class="va">pr_C_type_Z_caused_Y</span> <span class="op">+</span> <span class="va">pr_C_type_always_Y</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_type_Z_caused_Y</span><span class="op">)</span><span class="op">)</span>,
    estimator_label <span class="op">=</span> <span class="st">"Smoking Gun"</span>,
    estimand_label <span class="op">=</span> <span class="st">"did_Z_cause_Y"</span>,
    handler <span class="op">=</span> <span class="va">summarize</span><span class="op">)</span> </code></pre></div>
</div>
<div id="dag-12" class="section level3">
<h3>
<span class="header-section-number">16.6.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-12"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-283-1.svg" width="100%"></div>
<!-- **Comment for JC**: a really like most of this set up. My own thinking though has changed a fair bit on this stuff however and think now it is more coherent to have a model such as `X -> Y <- C` where the position in the model is what gives C explanatory power. Plus with teh CausalQueries package it is really easy to set this up in a natural way and connect with DD. Doing like this would be not just conceptually better (I think) but a lot more flexible for the user. I'd be happy to do the work, think most of the text would remain as is but the example and some questions etc would change. What do you think? -->
<!-- I think this is a question for Graeme, too, as we worked on this together and got it to a place we were pretty happy with. But I'd certainly be open to changing to something simpler and more accessible. If it's more complicated in spirit, then maybe it should go in the more detailed version below? -->
</div>
<div id="exercises-4" class="section level3">
<h3>
<span class="header-section-number">16.6.3</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-4"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Inspect the DAG. How would removing the arrow pointing from type to C affect the inferences a researcher could draw?</p></li>
<li>
<p>Run <code>draw_data(design)</code>.</p>
<ol style="list-style-type: lower-roman">
<li><p>Interpret the value of the <code>type</code> variable.</p></li>
<li><p>Look at the values of Z and Y. Explain which types could produce these values and why.</p></li>
<li><p>The variable <code>pr_C_1_Z_1_type_Z_caused_Y</code> indicates “The potential outcome of the clue probability, given the case is the type in which Z causes Y,” while <code>pr_C_1_Z_1_type_always_Y</code> gives the corresponding potential outcome for cases whose causal type is one in which Y always happens regardless of Z. Why do these potential outcomes make the clue a smoking gun?</p></li>
<li><p>Explain why the potential outcome <code>Y_Z_0_type_always_Y</code> takes the value 1 whereas the potential outcome <code>Y_Z_0_type_Z_caused_Y</code> takes the value 0.</p></li>
</ol>
</li>
<li><p>Using the code below, diagnose the <code>design</code> and interpret the diagnosands.</p></li>
</ol>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">diagnose_design</span><span class="op">(</span><span class="va">design</span>,
                diagnosands <span class="op">=</span> <span class="fu">declare_diagnosands</span><span class="op">(</span>
                  bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">posterior</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span>,
                  rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">posterior</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
                  mean_estimand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimand</span><span class="op">)</span>,
                  mean_posterior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">posterior</span><span class="op">)</span>,
                  keep_defaults <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, 
                sims <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>
<p>Look at the estimator declaration.</p>
<ol style="list-style-type: lower-roman">
<li><p>What prior beliefs do <code>pr_C_1_type_Z_caused_Y</code> and <code>pr_C_1_type_always_Y</code> represent?</p></li>
<li><p>How would setting these beliefs to the same value affect the design, and why?</p></li>
<li><p>What is the implication for clue selection in Bayesian Process Tracing designs?</p></li>
</ol>
</li>
<li>
<p>Declare a <code>new_design</code> in which you modify the prior belief that the case belongs to the first causal type by changing <code>pr_type_Z_caused_Y</code> to a different value (say, .7).</p>
<ol style="list-style-type: lower-roman">
<li><p>Diagnose <code>new_design</code>. How does the bias parameter change, and why?</p></li>
<li><p>Keeping the modification you just made, modify the code for <code>new_design</code> further so that the clue potential outcomes function is <code>pr_C_1 ~ Z * (.9999 * (type == "Z_caused_Y") + .0001 * (type == "always_Y"</code> and the clue priors are <code>pr_C_1_type_Z_caused_Y = .9999</code> and <code>pr_C_1_type_always_Y = .0001</code>. What kind of clue does the researcher have now?</p></li>
<li><p>Diagnose <code>new_design</code>. Why do these changes to the clue reduce bias?</p></li>
</ol>
</li>
</ol>
</div>
<div id="online-appendix-applied-example" class="section level3">
<h3>
<span class="header-section-number">16.6.4</span> Online Appendix Applied Example<a class="anchor" aria-label="anchor" href="#online-appendix-applied-example"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Point here is to explore cases where you look at multiple sources of
evidence</p></li>
<li><p>In many parts of the world, people rely on non-state institutions to construct social order. Sometimes, those institutions persist for a long time [e.g., mourides], whereas sometimes they break down. Why do non-state institutions fail? Some scholars of African societies think that traditional institutions declined in the 1960s and 1970s due to the forceful efforts of post-independence leaders who saw these alternative authorities as a threat to the young state. Other scholars such as <span class="citation">Ensminger (<a href="references-4.html#ref-ensminger1990" role="doc-biblioref">1990</a>)</span> point instead to the internal political economy of rural societies, and emphasize the role of economic interests in the decline of traditional institutions.</p></li>
<li><p><span class="citation">Ensminger (<a href="references-4.html#ref-ensminger1990" role="doc-biblioref">1990</a>)</span> is an economic anthropologist who does a bunch of cool work with the Orma in Kenya, a nomadic pastoralist group. She points out that, whereas the Orma were able to avoid a tragedy of the commons by policing access to scarce water resources by competing somali pastoralists throughout the 1960s and 1970s, by the 1980s the power of the council of elders was weakened, as evidenced by frequent defection of individual orma who sold their water to somalis, thus hurting the interests of the group.</p></li>
<li><p>Her study presents a case of causal process tracing in which the scholar presents evidence from rich fieldwork to support the inference that some effect was produced by a specific cause. It is useful to formalize as it provides lessons about what kinds of clues qualitative researchers might seek in order to maximize the probative value of their answer strategy.</p></li>
<li><p>The key pieces are the outcome (breakdown of council of elders – measured through defections by orma selling their water to somalis), its potential cause (economic diversification – measured as a move away from cattle-based pastoralism towards sendentary economic activity – teaching, shops – by some Orma), and the pieces of evidence or “clues” that support the notion that the relationship between the outcome and the cause is causal.</p></li>
<li><p>We set up an imaginary study inspired by <span class="citation">Ensminger (<a href="references-4.html#ref-ensminger1990" role="doc-biblioref">1990</a>)</span></p></li>
<li><p>The researcher seeks to test the claim that economic diversification leads to the breakdown of informal institutions. They look for a group in Kenya that has experienced diversification and whose institutions of managing the commons have failed. [think of cool empirical implications]. They want to test this claim against the idea that informal institutions failed due to a deliberate attempt by state authorities to supplant traditional leaders.</p></li>
<li><p>Their answer strategy diverges from the one in the book insofar as they seek not one but two clues to test their prior explanation.</p></li>
<li><p>This time the researcher needs to think not only about the typology of their clues in terms of Van Evera stuff, but also the joint probability distribution of the clues.</p></li>
<li><p>We make use of the <code>joint_prob</code> function from the book R package, which calculates the joint probability distribution of two correlated events, given their marginal probabilities and correlation</p></li>
<li><p>Researcher imposes monotonicity (no <code>Z_caused_not_Y</code> types) – economic diversity either
has no or a negative effect on institutions</p></li>
<li><p>Note: no variation in outcome. All informal institutions have declined, we just want to
know if economic diversification caused it. A quant study would provide no leverage.</p></li>
<li><p>Note: joint probabilities of observing clues depend only on type, not (as before) on type and Z</p></li>
</ul>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Z_caused_Y'</span>, <span class="st">'Z_caused_not_Y'</span>, <span class="st">'always_Y'</span>, <span class="st">'always_not_Y'</span><span class="op">)</span>




<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">20</span>,
                     Z <span class="op">=</span> <span class="fu">draw_binary</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">.5</span>, N <span class="op">=</span> <span class="va">N</span><span class="op">)</span>,
                     type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">types</span>, size <span class="op">=</span> <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">0</span>, <span class="fl">.5</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Z_caused_Y"</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Z</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Z_caused_not_Y"</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"always_Y"</span><span class="op">)</span>,
    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, type <span class="op">=</span> <span class="va">types</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">pr_C1C2_00</span> <span class="op">~</span> <span class="op">(</span><span class="fu">joint_prob</span><span class="op">(</span><span class="fl">.75</span>,<span class="fl">.3</span>,<span class="fl">0</span>,<span class="st">"00"</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Z_caused_Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">joint_prob</span><span class="op">(</span><span class="fl">.25</span>,<span class="fl">.005</span>,<span class="fl">0</span>,<span class="st">"00"</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"always_Y"</span><span class="op">)</span><span class="op">)</span>,
    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, type <span class="op">=</span> <span class="va">types</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">pr_C1C2_01</span> <span class="op">~</span> <span class="op">(</span><span class="fu">joint_prob</span><span class="op">(</span><span class="fl">.75</span>,<span class="fl">.3</span>,<span class="fl">0</span>,<span class="st">"01"</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Z_caused_Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">joint_prob</span><span class="op">(</span><span class="fl">.25</span>,<span class="fl">.005</span>,<span class="fl">0</span>,<span class="st">"01"</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"always_Y"</span><span class="op">)</span><span class="op">)</span>,
    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, type <span class="op">=</span> <span class="va">types</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">pr_C1C2_10</span> <span class="op">~</span> <span class="op">(</span><span class="fu">joint_prob</span><span class="op">(</span><span class="fl">.75</span>,<span class="fl">.3</span>,<span class="fl">0</span>,<span class="st">"10"</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Z_caused_Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">joint_prob</span><span class="op">(</span><span class="fl">.25</span>,<span class="fl">.005</span>,<span class="fl">0</span>,<span class="st">"10"</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"always_Y"</span><span class="op">)</span><span class="op">)</span>,
    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, type <span class="op">=</span> <span class="va">types</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">pr_C1C2_11</span> <span class="op">~</span> <span class="op">(</span><span class="fu">joint_prob</span><span class="op">(</span><span class="fl">.75</span>,<span class="fl">.3</span>,<span class="fl">0</span>,<span class="st">"11"</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Z_caused_Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">joint_prob</span><span class="op">(</span><span class="fl">.25</span>,<span class="fl">.005</span>,<span class="fl">0</span>,<span class="st">"11"</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"always_Y"</span><span class="op">)</span><span class="op">)</span>,
    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, type <span class="op">=</span> <span class="va">types</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">pr_C1C2_00</span>,<span class="va">pr_C1C2_01</span>,<span class="va">pr_C1C2_10</span>,<span class="va">pr_C1C2_11</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>blocks <span class="op">=</span> <span class="va">ID</span>, block_prob_each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">pr_C1C2_00</span>,<span class="va">pr_C1C2_01</span>,<span class="va">pr_C1C2_10</span>,<span class="va">pr_C1C2_11</span><span class="op">)</span>,
                     conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"00"</span>,<span class="st">"01"</span>,<span class="st">"10"</span>,<span class="st">"11"</span><span class="op">)</span>, 
                     assignment_variable <span class="op">=</span> <span class="st">"C1C2"</span><span class="op">)</span> <span class="op">+</span>  
  <span class="fu">declare_sampling</span><span class="op">(</span>handler <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Z</span><span class="op">==</span><span class="fl">1</span> <span class="op">&amp;</span> <span class="va">Y</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">sample_n</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>did_Z_cause_Y <span class="op">=</span> <span class="va">type</span> <span class="op">==</span> <span class="st">'Z_caused_Y'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_measurement</span><span class="op">(</span>
  C1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">C1C2</span> <span class="op">==</span> <span class="st">"10"</span> <span class="op">|</span> <span class="va">C1C2</span> <span class="op">==</span> <span class="st">"11"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
  C2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">C1C2</span> <span class="op">==</span> <span class="st">"01"</span> <span class="op">|</span> <span class="va">C1C2</span> <span class="op">==</span> <span class="st">"11"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
  handler <span class="op">=</span> <span class="va">fabricate</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    pr_type_Z_caused_Y <span class="op">=</span> <span class="fl">.5</span>,
    pr_C_1_type_Z_caused_Y <span class="op">=</span> <span class="fl">.75</span>,
    pr_C_1_type_always_Y <span class="op">=</span> <span class="fl">.25</span>,
    C <span class="op">=</span> <span class="va">C1</span>,
    pr_C_type_Z_caused_Y <span class="op">=</span> <span class="va">C</span> <span class="op">*</span> <span class="va">pr_C_1_type_Z_caused_Y</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">C</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_C_1_type_Z_caused_Y</span><span class="op">)</span>,
    pr_C_type_always_Y <span class="op">=</span> <span class="va">C</span> <span class="op">*</span> <span class="va">pr_C_1_type_always_Y</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">C</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_C_1_type_always_Y</span><span class="op">)</span>,
    posterior <span class="op">=</span>
      <span class="va">pr_type_Z_caused_Y</span> <span class="op">*</span> <span class="va">pr_C_type_Z_caused_Y</span> <span class="op">/</span> <span class="op">(</span><span class="va">pr_type_Z_caused_Y</span> <span class="op">*</span> <span class="va">pr_C_type_Z_caused_Y</span> <span class="op">+</span> <span class="va">pr_C_type_always_Y</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_type_Z_caused_Y</span><span class="op">)</span><span class="op">)</span>,
    label <span class="op">=</span> <span class="st">"Straw in the Wind"</span>,
    estimand_label <span class="op">=</span> <span class="st">"did_Z_cause_Y"</span>,
    handler <span class="op">=</span> <span class="va">summarize</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    pr_type_Z_caused_Y <span class="op">=</span> <span class="fl">.5</span>,
    pr_C_1_type_Z_caused_Y <span class="op">=</span> <span class="fl">.30</span>,
    pr_C_1_type_always_Y <span class="op">=</span> <span class="fl">.005</span>,
    C <span class="op">=</span> <span class="va">C2</span>,
    pr_C_type_Z_caused_Y <span class="op">=</span> <span class="va">C</span> <span class="op">*</span> <span class="va">pr_C_1_type_Z_caused_Y</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">C</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_C_1_type_Z_caused_Y</span><span class="op">)</span>,
    pr_C_type_always_Y <span class="op">=</span> <span class="va">C</span> <span class="op">*</span> <span class="va">pr_C_1_type_always_Y</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">C</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_C_1_type_always_Y</span><span class="op">)</span>,
    posterior <span class="op">=</span>
      <span class="va">pr_type_Z_caused_Y</span> <span class="op">*</span> <span class="va">pr_C_type_Z_caused_Y</span> <span class="op">/</span> <span class="op">(</span><span class="va">pr_type_Z_caused_Y</span> <span class="op">*</span> <span class="va">pr_C_type_Z_caused_Y</span> <span class="op">+</span> <span class="va">pr_C_type_always_Y</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_type_Z_caused_Y</span><span class="op">)</span><span class="op">)</span>,
    label <span class="op">=</span> <span class="st">"Smoking Gun"</span>,
    estimand_label <span class="op">=</span> <span class="st">"did_Z_cause_Y"</span>,
    handler <span class="op">=</span> <span class="va">summarize</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    pr_type_Z_caused_Y <span class="op">=</span> <span class="fl">.5</span>,
    pr_C1_1_type_Z_caused_Y <span class="op">=</span> <span class="fl">.30</span>,
    pr_C1_1_type_always_Y <span class="op">=</span> <span class="fl">.005</span>,
    pr_C2_1_type_Z_caused_Y <span class="op">=</span> <span class="fl">.75</span>,
    pr_C2_1_type_always_Y <span class="op">=</span> <span class="fl">.25</span>,
    rho <span class="op">=</span> <span class="fl">0</span>,
    pr_C_type_Z_caused_Y <span class="op">=</span> <span class="fu">joint_prob</span><span class="op">(</span><span class="va">pr_C1_1_type_Z_caused_Y</span>, <span class="va">pr_C2_1_type_Z_caused_Y</span>, 
                                      <span class="va">rho</span>, which_prob <span class="op">=</span> <span class="va">C1C2</span><span class="op">)</span>,
    pr_C_type_always_Y <span class="op">=</span> <span class="fu">joint_prob</span><span class="op">(</span><span class="va">pr_C1_1_type_always_Y</span>, <span class="va">pr_C2_1_type_always_Y</span>, 
                                      <span class="va">rho</span>, which_prob <span class="op">=</span> <span class="va">C1C2</span><span class="op">)</span>,
    posterior <span class="op">=</span>
      <span class="va">pr_type_Z_caused_Y</span> <span class="op">*</span> <span class="va">pr_C_type_Z_caused_Y</span> <span class="op">/</span> <span class="op">(</span><span class="va">pr_type_Z_caused_Y</span> <span class="op">*</span> <span class="va">pr_C_type_Z_caused_Y</span> <span class="op">+</span> <span class="va">pr_C_type_always_Y</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">pr_type_Z_caused_Y</span><span class="op">)</span><span class="op">)</span>,
    label <span class="op">=</span> <span class="st">"Joint Updating"</span>,
    estimand_label <span class="op">=</span> <span class="st">"did_Z_cause_Y"</span>,
    handler <span class="op">=</span> <span class="va">summarize</span><span class="op">)</span> 


<span class="co"># diagnose_design(design,</span>
<span class="co">#                 diagnosands = declare_diagnosands(</span>
<span class="co">#                   bias = mean(posterior - estimand),</span>
<span class="co">#                   rmse = sqrt(mean((posterior - estimand) ^ 2)),</span>
<span class="co">#                   mean_estimand = mean(estimand),</span>
<span class="co">#                   mean_posterior = mean(posterior),</span>
<span class="co">#                   keep_defaults = FALSE), </span>
<span class="co">#                 sims = 500)</span>

<span class="co"># design_sims &lt;- simulate_design(design, sims = 500)</span></code></pre></div>
</div>
<div id="dag-13" class="section level3">
<h3>
<span class="header-section-number">16.6.5</span> Dag<a class="anchor" aria-label="anchor" href="#dag-13"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dag</span> <span class="op">&lt;-</span> <span class="fu">dagify</span><span class="op">(</span><span class="va">C1</span> <span class="op">~</span> <span class="va">type</span>,
              <span class="va">C2</span> <span class="op">~</span> <span class="va">type</span>,
              <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">type</span><span class="op">)</span>


<span class="va">nodes</span> <span class="op">&lt;-</span>
  <span class="fu">tibble</span><span class="op">(</span>
    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">"type"</span>,<span class="st">"Z"</span>,<span class="st">"C1"</span>, <span class="st">"C2"</span>, <span class="st">"Y"</span><span class="op">)</span>,
    label <span class="op">=</span> <span class="va">name</span>,
    annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"**Type**&lt;br&gt;Causal relationship&lt;br&gt;between economic diversification&lt;br&gt;and breakdown of institutions"</span>,
      <span class="st">"**Cause**&lt;br&gt;Economic Diversification"</span>,
      <span class="st">"**Clue 1**&lt;br&gt;Smoking gun interview evidence"</span>,
      <span class="st">"**Clue 2**&lt;br&gt;Straw-in-the-wind archival evidence"</span>,
      <span class="st">"**Outcome**&lt;br&gt;Breakdown of traditional&lt;br&gt;institutions"</span><span class="op">)</span>,
    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,
    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">3.5</span>,<span class="fl">2</span>,<span class="fl">1.5</span>,<span class="fl">3.5</span><span class="op">)</span>,
    nudge_direction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"N"</span>, <span class="st">"N"</span>, <span class="st">"S"</span>,<span class="st">"N"</span><span class="op">)</span>,
    answer_strategy <span class="op">=</span> <span class="st">"uncontrolled"</span>
  <span class="op">)</span>


<span class="va">ggdd_df</span> <span class="op">&lt;-</span> <span class="fu">make_dag_df</span><span class="op">(</span><span class="va">dag</span>, <span class="va">nodes</span>, <span class="va">design</span><span class="op">)</span>

<span class="va">base_dag_plot</span> <span class="op">%+%</span> <span class="va">ggdd_df</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-287-1.svg" width="100%"></div>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
<div id="synthetic-controls" class="section level2">
<h2>
<span class="header-section-number">16.7</span> Synthetic controls<a class="anchor" aria-label="anchor" href="#synthetic-controls"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-15" class="section level3">
<h3>
<span class="header-section-number">16.7.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-15"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>
    unit <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">10</span>, units <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span>, X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,
    period <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">3</span>, time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span>, nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
    unit_period <span class="op">=</span> <span class="fu">cross_levels</span><span class="op">(</span>by <span class="op">=</span> <span class="fu">join</span><span class="op">(</span><span class="va">unit</span>, <span class="va">period</span><span class="op">)</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span>, subset <span class="op">=</span> <span class="va">period</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_step</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">mutate</span>, Z <span class="op">=</span> <span class="va">unit</span> <span class="op">==</span> <span class="st">"01"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_reveal</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="va">period</span> <span class="op">&lt;</span> <span class="fl">3</span>, <span class="va">Y_Z_0</span>, <span class="va">Y_Z_1</span><span class="op">)</span>, handler <span class="op">=</span> <span class="va">mutate</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_step</span><span class="op">(</span>predictors <span class="op">=</span> <span class="st">"X"</span>,
               time.predictors.prior <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,
               dependent <span class="op">=</span> <span class="st">"Y"</span>,
               unit.variable <span class="op">=</span> <span class="st">"units"</span>,
               time.variable <span class="op">=</span> <span class="st">"time"</span>,
               treatment.identifier <span class="op">=</span> <span class="fl">1</span>,
               controls.identifier <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">10</span>, 
               handler <span class="op">=</span> <span class="va">synth_weights_tidy</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, subset <span class="op">=</span> <span class="va">time</span> <span class="op">&gt;=</span> <span class="fl">3</span>, weights <span class="op">=</span> <span class="va">synth_weights</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, label <span class="op">=</span> <span class="st">"synth"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag-14" class="section level3">
<h3>
<span class="header-section-number">16.7.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-14"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Simulation --------------------------------------------------------------</span>

<span class="co"># simulations &lt;- simulate_design(design, sims = 100)</span>
<span class="co"># ggplot(simulations, aes(estimate)) + geom_histogram()</span>


<span class="co"># Synth plot --------------------------------------------------------------</span>

<span class="co"># data &lt;- draw_data(design)</span>
<span class="co"># summary_df &lt;- data %&gt;%</span>
<span class="co">#   group_by(Z, time) %&gt;%</span>
<span class="co">#   summarize(Y = weighted.mean(Y, w = synth_weights))</span>
<span class="co"># ggplot(summary_df, aes(x = time, y = Y, color = Z)) +</span>
<span class="co">#   geom_line(size = 2, alpha = 0.5) +</span>
<span class="co">#   geom_line(data = data, aes(x = time, y = Y, group = units), color = "black", alpha = 0.3) +</span>
<span class="co">#   geom_point(data = data, aes(x = time, y = Y, size = synth_weights^2), alpha = 0.3) +</span>
<span class="co">#   geom_vline(xintercept = 2.5)</span>

<span class="va">dag</span> <span class="op">&lt;-</span> <span class="fu">dagify</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">period</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span>,
              <span class="va">Z</span> <span class="op">~</span> <span class="va">X</span><span class="op">)</span>

<span class="va">nodes</span> <span class="op">&lt;-</span>
  <span class="fu">tibble</span><span class="op">(</span>
    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"U"</span>, <span class="st">"X"</span>, <span class="st">"period"</span>, <span class="st">"Z"</span>, <span class="st">"Y"</span><span class="op">)</span>,
    label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"U"</span>, <span class="st">"X"</span>, <span class="st">"T"</span>, <span class="st">"Z"</span>, <span class="st">"Y"</span><span class="op">)</span>,
    annotation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"**Unknown heterogeneity**"</span>,
      <span class="st">"**Unit effect**"</span>,
      <span class="st">"**Time period**"</span>,
      <span class="st">"**Treatment assignment**"</span>,
      <span class="st">"**Outcome variable**"</span>
    <span class="op">)</span>,
    
    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>,
    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">3.5</span>, <span class="fl">1</span>, <span class="fl">2.5</span>, <span class="fl">2.5</span><span class="op">)</span>, 
    nudge_direction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"N"</span>, <span class="st">"S"</span>, <span class="st">"S"</span>,<span class="st">"N"</span><span class="op">)</span>,
    answer_strategy <span class="op">=</span> <span class="st">"uncontrolled"</span><span class="op">)</span>
    
    

<span class="va">ggdd_df</span> <span class="op">&lt;-</span> <span class="fu">make_dag_df</span><span class="op">(</span><span class="va">dag</span>, <span class="va">nodes</span>, <span class="va">design</span><span class="op">)</span>

<span class="va">base_dag_plot</span> <span class="op">%+%</span> <span class="va">ggdd_df</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-294-1.svg" width="100%"></div>
</div>
<div id="example-15" class="section level3">
<h3>
<span class="header-section-number">16.7.3</span> Example<a class="anchor" aria-label="anchor" href="#example-15"><i class="fas fa-link"></i></a>
</h3>
<!-- make sure to rename the section title below -->
<p>Modeled after the example here:</p>
<p><a href="https://www.mitpressjournals.org/doi/abs/10.1162/REST_a_00429?casa_token=o-zWqCima50AAAAA:yiEERZfdhAUoHV0-xBYNjgdljvgfRXrriR8foG7X8nHSUAMFrLcw2vWY8e9pHzmRT24MMAIv9hvKpQ" class="uri">https://www.mitpressjournals.org/doi/abs/10.1162/REST_a_00429?casa_token=o-zWqCima50AAAAA:yiEERZfdhAUoHV0-xBYNjgdljvgfRXrriR8foG7X8nHSUAMFrLcw2vWY8e9pHzmRT24MMAIv9hvKpQ</a></p>
<p>Did the 2007 Legal Arizona Workers Act Reduce the State’s Unauthorized Immigrant Population?
Sarah Bohn, Magnus Lofstrom, and Steven Raphael
The Review of Economics and Statistics 2014 96:2, 258-269
Abstract: We test for an effect of Arizona’s 2007 Legal Arizona Workers Act (LAWA) on the proportion of the state’s population characterized as noncitizen Hispanic. We use the synthetic control method to select a group of states against which Arizona’s population trends can be compared. We document a notable and statistically significant reduction in the proportion of the Hispanic noncitizen population in Arizona. The decline observed matches the timing of LAWA’s implementation, deviates from the time series for the synthetic control group, and stands out relative to the distribution of placebo estimates for other states in the nation.</p>
<p>Outline:
(1) how does synth work?
- declaration: set up states with time trends and levels that are both correlated with a type and following the linear model assumed by SCM
- try three estimators: (1) difference-in-difference; (2) single difference in treated period; and (3) difference in treated period weighted by Synth weights.
- show that synth works under its assumptions; plot of time series of treat and synthetic control; plot of the time series from all units to illustrate which are picked (sorted by weights)
(2) what are synth’s assumptions?
- linear model; treated unit is in convex hull of control units’ pretreatment time series
(3) how to diagnose when you are outside the convex hull
- declaration outside the convex hull and use the Abadie diagnostic demonstrating a poor match. (possibly explore power of this diagnostic)
- show that synth is biased in this setting. augsynth is not.</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># tidy function that takes data and just adds the synthetic control weights to it</span>
<span class="va">synth_weights_tidy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">dataprep.out</span> <span class="op">&lt;-</span> <span class="fu">dataprep</span><span class="op">(</span>
    foo <span class="op">=</span> <span class="va">data</span>,
    predictors <span class="op">=</span> <span class="st">"prop_non_hispanic_below_hs"</span>,
    predictors.op <span class="op">=</span> <span class="st">"mean"</span>,
    time.predictors.prior <span class="op">=</span> <span class="fl">1998</span><span class="op">:</span><span class="fl">2006</span>,
    dependent <span class="op">=</span> <span class="st">"prop_non_hispanic_below_hs"</span>,
    unit.variable <span class="op">=</span> <span class="st">"state_number"</span>,
    time.variable <span class="op">=</span> <span class="st">"year"</span>,
    treatment.identifier <span class="op">=</span> <span class="fl">4</span>,
    controls.identifier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">5</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span>, <span class="co"># states without Arizona</span>
    time.optimize.ssr <span class="op">=</span> <span class="fl">1998</span><span class="op">:</span><span class="fl">2006</span>,
    time.plot <span class="op">=</span> <span class="fl">1998</span><span class="op">:</span><span class="fl">2009</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">synth</span><span class="op">(</span>data.prep.obj <span class="op">=</span> <span class="va">dataprep.out</span><span class="op">)</span><span class="op">)</span>
  <span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu">synth.tab</span><span class="op">(</span>dataprep.res <span class="op">=</span> <span class="va">dataprep.out</span>, synth.res <span class="op">=</span> <span class="va">fit</span><span class="op">)</span> 
  
  <span class="va">data</span> <span class="op">%&gt;%</span> 
    <span class="fu">left_join</span><span class="op">(</span><span class="va">tab</span><span class="op">$</span><span class="va">tab.w</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>synth_weights <span class="op">=</span> <span class="va">w.weights</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">synth_weights</span>, <span class="va">unit.numbers</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state_number"</span> <span class="op">=</span> <span class="st">"unit.numbers"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">mutate</span><span class="op">(</span>synth_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="va">synth_weights</span>, <span class="va">state_number</span> <span class="op">==</span> <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">augsynth_tidy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">augsynth</span><span class="op">(</span><span class="va">prop_non_hispanic_below_hs</span> <span class="op">~</span> <span class="va">legal_worker_act</span>, <span class="va">state</span>, <span class="va">year</span>, t_int <span class="op">=</span> <span class="fl">2007</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">$</span><span class="va">att</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Time</span> <span class="op">==</span> <span class="fl">2007</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">Estimate</span>, <span class="va">Std.Error</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"std.error"</span><span class="op">)</span>
  <span class="va">res</span><span class="op">$</span><span class="va">p.value</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">pt</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">estimate</span><span class="op">/</span><span class="va">res</span><span class="op">$</span><span class="va">std.error</span><span class="op">)</span>, df <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">-</span> <span class="fl">15</span><span class="op">)</span>
  <span class="va">res</span><span class="op">$</span><span class="va">conf.low</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">estimate</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">res</span><span class="op">$</span><span class="va">std.error</span>
  <span class="va">res</span><span class="op">$</span><span class="va">conf.high</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">estimate</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">res</span><span class="op">$</span><span class="va">std.error</span>
  <span class="va">res</span>
<span class="op">}</span>

<span class="co"># note need to clean up the range of the data, currently over 1</span>
<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    states <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>
      N <span class="op">=</span> <span class="fl">50</span>, 
      state <span class="op">=</span> <span class="va">state.abb</span>,
      state_number <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span>,
      state_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="op">-</span><span class="fl">.15</span>, <span class="fl">.15</span><span class="op">)</span>,
      border_state <span class="op">=</span> <span class="va">state</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AZ"</span>, <span class="st">"CA"</span>, <span class="st">"NM"</span>, <span class="st">"TX"</span><span class="op">)</span>,
      state_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">border_state</span>, <span class="fl">.2</span>, <span class="va">state_shock</span><span class="op">)</span>
    <span class="op">)</span>,
    years <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>
      N <span class="op">=</span> <span class="fl">12</span>, nest <span class="op">=</span> <span class="cn">FALSE</span>,
      year <span class="op">=</span> <span class="fl">1998</span><span class="op">:</span><span class="fl">2009</span>,
      post_treatment_period <span class="op">=</span> <span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">2007</span>,
      year_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="op">-</span><span class="fl">.025</span>, <span class="fl">.025</span><span class="op">)</span>, 
      year_trend <span class="op">=</span> <span class="va">year</span> <span class="op">-</span> <span class="fl">1998</span>
    <span class="op">)</span>,
    obs <span class="op">=</span> <span class="fu">cross_levels</span><span class="op">(</span>
      by <span class="op">=</span> <span class="fu">join</span><span class="op">(</span><span class="va">states</span>, <span class="va">years</span><span class="op">)</span>,
      <span class="co"># treatment indicator:</span>
      legal_worker_act <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">post_treatment_period</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">&amp;</span> <span class="va">state</span> <span class="op">==</span> <span class="st">"AZ"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
      state_year_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="op">-</span><span class="fl">.025</span>, <span class="fl">.025</span><span class="op">)</span>,
      prop_non_hispanic_below_hs_baseline <span class="op">=</span> 
        <span class="fl">0.4</span> <span class="op">+</span> <span class="va">state_shock</span> <span class="op">+</span> <span class="va">year_shock</span> <span class="op">+</span> <span class="op">(</span><span class="fl">.01</span> <span class="op">+</span> <span class="fl">.05</span> <span class="op">*</span> <span class="va">border_state</span><span class="op">)</span> <span class="op">*</span> <span class="va">year_trend</span> <span class="op">+</span> <span class="va">state_year_shock</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">prop_non_hispanic_below_hs</span> <span class="op">~</span> <span class="va">prop_non_hispanic_below_hs_baseline</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">legal_worker_act</span>, 
    assignment_variable <span class="op">=</span> <span class="va">legal_worker_act</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>
    ATE_AZ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">prop_non_hispanic_below_hs_legal_worker_act_1</span> <span class="op">-</span> 
                    <span class="va">prop_non_hispanic_below_hs_legal_worker_act_0</span><span class="op">)</span>, 
    subset <span class="op">=</span> <span class="va">legal_worker_act</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">prop_non_hispanic_below_hs</span>, <span class="va">legal_worker_act</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_step</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">synth_weights_tidy</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    <span class="va">prop_non_hispanic_below_hs</span> <span class="op">~</span> <span class="va">legal_worker_act</span>, 
    subset <span class="op">=</span> <span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">2007</span>, weights <span class="op">=</span> <span class="va">synth_weights</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, label <span class="op">=</span> <span class="st">"synth"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    <span class="va">prop_non_hispanic_below_hs</span> <span class="op">~</span> <span class="va">legal_worker_act</span>, subset <span class="op">=</span> <span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">2007</span>, 
    model <span class="op">=</span> <span class="va">lm_robust</span>, label <span class="op">=</span> <span class="st">"unweighted"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    <span class="va">prop_non_hispanic_below_hs</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"AZ"</span><span class="op">)</span> <span class="op">+</span> <span class="va">post_treatment_period</span> <span class="op">+</span> <span class="va">legal_worker_act</span>, term <span class="op">=</span> <span class="st">"legal_worker_act"</span>, 
    model <span class="op">=</span> <span class="va">lm_robust</span>, label <span class="op">=</span> <span class="st">"unweighted_did"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>handler <span class="op">=</span> <span class="fu">tidy_estimator</span><span class="op">(</span><span class="va">augsynth_tidy</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"augsynth"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">state_data</span> <span class="op">&lt;-</span> <span class="fu">draw_data</span><span class="op">(</span><span class="va">design</span><span class="op">)</span>

<span class="va">state_data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">synth_weights</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">distinct</span> <span class="op">%&gt;%</span> <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">synth_weights</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span></code></pre></div>
<pre><code>##   state synth_weights
## 1    AZ         1.000
## 2    NM         0.990
## 3    TX         0.007
## 4    CA         0.001
## 5    AL         0.000
## 6    AK         0.000</code></pre>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">state_data</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">year</span>, <span class="va">prop_non_hispanic_below_hs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">state</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-297-1.svg" width="100%"></div>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">state_data</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>treatment_state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"AZ"</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Synthethic Control"</span>, <span class="st">"Arizona"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">treatment_state</span>, <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>prop_non_hispanic_below_hs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">prop_non_hispanic_below_hs</span>, w <span class="op">=</span> <span class="va">synth_weights</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">prop_non_hispanic_below_hs</span>, color <span class="op">=</span> <span class="va">treatment_state</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">2007</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/breaks_pretty.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">2006.7</span>, y <span class="op">=</span> <span class="fl">1.7</span>, label <span class="op">=</span> <span class="st">"Law Introduced in 2007"</span>, hjust <span class="op">=</span> <span class="st">"right"</span>, family <span class="op">=</span> <span class="st">"Palatino"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"Proportion Non-Hispanic Below H.S. Education"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">dd_theme</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-298-1.svg" width="100%"></div>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">design</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span></code></pre></div>
<p>Now all that simulating, saving, and loading is done, and we can use the simulations for whatever you want.</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">synth_diagnosands</span> <span class="op">&lt;-</span> <span class="fu">declare_diagnosands</span><span class="op">(</span>select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bias"</span>, <span class="st">"rmse"</span>, <span class="st">"coverage"</span><span class="op">)</span><span class="op">)</span>

<span class="va">diagnosis</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">simulations</span>, diagnosands <span class="op">=</span> <span class="va">synth_diagnosands</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span>

<span class="fu">kable</span><span class="op">(</span><span class="fu">reshape_diagnosis</span><span class="op">(</span><span class="va">diagnosis</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
Design Label
</th>
<th style="text-align:left;">
Estimand Label
</th>
<th style="text-align:left;">
Estimator Label
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
N Sims
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Coverage
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_AZ
</td>
<td style="text-align:left;">
augsynth
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
1000
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.66
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.01)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_AZ
</td>
<td style="text-align:left;">
synth
</td>
<td style="text-align:left;">
legal_worker_act
</td>
<td style="text-align:left;">
1000
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_AZ
</td>
<td style="text-align:left;">
unweighted
</td>
<td style="text-align:left;">
legal_worker_act
</td>
<td style="text-align:left;">
1000
</td>
<td style="text-align:left;">
0.66
</td>
<td style="text-align:left;">
0.66
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_AZ
</td>
<td style="text-align:left;">
unweighted_did
</td>
<td style="text-align:left;">
legal_worker_act
</td>
<td style="text-align:left;">
1000
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
</tbody>
</table></div>
<ul>
<li>we see that Synth outperforms either method</li>
</ul>
</div>
<div id="when-there-are-not-good-controls-standard-synth-will-get-the-wrong-answer" class="section level3">
<h3>
<span class="header-section-number">16.7.4</span> When there are not good controls, standard synth will get the wrong answer<a class="anchor" aria-label="anchor" href="#when-there-are-not-good-controls-standard-synth-will-get-the-wrong-answer"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># declaration outside the convex hull</span>
<span class="va">design_outside_hull</span> <span class="op">&lt;-</span> <span class="fu">replace_step</span><span class="op">(</span>
  <span class="va">design</span>, 
  step <span class="op">=</span> <span class="fl">2</span>, 
  new_step <span class="op">=</span> <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">prop_non_hispanic_below_hs</span> <span class="op">~</span> <span class="va">prop_non_hispanic_below_hs_baseline</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">legal_worker_act</span> <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"AZ"</span><span class="op">)</span>, 
    assignment_variable <span class="op">=</span> <span class="va">legal_worker_act</span><span class="op">)</span><span class="op">)</span>

<span class="va">state_data_outside_hull</span> <span class="op">&lt;-</span> <span class="fu">draw_data</span><span class="op">(</span><span class="va">design_outside_hull</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simulations_outside_hull</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">design_outside_hull</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span></code></pre></div>
<p>Now all that simulating, saving, and loading is done, and we can use the simulations for whatever you want.</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diagnosis_outside_hull</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">simulations_outside_hull</span>, diagnosands <span class="op">=</span> <span class="va">synth_diagnosands</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span>

<span class="fu">kable</span><span class="op">(</span><span class="fu">reshape_diagnosis</span><span class="op">(</span><span class="va">diagnosis_outside_hull</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
Design Label
</th>
<th style="text-align:left;">
Estimand Label
</th>
<th style="text-align:left;">
Estimator Label
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
N Sims
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Coverage
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
design_outside_hull
</td>
<td style="text-align:left;">
ATE_AZ
</td>
<td style="text-align:left;">
augsynth
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
1000
</td>
<td style="text-align:left;">
-0.01
</td>
<td style="text-align:left;">
0.03
</td>
<td style="text-align:left;">
0.75
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.01)
</td>
</tr>
<tr>
<td style="text-align:left;">
design_outside_hull
</td>
<td style="text-align:left;">
ATE_AZ
</td>
<td style="text-align:left;">
synth
</td>
<td style="text-align:left;">
legal_worker_act
</td>
<td style="text-align:left;">
1000
</td>
<td style="text-align:left;">
0.20
</td>
<td style="text-align:left;">
0.20
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design_outside_hull
</td>
<td style="text-align:left;">
ATE_AZ
</td>
<td style="text-align:left;">
unweighted
</td>
<td style="text-align:left;">
legal_worker_act
</td>
<td style="text-align:left;">
1000
</td>
<td style="text-align:left;">
0.86
</td>
<td style="text-align:left;">
0.86
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design_outside_hull
</td>
<td style="text-align:left;">
ATE_AZ
</td>
<td style="text-align:left;">
unweighted_did
</td>
<td style="text-align:left;">
legal_worker_act
</td>
<td style="text-align:left;">
1000
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the synthetic control constructed in this way (it usually picks just texas and is highly biased)</span>
<span class="va">state_data_outside_hull</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>treatment_state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"AZ"</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Synthethic Control"</span>, <span class="st">"Arizona"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">treatment_state</span>, <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>prop_non_hispanic_below_hs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">prop_non_hispanic_below_hs</span>, w <span class="op">=</span> <span class="va">synth_weights</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">prop_non_hispanic_below_hs</span>, color <span class="op">=</span> <span class="va">treatment_state</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">2007</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org//reference/breaks_pretty.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">2006.7</span>, y <span class="op">=</span> <span class="fl">1.7</span>, label <span class="op">=</span> <span class="st">"Law Introduced in 2007"</span>, hjust <span class="op">=</span> <span class="st">"right"</span>, family <span class="op">=</span> <span class="st">"Palatino"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"Proportion Non-Hispanic Below H.S. Education"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">dd_theme</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-306-1.svg" width="100%"></div>
</div>
<div id="references-1" class="section level3">
<h3>
<span class="header-section-number">16.7.5</span> References<a class="anchor" aria-label="anchor" href="#references-1"><i class="fas fa-link"></i></a>
</h3>

</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="experimental-designs-for-descriptive-inference.html"><span class="header-section-number">15</span> Experimental designs for descriptive inference</a></div>
<div class="next"><a href="experimental-designs-for-causal-inference.html"><span class="header-section-number">17</span> Experimental designs for causal inference</a></div>
</div></main><div id="on-this-page-nav" class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#observational-designs-for-causal-inference"><span class="header-section-number">16</span> Observational designs for causal inference</a></li>
<li>
<a class="nav-link" href="#selection-on-observables"><span class="header-section-number">16.1</span> Selection on observables</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-10"><span class="header-section-number">16.1.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-8"><span class="header-section-number">16.1.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-11"><span class="header-section-number">16.1.3</span> Example</a></li>
<li><a class="nav-link" href="#classic-confounding"><span class="header-section-number">16.1.4</span> Classic Confounding</a></li>
<li><a class="nav-link" href="#what-if-the-functional-form-is-wrong"><span class="header-section-number">16.1.5</span> What if the functional form is wrong?</a></li>
<li><a class="nav-link" href="#what-if-you-have-unobserved-confounding"><span class="header-section-number">16.1.6</span> What if you have unobserved confounding?</a></li>
<li><a class="nav-link" href="#what-if-the-observed-covariate-is-post-treatment"><span class="header-section-number">16.1.7</span> What if the observed covariate is post-treatment?</a></li>
</ul>
</li>
<li><a class="nav-link" href="#further-reading-6"><span class="header-section-number">16.2</span> Further reading</a></li>
<li>
<a class="nav-link" href="#p3iv"><span class="header-section-number">16.3</span> Instrumental variables</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-11"><span class="header-section-number">16.3.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-9"><span class="header-section-number">16.3.2</span> Dag</a></li>
<li><a class="nav-link" href="#redesign-2"><span class="header-section-number">16.3.3</span> Redesign</a></li>
<li><a class="nav-link" href="#suggested-readings"><span class="header-section-number">16.3.4</span> Suggested readings</a></li>
<li><a class="nav-link" href="#example-12"><span class="header-section-number">16.3.5</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#difference-in-differences"><span class="header-section-number">16.4</span> Difference-in-differences</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-12"><span class="header-section-number">16.4.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-10"><span class="header-section-number">16.4.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-13"><span class="header-section-number">16.4.3</span> Example</a></li>
<li><a class="nav-link" href="#two-period-two-group-setting"><span class="header-section-number">16.4.4</span> Two-period two-group setting</a></li>
<li><a class="nav-link" href="#parallel-trends-assumption"><span class="header-section-number">16.4.5</span> Parallel trends assumption</a></li>
<li><a class="nav-link" href="#multi-period-design"><span class="header-section-number">16.4.6</span> Multi-period design</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#RDD"><span class="header-section-number">16.5</span> Regression Discontinuity</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-13"><span class="header-section-number">16.5.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-11"><span class="header-section-number">16.5.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-14"><span class="header-section-number">16.5.3</span> Example</a></li>
<li><a class="nav-link" href="#design-declaration-3"><span class="header-section-number">16.5.4</span> Design Declaration</a></li>
<li><a class="nav-link" href="#takeaways-3"><span class="header-section-number">16.5.5</span> Takeaways</a></li>
<li><a class="nav-link" href="#further-reading-7"><span class="header-section-number">16.5.6</span> Further Reading</a></li>
<li><a class="nav-link" href="#exercises-3"><span class="header-section-number">16.5.7</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#bayesianprocesstracing"><span class="header-section-number">16.6</span> Bayesian process-tracing</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-14"><span class="header-section-number">16.6.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-12"><span class="header-section-number">16.6.2</span> Dag</a></li>
<li><a class="nav-link" href="#exercises-4"><span class="header-section-number">16.6.3</span> Exercises</a></li>
<li><a class="nav-link" href="#online-appendix-applied-example"><span class="header-section-number">16.6.4</span> Online Appendix Applied Example</a></li>
<li><a class="nav-link" href="#dag-13"><span class="header-section-number">16.6.5</span> Dag</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#synthetic-controls"><span class="header-section-number">16.7</span> Synthetic controls</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-15"><span class="header-section-number">16.7.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-14"><span class="header-section-number">16.7.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-15"><span class="header-section-number">16.7.3</span> Example</a></li>
<li><a class="nav-link" href="#when-there-are-not-good-controls-standard-synth-will-get-the-wrong-answer"><span class="header-section-number">16.7.4</span> When there are not good controls, standard synth will get the wrong answer</a></li>
<li><a class="nav-link" href="#references-1"><span class="header-section-number">16.7.5</span> References</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Research Design: Declare, Diagnose, Redesign</strong>" was written by Graeme Blair, Jasper Cooper, Alexander Coppock, and Macartan Humphreys. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>Supported by the Laura and John Arnold Foundation and Evidence in Governance and Politics.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
