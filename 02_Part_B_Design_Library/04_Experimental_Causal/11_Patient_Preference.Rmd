---
title: "Patient preference trials"
output: html_document
bibliography: ../../bib/book.bib 
---

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # files are all relative to RStudio project home
```

```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
# load common packages, set ggplot ddtheme, etc.
source("scripts/before_chapter_script.R")
```

<!-- start post here, do not edit above -->

## Patient Preference Trials

<!-- make sure to rename the section title below -->

This design:

- takes as given we know how much "utility" a patient would derive from being treated and we've parameterized it from 0 to 1.
- We can either assign people to treatment, using this utility as the probability of assignment
- or we can assign with prob = 0.5
- the "slider" is a weighted average between those two approaches.
- The plot is supposed to show the precision / utility tradeoff.  the "expected total subject utility" is a diagnosand. The higher the utility, the worse the precision / power.
- I've shown it in "precision", but could do in power.

```{r section_title, echo = FALSE, output = FALSE, purl = FALSE}
# run the diagnosis (set to TRUE) on your computer for this section only before pushing to Github. no diagnosis will ever take place on github.
do_diagnosis <- FALSE
sims <- 100
b_sims <- 20
```

```{r}

slider <- 0

design <-
  
  # Model -------------------------------------------------------------------
  declare_population(
    N = 100,
    utility_from_treatment = runif(N),
    assignment_prob = 0.5 * slider + utility_from_treatment * (1 - slider),
    noise = rnorm(N)
  ) +
  declare_potential_outcomes(Y ~ 0.5 * Z+-0.2 * utility_from_treatment * Z + utility_from_treatment + noise) +
  
  # Inquiry -----------------------------------------------------------------
  declare_estimand(ATE = mean(Y_Z_1 - Y_Z_0)) +
  
  # Data Strategy -----------------------------------------------------------
  declare_assignment(
    prob = assignment_prob,
    simple = TRUE,
    assignment_variable = "Z"
  ) +
  declare_reveal(Y, Z) +
  
  # Answer Strategy ---------------------------------------------------------
  declare_estimator(
    handler = tidy_estimator(function(data) {
      with(data, data.frame(estimate = sum(utility_from_treatment * Z)))
    }),
    label = "total utility"
  ) +
  declare_estimator(
    Y ~ Z,
    model = lm_robust,
    weights = 1 / (assignment_prob * Z + (1 - assignment_prob) * (1 - Z)),
    label = "IPW"
  )
```

```{r, eval = do_diagnosis & !exists("do_bookdown")}
designs <- redesign(design, slider = seq(0, 1, length.out = 5))
simulations <- simulate_designs(designs, sims = sims)
```


```{r, echo = FALSE, purl = FALSE}
# figure out where the dropbox path is, create the directory if it doesn't exist, and name the RDS file
rds_file_path <- paste0(get_dropbox_path("Patient_Preference.Rmd"), "/simulations_patient_preference.RDS")
if (do_diagnosis & !exists("do_bookdown")) {
  write_rds(simulations, path = rds_file_path)
}
simulations <- read_rds(rds_file_path)
```

Two looks at graphs. need to visualize two series with respect to "slider" . Dont want a double y-axis.  I think I prefer the facetted.

```{r}
summary_df <- 
  simulations %>%
  group_by(slider, estimator_label) %>%
  summarise(var_estimate = var(estimate),
            mean_estimate = mean(estimate)) %>%
  group_by(slider) %>%
  summarise(total_utility = mean_estimate[estimator_label == "total utility"],
            precision = 1/var_estimate[estimator_label == "IPW"])


g1 <-
  summary_df %>%
  ggplot(aes(precision, total_utility, color = slider)) +
  geom_point() +
  geom_line()

g2 <-
  summary_df %>%
  gather(key, value, total_utility, precision) %>%
  ggplot(aes(slider, value)) +
  geom_point() +
  geom_line() +
  facet_wrap(vars(key), scales = "free")

g1
g2
```

# References





