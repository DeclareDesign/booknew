<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 18 Complex designs | Research Design: Declare, Diagnose, Redesign</title>
<meta name="author" content="Graeme Blair, Alexander Coppock, and Macartan Humphreys">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<link href="libs/bs4_book-1.0.0/dd_imgpopup.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/bs4_book-1.0.0/dd_imgpopup.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://hypothes.is/embed.js" async></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Research Design: Declare, Diagnose, Redesign</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li class="book-part">Introduction</li>
<li><a class="" href="preamble.html"><span class="header-section-number">1</span> Preamble</a></li>
<li><a class="" href="improving-research-designs.html"><span class="header-section-number">2</span> Improving research designs</a></li>
<li><a class="" href="primer.html"><span class="header-section-number">3</span> Software primer</a></li>
<li><a class="" href="part-i-exercises.html"><span class="header-section-number">4</span> Part I Exercises</a></li>
<li class="book-part">Declaration, Diagnosis, Redesign</li>
<li><a class="" href="declaration.html"><span class="header-section-number">5</span> Declaration</a></li>
<li><a class="" href="specifying-the-model.html"><span class="header-section-number">6</span> Specifying the model</a></li>
<li><a class="" href="defining-the-inquiry.html"><span class="header-section-number">7</span> Defining the inquiry</a></li>
<li><a class="" href="crafting-a-data-strategy.html"><span class="header-section-number">8</span> Crafting a data strategy</a></li>
<li><a class="" href="choosing-an-answer-strategy.html"><span class="header-section-number">9</span> Choosing an answer strategy</a></li>
<li><a class="" href="p2diagnosis.html"><span class="header-section-number">10</span> Diagnosis</a></li>
<li><a class="" href="redesign-2.html"><span class="header-section-number">11</span> Redesign</a></li>
<li><a class="" href="part-ii-exercises.html"><span class="header-section-number">12</span> Part II Exercises</a></li>
<li class="book-part">Research Design Library</li>
<li><a class="" href="research-design-library.html"><span class="header-section-number">13</span> Research Design Library</a></li>
<li><a class="" href="observational-designs-for-descriptive-inference.html"><span class="header-section-number">14</span> Observational designs for descriptive inference</a></li>
<li><a class="" href="experimental-designs-for-descriptive-inference.html"><span class="header-section-number">15</span> Experimental designs for descriptive inference</a></li>
<li><a class="" href="observational-designs-for-causal-inference.html"><span class="header-section-number">16</span> Observational designs for causal inference</a></li>
<li><a class="" href="experimental-designs-for-causal-inference.html"><span class="header-section-number">17</span> Experimental designs for causal inference</a></li>
<li><a class="active" href="complex-designs-1.html"><span class="header-section-number">18</span> Complex designs</a></li>
<li><a class="" href="part-iii-exercises.html"><span class="header-section-number">19</span> Part III Exercises</a></li>
<li class="book-part">Research Design Lifecycle</li>
<li><a class="" href="research-design-lifecycle.html"><span class="header-section-number">20</span> Research Design Lifecycle</a></li>
<li><a class="" href="before.html"><span class="header-section-number">21</span> Before</a></li>
<li><a class="" href="during.html"><span class="header-section-number">22</span> During</a></li>
<li><a class="" href="after.html"><span class="header-section-number">23</span> After</a></li>
<li><a class="" href="part-iv-exercises.html"><span class="header-section-number">24</span> Part IV Exercises</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="complex-designs-1" class="section level1">
<h1>
<span class="header-section-number">18</span> Complex designs<a class="anchor" aria-label="anchor" href="#complex-designs-1"><i class="fas fa-link"></i></a>
</h1>
<p>In the designs we presented thus far, the aim was generally to learn about the level of some variable or some particular causal effect. In most cases, a single set of observations was collected and an answer strategy was applied directly to this data to answer a pre-defined question.</p>
<p>Very many studies have this form. But studies can also be “complex” in multiple ways. For instance although we have assumed researchers start with well defined estimands, some studies focus on first figuring out what question to ask and then proceed to ask and answer it. Some studies seek not to learn about levels and effects but search explicitly for a model of a phenomenon, asking for instance “what causes <span class="math inline">\(Y\)</span>?” or “what model, in some class, best accounts for observed data”? These studies have complex inquiries. Other studies have complex data and answer strategies, for instance, gathering together findings from multiple sub-studies in order to arrive at an overall conclusion.</p>
<p>We address the declaration and diagnosis of such complex designs in this section.</p>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
<!-- make sure to rename the section title below -->
<div id="discovery" class="section level2">
<h2>
<span class="header-section-number">18.1</span> Discovery<a class="anchor" aria-label="anchor" href="#discovery"><i class="fas fa-link"></i></a>
</h2>
<p>Imagine a study in which a researcher is interested not just in figuring out the effects of an intervention but also in what accounts for variation in effects. They have <em>candidate</em> estimands but the decision whether to promote these candidates to study estimands depends on data patterns that are found along the way. This kind of problem is akin to the common problem of selecting predictors or selecting controls.</p>
<p>For simplicity we define a design of this form with just a single candidate. The design lets us assess the risks and benefits of different answer strategies given the endogenous choice of estimand.</p>
<div id="design-declaration" class="section level3">
<h3>
<span class="header-section-number">18.1.1</span> Design Declaration<a class="anchor" aria-label="anchor" href="#design-declaration"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><strong>M</strong>odel: The population consists of two groups (men and women, for instance). The conditional average treatment effect is possibly larger in one group than another. This group is the candidate variable for forming an heterogeneous effects estimand.</p></li>
<li><p><strong>I</strong>nquiry: The main purpose of the experiment is to estimate the overall Average Treatment Effect. Here, though, we consider the secondary, heterogeneous effects analysis that many researchers conduct after examining the ATE, in which they seek to assess whether effects are larger for one group than for another. This potentially becomes a second question of interest, depending on a discovery process.</p></li>
<li><p><strong>D</strong>ata strategy: We allocate treatment using complete random assignment.</p></li>
<li><p><strong>A</strong>nswer strategy: Using a random half of the data (the test set), we test for an interaction of treatment with group membership. If we find a significant interaction at the <span class="math inline">\(p \leq 0.05\)</span> level, we declare the interaction as a new estimand and estimate the size of the interaction in the test data set.</p></li>
</ul>
<p>We also include, for comparison, a “naive” analysis that reports the interaction estimated using the full data whenever that interaction is significant.</p>
</div>
<div id="declaration-22" class="section level3">
<h3>
<span class="header-section-number">18.1.2</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-22"><i class="fas fa-link"></i></a>
</h3>
<p>The declaration makes use of two conditional estimators.</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># An estimator that estimates on testing data only if </span>
<span class="co"># estimates on training data were significant</span>

<span class="va">new_estimator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
      estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">train_p</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="fl">.05</span>, 
                        <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">*</span><span class="va">X</span>, subset <span class="op">=</span> <span class="op">!</span><span class="va">train</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, 
                        <span class="cn">NA</span><span class="op">)</span>,
      p.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">train_p</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="fl">.05</span>, 
                       <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span>, subset <span class="op">=</span> <span class="op">!</span><span class="va">train</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">4</span><span class="op">]</span>,
                       <span class="cn">NA</span><span class="op">)</span>,
      term <span class="op">=</span> <span class="st">"Z:X"</span>,
      stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>

<span class="co"># An estimator that estimates on all data only if estimates are significant</span>

<span class="va">comparison_estimator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">all_p</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.05</span>, <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">*</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="cn">NA</span><span class="op">)</span>,
    p.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">all_p</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.05</span>, <span class="va">all_p</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="cn">NA</span><span class="op">)</span>,
    term <span class="op">=</span> <span class="st">"Z:X"</span>,
    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></code></pre></div>
<p>We now declare the design:</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># The design</span>

<span class="va">discovery</span> <span class="op">&lt;-</span> 
  
  <span class="fu">declare_population</span><span class="op">(</span>
    N <span class="op">=</span> <span class="fl">200</span>, 
    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span> <span class="op">%%</span> <span class="fl">2</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span>,
    het_effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">.5</span><span class="op">)</span>,<span class="fl">1</span>,<span class="cn">TRUE</span><span class="op">)</span>,
    train <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span> <span class="op">%%</span> <span class="fl">2</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span>,
    u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">het_effect</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="va">u</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_assignment</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    
  <span class="co"># Main analysis</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"Main"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Exploration</span>
  <span class="fu">declare_step</span><span class="op">(</span>
      train_p <span class="op">=</span> <span class="op">(</span><span class="fu">lm_robust</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span>, subset <span class="op">=</span> <span class="va">train</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">4</span><span class="op">]</span>,
      all_p   <span class="op">=</span> <span class="op">(</span><span class="fu">lm_robust</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">4</span><span class="op">]</span>,
      handler <span class="op">=</span> <span class="va">fabricate</span><span class="op">)</span> <span class="op">+</span>
    
  <span class="fu">declare_estimand</span><span class="op">(</span>
    het <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span><span class="op">[</span><span class="va">X</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">[</span><span class="va">X</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span><span class="op">[</span><span class="op">!</span><span class="va">X</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">[</span><span class="op">!</span><span class="va">X</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Handler estimates only if p low in training group  </span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    handler <span class="op">=</span> <span class="fu">tidy_estimator</span><span class="op">(</span><span class="va">new_estimator</span><span class="op">)</span>, 
    estimand <span class="op">=</span> <span class="st">"het"</span>,
    label <span class="op">=</span> <span class="st">"Discovery"</span><span class="op">)</span> <span class="op">+</span>
    
  <span class="fu">declare_estimator</span><span class="op">(</span>
    handler <span class="op">=</span> <span class="fu">tidy_estimator</span><span class="op">(</span><span class="va">comparison_estimator</span><span class="op">)</span>, 
    estimand <span class="op">=</span> <span class="st">"het"</span>,
    label <span class="op">=</span> <span class="st">"Comparison"</span><span class="op">)</span></code></pre></div>
<p>We include diagnosands that take account of the fact that some runs of the designs do not produce estimates for the new estimand.</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">discovery</span> <span class="op">&lt;-</span> <span class="fu">set_diagnosands</span><span class="op">(</span><span class="va">discovery</span>, <span class="fu">declare_diagnosands</span><span class="op">(</span>
  bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  RMSE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
  frequency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span>,
  false_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">p.value</span><span class="op">[</span><span class="va">estimand</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  false_neg <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">p.value</span><span class="op">[</span><span class="va">estimand</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="diagnosis-3" class="section level3">
<h3>
<span class="header-section-number">18.1.3</span> Diagnosis<a class="anchor" aria-label="anchor" href="#diagnosis-3"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:discoverydiagnosis">Table 18.1: </span>Complete random sampling design diagnosis
</caption>
<thead><tr>
<th style="text-align:left;">
Design Label
</th>
<th style="text-align:left;">
Estimand Label
</th>
<th style="text-align:left;">
Estimator Label
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Frequency
</th>
<th style="text-align:left;">
False Pos
</th>
<th style="text-align:left;">
False Neg
</th>
<th style="text-align:left;">
Keep Defaults
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
discovery
</td>
<td style="text-align:left;">
ATE
</td>
<td style="text-align:left;">
Main
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.14
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
NaN
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
discovery
</td>
<td style="text-align:left;">
het
</td>
<td style="text-align:left;">
Comparison
</td>
<td style="text-align:left;">
-0.25
</td>
<td style="text-align:left;">
0.31
</td>
<td style="text-align:left;">
0.26
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
discovery
</td>
<td style="text-align:left;">
het
</td>
<td style="text-align:left;">
Discovery
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.41
</td>
<td style="text-align:left;">
0.31
</td>
<td style="text-align:left;">
0.06
</td>
<td style="text-align:left;">
0.82
</td>
<td style="text-align:left;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.02)
</td>
<td style="text-align:left;">
(0.02)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.05)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
</tbody>
</table></div>
<p>We see that the principled discovery method, using training and testing data, provides essentially unbiased estimates of the heterogeneous effect, when it is estimated. The comparison method tends to provide biased estimates, because conditioning on statistical significance tends to exaggerate effect sizes (<span class="citation">Gelman and Carlin (<a href="references.html#ref-Gelman2014b" role="doc-biblioref">2014</a>)</span>).</p>
<p>The consequences of the two approaches for false discovery rates are stark. If the true effect is 0, the probability of falsely rejecting the null of 0 (conditional on reporting) is 1 under the comparison method: by definition, only significant estimates are kept. Similarly, since the only estimates generated by this procedure are statistically significant, the false negative rate (conditional on reporting) is 0: the estimand is declared and the analysis conducted only when estimates are guaranteed to be significant. The principled discovery method exhibits conventional rates for falsely rejecting a true null (0.05) though it it fails to reject the null quite often, due to weak power.</p>
<p>Strikingly we see in this example that the protection from bias from the principled discovery strategy declared here does not necessarily translate into improved inferences on average (as measured by the MSE), because of a bias-variance tradeoff inherent in the approach. Less data is used in the final test when adopting a principled discovery approach, and so on average the estimates are much noisier than under the unprincipled comparison.</p>
<p>Moreover the principled strategy is somewhat less likely to produce a result <em>at all</em> since it is less likely that a result would be discovered in a subset of the data than in the entire data set.</p>
<p>Reanalysis of this design can be used to assess what an optimal division of units into training and testing data might be given different hypothesized effect sizes.</p>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
<!-- make sure to rename the section title below -->
</div>
</div>
<div id="structural-estimation" class="section level2">
<h2>
<span class="header-section-number">18.2</span> Structural estimation<a class="anchor" aria-label="anchor" href="#structural-estimation"><i class="fas fa-link"></i></a>
</h2>
<p>Structural estimation is used in situations where researchers have a general model in mind for how processes work and their goal is to fit the parameters of the model. With the fitted model they might then estimate levels of unobserved variables, treatment effects, or other quantities. They might even extrapolate to estimate counterfactual quantities, such as the effects of interventions that have not been implemented <span class="citation">(Reiss and Wolak <a href="references.html#ref-reiss2007structural" role="doc-biblioref">2007</a>)</span>.</p>
<p>We illustrate using an example of a model of bargaining between pairs of players, drawing on an example use in <span class="citation">Wilke and Humphreys (<a href="references.html#ref-wilke2020field" role="doc-biblioref">2020</a>)</span>.</p>
<p><span class="citation">Wilke and Humphreys (<a href="references.html#ref-wilke2020field" role="doc-biblioref">2020</a>)</span> imagine a bargaining game with payments from customer <span class="math inline">\(i\)</span> to a taxi driver given by:</p>
<p><span class="math display">\[\pi_i =  \theta_i(z_iy + (1-z_i)(1-y)) + (1-\theta_i)\chi\]</span></p>
<p>Here <span class="math inline">\(y = \sum_{j = 2}^n(-1^{j})\delta^{j-1}\)</span> is the equilibrium offer made by the first mover as predicted by the <span class="citation">Rubinstein (<a href="references.html#ref-rubinstein1982perfect" role="doc-biblioref">1982</a>)</span> alternating offers bargaining model with <span class="math inline">\(n\)</span> possible bargaining rounds given discount factor <span class="math inline">\(\delta\)</span>. The customer’s payoff depends on whether she goes first (<span class="math inline">\(z_i = 1\)</span>) or second (<span class="math inline">\(z_i = 0\)</span>). Non-rational customers (<span class="math inline">\(\theta_i = 0\)</span>) do not engage in bargaining but successfully invoke a norm, insisting on giving the driver some share <span class="math inline">\(\chi\)</span> of their endowment, irrespective of whether they go first or second. We let <span class="math inline">\(q\)</span> denote the probability that <span class="math inline">\(\theta = 1\)</span>.</p>
<p>To allow for a disturbance we assume that <em>measured</em> payments are a draw from a Beta distribution with expectation given by the expected payment and variance parameterized by <span class="math inline">\(\kappa\)</span>.</p>
<p>We imagine that <span class="math inline">\(Z\)</span> is randomly assigned and we have access to data on payments, <span class="math inline">\(\pi\)</span>. We will also assume we know price <span class="math inline">\(\chi\)</span>. Our goal however is not simply to measure the effect of <span class="math inline">\(Z\)</span> on <span class="math inline">\(\pi\)</span> but to estimate the model parameters, <span class="math inline">\(q\)</span>, <span class="math inline">\(\delta\)</span>, <span class="math inline">\(\kappa\)</span>, which themselves can be used to estimate this effect and other counterfactual quantities (if we assume the model is true).</p>
<div id="design" class="section level3">
<h3>
<span class="header-section-number">18.2.1</span> Design<a class="anchor" aria-label="anchor" href="#design"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><strong>M</strong>odel. In this declaration we will assume that the data is indeed produced by a process similar to that assumed at the estimation stage.</p></li>
<li><p><strong>I</strong>nquiries. Our inquiries will include parameters <code>k</code>, <code>d</code>, and <code>q</code> corresponding to <span class="math inline">\(\kappa\)</span>, <span class="math inline">\(\delta\)</span> and <span class="math inline">\(q\)</span> in the model (we will treat <span class="math inline">\(\chi\)</span> as known). In addition we will be interested in the effect of <span class="math inline">\(Z\)</span> on payments in a two period game and in the game of indefinite duration.</p></li>
<li><p><strong>D</strong>ata. First mover position, <span class="math inline">\(Z\)</span>, is randomly assigned. Payments are measured with some error (in this model however we cannot distinguish between measurement error and decision making error). We imagine that we have access to data from games with <span class="math inline">\(n=2\)</span> and games with <span class="math inline">\(n=\infty\)</span> in order to compare the performance of estimators in both conditions.</p></li>
<li><p><strong>A</strong>nalysis is implemented using maximum likelihood to identify which parameter values are most consistent with the data (which collection of parameter values produce the observed data with greatest likelihood). In this declaration the model employed in <strong>A</strong> is the same as that employed in <strong>M</strong>. We will report analysis results from both differences in means and structural estimation generated both from using the <span class="math inline">\(n=2\)</span> data (<code>DIM_two, Struc_two</code>) and from using <span class="math inline">\(n=\infty\)</span> data (<code>DIM_inf, Struc_inf</code>)</p></li>
</ul>
<p>The most complex part of the design is the specification of the estimator, shown next:</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">structural_estimator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">pi</span>, <span class="va">y</span>, <span class="va">chi</span> <span class="op">=</span> <span class="fl">3</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span><span class="op">{</span>
    
    <span class="co"># Define negative log likelihood as a function of k, d and q</span>
    <span class="va">LL</span>  <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">k</span>, <span class="va">d</span>, <span class="va">q</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu">y</span><span class="op">(</span><span class="va">Z</span>, <span class="va">d</span><span class="op">)</span><span class="op">)</span>
      <span class="va">R</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">dbeta</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">pi</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">k</span> <span class="op">*</span> <span class="va">chi</span>, <span class="va">k</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span> <span class="va">chi</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
        <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">q</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">dbeta</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">pi</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">k</span> <span class="op">*</span> <span class="va">m</span>, <span class="va">k</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">m</span><span class="op">)</span><span class="op">)</span>
      <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>

  <span class="co"># Estimation</span>
  <span class="va">M</span> <span class="op">&lt;-</span> <span class="fu">mle2</span><span class="op">(</span>
    <span class="va">LL</span>,
    method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
    start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">2</span>, d <span class="op">=</span> <span class="fl">0.50</span>,  q <span class="op">=</span> <span class="fl">0.50</span><span class="op">)</span>,
    lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">1</span>,    d <span class="op">=</span> <span class="fl">0.01</span>,  q <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>,
    upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">1000</span>, d <span class="op">=</span> <span class="fl">0.99</span>,  q <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span>
  <span class="op">)</span>
  
  <span class="co"># Format output from estimation</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">)</span>, outcome <span class="op">=</span> <span class="va">pi</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"std.error"</span>, <span class="st">"statistic"</span>, <span class="st">"p.value"</span>, <span class="st">"outcome"</span><span class="op">)</span>
  
  <span class="co"># Use estimates of q and delta to predict average treatment effects (ATEs)</span>
  <span class="co"># Predicted ATE for n=2</span>
  <span class="va">out</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">out</span><span class="op">[</span><span class="st">"q"</span>, <span class="st">"estimate"</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">out</span><span class="op">[</span><span class="st">"d"</span>, <span class="st">"estimate"</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
  
  <span class="co"># Predicted ATE for n=infinity</span>
  <span class="va">out</span><span class="op">[</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">out</span><span class="op">[</span><span class="st">"q"</span>, <span class="st">"estimate"</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">out</span><span class="op">[</span><span class="st">"d"</span>, <span class="st">"estimate"</span><span class="op">]</span> <span class="op">/</span>
                                               <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">out</span><span class="op">[</span><span class="st">"d"</span>, <span class="st">"estimate"</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
  
  <span class="va">out</span>
<span class="op">}</span></code></pre></div>
<p>The design makes use of this estimator to estimate parameter values as well as treatment effects. It is accompanied by a simpler difference in means estimator of treatment effects.</p>
<p>An attraction of structural estimation is that, with a fitted model, one can generate estimates of effects of treatments that have not been implemented. In this case the
same parameters that describe the equilibrium outcomes in a two round game are sufficient to describe outcomes in the infinitely repeated game. So if you understand the effects of a treatment in one case you understand it in the other. At least if the model is correct. In the design below we generate such estimates for the effects of unimplemented treatments.</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Declare the design ----------------------------------------------------------</span>

<span class="co"># Define parameter values:</span>
<span class="va">d</span> <span class="op">=</span> <span class="fl">0.8</span>       <span class="co"># True delta (unknown)</span>
<span class="va">k</span> <span class="op">=</span> <span class="fl">6</span>         <span class="co"># Parameter to governance variance (unknown)</span>
<span class="va">q</span> <span class="op">=</span> <span class="fl">0.5</span>       <span class="co"># Share of behavioral types in the population (unknown)</span>
<span class="va">chi</span> <span class="op">=</span> <span class="fl">0.75</span>    <span class="co"># Price paid by norm following ("behavioral" customers) (known)</span>

<span class="co"># Design declaration:</span>

<span class="va">design</span> <span class="op">&lt;-</span> 
  
  <span class="co"># Define the population: indicator for behavioral type (norm = 1)</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">500</span>, norm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="va">q</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Define mean potential outcomes for n = 2 </span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">pi_two</span> <span class="op">~</span> <span class="va">norm</span><span class="op">*</span><span class="va">chi</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">norm</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">Z</span><span class="op">*</span><span class="va">d</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">Z</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">d</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Define mean potential outcomes for n = infinity</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">pi_inf</span> <span class="op">~</span> <span class="va">norm</span><span class="op">*</span><span class="va">chi</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">norm</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">Z</span><span class="op">*</span><span class="va">d</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">d</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">Z</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">d</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">d</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Define estimands (quantities we want to estimate)</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE_two <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pi_two_Z_1</span> <span class="op">-</span> <span class="va">pi_two_Z_0</span><span class="op">)</span>, <span class="co"># ATE n = 2</span>
                   ATE_inf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pi_inf_Z_1</span> <span class="op">-</span> <span class="va">pi_inf_Z_0</span><span class="op">)</span>, <span class="co"># ATE n = infinity</span>
                   k <span class="op">=</span> <span class="va">k</span>,                                   <span class="co"># kappa</span>
                   d <span class="op">=</span> <span class="va">d</span>,                                   <span class="co"># delta</span>
                   q <span class="op">=</span> <span class="va">q</span><span class="op">)</span> <span class="op">+</span>                                 <span class="co"># q</span>

  <span class="co"># Declare assignment process </span>
  <span class="fu">declare_assignment</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Declare revealed potential outcomes</span>
  <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">pi_two</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">pi_inf</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Get draws from beta distribution given means for n = 2 and n = infinity</span>
  <span class="fu">declare_measurement</span><span class="op">(</span>
    pi_two_obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">pi_two</span><span class="op">*</span><span class="va">k</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">pi_two</span><span class="op">)</span><span class="op">*</span><span class="va">k</span><span class="op">)</span>,      
    pi_inf_obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">pi_inf</span><span class="op">*</span><span class="va">k</span>, <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">pi_inf</span><span class="op">)</span><span class="op">*</span><span class="va">k</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Declare estimators</span>
  <span class="co"># Difference-in-means for n = 2</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">pi_two_obs</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE_two"</span>, label <span class="op">=</span> <span class="st">"DIM_two"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># Difference-in-means for n = infinity</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">pi_inf_obs</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE_inf"</span>, label <span class="op">=</span> <span class="st">"DIM_inf"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># MLE for n = 2</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>handler <span class="op">=</span> <span class="fu">tidy_estimator</span><span class="op">(</span><span class="va">structural_estimator</span><span class="op">)</span>, 
                    pi <span class="op">=</span> <span class="st">"pi_two_obs"</span>, 
                    y <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">Z</span>, <span class="va">d</span><span class="op">)</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">d</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Z</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">d</span><span class="op">)</span>, 
                    estimand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"k"</span>,<span class="st">"d"</span>, <span class="st">"q"</span>, <span class="st">"ATE_two"</span>, <span class="st">"ATE_inf"</span><span class="op">)</span>, 
                    label <span class="op">=</span> <span class="st">"Struc_two"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># MLE for n = infinity</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>handler <span class="op">=</span> <span class="fu">tidy_estimator</span><span class="op">(</span><span class="va">structural_estimator</span><span class="op">)</span>,
                    pi <span class="op">=</span> <span class="st">"pi_inf_obs"</span>, 
                    y <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">Z</span>, <span class="va">d</span><span class="op">)</span> <span class="va">Z</span><span class="op">*</span><span class="va">d</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">d</span><span class="op">)</span> <span class="op">+</span>  <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">Z</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">d</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">d</span><span class="op">)</span><span class="op">)</span>,
                    estimand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"k"</span>,<span class="st">"d"</span>,<span class="st">"q"</span>,<span class="st">"ATE_two"</span>, <span class="st">"ATE_inf"</span><span class="op">)</span>, 
                    label <span class="op">=</span> <span class="st">"Struc_inf"</span><span class="op">)</span> </code></pre></div>
Now for the diagnosis.
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:structuraldiagnosis">Table 18.2: </span>Complete random sampling design diagnosis
</caption>
<thead><tr>
<th style="text-align:left;">
Design Label
</th>
<th style="text-align:left;">
Estimand Label
</th>
<th style="text-align:left;">
Estimator Label
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
Mean Estimand
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_inf
</td>
<td style="text-align:left;">
DIM_inf
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.80
</td>
<td style="text-align:left;">
-0.05
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
-0.06
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_inf
</td>
<td style="text-align:left;">
Struc_inf
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
-0.05
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
-0.06
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_inf
</td>
<td style="text-align:left;">
Struc_two
</td>
<td style="text-align:left;">
-0.00
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
-0.06
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
-0.06
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_two
</td>
<td style="text-align:left;">
DIM_two
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
0.30
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.30
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_two
</td>
<td style="text-align:left;">
Struc_inf
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
0.30
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
0.30
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
ATE_two
</td>
<td style="text-align:left;">
Struc_two
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
0.30
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.30
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
d
</td>
<td style="text-align:left;">
Struc_inf
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
0.80
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
0.80
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
d
</td>
<td style="text-align:left;">
Struc_two
</td>
<td style="text-align:left;">
-0.00
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
0.80
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.80
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
k
</td>
<td style="text-align:left;">
Struc_inf
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
0.44
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
6.05
</td>
<td style="text-align:left;">
0.44
</td>
<td style="text-align:left;">
6.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
k
</td>
<td style="text-align:left;">
Struc_two
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
0.46
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
6.05
</td>
<td style="text-align:left;">
0.45
</td>
<td style="text-align:left;">
6.00
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
q
</td>
<td style="text-align:left;">
Struc_inf
</td>
<td style="text-align:left;">
-0.00
</td>
<td style="text-align:left;">
0.04
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
0.50
</td>
<td style="text-align:left;">
0.04
</td>
<td style="text-align:left;">
0.50
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:left;">
q
</td>
<td style="text-align:left;">
Struc_two
</td>
<td style="text-align:left;">
-0.00
</td>
<td style="text-align:left;">
0.04
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
0.50
</td>
<td style="text-align:left;">
0.04
</td>
<td style="text-align:left;">
0.50
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
</tbody>
</table></div>
<p>We see here that we do a good job in recovering parameter values and we also recover treatment effects. When using two period data the estimate for the <code>ATE_two</code> is as good when estimated using the structural and design based approaches. In the case with data from <span class="math inline">\(n=\infty\)</span> games however the estimate from the structural model is less precise, though unbiased. In contrast we have no estimate using design based methods for this estimand. Finally, <span class="math inline">\(\delta\)</span>, we see, is better estimated using data from the 2 period games; the estimate for <span class="math inline">\(\kappa\)</span> is biased though the bias is small.</p>
</div>
<div id="exercises-8" class="section level3">
<h3>
<span class="header-section-number">18.2.2</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-8"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Declare and diagnose a version of this design where the benchmark model is different to the analysis model. How do you define parameter estimands in this case?</li>
</ul>
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- start post here, do not edit above --><!-- make sure to rename the section title below -->
</div>
</div>
<div id="multi-site-trials" class="section level2">
<h2>
<span class="header-section-number">18.3</span> Multi-site trials<a class="anchor" aria-label="anchor" href="#multi-site-trials"><i class="fas fa-link"></i></a>
</h2>
<!-- ## The Metaketa design -->
<!-- | Study Number | Place | What Works   | Design Implemented | Success? | -->
<!-- | ------------ | ----- | ------------ | ------------------ | -------- | -->
<!-- | 1            | A     | $Y_A ~ Z_A$  | $MIDA_A$           | Yes      | -->
<!-- | 2            | B     | $Y_B ~ Z_B$  | $MIDA_B$           | Yes      | -->
<!-- | 3            | C     | $Y_C ~ Z_C$  | $MIDA_C$           | Yes      | -->
<!-- | 4            | D     | $Y_D ~ Z_D$  | $MIDA_D$           | Yes      | -->
<!-- | 5            | E     | $Y_E ~ Z_E$  | $MIDA_E$           | Yes      | -->
<!-- The worry is that $I_A$ and $I_B$ etc are fundamentally different inquiries about different dags -->
<!-- [faceted figure of 5 different DAGs with nodes in different languages roman, greek, numeric, windings].  The purpose of *theory* is to tell us when the $I$'s across context are different, but that is HARD and that is how research has gone for YEARS. -->
<!-- The metaketa design says WAIT -- LET'S agree on a $MIDA_{MK}$ that we will implement in all 5 places, mutatis mutandis. That is, everyone "localizes" their design because things work slightly differently in different places, but if we try hard, we can implement the same "important" treatment on the same "important" outcome, even though the details (like the language of the treatment materials, the specifics of the measurement strategies.) will differ from place to place. -->
<!-- | Study Number | Place | What Works   | Design Implemented                               | Success? | -->
<!-- | ------------ | ----- | ------------ | ------------------------------------------------ | -------- | -->
<!-- | 1            | A     | $Y_A ~ Z_A$  | $\delta_A * MIDA_{MK} - (1 - \delta_A) * MIDA_A$ | ?        | -->
<!-- | 2            | B     | $Y_B ~ Z_B$  | $\delta_B * MIDA_{MK} - (1 - \delta_B) * MIDA_B$ | ?        | -->
<!-- | 3            | C     | $Y_C ~ Z_C$  | $\delta_C * MIDA_{MK} - (1 - \delta_C) * MIDA_C$ | ?        | -->
<!-- | 4            | D     | $Y_D ~ Z_D$  | $\delta_D * MIDA_{MK} - (1 - \delta_D) * MIDA_D$ | ?        | -->
<!-- | 5            | E     | $Y_E ~ Z_E$  | $\delta_E * MIDA_{MK} - (1 - \delta_E) * MIDA_E$ | ?        | -->
<!-- Coordinating trials like the metaketa design means causing teams to implement designs that they otherwise would not have. Collaboration can bring many benefits and shared struggle, but fundamentally, it pulls all the designs towards the common $MIDA_{MK}$ design. The strength of the pull is given by the $\delta$ parameters.  -->
<!-- Will the metaketa design be a success? Only if (1) the $MIDA_{MK}$ design is a strong one and it is correct about how $Y$ and $Z$ relate. If the $MIDA_{MK}$ design is poor, however, then all the studies will be a failure. Instead of learning $I_A$ in place $A$ and learning $I_B$ in place $B$, we learn nothing anywhere.  -->
<!-- The trouble with the standard approach (separate teams investigating phenomena that later theory tries to label as instances of the same thing) is that theory is hard and we can never really be sure if $I_A$ means the same thing for $M_A$ as $I_B$ means for $M_B$. The metaketa design tries to solve this theoretical problem on the front end -- let's agree on what the $M$ we all have in mind is (with local variations), then run a study. This approach works well if the $M$ we all agree on is approximately correct, and it works *worse* than the standard approach if we're wrong. -->
<p>The starting point is a fixed budget and considering two possible designs: (1) a single large study in one context or (2) a set of five studies in five different contexts with the same intervention and outcome measures.</p>
<p>When there are heterogeneous effects, you can get good predictions out of sample even when average effects differ substantially (and you do better with multiple sites when sites in the population have different proportions of subject types that are correlated with heterogeneous effects).</p>
<p>Two notable features of the design:
- there must be heterogeneous effects for this to work (otherwise our estimates get biased toward zero due to overfitting to the variables).
- we have to have information about the covariate in the population and the sample (here we used the proportion of people in each heterogeneous type).</p>
<!-- Findings: -->
<!-- - these two strategies are both unbiased -->
<!-- - the design with five sites has half the RMSE of the one-site design. this is because of the variation in the proportions of types across sites. -->
<!-- - interestingly there is poor coverage (anti-conservative) when you use the single site design -->
<!-- (when you have contextual variation as well, i.e. effect differs across sites for reasons not captured by the het fx, coverage is off for all designs. will keep this point out, seems like too much and you don't need contextual effects to get different effects across sites, those come from different proportions of types) -->
<!-- need to have biased sampling to get bias here -->
<!-- two kinds of populations, one in which the study type determines the subject types and you select on study type -->
<!--   a second kind where study type determines study shock  -->
<!--   in second type if you adjust for subject type then you will be able to unbiased recover global -->
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">single_site_design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>
    site <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>
      N <span class="op">=</span> <span class="fl">10</span>, 
      feasible_site <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
      study_effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, to <span class="op">=</span> <span class="fl">0.1</span>, length.out <span class="op">=</span> <span class="va">N</span><span class="op">)</span> 
    <span class="op">)</span>,
    subjects <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">n_subjects_per_site</span>, noise <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">+</span> <span class="va">study_effect</span> <span class="op">+</span> <span class="fl">0.025</span> <span class="op">*</span> <span class="va">feasible_site</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimand</span><span class="op">(</span>PATE_feasible <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span>, subset <span class="op">=</span> <span class="va">feasible_site</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_sampling</span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">site</span>, strata <span class="op">=</span> <span class="va">feasible_site</span>, strata_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_sampling</span><span class="op">(</span>strata <span class="op">=</span> <span class="va">site</span>, n <span class="op">=</span> <span class="va">n_subjects_per_site</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_assignment</span><span class="op">(</span>blocks <span class="op">=</span> <span class="va">site</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">lm_robust</span><span class="op">)</span>

<span class="va">multi_site_design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>
    site <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>
      N <span class="op">=</span> <span class="fl">10</span>, 
      feasible_site <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
      study_effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, to <span class="op">=</span> <span class="fl">0.1</span>, length.out <span class="op">=</span> <span class="va">N</span><span class="op">)</span> 
    <span class="op">)</span>,
    subjects <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">n_subjects_per_site</span>, noise <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="op">(</span><span class="fl">0.1</span> <span class="op">+</span> <span class="va">study_effect</span> <span class="op">+</span> <span class="fl">0.025</span> <span class="op">*</span> <span class="va">feasible_site</span><span class="op">)</span> <span class="op">+</span> <span class="va">noise</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimand</span><span class="op">(</span>PATE_feasible <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span>, subset <span class="op">=</span> <span class="va">feasible_site</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_sampling</span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">site</span>, strata <span class="op">=</span> <span class="va">feasible_site</span>, strata_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_study_sites</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_sampling</span><span class="op">(</span>strata <span class="op">=</span> <span class="va">site</span>, n <span class="op">=</span> <span class="va">n_subjects_per_site</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_assignment</span><span class="op">(</span>blocks <span class="op">=</span> <span class="va">site</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimator</span><span class="op">(</span>handler <span class="op">=</span> <span class="fu">label_estimator</span><span class="op">(</span><span class="va">random_effects_meta_analysis</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"random-effects"</span><span class="op">)</span>

<span class="va">single_site_large_design</span> <span class="op">&lt;-</span> <span class="fu">redesign</span><span class="op">(</span><span class="va">single_site_design</span>, n_subjects_per_site <span class="op">=</span> <span class="fl">2500</span><span class="op">)</span>

<span class="va">small_study_five_sites</span> <span class="op">&lt;-</span> <span class="fu">redesign</span><span class="op">(</span><span class="va">multi_site_design</span>, n_study_sites <span class="op">=</span> <span class="fl">5</span>, n_subjects_per_site <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simulations_small_large</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">single_site_large_design</span>, <span class="va">small_study_five_sites</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span>
<span class="va">diagnosis_small_large</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">simulations_small_large</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
Design Label
</th>
<th style="text-align:left;">
Estimand Label
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
RMSE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
single_site_large_design
</td>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.07
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
single_site_large_design
</td>
<td style="text-align:left;">
PATE_feasible
</td>
<td style="text-align:left;">
-0.00
</td>
<td style="text-align:left;">
0.07
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
small_study_five_sites
</td>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.05
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
<tr>
<td style="text-align:left;">
small_study_five_sites
</td>
<td style="text-align:left;">
PATE_feasible
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
0.04
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
</tbody>
</table></div>
<div id="bayesian-estimation-can-improve-estimates-of-effects-for-sampled-sites" class="section level3">
<h3>
<span class="header-section-number">18.3.1</span> Bayesian estimation can improve estimates of effects for sampled sites<a class="anchor" aria-label="anchor" href="#bayesian-estimation-can-improve-estimates-of-effects-for-sampled-sites"><i class="fas fa-link"></i></a>
</h3>
<p>To do: you can improve site-level effect estimates by analyzing with a simple Bayesian model because of its shrinkage property, even when the Bayesian model is wrong about distribution of effects in population.</p>
<!-- this is the point from the blog post; I will modify the above design so it can also make this point, switching between the normal distribution and uniform distribution for the fx distribution -->
<!-- # ```{r, eval = FALSE} -->
<!-- # stan_model <- "  -->
<!-- # data { -->
<!-- #   int<lower=0> J;         // number of sites  -->
<!-- #   real y[J];              // estimated effects -->
<!-- #   real<lower=0> sigma[J]; // s.e. of effect estimates  -->
<!-- # } -->
<!-- # parameters { -->
<!-- #   real mu;  -->
<!-- #   real<lower=0> tau; -->
<!-- #   real eta[J]; -->
<!-- # } -->
<!-- # transformed parameters { -->
<!-- #   real theta[J]; -->
<!-- #   real tau_sq = tau^2; -->
<!-- #   for (j in 1:J) -->
<!-- #     theta[j] = mu + tau * eta[j]; -->
<!-- # } -->
<!-- # model { -->
<!-- #   target += normal_lpdf(eta | 0, 1); -->
<!-- #   target += normal_lpdf(y | theta, sigma); -->
<!-- # } -->
<!-- # " -->
<!-- #  -->
<!-- # stan_re_estimator <- function(data) { -->
<!-- #   site_estimates_df <- data %>%  -->
<!-- #     group_by(site) %>%  -->
<!-- #     do(tidy(lm_robust(Y ~ Z, data = .))) %>%  -->
<!-- #     filter(term == "Z") %>%  -->
<!-- #     ungroup  -->
<!-- #    -->
<!-- #   J      <- nrow(site_estimates_df) -->
<!-- #   df     <- list(J = J, y = site_estimates_df$estimate, sigma = site_estimates_df$std.error) -->
<!-- #   fit    <- stan(model_code = stan_model, data = site_estimates_df) -->
<!-- #   fit_sm <- summary(fit)$summary -->
<!-- #   data.frame(estimate = fit_sm[,1][c("mu", "tau", "theta[1]", "prob_pos")]) -->
<!-- # } -->
<!-- #  -->
<!-- # bayes_estimator <- declare_estimator(handler = stan_re_estimator) -->
<!-- # ``` -->
<!-- ### When things break down: confounded sampling -->
<!-- None of these designs work when you're trying to make predictions for sites that are systematically different, i.e. are not in the same population as the sampling frame. -->
<!-- The design was set up to include several sites where researchers could not feasibly set up experiments. in the original design, effects do not depend on whether sites are feasible for the experiment. When effects do vary, there are systematic differences for those target sites. Those differences might come from three sources: mean effect size differs in places that are sampled vs not sampled; individual-level heterogeneous effect sizes that systematically differ in places that are sampled to study vs others; or covariate profiles that do not exist in sites outside the sampling frame. We introduce effects in the first way and show there is substantial bias. -->
<!-- ```{r} -->
<!-- small_study_five_sites_feasible_effects <- multi_site_designer(n_study_sites = 5, n_subjects_per_site = 500, feasible_effect  = -0.25) -->
<!-- ``` -->
<!-- ```{r, warning = FALSE, eval = do_diagnosis & !exists("do_bookdown")} -->
<!-- simulations_feasible_effects <- simulate_design(small_study_five_sites_feasible_effects, sims = sims) -->
<!-- diagnosis_feasible_effects <- diagnose_design(simulations_feasible_effects %>% filter(!is.na(estimate) & !is.na(std.error) & !is.na(statistic) & !is.na(p.value) & !is.na(conf.low) & !is.na(conf.high)), bootstrap_sims = b_sims) -->
<!-- ``` -->
<!-- ```{r, echo = FALSE, purl = FALSE} -->
<!-- # figure out where the dropbox path is, create the directory if it doesn't exist, and name the RDS file -->
<!-- rds_file_path <- paste0(get_dropbox_path("multi_site_studies"), "/diagnosis_feasible_effects.RDS") -->
<!-- if (do_diagnosis & !exists("do_bookdown")) { -->
<!--   write_rds(diagnosis_feasible_effects, path = rds_file_path) -->
<!-- } -->
<!-- diagnosis_feasible_effects <- read_rds(rds_file_path) -->
<!-- ``` -->
<!-- ```{r, echo = FALSE} -->
<!-- kable(get_diagnosands(diagnosis_feasible_effects) %>% reshape_diagnosis %>% select(Bias, RMSE), booktabs = TRUE, caption = "Diagnosis with confounded sampling,", digits = 3) -->
<!-- ``` -->
<!-- Other points I decided to abandon to keep this simple: -->
<!-- - tradeoff: context-specific interventions and comparability of intervention effects -->
<!-- - tradeoff: comparability and fidelity to context in outcome measurement -->

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
<div id="three-study-papers" class="section level2">
<h2>
<span class="header-section-number">18.4</span> Three-study papers<a class="anchor" aria-label="anchor" href="#three-study-papers"><i class="fas fa-link"></i></a>
</h2>
<!-- make sure to rename the section title below -->
<p>In many research projects, we seek to evaluate multiple observable implications for a single theory. In such cases, a single piece of evidence does not constitute sufficient evidence to validate the theory as a whole. Rather, we believe in the theory when multiple pieces of evidence support it.
<!-- [Examples: Psychology; APSR articles that have an experiment plus observational work; replication efforts.] --></p>
<p>Conventions around what constitutes a convincing pattern of evidence vary. Some researchers will not believe a theory unless each piece of evidence in support of it is <em>statistically significant</em>.
<!-- Reviewer / skeptic: an observable implication is X.  -->
<!-- You have failed to provide evidence of X, this is inconsistent with your theory. -->
Less stringent approaches simply seek evidence “consistent” with the theory, such as the observation that all effects are signed in the predicted direction.</p>
<p>Here, we declare an <span class="math inline">\(N\)</span>-study design, and examine the consequences of these two different approaches to evaluating a theory in light of multiple studies. We show that, under multiple observable implications generated by the same process, conditioning on significance can lead one strongly astray. Generally speaking, looking at the sign of effects is more probative because it is much less prone to false negatives. With small numbers of studies, however, the risks of false positives are high.</p>
<div id="design-declaration-1" class="section level3">
<h3>
<span class="header-section-number">18.4.1</span> Design Declaration<a class="anchor" aria-label="anchor" href="#design-declaration-1"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><strong>M</strong>odel: We declare <span class="math inline">\(N\)</span> populations, all of which are governed by the same
data-generating process: <code>X</code> is exogenous and standard normally-distributed,
<code>M</code> is standard-normally distributed and correlated with <code>X</code> by <code>rho</code>, and <code>Y</code> is a function of the main effect of <code>X</code> as well as the interaction between <code>X</code> and <code>M</code>, with the size and sign of the direct and interactive effects determined by <code>tau</code> and <code>gamma</code>, respectively.</p></li>
<li><p><strong>I</strong>nquiry: We want to know, in a global sense, if our theory is “right.”
Here, that means that the effect of <code>X</code> on <code>Y</code> is positive and increasing with <code>M</code>, and that <code>X</code> affects <code>M</code>.
When <code>tau</code> is positive, our theory is correct. When it is zero or negative, our theory is incorrect.</p></li>
<li><p><strong>D</strong>ata strategy: We conduct and collect independent datasets on <span class="math inline">\(N\)</span> datasets of size <code>n</code>. In the example below, we conduct three studies, assuming we only observe <code>X</code> and <code>Y</code> in the first, only <code>M</code> and <code>X</code> in the second, and <code>Y</code>, <code>M</code>, and <code>X</code>, in the third.</p></li>
<li><p><strong>A</strong>nswer strategy: Using linear regression, we estimate the bivariate correlation between <code>X</code> and <code>Y</code> in study 1, the bivariate correlation between <code>X</code> and <code>M</code> in study 2, and the interaction between <code>X</code> and <code>M</code> on <code>Y</code> in study 3.</p></li>
</ul>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n1</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">n2</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">n3</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">.5</span>
<span class="va">gamma</span> <span class="op">&lt;-</span> <span class="va">tau</span> <span class="op">&lt;-</span> <span class="fl">.2</span>

<span class="va">generate_study_sample</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">rho</span>, <span class="va">tau</span>, <span class="va">gamma</span>, <span class="va">data</span><span class="op">)</span><span class="op">{</span>
  <span class="fu">fabricate</span><span class="op">(</span>N <span class="op">=</span> <span class="va">n</span>, X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, M <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="va">X</span> <span class="op">*</span> <span class="va">rho</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">rho</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, 
            U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, Y <span class="op">=</span> <span class="va">tau</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="va">gamma</span> <span class="op">*</span> <span class="va">M</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">three_study_design</span> <span class="op">&lt;-</span>
  <span class="co"># Study 1 -- Bivariate correlation between X and Y</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">n1</span>,
    tau <span class="op">=</span> <span class="va">tau</span>,
    gamma <span class="op">=</span> <span class="va">gamma</span>,
    rho <span class="op">=</span> <span class="va">rho</span>,
    handler <span class="op">=</span> <span class="va">generate_study_sample</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span>,
                    term <span class="op">=</span> <span class="st">"X"</span>,
                    model <span class="op">=</span> <span class="va">lm_robust</span>,
                    label <span class="op">=</span> <span class="st">"Study 1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># Study 2 -- Bivariate correlation between M and X</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">n2</span>,
    tau <span class="op">=</span> <span class="va">tau</span>,
    gamma <span class="op">=</span> <span class="va">gamma</span>,
    rho <span class="op">=</span> <span class="va">rho</span>,
    handler <span class="op">=</span> <span class="va">generate_study_sample</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">M</span> <span class="op">~</span> <span class="va">X</span>,
                    term <span class="op">=</span> <span class="st">"X"</span>,
                    model <span class="op">=</span> <span class="va">lm_robust</span>,
                    label <span class="op">=</span> <span class="st">"Study 2"</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># Study 3 -- Interaction in X and M</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">n3</span>,
    tau <span class="op">=</span> <span class="va">tau</span>,
    gamma <span class="op">=</span> <span class="va">gamma</span>,
    rho <span class="op">=</span> <span class="va">rho</span>,
    handler <span class="op">=</span> <span class="va">generate_study_sample</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">M</span> <span class="op">+</span> <span class="va">X</span><span class="op">:</span><span class="va">M</span>,
                    term <span class="op">=</span> <span class="st">"X:M"</span>,
                    model <span class="op">=</span> <span class="va">lm_robust</span>,
                    label <span class="op">=</span> <span class="st">"Study 3"</span><span class="op">)</span> </code></pre></div>
</div>
<div id="dag-21" class="section level3">
<h3>
<span class="header-section-number">18.4.2</span> DAG<a class="anchor" aria-label="anchor" href="#dag-21"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-391-1.svg" width="100%"></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-392-1.svg" width="100%"></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-393-1.svg" width="100%"></div>
</div>
<div id="takeaways-1" class="section level3">
<h3>
<span class="header-section-number">18.4.3</span> Takeaways<a class="anchor" aria-label="anchor" href="#takeaways-1"><i class="fas fa-link"></i></a>
</h3>
<p>Let us compare the performance of the “all significant” versus “all signed”
approaches to theory confirmation when the theory is “correct” (<code>tau</code> and <code>gamma</code> positive),
versus when it is “incorrect” (both parameters zero).
In the first approach, a theory is deemed “supported” by the evidence when all effects
are significant. In the second, the theory is supported by the evidence when the signs of all effects are positive.</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Simulate design</span>
<span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">three_study_design</span><span class="op">)</span>

<span class="co"># Simulate null design</span>
<span class="va">null_three_study_design</span> <span class="op">&lt;-</span> 
  <span class="fu">redesign</span><span class="op">(</span><span class="va">three_study_design</span>, tau <span class="op">=</span> <span class="fl">0</span>, gamma <span class="op">=</span> <span class="fl">0</span>, rho <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">null_simulations</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">null_three_study_design</span><span class="op">)</span></code></pre></div>
<p>In the first three rows of the table, the theory is correct in that <code>tau</code>, <code>gamma</code>, and <code>rho</code> are positive; in the second three rows, it is incorrect because both the main effect and interaction are zero. The “power” column tells us the proportion of simulations in which the effect is significant at the <span class="math inline">\(\alpha = .05\)</span> level, the “all significant” column tells us the proportion of simulations in which all of the studies have significant effects, the “positive” column tells us how often the study found a positively signed result, while the “all positive column” tells us the proportion of simulations where all studies had a positively signed result.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:right;">
tau
</th>
<th style="text-align:left;">
estimator_label
</th>
<th style="text-align:right;">
gamma
</th>
<th style="text-align:right;">
power
</th>
<th style="text-align:right;">
all_significant
</th>
<th style="text-align:right;">
positive
</th>
<th style="text-align:right;">
all_positive
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:left;">
Study 1
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.406
</td>
<td style="text-align:right;">
0.256
</td>
<td style="text-align:right;">
0.968
</td>
<td style="text-align:right;">
0.938
</td>
</tr>
<tr>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:left;">
Study 2
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.998
</td>
<td style="text-align:right;">
0.256
</td>
<td style="text-align:right;">
1.000
</td>
<td style="text-align:right;">
0.938
</td>
</tr>
<tr>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:left;">
Study 3
</td>
<td style="text-align:right;">
0.2
</td>
<td style="text-align:right;">
0.616
</td>
<td style="text-align:right;">
0.256
</td>
<td style="text-align:right;">
0.966
</td>
<td style="text-align:right;">
0.938
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:left;">
Study 1
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.058
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.500
</td>
<td style="text-align:right;">
0.114
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:left;">
Study 2
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.052
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.506
</td>
<td style="text-align:right;">
0.114
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:left;">
Study 3
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.060
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.530
</td>
<td style="text-align:right;">
0.114
</td>
</tr>
</tbody>
</table></div>
<ul>
<li><p>Notice that, because the studies are independent, the probability that all
are significant is equal to the product of their power:
Pr(all studies significant) = Pr(Study 1 significant) <span class="math inline">\(\times\)</span>…<span class="math inline">\(\times\)</span> Pr(Study <span class="math inline">\(N\)</span> significant). Thus, if you only believe a theory if the studies conducted to test it yield significant results, and those studies are all powered at the conventionally accepted level of 80%, you erroneously reject the theory with a probability of <span class="math inline">\(.8^N\)</span>. If you do three, conventionally well-powered, randomized studies each shooting at the right quantity of interest, then in almost half of the cases where you are right, you will think
you are wrong.</p></li>
<li><p>Furthermore, notice how detrimental the addition of a small study can be by this metric, even if it gets at an important mechanism. As soon as you condition your inference about the theory being correct on the significance of all the observable implications, a low-powered test can sharply increase the risk of false rejection.</p></li>
<li><p>What can we say about the risk of false positives? The power of the individual studies is where it should be: for a stated error rate of <span class="math inline">\(\alpha = 0.05\)</span>, the studies are every so slightly anti-conservative. However, the “all significant” desideratum creates a rejection rate that is too high.</p></li>
<li><p>Some of these problems, though not all, are alleviated when we disregard significance and just look at signs. When the theory is right, there is a very good chance that all of the effects we estimate are positive: we surmise the theory is correct roughly 94% of the time when it actually is.</p></li>
<li><p>When the theory is not correct in the sense that the true effects are zero, random error means that they are positive half the time and negative the other half. Consequently, the probability of erroneously accepting the theory based on the sign of effects when the true underlying effects are zero is equal to <span class="math inline">\(0.5^N\)</span>. Here, that means we erroneously infer we are right at a relatively high rate of 12% of simulations.</p></li>
</ul>
<p>In the design above, the rates at which we rejected or accepted theories seemed
to depend on the number of studies we considered. In the graph below, we look
at twenty-nine different <span class="math inline">\(N\)</span>-study designs, all of which seek to confirm a theory
by replicating evidence for it <span class="math inline">\(N\)</span> times. The first design is made of two studies,
each independently evaluating the hypothesis that <span class="math inline">\(Y\)</span> is positively correlated with <span class="math inline">\(X\)</span>.
Again, we consider how conditioning an inference about the theory on whether
all results are significant or all results are positive affects error rates.</p>
<ul>
<li><p>Again, we see that significance is not a probative way to look for observable
theoretical implications. As soon as there are more than four studies,
there is virtually no chance of confirming even a true theory by this metric.
We see a sort of reverse multiple-comparisons problem: increasing the number
of tests makes false rejections increasingly more likely when we are interested
in the joint probability of all the tests saying the same thing.
Unless the number of studies is small, whether all produce significant results
essentially yields no information about whether the theory is correct.</p></li>
<li><p>By contrast, looking at signs only can be highly probative. In this
application, the optimal number of studies is about eight. At that point,
there is virtually no chance of erroneously inferring that the theory is
correct when the effects are zero, but when the theory is correct there is
a good chance (almost 75%) that all of the available evidence will be signed
accordingly. As the number of studies increases, so too does the probability
of discordant results, and using the unanimity of signs to judge whether
the theory is correct becomes increasingly unwise.</p></li>
</ul>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-401-1.svg" width="100%"></div>

<!-- bibliography: ../../bib/book.bib  -->
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="experimental-designs-for-causal-inference.html"><span class="header-section-number">17</span> Experimental designs for causal inference</a></div>
<div class="next"><a href="part-iii-exercises.html"><span class="header-section-number">19</span> Part III Exercises</a></div>
</div></main><div id="on-this-page-nav" class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#complex-designs-1"><span class="header-section-number">18</span> Complex designs</a></li>
<li>
<a class="nav-link" href="#discovery"><span class="header-section-number">18.1</span> Discovery</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#design-declaration"><span class="header-section-number">18.1.1</span> Design Declaration</a></li>
<li><a class="nav-link" href="#declaration-22"><span class="header-section-number">18.1.2</span> Declaration</a></li>
<li><a class="nav-link" href="#diagnosis-3"><span class="header-section-number">18.1.3</span> Diagnosis</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#structural-estimation"><span class="header-section-number">18.2</span> Structural estimation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#design"><span class="header-section-number">18.2.1</span> Design</a></li>
<li><a class="nav-link" href="#exercises-8"><span class="header-section-number">18.2.2</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#multi-site-trials"><span class="header-section-number">18.3</span> Multi-site trials</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#bayesian-estimation-can-improve-estimates-of-effects-for-sampled-sites"><span class="header-section-number">18.3.1</span> Bayesian estimation can improve estimates of effects for sampled sites</a></li></ul>
</li>
<li>
<a class="nav-link" href="#three-study-papers"><span class="header-section-number">18.4</span> Three-study papers</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#design-declaration-1"><span class="header-section-number">18.4.1</span> Design Declaration</a></li>
<li><a class="nav-link" href="#dag-21"><span class="header-section-number">18.4.2</span> DAG</a></li>
<li><a class="nav-link" href="#takeaways-1"><span class="header-section-number">18.4.3</span> Takeaways</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="download-code" href="./complex-designs-1.R"><i class="far fa-file-code"></i> Download R code</a></li>
          
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Research Design: Declare, Diagnose, Redesign</strong>" was written by Graeme Blair, Alexander Coppock, and Macartan Humphreys. </p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
