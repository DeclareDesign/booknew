<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 Software primer | Research Design: Declare, Diagnose, Redesign</title>
<meta name="author" content="Graeme Blair, Jasper Cooper, Alexander Coppock, and Macartan Humphreys">
<!-- CSS --><!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.1.9000/tabs.js"></script><script src="libs/bs3compat-0.2.1.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://hypothes.is/embed.js" async></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Research Design: Declare, Diagnose, Redesign</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li class="book-part">Introduction</li>
<li><a class="" href="preamble.html"><span class="header-section-number">1</span> Preamble</a></li>
<li><a class="" href="improving-research-designs.html"><span class="header-section-number">2</span> Improving research designs</a></li>
<li><a class="active" href="primer.html"><span class="header-section-number">3</span> Software primer</a></li>
<li><a class="" href="part-i-exercises.html"><span class="header-section-number">4</span> Part I Exercises</a></li>
<li class="book-part">Declaration, Diagnosis, Redesign</li>
<li><a class="" href="declaration.html"><span class="header-section-number">5</span> Declaration</a></li>
<li><a class="" href="specifying-the-model.html"><span class="header-section-number">6</span> Specifying the model</a></li>
<li><a class="" href="defining-the-inquiry.html"><span class="header-section-number">7</span> Defining the inquiry</a></li>
<li><a class="" href="crafting-a-data-strategy.html"><span class="header-section-number">8</span> Crafting a data strategy</a></li>
<li><a class="" href="choosing-an-answer-strategy.html"><span class="header-section-number">9</span> Choosing an answer strategy</a></li>
<li><a class="" href="p2diagnosis.html"><span class="header-section-number">10</span> Diagnosis</a></li>
<li><a class="" href="redesign-1.html"><span class="header-section-number">11</span> Redesign</a></li>
<li><a class="" href="part-ii-exercises.html"><span class="header-section-number">12</span> Part II Exercises</a></li>
<li class="book-part">Research Design Library</li>
<li><a class="" href="research-design-library.html"><span class="header-section-number">13</span> Research Design Library</a></li>
<li><a class="" href="observational-designs-for-descriptive-inference.html"><span class="header-section-number">14</span> Observational designs for descriptive inference</a></li>
<li><a class="" href="experimental-designs-for-descriptive-inference.html"><span class="header-section-number">15</span> Experimental designs for descriptive inference</a></li>
<li><a class="" href="observational-designs-for-causal-inference.html"><span class="header-section-number">16</span> Observational designs for causal inference</a></li>
<li><a class="" href="experimental-designs-for-causal-inference.html"><span class="header-section-number">17</span> Experimental designs for causal inference</a></li>
<li><a class="" href="multi-study-designs.html"><span class="header-section-number">18</span> Multi-study designs</a></li>
<li><a class="" href="part-iii-exercises.html"><span class="header-section-number">19</span> Part III Exercises</a></li>
<li class="book-part">Research Design Lifecycle</li>
<li><a class="" href="research-design-lifecycle.html"><span class="header-section-number">20</span> Research Design Lifecycle</a></li>
<li><a class="" href="part-iv-exercises.html"><span class="header-section-number">21</span> Part IV Exercises</a></li>
<li><a class="" href="glossary.html"><span class="header-section-number">22</span> Glossary</a></li>
<li><a class="" href="references-4.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="primer" class="section level1">
<h1>
<span class="header-section-number">3</span> Software primer<a class="anchor" aria-label="anchor" href="#primer"><i class="fas fa-link"></i></a>
</h1>
<!-- make sure to rename the section title below -->
<p>In this section, we introduce you to <code>DeclareDesign</code> for R and describe how to use it to implement each step of the design-diagnose-redesign process.</p>
<div id="installing-r" class="section level2">
<h2>
<span class="header-section-number">3.1</span> Installing R<a class="anchor" aria-label="anchor" href="#installing-r"><i class="fas fa-link"></i></a>
</h2>
<p>You can download the statistical computing environment R for free from <a href="https://cran.r-project.org">CRAN</a>. We also recommend the free program <a href="https://www.rstudio.com/products/rstudio/download">RStudio</a>, which provides a friendly interface to R.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Both R and RStudio are available on Windows, Mac, and Linux.&lt;/p&gt;"><sup>3</sup></a></p>
<p>Once you have got RStudio installed, open it up and install <code>DeclareDesign</code> and its related packages. These include three packages that enable specific steps in the research process (<code>fabricatr</code> for simulating social science data; <code>randomizr</code>, for random sampling and random assignment; and <code>estimatr</code> for design-based estimators). You can also install <code>DesignLibrary</code>, which gets standard designs up-and-running in one line. To install them, you can type:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DeclareDesign"</span>, <span class="st">"fabricatr"</span>, <span class="st">"randomizr"</span>, <span class="st">"estimatr"</span>, <span class="st">"DesignLibrary"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We also recommend that you install and get to know the <code>tidyverse</code> suite of packages for data analysis, which we will use throughout the book:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"tidyverse"</span><span class="op">)</span></code></pre></div>
<p>For introductions to R and the <code>tidyverse</code> we especially recommend the free resource <a href="https://r4ds.had.co.nz"><code>R for Data Science</code></a>.</p>
</div>
<div id="building-a-step-of-a-research-design" class="section level2">
<h2>
<span class="header-section-number">3.2</span> Building a step of a research design<a class="anchor" aria-label="anchor" href="#building-a-step-of-a-research-design"><i class="fas fa-link"></i></a>
</h2>
<p>A research design is a concatenation of steps so the best way to learn how to build a design is learn how to make a step. We will start out by making—or <em>declaring</em>—a step that implements random assignment.</p>
<p>Almost all steps take a dataset as input and return a dataset as output. We will will imagine input data that describes a set of voters in Los Angeles. The research project we are planning involves randomly assigning voters to receive (or not receive) a knock on their door from a canvasser. Our data look like this:</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:voterfile">Table 3.1: </span>Example data
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
sex
</th>
<th style="text-align:left;">
party
</th>
<th style="text-align:right;">
precinct
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
9104
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
8029
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
GRN
</td>
<td style="text-align:right;">
8383
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
2048
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
5210
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
53
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
2155
</td>
</tr>
</tbody>
</table></div>
<p>There are 100 voters in the dataset.</p>
<p>We want a function that takes this dataset, implements a random assignment, adds it to the dataset, and then returns the new dataset containing the random assignment.</p>
<p>You could write your own function to do that but you can also use one of the <code>declare_*</code> functions in <code>DeclareDesign</code> that are designed to write functions. Each one of these functions is a kind of <em>function factory</em>: it takes a set of parameters about your research design like the number of units and the random assignment probability as <em>inputs</em>, and returns a <em>function</em> as an output.</p>
<p>For generating assignment functions we can use <code>declare_assignment</code> like this:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simple_random_assignment_step</span> <span class="op">&lt;-</span> <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></code></pre></div>
<p>The big idea to understand here is that the object we created, <code>simple_random_assignment_step</code>, is not a particular assignment, it is a <em>function</em> that creates an assignment. In particular it is a tidy function that summarizes how your design does assignment. You can run the function on data:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">simple_random_assignment_step</span><span class="op">(</span><span class="va">voter_file</span><span class="op">)</span> </code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:voterfilera">Table 3.2: </span>Data output following implementation of an assignment step.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
sex
</th>
<th style="text-align:left;">
party
</th>
<th style="text-align:right;">
precinct
</th>
<th style="text-align:right;">
Z
</th>
<th style="text-align:right;">
Z_cond_prob
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
9104
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
8029
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
GRN
</td>
<td style="text-align:right;">
8383
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.6
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
2048
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
5210
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
53
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
2155
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4
</td>
</tr>
</tbody>
</table></div>
<p>The output here is an expanded dataset with a new column indicating treatment assignment (<code>Z</code>). As a bonus the data also includes the implied assignment propensity for each unit <em>to the condition in which it is in</em> (<code>Z_cond</code>). The most important thing to understand here is that implementing a step means taking a dataset in and sending a new dataset out.</p>
<p>A few parts of this step declaration may seem a little bit odd. First, we did not tell R anything about the number of units in our dataset. Second, we did not give it the data. This is because a step declaration creates functions that are meant to be flexible, function that will work on any size dataset. We told <code>declare_assignment</code> that we want to assign treatment with probability <code>0.6</code> (and implicitly control with probability <code>1-0.6 = 0.4</code>), regardless of how large the dataset is. We did not send the declaration the data because, although the assignment is a function of the data, the assignment <em>function</em> is not a function of the data. Put differently, the assignment function takes data as an argument, but the function to create the assignment function (<code>declare_assignment()</code>) does not.</p>
<p>When you implement your research design after you have conducted it, you can use the exact same functions you generated in this design phase. In the same way when you <em>diagnose</em> your design you will use the same function many times. This is one of the reasons we <em>declare</em> the assignment step — because we will learn about the properties of your design with the same code you can actually use to randomly assign treatment.</p>
<p>Every step of a research design in MIDA can be written using one of the <code>declare_*</code> functions. In the next section, we walk through each step and how to declare it using <code>DeclareDesign</code>.</p>
<div id="options-and-defaults" class="section level3">
<h3>
<span class="header-section-number">3.2.1</span> Options and defaults<a class="anchor" aria-label="anchor" href="#options-and-defaults"><i class="fas fa-link"></i></a>
</h3>
<p>Most of the <code>declare_*</code> functions have many options. In general you do not have to specify these as default values are usually provided (though you should be familiar with what these default values are). For instance you might have noticed above that when you ran the assignment step above, the new variable that was created was called <code>Z</code>. This is because <code>declare_assignment</code> has an argument <code>assignment_variable</code> that defaults to <code>Z</code>. You can change that of course to whatever you want.</p>
<p>More subtly, the <code>declare_*</code> functions also default to “handlers” which have their own default arguments. These handlers are generally quite well developed sets of functions that implement the tasks needed by the <code>declare_</code> function. For instance <code>declare_assignment</code> defaults to <code>conduct_ra</code> from the <code>randomizr</code> package as a handler and passes any additional arguments that you give it on to <code>conduct_ra</code>, and, by the same token, assumes by default the default values of the handler. In the example above we had <code>prob = 0.6</code> as an argument. If you look at the documentation, <code>prob</code> is not an argument of <code>declare_assignment</code> but it is an argument of <code>conduct_ra</code>, with a default value of .5. If we had left this bit out we would have gotten a function that assigned treatment with probability .5.</p>
</div>
<div id="your-own-handlers" class="section level3">
<h3>
<span class="header-section-number">3.2.2</span> Your own handlers<a class="anchor" aria-label="anchor" href="#your-own-handlers"><i class="fas fa-link"></i></a>
</h3>
<p>The built in functions we provide in the <code>DeclareDesign</code> package are quite flexible and handle many major designs but the framework is built so that you are never constrained by what we provide. At any point rather than using the default handlers (such as <code>conduct_ra</code>), you can write a function that implements your own procedures. The only discipline that the framework imposes is that you write your procedure as a function that takes data in and send data back.</p>
<p>Here is an example of how you turn your own functions into design steps.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">custom_assignment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
  <span class="fu">mutate</span><span class="op">(</span><span class="va">data</span>, X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>

<span class="va">my_assignment_step</span> <span class="op">&lt;-</span> <span class="fu">declare_assignment</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">custom_assignment</span><span class="op">)</span>

<span class="fu">my_assignment_step</span><span class="op">(</span><span class="va">voter_file</span><span class="op">)</span>  </code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:voterfilecustomfunction">Table 3.3: </span>Data generated using a custom function
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
sex
</th>
<th style="text-align:left;">
party
</th>
<th style="text-align:right;">
precinct
</th>
<th style="text-align:right;">
X
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
9104
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
8029
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
GRN
</td>
<td style="text-align:right;">
8383
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
2048
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
5210
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
53
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
2155
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table></div>
<p>There is, of course, no great difference in this example between <code>custom_assignment</code> and <code>my_assignment_step</code> since <code>my_assignment_step</code> is just a function that applies <code>custom_assignment</code>. Even still, it is worth declaring this step formally as a design step using <code>declare_assignment</code> since this lets <code>DeclareDesign</code> know how the step fits into the whole design, how to interpret it, and when to call it.</p>
</div>
</div>
<div id="research-design-steps" class="section level2">
<h2>
<span class="header-section-number">3.3</span> Research design steps<a class="anchor" aria-label="anchor" href="#research-design-steps"><i class="fas fa-link"></i></a>
</h2>
<p>In this section, we walk through how to declare each step of a research design using <code>DeclareDesign</code>. In the next section, we build those steps into a research design, and then describe how to interrogate the design.</p>
<div id="model" class="section level3">
<h3>
<span class="header-section-number">3.3.1</span> Model<a class="anchor" aria-label="anchor" href="#model"><i class="fas fa-link"></i></a>
</h3>
<p>The model defines the structure of the world, both its size and background characteristics as well as how interventions in the world determine outcomes. In <code>DeclareDesign</code>, we split the model into two main design steps: the population and potential outcomes steps. There</p>
<!-- is always one population in a design, but there can be multiple sets of potential outcomes. -->
<!-- ALWAYS ONE POPULATION -- OR ARE WE DESCRIBING SETS -->
<div id="population" class="section level4">
<h4>
<span class="header-section-number">3.3.1.1</span> Population<a class="anchor" aria-label="anchor" href="#population"><i class="fas fa-link"></i></a>
</h4>
<p>The population defines the number of units in the population, any multilevel structure to the data, and its background characteristics. We can define the population in several ways.</p>
<p>In some cases, you may start a design with data on the population. When that happens, we do not to simulate it. We can simply declare the data as our population:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_population</span><span class="op">(</span>data <span class="op">=</span> <span class="va">voter_file</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:voterfilepopulation">Table 3.4: </span>Draw from a fixed population
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
sex
</th>
<th style="text-align:left;">
party
</th>
<th style="text-align:right;">
precinct
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
9104
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
8029
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
GRN
</td>
<td style="text-align:right;">
8383
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
2048
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
5210
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
53
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
2155
</td>
</tr>
</tbody>
</table></div>
<p>When we do not have complete data on the population, we simulate it. Relying on the data simulation functions from our <code>fabricatr</code> package, <code>declare_population</code> asks about the size and variables of the population. For instance if we want a function that generates a dataset with 100 units and a random variable <code>u</code> we write:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>When we run this population function, we will get a different 100-unit dataset each time:</p>
<div class="inline-table"><table class="kable_wrapper">
<caption>
<span id="tab:threepopulationdraws">Table 3.5: </span>Three draws from the population function.
</caption>
<tbody><tr>
<td>
<table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
u
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
-0.319
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
1.168
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
1.697
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
0.931
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
-1.152
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
0.122
</td>
</tr>
</tbody>
</table>
</td>
<td>
<table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
u
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
0.189
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
0.691
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
0.822
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
-0.976
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
-1.295
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
0.863
</td>
</tr>
</tbody>
</table>
</td>
<td>
<table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
u
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
-1.280
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
1.880
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
0.597
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
-1.963
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
0.084
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
-1.693
</td>
</tr>
</tbody>
</table>
</td>
</tr></tbody>
</table></div>
<p>The <code>fabricatr</code> package can simulate many different typs of data, including various types of categorical variables or different types of data structures, such as panel or multilevel strucures.</p>
<p>You can read the <code>fabricatr</code> <a href="https://declaredesign.org/r/fabricatr/">website</a> to get started simulating your data structure.</p>
<p>As an exmaple of a simple two-level data structure, we imagine a setting with 100 households and random number of individuals within each household. This two level structure could be declared as:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_population</span><span class="op">(</span>
  households <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, individuals_per_hh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
  individuals <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">individuals_per_hh</span>, age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Remember, in every step of the research design process, you can short-circuit our default way of doing things and bring in your own code. This is useful when you have a complex design, or when you have already written code for your design and you want to use it directly. It works by setting the handler:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">complex_population_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">N_units</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_units</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">declare_population</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">complex_population_function</span>, N_units <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
</div>
<div id="potential-outcomes" class="section level4">
<h4>
<span class="header-section-number">3.3.1.2</span> Potential outcomes<a class="anchor" aria-label="anchor" href="#potential-outcomes"><i class="fas fa-link"></i></a>
</h4>
<p>Defining potential outcomes is as easy as a single expression per potential outcome. These may be a function of background characteristics, other potential outcomes, or other R functions.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Typically, we think of potential outcomes as fixed and not random, and move random variables to the population.&lt;/p&gt;"><sup>4</sup></a></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_potential_outcomes</span><span class="op">(</span>
  Y_Z_0 <span class="op">=</span> <span class="va">u</span>, 
  Y_Z_1 <span class="op">=</span> <span class="va">Y_Z_0</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>Y_Z_0 <span class="op">=</span> <span class="va">u</span>, Y_Z_1 <span class="op">=</span> <span class="va">Y_Z_0</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">)</span>

<span class="fu">draw_data</span><span class="op">(</span><span class="va">des</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:potentialoutcomesdraw">Table 3.6: </span>Adding potential outcomes to the population.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
u
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
-0.379
</td>
<td style="text-align:right;">
-0.379
</td>
<td style="text-align:right;">
-0.129
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
-0.346
</td>
<td style="text-align:right;">
-0.346
</td>
<td style="text-align:right;">
-0.096
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
-0.641
</td>
<td style="text-align:right;">
-0.641
</td>
<td style="text-align:right;">
-0.391
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
0.402
</td>
<td style="text-align:right;">
0.402
</td>
<td style="text-align:right;">
0.652
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
0.335
</td>
<td style="text-align:right;">
0.335
</td>
<td style="text-align:right;">
0.585
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
0.068
</td>
<td style="text-align:right;">
0.068
</td>
<td style="text-align:right;">
0.318
</td>
</tr>
</tbody>
</table></div>
<p>We also have a simpler interface to define all the potential outcomes at once as a function of a treatment assignment variable. The names of the potential outcomes are constructed from the outcome name (here <code>Y</code> on the lefthand side of the formula) and from the <code>assignment_variables</code> argument (here <code>Z</code>).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">u</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">Z</span>, assignment_variables <span class="op">=</span> <span class="va">Z</span><span class="op">)</span></code></pre></div>
<p>Either way of creating potential outcomes works; one may be easier or harder to code up in a given research design setting.</p>
</div>
</div>
<div id="inquiry" class="section level3">
<h3>
<span class="header-section-number">3.3.2</span> Inquiry<a class="anchor" aria-label="anchor" href="#inquiry"><i class="fas fa-link"></i></a>
</h3>
<p>To define your inquiry, declare your estimand, which is a function of background characteristics from your population, potential outcomes, or both. We define the average treatment effect for the experiment in our simple design as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Notice that we defined the PATE (the <em>population</em> average treatment effect), but said nothing special related to the population. In fact, it looks like we just defined the average treatment effect. This is because where you define the estimand in your design is going to determine whether it refers to the population, sample, or other form of estimand. We will see how to do this in a moment.</p>
</div>
<div id="data-strategy" class="section level3">
<h3>
<span class="header-section-number">3.3.3</span> Data strategy<a class="anchor" aria-label="anchor" href="#data-strategy"><i class="fas fa-link"></i></a>
</h3>
<p>The data strategy constitutes one or more steps representing interventions the researcher makes in the world from sampling to assignment to measurement. Typically, this may include sampling and assignment.</p>
<div id="sampling" class="section level4">
<h4>
<span class="header-section-number">3.3.3.1</span> Sampling<a class="anchor" aria-label="anchor" href="#sampling"><i class="fas fa-link"></i></a>
</h4>
<p>The sampling step relies on the <code>randomizr</code> package to conduct random sampling. See Section <a href="crafting-a-data-strategy.html#p2sampling">8.1</a> for an overview of the many kinds of sampling that are possible. We define a simple 50-unit sample from the population as follows:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></code></pre></div>
<p>When we draw data from our simple design at this point, it will be smaller: from 100 units in the population to a data frame of 50 units representing the sample. In the data frame, we have an inclusion probability, the probability of being included in the sample. <code>randomizr</code> includes this by default. In this case, every unit in the population had an equal 0.5 probability of inclusion.</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:sampleddatadraw">Table 3.7: </span>Sampled data.
</caption>
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
u
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
<th style="text-align:right;">
S_inclusion_prob
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
2.445
</td>
<td style="text-align:right;">
2.445
</td>
<td style="text-align:right;">
2.695
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
8
</td>
<td style="text-align:left;">
008
</td>
<td style="text-align:right;">
0.404
</td>
<td style="text-align:right;">
0.404
</td>
<td style="text-align:right;">
0.654
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
9
</td>
<td style="text-align:left;">
009
</td>
<td style="text-align:right;">
0.609
</td>
<td style="text-align:right;">
0.609
</td>
<td style="text-align:right;">
0.859
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
10
</td>
<td style="text-align:left;">
010
</td>
<td style="text-align:right;">
-1.062
</td>
<td style="text-align:right;">
-1.062
</td>
<td style="text-align:right;">
-0.812
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
12
</td>
<td style="text-align:left;">
012
</td>
<td style="text-align:right;">
1.410
</td>
<td style="text-align:right;">
1.410
</td>
<td style="text-align:right;">
1.660
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
14
</td>
<td style="text-align:left;">
014
</td>
<td style="text-align:right;">
-0.571
</td>
<td style="text-align:right;">
-0.571
</td>
<td style="text-align:right;">
-0.321
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
</tbody>
</table></div>
<p>Sampling could also be non-random, which could be accomplished by using a handler.</p>
</div>
<div id="assignment" class="section level4">
<h4>
<span class="header-section-number">3.3.3.2</span> Assignment<a class="anchor" aria-label="anchor" href="#assignment"><i class="fas fa-link"></i></a>
</h4>
<p>Assignment also relies, by default, on the <code>randomizr</code> package for random assignment. Here, we define assignment as a 50% probability of assignment to treatment and 50% to control.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></code></pre></div>
<p>Assignment results in a data frame with an additional indicator <code>Z</code> of the assignment as well as the probability of assignment. Again, here the assignment probabilities are constant, but in other designs described in Section <a href="crafting-a-data-strategy.html#p2assignment">8.2</a> they are not and this is crucial information for the analysis stage.</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignassignment">Table 3.8: </span>Sampled data with assignment indicator.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
u
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
<th style="text-align:right;">
S_inclusion_prob
</th>
<th style="text-align:right;">
Z
</th>
<th style="text-align:right;">
Z_cond_prob
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
1.267
</td>
<td style="text-align:right;">
1.267
</td>
<td style="text-align:right;">
1.517
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
0.934
</td>
<td style="text-align:right;">
0.934
</td>
<td style="text-align:right;">
1.184
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
0.927
</td>
<td style="text-align:right;">
0.927
</td>
<td style="text-align:right;">
1.177
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
008
</td>
<td style="text-align:right;">
-0.668
</td>
<td style="text-align:right;">
-0.668
</td>
<td style="text-align:right;">
-0.418
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
011
</td>
<td style="text-align:right;">
1.674
</td>
<td style="text-align:right;">
1.674
</td>
<td style="text-align:right;">
1.924
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
017
</td>
<td style="text-align:right;">
-0.078
</td>
<td style="text-align:right;">
-0.078
</td>
<td style="text-align:right;">
0.172
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="other-data-strategies" class="section level4">
<h4>
<span class="header-section-number">3.3.3.3</span> Other data strategies<a class="anchor" aria-label="anchor" href="#other-data-strategies"><i class="fas fa-link"></i></a>
</h4>
<p>Random sampling and random assignment are not the only kinds of data strategies. Others may include merging in fixed administrative data from other sources, collapsing data across months or days, and other operations. You can include these as steps in your design too, using <code>declare_step</code>. Here, you must define a handler, as we did for using a custom function in <code>declare_population</code>. Some handlers that may prove useful are the <code>dplyr</code> verbs such as <code>mutate</code> and <code>summarize</code>, and the <code>fabricate</code> function from our <code>fabricatr</code> package.</p>
<p>To add a variable using fabricate:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_step</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">fabricate</span>, add_variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>If you have district-month data you may want to analyze at the district level, collapsing across months:<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;The &lt;code&gt;{{ }}&lt;/code&gt; syntax is handy for writing functions in &lt;code&gt;dplyr&lt;/code&gt; where you want to be able reuse the function with different variable names. Here, the &lt;code&gt;collapse_data&lt;/code&gt; function will &lt;code&gt;group_by&lt;/code&gt; the variable you send to the argument &lt;code&gt;collapse_by&lt;/code&gt;, which in our declaration we set to &lt;code&gt;district&lt;/code&gt;. The pipeline within the function then calculates the mean in each district.&lt;/p&gt;"><sup>5</sup></a></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">collapse_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">collapse_by</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu">group_by</span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">collapse_by</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">summarize_all</span><span class="op">(</span><span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">declare_step</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">collapse_data</span>, collapse_by <span class="op">=</span> <span class="va">district</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="answer-strategy" class="section level3">
<h3>
<span class="header-section-number">3.3.4</span> Answer strategy<a class="anchor" aria-label="anchor" href="#answer-strategy"><i class="fas fa-link"></i></a>
</h3>
<p>Through our model and data strategy steps, we have simulated a dataset with two key inputs to the answer strategy: an assignment variable and an outcome. In other answer strategies, pretreatment characteristics from the model might also be relevant. The data look like this:</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignrevealedoutcomes">Table 3.9: </span>Data with revealed outcomes.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
u
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
<th style="text-align:right;">
S_inclusion_prob
</th>
<th style="text-align:right;">
Z
</th>
<th style="text-align:right;">
Z_cond_prob
</th>
<th style="text-align:right;">
Y
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
-0.529
</td>
<td style="text-align:right;">
-0.529
</td>
<td style="text-align:right;">
-0.279
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.529
</td>
</tr>
<tr>
<td style="text-align:left;">
007
</td>
<td style="text-align:right;">
-0.251
</td>
<td style="text-align:right;">
-0.251
</td>
<td style="text-align:right;">
-0.001
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.251
</td>
</tr>
<tr>
<td style="text-align:left;">
008
</td>
<td style="text-align:right;">
-0.686
</td>
<td style="text-align:right;">
-0.686
</td>
<td style="text-align:right;">
-0.436
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.686
</td>
</tr>
<tr>
<td style="text-align:left;">
014
</td>
<td style="text-align:right;">
-0.097
</td>
<td style="text-align:right;">
-0.097
</td>
<td style="text-align:right;">
0.153
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.097
</td>
</tr>
<tr>
<td style="text-align:left;">
016
</td>
<td style="text-align:right;">
1.597
</td>
<td style="text-align:right;">
1.597
</td>
<td style="text-align:right;">
1.847
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.597
</td>
</tr>
<tr>
<td style="text-align:left;">
017
</td>
<td style="text-align:right;">
-0.451
</td>
<td style="text-align:right;">
-0.451
</td>
<td style="text-align:right;">
-0.201
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.451
</td>
</tr>
</tbody>
</table></div>
<p>Our estimator is the difference-in-means estimator, which compares outcomes between the group that was assigned to treatment and that assigned to control. The <code>estimatr</code> package makes this easy and calculates the design-based standard error and a p-value and confidence interval for you:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">difference_in_means</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, data <span class="op">=</span> <span class="va">simple_design_data</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesigndimestimate">Table 3.10: </span>Difference-in-means estimate from simulated data.
</caption>
<thead><tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
<th style="text-align:right;">
conf.low
</th>
<th style="text-align:right;">
conf.high
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:left;">
outcome
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.283
</td>
<td style="text-align:right;">
0.29
</td>
<td style="text-align:right;">
0.979
</td>
<td style="text-align:right;">
0.332
</td>
<td style="text-align:right;">
-0.299
</td>
<td style="text-align:right;">
0.866
</td>
<td style="text-align:right;">
47.727
</td>
<td style="text-align:left;">
Y
</td>
</tr></tbody>
</table></div>
<p>Now, in order to <em>declare</em> our estimator, we can send the name of a model to <code>declare_estimator</code>. R has many models that work with <code>declare_estimator</code>, including <code>lm</code>, <code>glm</code>, the <code>ictreg</code> package from the <code>list</code> package, etc. The design-based estimators from <code>estimatr</code> can all be used.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, estimand <span class="op">=</span> <span class="st">"PATE"</span><span class="op">)</span></code></pre></div>
<p>In this declaration, we also define the estimand we are targeting with the difference-in-means estimator.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Sometimes, you may be interested just in the properties of an estimator, such as calculating its power. In this case, you need not define an estimand.&lt;/p&gt;"><sup>6</sup></a> Typically, you will have an estimand that you are targeting, and sometimes you may consider targeting more than one and assessing how good your estimator estimates them. For example, you may want to know how good a job your instrumental variables job is at targeting the complier average causal effect, but also how close it gets on average to the average treatment effect.</p>
</div>
</div>
<div id="building-a-design-from-design-steps" class="section level2">
<h2>
<span class="header-section-number">3.4</span> Building a design from design steps<a class="anchor" aria-label="anchor" href="#building-a-design-from-design-steps"><i class="fas fa-link"></i></a>
</h2>
<p>In the last section, we defined a set of individual research steps. We draw one version of them together here:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">population</span> <span class="op">&lt;-</span> <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> 
<span class="va">potential_outcomes</span> <span class="op">&lt;-</span> <span class="fu">declare_potential_outcomes</span><span class="op">(</span>Y_Z_0 <span class="op">=</span> <span class="va">u</span>, Y_Z_1 <span class="op">=</span> <span class="va">Y_Z_0</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">)</span> 
<span class="va">estimand</span> <span class="op">&lt;-</span> <span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> 
<span class="va">sampling</span> <span class="op">&lt;-</span> <span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> 
<span class="va">assignment</span> <span class="op">&lt;-</span> <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> 
<span class="va">reveal</span> <span class="op">&lt;-</span> <span class="fu">declare_reveal</span><span class="op">(</span>outcome_variables <span class="op">=</span> <span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="va">Z</span><span class="op">)</span> 
<span class="va">estimator</span> <span class="op">&lt;-</span> <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, estimand <span class="op">=</span> <span class="st">"PATE"</span><span class="op">)</span></code></pre></div>
<p>To construct a research design <em>object</em> that we can operate on — diagnose it, redesign it, draw data from it, etc. — we add them together with the <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> operator. The <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> creates a design object.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simple_design</span> <span class="op">&lt;-</span> 
  <span class="va">population</span> <span class="op">+</span> <span class="va">potential_outcomes</span> <span class="op">+</span> <span class="va">estimand</span> <span class="op">+</span> <span class="va">sampling</span> <span class="op">+</span> <span class="va">assignment</span> <span class="op">+</span> <span class="va">reveal</span> <span class="op">+</span> <span class="va">estimator</span></code></pre></div>
<p>In the book, we’ll use a more compact way of writing a design, where we define it all at once with the <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code>:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simple_design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>Y_Z_0 <span class="op">=</span> <span class="va">u</span>, Y_Z_1 <span class="op">=</span> <span class="va">Y_Z_0</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span>outcome_variables <span class="op">=</span> <span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, estimand <span class="op">=</span> <span class="st">"PATE"</span><span class="op">)</span></code></pre></div>
<div id="order-matters" class="section level3">
<h3>
<span class="header-section-number">3.4.1</span> Order matters<a class="anchor" aria-label="anchor" href="#order-matters"><i class="fas fa-link"></i></a>
</h3>
<p>When defining a design, the order steps are included in the design via the <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> operator matters. Think of the order of your design as the causal order in which steps take place.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">population</span> <span class="op">+</span> <span class="va">potential_outcomes</span> <span class="op">+</span> <span class="va">estimand</span> <span class="op">+</span> <span class="va">sampling</span> <span class="op">+</span> <span class="va">assignment</span> <span class="op">+</span> <span class="va">reveal</span> <span class="op">+</span> <span class="va">estimator</span></code></pre></div>
<p>The order encodes several important aspects of the design:
- First, the fact that the estimand follows the potential outcomes and comes before sampling and assignment means it is a <em>population</em> estimand, the population average treatment effect. This is because it is calculated on the data created <em>so far</em>.
- The estimator comes after the assignment and reveal outcomes steps. If it didn’t, our difference-in-means would not work, because it wouldn’t have access to the treatment variable and the realized outcomes.</p>
</div>
</div>
<div id="simulating-a-research-design" class="section level2">
<h2>
<span class="header-section-number">3.5</span> Simulating a research design<a class="anchor" aria-label="anchor" href="#simulating-a-research-design"><i class="fas fa-link"></i></a>
</h2>
<p>Diagnosing a research design — learning about its properties — requires first simulating running the design over and over. We need to simulate the data generating process, then calculate the estimands, then calculate the estimates that will result.</p>
<p>With simple design defined as an object, we can easily learn about what kind of data it generates, the values of its estimand and estimates, and other features with simple funtions in <code>DeclareDesign</code>. They chain together functions in a similar way to a <code>dplyr</code> or <code>ggplot</code> pipeline.</p>
<p>To draw simulated data based on the design, we use <code>draw_data</code>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">draw_data</span><span class="op">(</span><span class="va">simple_design</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesigndatadraw">Table 3.11: </span>Simulated data draw.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
u
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
<th style="text-align:right;">
S_inclusion_prob
</th>
<th style="text-align:right;">
Z
</th>
<th style="text-align:right;">
Z_cond_prob
</th>
<th style="text-align:right;">
Y
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
-1.127
</td>
<td style="text-align:right;">
-1.127
</td>
<td style="text-align:right;">
-0.877
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.877
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
-0.956
</td>
<td style="text-align:right;">
-0.956
</td>
<td style="text-align:right;">
-0.706
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.956
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
-0.692
</td>
<td style="text-align:right;">
-0.692
</td>
<td style="text-align:right;">
-0.442
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.692
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
-0.445
</td>
<td style="text-align:right;">
-0.445
</td>
<td style="text-align:right;">
-0.195
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.195
</td>
</tr>
<tr>
<td style="text-align:left;">
007
</td>
<td style="text-align:right;">
0.704
</td>
<td style="text-align:right;">
0.704
</td>
<td style="text-align:right;">
0.954
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.704
</td>
</tr>
<tr>
<td style="text-align:left;">
008
</td>
<td style="text-align:right;">
-0.603
</td>
<td style="text-align:right;">
-0.603
</td>
<td style="text-align:right;">
-0.353
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.603
</td>
</tr>
</tbody>
</table></div>
<p><code>draw_data</code> runs all of the “data steps” in a design, which are both from the model (population and potential outcomes) and from the data strategy (typically sampling and assignment).</p>
<p>To simulate the estimands from a single run of the design, we use <code>draw_estimands</code>. This runs two operations at once: it draws the data, and calculates the estimands at the point defined by the design. For example, in our design the estimand comes just after the potential outcomes. In this design, <code>draw_estimands</code> will run the first two steps and then calculate the estimands from the <code>estimand</code> function we declared:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">draw_estimands</span><span class="op">(</span><span class="va">simple_design</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignestimanddraw">Table 3.12: </span>Estimands calculated from simulated data.
</caption>
<thead><tr>
<th style="text-align:left;">
estimand_label
</th>
<th style="text-align:right;">
estimand
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:right;">
0.25
</td>
</tr></tbody>
</table></div>
<p>Similarly, we can draw the estimates from a single run with <code>draw_estimates</code> which simulates data and at the appropriate moment calculates estimates.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">draw_estimates</span><span class="op">(</span><span class="va">simple_design</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignestimatedraw">Table 3.13: </span>Estimates calculated from simulated data.
</caption>
<thead><tr>
<th style="text-align:left;">
estimator_label
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
<th style="text-align:right;">
conf.low
</th>
<th style="text-align:right;">
conf.high
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:left;">
outcome
</th>
<th style="text-align:left;">
estimand_label
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.301
</td>
<td style="text-align:right;">
0.304
</td>
<td style="text-align:right;">
0.991
</td>
<td style="text-align:right;">
0.327
</td>
<td style="text-align:right;">
-0.31
</td>
<td style="text-align:right;">
0.912
</td>
<td style="text-align:right;">
47.073
</td>
<td style="text-align:left;">
Y
</td>
<td style="text-align:left;">
PATE
</td>
</tr></tbody>
</table></div>
<p>To diagnose a design, we want a data frame that includes the estimates <em>and</em> estimands from many runs of a design. That is, we want to run the design, draw estimates and estimands, and then do that over and over and stack the results. This is exactly what <code>simulate_design</code> does:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">simulate_design</span><span class="op">(</span><span class="va">simple_design</span>, sims <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignsimulationsdf">Table 3.14: </span>Simulations data frame.
</caption>
<thead><tr>
<th style="text-align:left;">
design_label
</th>
<th style="text-align:right;">
sim_ID
</th>
<th style="text-align:left;">
estimand_label
</th>
<th style="text-align:right;">
estimand
</th>
<th style="text-align:left;">
estimator_label
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
<th style="text-align:right;">
conf.low
</th>
<th style="text-align:right;">
conf.high
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:left;">
outcome
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
simple_design
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.309
</td>
<td style="text-align:right;">
0.292
</td>
<td style="text-align:right;">
1.058
</td>
<td style="text-align:right;">
0.295
</td>
<td style="text-align:right;">
-0.278
</td>
<td style="text-align:right;">
0.896
</td>
<td style="text-align:right;">
47.995
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
simple_design
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
-0.274
</td>
<td style="text-align:right;">
0.288
</td>
<td style="text-align:right;">
-0.952
</td>
<td style="text-align:right;">
0.346
</td>
<td style="text-align:right;">
-0.854
</td>
<td style="text-align:right;">
0.305
</td>
<td style="text-align:right;">
47.992
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
simple_design
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.263
</td>
<td style="text-align:right;">
0.265
</td>
<td style="text-align:right;">
0.991
</td>
<td style="text-align:right;">
0.327
</td>
<td style="text-align:right;">
-0.271
</td>
<td style="text-align:right;">
0.796
</td>
<td style="text-align:right;">
47.519
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
simple_design
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.155
</td>
<td style="text-align:right;">
0.302
</td>
<td style="text-align:right;">
0.515
</td>
<td style="text-align:right;">
0.609
</td>
<td style="text-align:right;">
-0.451
</td>
<td style="text-align:right;">
0.762
</td>
<td style="text-align:right;">
47.933
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
simple_design
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
-0.203
</td>
<td style="text-align:right;">
0.280
</td>
<td style="text-align:right;">
-0.726
</td>
<td style="text-align:right;">
0.471
</td>
<td style="text-align:right;">
-0.765
</td>
<td style="text-align:right;">
0.359
</td>
<td style="text-align:right;">
47.988
</td>
<td style="text-align:left;">
Y
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="diagnosing-a-research-design" class="section level2">
<h2>
<span class="header-section-number">3.6</span> Diagnosing a research design<a class="anchor" aria-label="anchor" href="#diagnosing-a-research-design"><i class="fas fa-link"></i></a>
</h2>
<p>The simulations data frame we created allows us to diagnose the design (calculate summary statistics from the simulations) directly. We can now calculate the bias, root mean-squared error, and power for each estimator-estimand pair. In <code>DeclareDesign</code>, we do this in two steps. First, declare your diagnosands. These are functions of the simulations data. We have precoded several standard diagnosands (see Section <a href="p2diagnosis.html#p2diagnosis">10</a>).</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">study_diagnosands</span> <span class="op">&lt;-</span> <span class="fu">declare_diagnosands</span><span class="op">(</span>
  select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bias</span>, <span class="va">rmse</span>, <span class="va">power</span><span class="op">)</span>, 
  mse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next, take your simulations data and the diagnosands, and diagnose. This runs a single operation, which is to calculate the diagnosands on your simulations data.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">diagnose_design</span><span class="op">(</span><span class="va">simulations_df</span>, diagnosands <span class="op">=</span> <span class="va">study_diagnosands</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesigndiagnosis2">Table 3.15: </span>Design diagnosis.
</caption>
<thead><tr>
<th style="text-align:left;">
design_label
</th>
<th style="text-align:left;">
estimand_label
</th>
<th style="text-align:left;">
estimator_label
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
mse
</th>
<th style="text-align:right;">
se(mse)
</th>
<th style="text-align:right;">
bias
</th>
<th style="text-align:right;">
se(bias)
</th>
<th style="text-align:right;">
rmse
</th>
<th style="text-align:right;">
se(rmse)
</th>
<th style="text-align:right;">
power
</th>
<th style="text-align:right;">
se(power)
</th>
<th style="text-align:right;">
n_sims
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
simple_design
</td>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.099
</td>
<td style="text-align:right;">
0.052
</td>
<td style="text-align:right;">
-0.2
</td>
<td style="text-align:right;">
0.109
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:right;">
0.086
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5
</td>
</tr></tbody>
</table></div>
<p>We can also do this in a single step. When you send <code>diagnose_design</code> a design object, it will first run the simulations for you, then calculate the diagnosands from the simulations data frame that results.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">diagnose_design</span><span class="op">(</span><span class="va">simple_design</span>, diagnosands <span class="op">=</span> <span class="va">study_diagnosands</span><span class="op">)</span></code></pre></div>
</div>
<div id="comparing-designs" class="section level2">
<h2>
<span class="header-section-number">3.7</span> Comparing designs<a class="anchor" aria-label="anchor" href="#comparing-designs"><i class="fas fa-link"></i></a>
</h2>
<p>In the diagnosis phase, you will often want to compare the properties of two designs to see which you prefer on the basis of the diagnosand values. We have two ways to compare. First, we can compare the designs themselves — what kinds of estimates and estimands do they produce, what steps are in the design. And we can compare the diagnoses.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">compare_designs</span><span class="op">(</span><span class="va">simple_design</span>, <span class="va">redesigned_simple_design</span><span class="op">)</span></code></pre></div>
<p>To compare the diagnoses, we run a diagnosis for each one and then calculate the difference between each diagnosand for the two designs and conduct a statistical test of the null effect of no difference.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">compare_diagnoses</span><span class="op">(</span><span class="va">simple_design</span>, <span class="va">redesigned_simple_design</span><span class="op">)</span></code></pre></div>
<div id="comparing-many-variants-of-a-design" class="section level3">
<h3>
<span class="header-section-number">3.7.1</span> Comparing many variants of a design<a class="anchor" aria-label="anchor" href="#comparing-many-variants-of-a-design"><i class="fas fa-link"></i></a>
</h3>
<p>In the diagnosis phase, you will often want to compare the properties of two designs to see which you prefer on the basis of the diagnosand values. We have two ways to compare. First, we can compare the designs themselves — what kinds of estimates and estimands do they produce, what steps are in the design. And we can compare the diagnoses. We can do this using <code>redesign</code>:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">redesign</span><span class="op">(</span><span class="va">simple_design</span>, N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span>, <span class="fl">400</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>An alternative way to do this is to write a function that makes designs based on a set of these design inputs. This offers the researcher more flexibility in setting up the design variants. We call these functions <em>designers</em>. Here’s a simple designer based on our running example:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simple_designer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sample_size</span>, <span class="va">effect_size</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="va">sample_size</span>, u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_potential_outcomes</span><span class="op">(</span>Y_Z_0 <span class="op">=</span> <span class="va">u</span>, Y_Z_1 <span class="op">=</span> <span class="va">Y_Z_0</span> <span class="op">+</span> <span class="va">effect_size</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_reveal</span><span class="op">(</span>outcome_variables <span class="op">=</span> <span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, estimand <span class="op">=</span> <span class="st">"PATE"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>To create a single design, based on our original parameters of a 100-unit sample size and a treatment effect of <code>0.25</code>, we can run:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simple_design</span> <span class="op">&lt;-</span> <span class="fu">simple_designer</span><span class="op">(</span>sample_size <span class="op">=</span> <span class="fl">100</span>, effect_size <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></code></pre></div>
<p>Now to simulate multiple designs, we can use the <code>DeclareDesign</code> function <code>expand_design</code>. Here we examine our simple design under several possible sample sizes, which we might want to do to conduct a minimum power analysis. We hold the effect size constant.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simple_designs</span> <span class="op">&lt;-</span> <span class="fu">expand_design</span><span class="op">(</span><span class="va">simple_designer</span>, sample_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span>, <span class="fl">1000</span><span class="op">)</span>, effect_size <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></code></pre></div>
<p>Our simulation and diagnosis tools can take a set of expanded designs (an R list) and will simulate all of them at once, creating a column called <code>design_label</code> to keep them apart. For example:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">diagnose_design</span><span class="op">(</span><span class="va">simple_designs</span><span class="op">)</span></code></pre></div>
</div>
<div id="library-of-designs" class="section level3">
<h3>
<span class="header-section-number">3.7.2</span> Library of designs<a class="anchor" aria-label="anchor" href="#library-of-designs"><i class="fas fa-link"></i></a>
</h3>
<p>In our <code>DesignLibrary</code> package, we have created a set of common designs as designers, so you can get started quickly and also easily set up a range of design variants for comparison.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://declaredesign.org/library/">DesignLibrary</a></span><span class="op">)</span>

<span class="va">b_c_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DesignLibrary/man/block_cluster_two_arm_designer.html">block_cluster_two_arm_designer</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">1000</span>, N_blocks <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="fu">diagnose_design</span><span class="op">(</span><span class="va">b_c_design</span><span class="op">)</span></code></pre></div>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="improving-research-designs.html"><span class="header-section-number">2</span> Improving research designs</a></div>
<div class="next"><a href="part-i-exercises.html"><span class="header-section-number">4</span> Part I Exercises</a></div>
</div></main><div id="on-this-page-nav" class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#primer"><span class="header-section-number">3</span> Software primer</a></li>
<li><a class="nav-link" href="#installing-r"><span class="header-section-number">3.1</span> Installing R</a></li>
<li>
<a class="nav-link" href="#building-a-step-of-a-research-design"><span class="header-section-number">3.2</span> Building a step of a research design</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#options-and-defaults"><span class="header-section-number">3.2.1</span> Options and defaults</a></li>
<li><a class="nav-link" href="#your-own-handlers"><span class="header-section-number">3.2.2</span> Your own handlers</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#research-design-steps"><span class="header-section-number">3.3</span> Research design steps</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#model"><span class="header-section-number">3.3.1</span> Model</a></li>
<li><a class="nav-link" href="#inquiry"><span class="header-section-number">3.3.2</span> Inquiry</a></li>
<li><a class="nav-link" href="#data-strategy"><span class="header-section-number">3.3.3</span> Data strategy</a></li>
<li><a class="nav-link" href="#answer-strategy"><span class="header-section-number">3.3.4</span> Answer strategy</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#building-a-design-from-design-steps"><span class="header-section-number">3.4</span> Building a design from design steps</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#order-matters"><span class="header-section-number">3.4.1</span> Order matters</a></li></ul>
</li>
<li><a class="nav-link" href="#simulating-a-research-design"><span class="header-section-number">3.5</span> Simulating a research design</a></li>
<li><a class="nav-link" href="#diagnosing-a-research-design"><span class="header-section-number">3.6</span> Diagnosing a research design</a></li>
<li>
<a class="nav-link" href="#comparing-designs"><span class="header-section-number">3.7</span> Comparing designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#comparing-many-variants-of-a-design"><span class="header-section-number">3.7.1</span> Comparing many variants of a design</a></li>
<li><a class="nav-link" href="#library-of-designs"><span class="header-section-number">3.7.2</span> Library of designs</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Research Design: Declare, Diagnose, Redesign</strong>" was written by Graeme Blair, Jasper Cooper, Alexander Coppock, and Macartan Humphreys. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>Supported by the Laura and John Arnold Foundation and Evidence in Governance and Politics.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
