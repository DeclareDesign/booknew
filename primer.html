<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 Software primer | Research Design: Declare, Diagnose, Redesign</title>
<meta name="author" content="Graeme Blair, Alexander Coppock, and Macartan Humphreys">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.2.9000/tabs.js"></script><script src="libs/bs3compat-0.2.2.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<link href="libs/bs4_book-1.0.0/dd_imgpopup.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/bs4_book-1.0.0/dd_imgpopup.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://hypothes.is/embed.js" async></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Research Design: Declare, Diagnose, Redesign</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li class="book-part">Introduction</li>
<li><a class="" href="preamble.html"><span class="header-section-number">1</span> Preamble</a></li>
<li><a class="" href="improving-research-designs.html"><span class="header-section-number">2</span> Improving research designs</a></li>
<li><a class="active" href="primer.html"><span class="header-section-number">3</span> Software primer</a></li>
<li><a class="" href="part-i-exercises.html"><span class="header-section-number">4</span> Part I Exercises</a></li>
<li class="book-part">Declaration, Diagnosis, Redesign</li>
<li><a class="" href="declaration.html"><span class="header-section-number">5</span> Declaration</a></li>
<li><a class="" href="specifying-the-model.html"><span class="header-section-number">6</span> Specifying the model</a></li>
<li><a class="" href="defining-the-inquiry.html"><span class="header-section-number">7</span> Defining the inquiry</a></li>
<li><a class="" href="crafting-a-data-strategy.html"><span class="header-section-number">8</span> Crafting a data strategy</a></li>
<li><a class="" href="choosing-an-answer-strategy.html"><span class="header-section-number">9</span> Choosing an answer strategy</a></li>
<li><a class="" href="p2diagnosis.html"><span class="header-section-number">10</span> Diagnosis</a></li>
<li><a class="" href="redesign-2.html"><span class="header-section-number">11</span> Redesign</a></li>
<li><a class="" href="part-ii-exercises.html"><span class="header-section-number">12</span> Part II Exercises</a></li>
<li class="book-part">Research Design Library</li>
<li><a class="" href="research-design-library.html"><span class="header-section-number">13</span> Research Design Library</a></li>
<li><a class="" href="observational-designs-for-descriptive-inference.html"><span class="header-section-number">14</span> Observational designs for descriptive inference</a></li>
<li><a class="" href="experimental-designs-for-descriptive-inference.html"><span class="header-section-number">15</span> Experimental designs for descriptive inference</a></li>
<li><a class="" href="observational-designs-for-causal-inference.html"><span class="header-section-number">16</span> Observational designs for causal inference</a></li>
<li><a class="" href="experimental-designs-for-causal-inference.html"><span class="header-section-number">17</span> Experimental designs for causal inference</a></li>
<li><a class="" href="multi-study-designs.html"><span class="header-section-number">18</span> Multi-study designs</a></li>
<li><a class="" href="part-iii-exercises.html"><span class="header-section-number">19</span> Part III Exercises</a></li>
<li class="book-part">Research Design Lifecycle</li>
<li><a class="" href="research-design-lifecycle.html"><span class="header-section-number">20</span> Research Design Lifecycle</a></li>
<li><a class="" href="before.html"><span class="header-section-number">21</span> Before</a></li>
<li><a class="" href="during.html"><span class="header-section-number">22</span> During</a></li>
<li><a class="" href="after.html"><span class="header-section-number">23</span> After</a></li>
<li><a class="" href="part-iv-exercises.html"><span class="header-section-number">24</span> Part IV Exercises</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="primer" class="section level1">
<h1>
<span class="header-section-number">3</span> Software primer<a class="anchor" aria-label="anchor" href="#primer"><i class="fas fa-link"></i></a>
</h1>
<!-- make sure to rename the section title below -->
<p>This chapter serves as a brief introduction to the <code>DeclareDesign</code> package for R. <code>DeclareDesign</code> is a software implementation of every step of the design-diagnose-redesign process. While you can of course declare, diagnose, and redesign your design using nearly any programming language, <code>DeclareDesign</code> is structured to make it easy to mix-and-match design elements while handling the tedious simulation bookkeeping behind the scenes.</p>
<div id="installing-r" class="section level2">
<h2>
<span class="header-section-number">3.1</span> Installing R<a class="anchor" aria-label="anchor" href="#installing-r"><i class="fas fa-link"></i></a>
</h2>
<p>You can download the statistical computing environment R for free from <a href="https://cran.r-project.org">CRAN</a>. We also recommend the free program <a href="https://rstudio.com/products/rstudio/download/">RStudio</a>, which provides a friendly interface to R. Both R and RStudio are available on Windows, Mac, and Linux.</p>
<p>Once you have R and RStudio installed, open it up and install <code>DeclareDesign</code> and its related packages. These include three packages that enable specific steps in the research process (<code>fabricatr</code> for simulating social science data; <code>randomizr</code> for random sampling and random assignment; and <code>estimatr</code> for design-based estimators). You can also install <code>DesignLibrary</code>, which gets standard designs up-and-running in one line. To install them, copy the following code into your R console:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"DeclareDesign"</span>,
  <span class="st">"fabricatr"</span>,
  <span class="st">"randomizr"</span>,
  <span class="st">"estimatr"</span>,
  <span class="st">"DesignLibrary"</span>
<span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We also recommend that you install and get to know the <code>tidyverse</code> suite of packages for data analysis, which we will use throughout the book:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"tidyverse"</span><span class="op">)</span></code></pre></div>
<p>For introductions to R and the <code>tidyverse</code> we especially recommend the free resource <a href="https://r4ds.had.co.nz"><code>R for Data Science</code></a>.</p>
</div>
<div id="building-a-step-of-a-research-design" class="section level2">
<h2>
<span class="header-section-number">3.2</span> Building a step of a research design<a class="anchor" aria-label="anchor" href="#building-a-step-of-a-research-design"><i class="fas fa-link"></i></a>
</h2>
<p>A research design is a concatenation of design steps. The best way to learn how to build a design is to learn how to make a step. We will start out by making—or <em>declaring</em>—a step that implements random assignment.</p>
<p>Almost all steps take a dataset as input and return a dataset as output. We will imagine input data that describes a set of voters in Los Angeles. The research project we are planning involves randomly assigning voters to receive (or not receive) a knock on their door from a canvasser. Our data look like this:</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:voterfile">Table 3.1: </span>Example data
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
sex
</th>
<th style="text-align:left;">
party
</th>
<th style="text-align:right;">
precinct
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
9104
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
8029
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
GRN
</td>
<td style="text-align:right;">
8383
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
2048
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
5210
</td>
</tr>
</tbody>
</table></div>
<p>There are 100 voters in the dataset.</p>
<p>We want a function that takes this dataset, implements a random assignment, adds it to the dataset, and then returns the new dataset containing the random assignment.</p>
<p>You could write your own function to do that but you can also use one of the <code>declare_*</code> functions in <code>DeclareDesign</code> that are designed to write functions. Each one of these functions is a kind of <em>function factory</em>: it takes a set of parameters about your research design like the number of units and the random assignment probability as <em>inputs</em>, and returns a <em>function</em> as an output.</p>
<p>Here is an example of a <code>declare_assignment</code> step .</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simple_random_assignment_step</span> <span class="op">&lt;-</span> <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></code></pre></div>
<p>The big idea here is that the object we created, <code>simple_random_assignment_step</code>, is not a particular assignment, it is a <em>function</em> that conducts assignment when called. You can run the function on data:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">simple_random_assignment_step</span><span class="op">(</span><span class="va">voter_file</span><span class="op">)</span> </code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:voterfilera">Table 3.2: </span>Data output following implementation of an assignment step.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
sex
</th>
<th style="text-align:left;">
party
</th>
<th style="text-align:right;">
precinct
</th>
<th style="text-align:right;">
Z
</th>
<th style="text-align:right;">
Z_cond_prob
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
9104
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
8029
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
GRN
</td>
<td style="text-align:right;">
8383
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.6
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
2048
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
5210
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4
</td>
</tr>
</tbody>
</table></div>
<p>The output of the <code>simple_random_assignment_step(voter_file)</code> call is the original dataset with a new column indicating treatment assignment (<code>Z</code>) appended. As a bonus, the data also includes the probability that each unit is assigned <em>to the condition in which it is in</em> (<code>Z_cond</code>), which is an extremely useful number to know in many analysis settings. The most important thing to understand here is that steps are “dataset-in, dataset-out” functions. The <code>simple_random_assignment_step</code> took the <code>voter_file</code> dataset and returned a dataset with assignment information appended.</p>
<!-- A few parts of this step declaration may seem a little bit odd. First, we did not tell R anything about the number of units in our dataset. Second, we did not give it the data. This is because a step declaration creates functions that are meant to be flexible, function that will work on any size dataset. We told `declare_assignment` that we want to assign treatment with probability `0.6`, regardless of how large the dataset is. We did not send the declaration the data because, although the assignment is a function of the data, the assignment *function* is not a function of the data. Put differently, the assignment function takes data as an argument, but the function to create the assignment function (`declare_assignment()`) does not.  -->
<!-- When you implement your research design after you have conducted it, you can use the exact same functions you generated in this design phase. In the same way when you *diagnose* your design you will use the same function many times. This is one of the reasons we *declare* the assignment step --- because we will learn about the properties of your design with the same code you can actually use to randomly assign treatment. -->
<p>Every step of a research design declaration can be written using one of the <code>declare_*</code> functions. Table <a href="primer.html#tab:declarationfunctions">3.3</a> collects these according to the four elements of a research design. Below, we walk through the common uses of each of these declaration functions.</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:declarationfunctions">Table 3.3: </span> Declaration functions in <code>DeclareDesign</code>
</caption>
<colgroup>
<col width="14%">
<col width="27%">
<col width="57%">
</colgroup>
<thead><tr class="header">
<th>Design component</th>
<th>Function</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Model</td>
<td><code>declare_population()</code></td>
<td>define background variables</td>
</tr>
<tr class="even">
<td></td>
<td><code>declare_potential_outcomes()</code></td>
<td>define functional relationships between treatments and outcomes</td>
</tr>
<tr class="odd">
<td>Inquiry</td>
<td><code>declare_estimand()</code></td>
<td>define research question</td>
</tr>
<tr class="even">
<td>Data strategy</td>
<td><code>declare_sampling()</code></td>
<td>specify sampling procedures</td>
</tr>
<tr class="odd">
<td></td>
<td><code>declare_assignment()</code></td>
<td>specify assignment procedures</td>
</tr>
<tr class="even">
<td></td>
<td><code>reveal_outcomes()</code></td>
<td>link potential outcomes to revealed outcomes via assignment</td>
</tr>
<tr class="odd">
<td></td>
<td><code>declare_measurement()</code></td>
<td>specify measurement procedures</td>
</tr>
<tr class="even">
<td>Answer strategy</td>
<td><code>declare_estimator()</code></td>
<td>specify data summary procedures</td>
</tr>
</tbody>
</table></div>
<div id="options-and-defaults" class="section level3">
<h3>
<span class="header-section-number">3.2.1</span> Options and defaults<a class="anchor" aria-label="anchor" href="#options-and-defaults"><i class="fas fa-link"></i></a>
</h3>
<p>Each of the <code>declare_*</code> functions has many options. In general, you do not have to specify these as default values are usually provided. For instance, you might have noticed above that when you ran the assignment step above, the new variable that was created was called <code>Z</code>. This is because <code>declare_assignment</code> has an argument <code>assignment_variable</code> that defaults to <code>Z</code>. You can change that of course to whatever you want.</p>
<p>More subtly, the <code>declare_*</code> functions also default to “handlers” which have their own default arguments. These handlers are generally well-developed sets of functions that implement the tasks needed by the <code>declare_</code> function. For instance, <code>assignment_handler</code> defaults to the <code>conduct_ra</code> function from the <code>randomizr</code> package. The declaration passes any additional arguments that you give it on to <code>conduct_ra</code>, and, by the same token, assumes the default values of the handler. In the example above, we had <code>prob = 0.6</code> as an argument. If you look at the documentation, <code>prob</code> is not an argument of <code>declare_assignment</code> but it is an argument of <code>conduct_ra</code>, with a default value of 0.5. If we had left this bit out we would have gotten a function that assigned treatment with probability 0.5. As with any software, learning these defaults will take some time and can be looked up in the help files, e.g. <code>?declare_assignment</code>.</p>
</div>
<div id="your-own-handlers" class="section level3">
<h3>
<span class="header-section-number">3.2.2</span> Your own handlers<a class="anchor" aria-label="anchor" href="#your-own-handlers"><i class="fas fa-link"></i></a>
</h3>
<p>The built-in functions we provide in the <code>DeclareDesign</code> package are quite flexible and handle many major designs, but not all. The framework is built so that you are never constrained by what we provide. At any point, rather than using the default handlers (such as <code>conduct_ra</code>), you can write a function that implements your own procedures. The only discipline that the framework imposes is that you write your procedure as a function that takes data in and sends data back.</p>
<p>Here is an example of how you turn your own functions into design steps.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">custom_assignment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">mutate</span><span class="op">(</span><span class="va">data</span>, Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">my_assignment_step</span> <span class="op">&lt;-</span> <span class="fu">declare_assignment</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">custom_assignment</span><span class="op">)</span>

<span class="fu">my_assignment_step</span><span class="op">(</span><span class="va">voter_file</span><span class="op">)</span>  </code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:voterfilecustomfunction">Table 3.4: </span>Data generated using a custom function
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
sex
</th>
<th style="text-align:left;">
party
</th>
<th style="text-align:right;">
precinct
</th>
<th style="text-align:right;">
Z
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
9104
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
8029
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
GRN
</td>
<td style="text-align:right;">
8383
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
2048
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
5210
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table></div>
<!-- There is, of course, no great difference in this example between `custom_assignment` and `my_assignment_step` since `my_assignment_step` is just a function that applies `custom_assignment`. Even still, it is worth declaring this step formally as a design step using `declare_assignment` since this lets `DeclareDesign` know how the step fits into the whole design, how to interpret it, and when to call it.    -->
</div>
</div>
<div id="research-design-steps" class="section level2">
<h2>
<span class="header-section-number">3.3</span> Research design steps<a class="anchor" aria-label="anchor" href="#research-design-steps"><i class="fas fa-link"></i></a>
</h2>
<p>In this section, we walk through how to declare each step of a research design using <code>DeclareDesign</code>. In the next section, we build those steps into a research design, and then describe how to interrogate the design.</p>
<div id="model" class="section level3">
<h3>
<span class="header-section-number">3.3.1</span> Model<a class="anchor" aria-label="anchor" href="#model"><i class="fas fa-link"></i></a>
</h3>
<p>The model defines the structure of the world, both its size and background characteristics as well as how interventions in the world determine outcomes. In <code>DeclareDesign</code>, we split the model into two functions: <code>declare_population</code> and <code>declare_potential_outcomes</code>.</p>
<div id="population" class="section level4">
<h4>
<span class="header-section-number">3.3.1.1</span> Population<a class="anchor" aria-label="anchor" href="#population"><i class="fas fa-link"></i></a>
</h4>
<p>The population defines the number of units in the population, any multilevel structure to the data, and its background characteristics. We can define the population in several ways. In some cases, you may start a design with data on the population. When that happens, we do not need to simulate it. We can simply declare the data as our population:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_population</span><span class="op">(</span>data <span class="op">=</span> <span class="va">voter_file</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:voterfilepopulation">Table 3.5: </span>Draw from a fixed population
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
sex
</th>
<th style="text-align:left;">
party
</th>
<th style="text-align:right;">
precinct
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
9104
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
8029
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
GRN
</td>
<td style="text-align:right;">
8383
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
DEM
</td>
<td style="text-align:right;">
2048
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
REP
</td>
<td style="text-align:right;">
5210
</td>
</tr>
</tbody>
</table></div>
<p>When we do not have complete data on the population, we simulate it. Relying on the data simulation functions from our <code>fabricatr</code> package, <code>declare_population</code> asks about the size and variables of the population. For instance, if we want a function that generates a dataset with 100 units and a random variable <code>U</code> we write:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>When we run this population function, we will get a different 100-unit dataset each time, as shown in Table <a href="primer.html#tab:fivepopulationdraws">3.6</a>.</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:fivepopulationdraws">Table 3.6: </span>Five draws from the population.
</caption>
<thead>
<tr>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Draw 1
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Draw 2
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Draw 3
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Draw 4
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Draw 5
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
-0.319
</td>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
0.189
</td>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
-1.280
</td>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
-0.379
</td>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
0.744
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
1.168
</td>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
0.691
</td>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
1.880
</td>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
-0.346
</td>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
2.445
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
1.697
</td>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
0.822
</td>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
0.597
</td>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
-0.641
</td>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
0.043
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
0.931
</td>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
-0.976
</td>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
-1.963
</td>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
0.402
</td>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
0.159
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
-1.152
</td>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
-1.295
</td>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
0.084
</td>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
0.335
</td>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
1.686
</td>
</tr>
</tbody>
</table></div>
<p>The <code>fabricatr</code> package can simulate many different types of data, including various types of categorical variables or different types of data structures, such as panel or multilevel structures. You can read the <code>fabricatr</code> <a href="https://declaredesign.org/r/fabricatr/">website</a> vignette to get started simulating data.</p>
<p>As an example of a two-level hierarchical data structure, here is a declaration for 100 households with a random number of individuals within each household. This two-level structure could be declared as:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_population</span><span class="op">(</span>
  households <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>
    N <span class="op">=</span> <span class="fl">100</span>,
    individuals_per_hh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>,
  individuals <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>
    N <span class="op">=</span> <span class="va">individuals_per_hh</span>, 
    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>As always, you can exit our built-in way of doing things and bring in your own code. This is useful for complex designs, or when you have already written code for your design and you want to use it directly. Here is an example of a custom population declaration:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">complex_population_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">N_units</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N_units</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">declare_population</span><span class="op">(</span>
  handler <span class="op">=</span> <span class="va">complex_population_function</span>, N_units <span class="op">=</span> <span class="fl">100</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="potential-outcomes" class="section level4">
<h4>
<span class="header-section-number">3.3.1.2</span> Potential outcomes<a class="anchor" aria-label="anchor" href="#potential-outcomes"><i class="fas fa-link"></i></a>
</h4>
<p>Defining potential outcomes is as easy as a single expression per potential outcome. Potential outcomes may depend on background characteristics, other potential outcomes, or other R functions.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_potential_outcomes</span><span class="op">(</span>
  Y_Z_0 <span class="op">=</span> <span class="va">U</span>, 
  Y_Z_1 <span class="op">=</span> <span class="va">Y_Z_0</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span>

<span class="fu">draw_data</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:potentialoutcomesdraw">Table 3.7: </span>Adding potential outcomes to the population.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
1.532
</td>
<td style="text-align:right;">
1.532
</td>
<td style="text-align:right;">
1.782
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
0.922
</td>
<td style="text-align:right;">
0.922
</td>
<td style="text-align:right;">
1.172
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
-1.187
</td>
<td style="text-align:right;">
-1.187
</td>
<td style="text-align:right;">
-0.937
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
-0.204
</td>
<td style="text-align:right;">
-0.204
</td>
<td style="text-align:right;">
0.046
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
-1.059
</td>
<td style="text-align:right;">
-1.059
</td>
<td style="text-align:right;">
-0.809
</td>
</tr>
</tbody>
</table></div>
<p>The <code>declare_potential_outcomes</code> function also includes an alternative interface for defining potential outcomes that uses R’s formula syntax. The formula syntax lets you specify “regression-like” outcome equations. One downside is that it mildly obscures how the names of the eventual potential outcomes columns are named. We build the names of the potential outcomes columns the outcome name (here <code>Y</code> on the left-hand side of the formula) and from the <code>assignment_variables</code> argument (here <code>Z</code>).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span>, assignment_variables <span class="op">=</span> <span class="va">Z</span><span class="op">)</span></code></pre></div>
<p>Either way of creating potential outcomes works; one may be easier or harder to code up in a given research design setting.</p>
</div>
</div>
<div id="inquiry" class="section level3">
<h3>
<span class="header-section-number">3.3.2</span> Inquiry<a class="anchor" aria-label="anchor" href="#inquiry"><i class="fas fa-link"></i></a>
</h3>
<p>To define your inquiry, declare your estimand. Estimands are typically summaries of the data produced in <code>declare_population</code> and <code>declare_potential_outcomes</code>. Here we define the average treatment effect as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Notice that we defined the PATE (the <em>population</em> average treatment effect), but said nothing special related to the population – it looks like we just defined the average treatment effect. This is because <em>order matters</em>. If we want to define a SATE (the <em>sample</em> average treatment effect), we would have to do so after sampling has occurred. We will see how to do this in a moment.</p>
</div>
<div id="data-strategy" class="section level3">
<h3>
<span class="header-section-number">3.3.3</span> Data strategy<a class="anchor" aria-label="anchor" href="#data-strategy"><i class="fas fa-link"></i></a>
</h3>
<p>The data strategy constitutes one or more steps representing interventions the researcher makes in the world from sampling to assignment to measurement.</p>
<div id="sampling" class="section level4">
<h4>
<span class="header-section-number">3.3.3.1</span> Sampling<a class="anchor" aria-label="anchor" href="#sampling"><i class="fas fa-link"></i></a>
</h4>
<p>The sampling step relies on the <code>randomizr</code> package to conduct random sampling. See Section <a href="crafting-a-data-strategy.html#p2sampling">8.1</a> for an overview of the many kinds of sampling that are possible. Here we define a procedure for drawing a 50-unit sample from the population:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></code></pre></div>
<p>When we draw data from our simple design at this point, it will have fewer rows: it will have shrunk from 100 units in the population to a data frame of 50 units representing the sample. The new data frame also includes a variable indicating the probability of being included in the sample. In this case, every unit in the population had an equal inclusion probability of 0.5.</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:sampleddatadraw">Table 3.8: </span>Sampled data.
</caption>
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
<th style="text-align:right;">
S_inclusion_prob
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
0.861
</td>
<td style="text-align:right;">
0.861
</td>
<td style="text-align:right;">
1.111
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
3
</td>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
0.624
</td>
<td style="text-align:right;">
0.624
</td>
<td style="text-align:right;">
0.874
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
5
</td>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
1.024
</td>
<td style="text-align:right;">
1.024
</td>
<td style="text-align:right;">
1.274
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
6
</td>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
0.861
</td>
<td style="text-align:right;">
0.861
</td>
<td style="text-align:right;">
1.111
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:left;">
8
</td>
<td style="text-align:left;">
008
</td>
<td style="text-align:right;">
-0.435
</td>
<td style="text-align:right;">
-0.435
</td>
<td style="text-align:right;">
-0.185
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
</tbody>
</table></div>
<p>Sampling could also be non-random, which could be accomplished by using a custom handler.</p>
</div>
<div id="assignment" class="section level4">
<h4>
<span class="header-section-number">3.3.3.2</span> Assignment<a class="anchor" aria-label="anchor" href="#assignment"><i class="fas fa-link"></i></a>
</h4>
<p>The default handler for <code>declare_assignment</code> also relies on the <code>randomizr</code> package for random assignment. Here, we define an assignment procedure that allocates subjects to treatment with probability 0.5. One subtlety is that by default, <code>declare_assignment</code> conducts complete random assignment (exactly <span class="math inline">\(m\)</span> of <span class="math inline">\(N\)</span> units assigned to treatment, where <span class="math inline">\(m\)</span> = <code>prob</code> * <span class="math inline">\(N\)</span>).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></code></pre></div>
<p>After treatments are assigned, some <em>potential</em> outcomes are <em>revealed</em>. Treated units reveal their treated potential outcomes and untreated units reveal their untreated potential outcomes. The <code>reveal_outcomes</code> function performs this switching operation.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span></code></pre></div>
<p>Adding these two declarations to the design results in a data frame with an additional indicator <code>Z</code> for the assignment as well as its corresponding probability of assignment. Again, here the assignment probabilities are constant, but in other designs described in Section <a href="crafting-a-data-strategy.html#p2assignment">8.2</a> they are not and this is crucial information for the analysis stage. The outcome variable <code>Y</code> is composed of each unit’s potential outcomes depending on its treatment status.</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignassignment">Table 3.9: </span>Sampled data with assignment indicator.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
<th style="text-align:right;">
S_inclusion_prob
</th>
<th style="text-align:right;">
Z
</th>
<th style="text-align:right;">
Z_cond_prob
</th>
<th style="text-align:right;">
Y
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
-0.857
</td>
<td style="text-align:right;">
-0.857
</td>
<td style="text-align:right;">
-0.607
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.607
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
0.916
</td>
<td style="text-align:right;">
0.916
</td>
<td style="text-align:right;">
1.166
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.166
</td>
</tr>
<tr>
<td style="text-align:left;">
004
</td>
<td style="text-align:right;">
-0.724
</td>
<td style="text-align:right;">
-0.724
</td>
<td style="text-align:right;">
-0.474
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.724
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
0.450
</td>
<td style="text-align:right;">
0.450
</td>
<td style="text-align:right;">
0.700
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.450
</td>
</tr>
<tr>
<td style="text-align:left;">
008
</td>
<td style="text-align:right;">
0.150
</td>
<td style="text-align:right;">
0.150
</td>
<td style="text-align:right;">
0.400
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.150
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="measurement" class="section level4">
<h4>
<span class="header-section-number">3.3.3.3</span> Measurement<a class="anchor" aria-label="anchor" href="#measurement"><i class="fas fa-link"></i></a>
</h4>
<p>Measurement is a critical part of every research design; sometimes it is beneficial to explicitly declare the measurement procedures of the design, rather than allowing them to be implicit in the ways variables are created in <code>declare_population</code> and <code>declare_potential_outcomes</code>. For example, we might imagine that the normally distributed outcome variable <code>Y</code> is a latent outcome that will be translated into a binary outcome when measured by the researcher:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_measurement</span><span class="op">(</span>Y_binary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignmeasurement">Table 3.10: </span>Sampled data with an explicitly measured outcome.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
<th style="text-align:right;">
S_inclusion_prob
</th>
<th style="text-align:right;">
Z
</th>
<th style="text-align:right;">
Z_cond_prob
</th>
<th style="text-align:right;">
Y
</th>
<th style="text-align:right;">
Y_binary
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
-1.114
</td>
<td style="text-align:right;">
-1.114
</td>
<td style="text-align:right;">
-0.864
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.864
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
3.133
</td>
<td style="text-align:right;">
3.133
</td>
<td style="text-align:right;">
3.383
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
3.383
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
008
</td>
<td style="text-align:right;">
1.858
</td>
<td style="text-align:right;">
1.858
</td>
<td style="text-align:right;">
2.108
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.858
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
012
</td>
<td style="text-align:right;">
-1.571
</td>
<td style="text-align:right;">
-1.571
</td>
<td style="text-align:right;">
-1.321
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-1.321
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
013
</td>
<td style="text-align:right;">
-0.300
</td>
<td style="text-align:right;">
-0.300
</td>
<td style="text-align:right;">
-0.050
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.300
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div id="answer-strategy" class="section level3">
<h3>
<span class="header-section-number">3.3.4</span> Answer strategy<a class="anchor" aria-label="anchor" href="#answer-strategy"><i class="fas fa-link"></i></a>
</h3>
<p>Through our model and data strategy steps, we have simulated a dataset with two key inputs to the answer strategy: an assignment variable and an outcome. In other answer strategies, pretreatment characteristics from the model might also be relevant. The data look like this:</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignrevealedoutcomes">Table 3.11: </span>Data with revealed outcomes.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
<th style="text-align:right;">
S_inclusion_prob
</th>
<th style="text-align:right;">
Z
</th>
<th style="text-align:right;">
Z_cond_prob
</th>
<th style="text-align:right;">
Y
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
001
</td>
<td style="text-align:right;">
1.680
</td>
<td style="text-align:right;">
1.680
</td>
<td style="text-align:right;">
1.930
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.930
</td>
</tr>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
0.057
</td>
<td style="text-align:right;">
0.057
</td>
<td style="text-align:right;">
0.307
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.057
</td>
</tr>
<tr>
<td style="text-align:left;">
003
</td>
<td style="text-align:right;">
-1.280
</td>
<td style="text-align:right;">
-1.280
</td>
<td style="text-align:right;">
-1.030
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-1.030
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
0.613
</td>
<td style="text-align:right;">
0.613
</td>
<td style="text-align:right;">
0.863
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.863
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
-1.241
</td>
<td style="text-align:right;">
-1.241
</td>
<td style="text-align:right;">
-0.991
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.991
</td>
</tr>
</tbody>
</table></div>
<p>Our estimator is the difference-in-means estimator, which compares outcomes between the group that was assigned to treatment and that assigned to control. The <code>difference_in_means()</code> function in the <code>estimatr</code> package calculates the estimate, the standard error, <span class="math inline">\(p\)</span>-value and confidence interval for you:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">difference_in_means</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, data <span class="op">=</span> <span class="va">simple_design_data</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesigndimestimate">Table 3.12: </span>Difference-in-means estimate from simulated data.
</caption>
<thead><tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
<th style="text-align:right;">
conf.low
</th>
<th style="text-align:right;">
conf.high
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:left;">
outcome
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.133
</td>
<td style="text-align:right;">
0.265
</td>
<td style="text-align:right;">
0.501
</td>
<td style="text-align:right;">
0.618
</td>
<td style="text-align:right;">
-0.4
</td>
<td style="text-align:right;">
0.666
</td>
<td style="text-align:right;">
47.838
</td>
<td style="text-align:left;">
Y
</td>
</tr></tbody>
</table></div>
<p>Now, in order to <em>declare</em> our estimator, we can send the name of a modeling function to <code>declare_estimator</code>. R has many modeling functions that work with <code>declare_estimator</code>, including <code>lm</code>, <code>glm</code>, or the <code>ictreg</code> function from the <code>list</code> package, among hundreds of others. Throughout the book, we will be using many estimators from <code>estimatr</code> because they are fast and calculate robust standard errors easily. Estimators are (almost always) associated with estimands.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Sometimes, you may be interested in properties of an estimator that do not depend on an estimand, such as calculating its power&lt;/p&gt;"><sup>4</sup></a> Here, we are targeting the population average treatment effect with the difference-in-means estimator.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_estimator</span><span class="op">(</span>
  <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, estimand <span class="op">=</span> <span class="st">"PATE"</span>
<span class="op">)</span></code></pre></div>
<div id="other-design-steps" class="section level4">
<h4>
<span class="header-section-number">3.3.4.1</span> Other design steps<a class="anchor" aria-label="anchor" href="#other-design-steps"><i class="fas fa-link"></i></a>
</h4>
<p>The main <code>declare_*</code> functions cover many elements of research designs, but not all. You can include any operations we haven’t explicitly included as steps in your design too, using <code>declare_step</code>. Here, you must define a specific handler. Some handlers that may be useful are the <code>dplyr</code> verbs such as <code>mutate</code> and <code>summarize</code>, and the <code>fabricate</code> function from our <code>fabricatr</code> package.</p>
<p>To add a variable using fabricate:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">declare_step</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">fabricate</span>, added_variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>If you have district-month data you may want to analyze at the district level, collapsing across months:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">collapse_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">collapse_by</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">data</span> <span class="op">%&gt;%</span> 
    <span class="fu">group_by</span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">collapse_by</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">summarize_all</span><span class="op">(</span><span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">declare_step</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">collapse_data</span>, collapse_by <span class="op">=</span> <span class="va">district</span><span class="op">)</span>

<span class="co"># Note: The `{{ }}` syntax is handy for writing functions in `dplyr` </span>
<span class="co"># where you want to be able to reuse the function with different variable </span>
<span class="co"># names. Here, the `collapse_data` function will `group_by` the </span>
<span class="co"># variable you send to the argument `collapse_by`, which in our </span>
<span class="co"># declaration we set to `district`. The pipeline within the function </span>
<span class="co"># then calculates the mean in each district.</span></code></pre></div>
</div>
</div>
</div>
<div id="building-a-design-from-design-steps" class="section level2">
<h2>
<span class="header-section-number">3.4</span> Building a design from design steps<a class="anchor" aria-label="anchor" href="#building-a-design-from-design-steps"><i class="fas fa-link"></i></a>
</h2>
<p>In the last section, we defined a set of individual research steps. We draw one version of them together here:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">population</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> 

<span class="va">potential_outcomes</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> 

<span class="va">estimand</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> 

<span class="va">sampling</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> 

<span class="va">assignment</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> 

<span class="va">reveal</span> <span class="op">&lt;-</span> 
  <span class="fu">reveal_outcomes</span><span class="op">(</span>outcome_variables <span class="op">=</span> <span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="va">Z</span><span class="op">)</span> 

<span class="va">estimator</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_estimator</span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, estimand <span class="op">=</span> <span class="st">"PATE"</span>
  <span class="op">)</span></code></pre></div>
<p>To construct a research design <em>object</em> that we can operate on — diagnose it, redesign it, draw data from it, etc. — we add them together with the <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> operator, just as <code>%&gt;%</code> makes <code>dplyr</code> pipelines or <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> creates <code>ggplot</code> objects.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="va">population</span> <span class="op">+</span> <span class="va">potential_outcomes</span> <span class="op">+</span> <span class="va">estimand</span> <span class="op">+</span> 
  <span class="va">sampling</span> <span class="op">+</span> <span class="va">assignment</span> <span class="op">+</span> <span class="va">reveal</span> <span class="op">+</span> <span class="va">estimator</span></code></pre></div>
<p>We will usually declare designs more compactly, concatenating steps directly with <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">reveal_outcomes</span><span class="op">(</span>outcome_variables <span class="op">=</span> <span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, estimand <span class="op">=</span> <span class="st">"PATE"</span>
  <span class="op">)</span></code></pre></div>
<div id="order-matters" class="section level3">
<h3>
<span class="header-section-number">3.4.1</span> Order matters<a class="anchor" aria-label="anchor" href="#order-matters"><i class="fas fa-link"></i></a>
</h3>
<p>When defining a design, the order in which steps are included in the design via the <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> operator matters. Think of the order of your design as the temporal order in which steps take place. Here, since the estimand comes before sampling and assignment, it is a <em>population</em> estimand, the population average treatment effect.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">population</span> <span class="op">+</span> <span class="va">potential_outcomes</span> <span class="op">+</span> <span class="va">estimand</span> <span class="op">+</span> 
  <span class="va">sampling</span> <span class="op">+</span> <span class="va">assignment</span> <span class="op">+</span> <span class="va">reveal</span> <span class="op">+</span> <span class="va">estimator</span></code></pre></div>
<p>We could define our estimand as a <em>sample</em> average treatment effect by putting <code>estimand</code> after <code>sampling</code>:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">population</span> <span class="op">+</span> <span class="va">potential_outcomes</span> <span class="op">+</span> <span class="va">sampling</span> <span class="op">+</span>
  <span class="va">estimand</span> <span class="op">+</span> <span class="va">assignment</span> <span class="op">+</span> <span class="va">reveal</span> <span class="op">+</span> <span class="va">estimator</span></code></pre></div>
</div>
</div>
<div id="simulating-a-research-design" class="section level2">
<h2>
<span class="header-section-number">3.5</span> Simulating a research design<a class="anchor" aria-label="anchor" href="#simulating-a-research-design"><i class="fas fa-link"></i></a>
</h2>
<p>Diagnosing a research design — learning about its properties — requires first simulating running the design over and over. We need to simulate the data generating process, then calculate the estimands, then calculate the resulting estimates.</p>
<p>With the design defined as an object, we can learn about what kind of data it generates, the values of its estimand and estimates, and other features. For example, to draw simulated data based on the design, we use <code>draw_data</code>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">draw_data</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesigndatadraw">Table 3.13: </span>Simulated data draw.
</caption>
<thead><tr>
<th style="text-align:left;">
ID
</th>
<th style="text-align:right;">
U
</th>
<th style="text-align:right;">
Y_Z_0
</th>
<th style="text-align:right;">
Y_Z_1
</th>
<th style="text-align:right;">
S_inclusion_prob
</th>
<th style="text-align:right;">
Z
</th>
<th style="text-align:right;">
Z_cond_prob
</th>
<th style="text-align:right;">
Y
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
002
</td>
<td style="text-align:right;">
0.076
</td>
<td style="text-align:right;">
0.076
</td>
<td style="text-align:right;">
0.326
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.076
</td>
</tr>
<tr>
<td style="text-align:left;">
005
</td>
<td style="text-align:right;">
0.595
</td>
<td style="text-align:right;">
0.595
</td>
<td style="text-align:right;">
0.845
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.595
</td>
</tr>
<tr>
<td style="text-align:left;">
006
</td>
<td style="text-align:right;">
-0.431
</td>
<td style="text-align:right;">
-0.431
</td>
<td style="text-align:right;">
-0.181
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-0.431
</td>
</tr>
<tr>
<td style="text-align:left;">
007
</td>
<td style="text-align:right;">
-1.133
</td>
<td style="text-align:right;">
-1.133
</td>
<td style="text-align:right;">
-0.883
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-1.133
</td>
</tr>
<tr>
<td style="text-align:left;">
008
</td>
<td style="text-align:right;">
-2.237
</td>
<td style="text-align:right;">
-2.237
</td>
<td style="text-align:right;">
-1.987
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
-2.237
</td>
</tr>
</tbody>
</table></div>
<p><code>draw_data</code> runs all of the “data steps” in a design, which are both from the model (population and potential outcomes) and from the data strategy (sampling, assignment, and measurement).</p>
<p>To simulate the estimands from a single run of the design, we use <code>draw_estimands</code>. This runs two operations at once: it draws the data, and calculates the estimands at the point defined by the design. For example, in our design, the estimand comes just after the potential outcomes. In this design, <code>draw_estimands</code> will run the first two steps and then calculate the estimands from the <code>estimand</code> function we declared:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">draw_estimands</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignestimanddraw">Table 3.14: </span>Estimands calculated from simulated data.
</caption>
<thead><tr>
<th style="text-align:left;">
estimand_label
</th>
<th style="text-align:right;">
estimand
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
PATE
</td>
<td style="text-align:right;">
0.25
</td>
</tr></tbody>
</table></div>
<p>Similarly, we can draw the estimates from a single run with <code>draw_estimates</code> which simulates data and, at the appropriate moment, calculates estimates.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">draw_estimates</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignestimatedraw">Table 3.15: </span>Estimates calculated from simulated data.
</caption>
<thead><tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
<th style="text-align:right;">
conf.low
</th>
<th style="text-align:right;">
conf.high
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:left;">
outcome
</th>
<th style="text-align:left;">
estimand_label
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.627
</td>
<td style="text-align:right;">
0.317
</td>
<td style="text-align:right;">
1.98
</td>
<td style="text-align:right;">
0.054
</td>
<td style="text-align:right;">
-0.011
</td>
<td style="text-align:right;">
1.266
</td>
<td style="text-align:right;">
43.677
</td>
<td style="text-align:left;">
Y
</td>
<td style="text-align:left;">
PATE
</td>
</tr></tbody>
</table></div>
<p>To simulate designs, we use the <code>simulate_design</code> function to draw data, calculate estimands and estimates, and then repeat the process over and over.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">simulate_design</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesignsimulationsdf">Table 3.16: </span>Simulations data frame.
</caption>
<thead><tr>
<th style="text-align:right;">
sim_ID
</th>
<th style="text-align:right;">
estimand
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
<th style="text-align:right;">
conf.low
</th>
<th style="text-align:right;">
conf.high
</th>
<th style="text-align:right;">
df
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:right;">
1.030
</td>
<td style="text-align:right;">
0.271
</td>
<td style="text-align:right;">
3.797
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.483
</td>
<td style="text-align:right;">
1.578
</td>
<td style="text-align:right;">
43.521
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:right;">
0.320
</td>
<td style="text-align:right;">
0.253
</td>
<td style="text-align:right;">
1.264
</td>
<td style="text-align:right;">
0.212
</td>
<td style="text-align:right;">
-0.189
</td>
<td style="text-align:right;">
0.830
</td>
<td style="text-align:right;">
47.943
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:right;">
-0.070
</td>
<td style="text-align:right;">
0.282
</td>
<td style="text-align:right;">
-0.247
</td>
<td style="text-align:right;">
0.806
</td>
<td style="text-align:right;">
-0.636
</td>
<td style="text-align:right;">
0.497
</td>
<td style="text-align:right;">
46.833
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:right;">
0.557
</td>
<td style="text-align:right;">
0.298
</td>
<td style="text-align:right;">
1.868
</td>
<td style="text-align:right;">
0.068
</td>
<td style="text-align:right;">
-0.043
</td>
<td style="text-align:right;">
1.157
</td>
<td style="text-align:right;">
46.729
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:right;">
0.817
</td>
<td style="text-align:right;">
0.268
</td>
<td style="text-align:right;">
3.049
</td>
<td style="text-align:right;">
0.004
</td>
<td style="text-align:right;">
0.278
</td>
<td style="text-align:right;">
1.356
</td>
<td style="text-align:right;">
47.930
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="diagnosing-a-research-design" class="section level2">
<h2>
<span class="header-section-number">3.6</span> Diagnosing a research design<a class="anchor" aria-label="anchor" href="#diagnosing-a-research-design"><i class="fas fa-link"></i></a>
</h2>
<p>Using the simulations data frame, we can calculate diagnosands like bias, root mean-squared-error, and power for each estimator-estimand pair. In <code>DeclareDesign</code>, we do this in two steps. First, declare your diagnosands, which are functions that summarize simulations data. The software includes many pre-coded diagnosands (see Section <a href="p2diagnosis.html#p2diagnosis">10</a>), though you can write your own like this:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">study_diagnosands</span> <span class="op">&lt;-</span> <span class="fu">declare_diagnosands</span><span class="op">(</span>
  bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span>,
  rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
  power <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">p.value</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Second, apply your diagnosand declaration to the simulations data frame with the <code>diagnose_design</code> function:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">diagnose_design</span><span class="op">(</span><span class="va">simulation_df</span>, diagnosands <span class="op">=</span> <span class="va">study_diagnosands</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:simpledesigndiagnosis2">Table 3.17: </span>Design diagnosis.
</caption>
<thead><tr>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
-0.00
</td>
<td style="text-align:left;">
0.29
</td>
<td style="text-align:left;">
0.15
</td>
</tr>
<tr>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
</tr>
</tbody>
</table></div>
<p>We can also do this in a single step by sending <code>diagnose_design</code> a design object. The function will first run the simulations for you, then calculate the diagnosands from the simulation data frame that results.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">diagnose_design</span><span class="op">(</span><span class="va">design</span>, diagnosands <span class="op">=</span> <span class="va">study_diagnosands</span><span class="op">)</span></code></pre></div>
<div id="redesign-1" class="section level3">
<h3>
<span class="header-section-number">3.6.1</span> Redesign<a class="anchor" aria-label="anchor" href="#redesign-1"><i class="fas fa-link"></i></a>
</h3>
<p>After the declaration phase, you will often want to learn how the diagnosands change as design features change. We can do this using <code>redesign</code>:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">redesign</span><span class="op">(</span><span class="va">design</span>, N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span>, <span class="fl">400</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>An alternative way to do this is to write a “designer.” A designer is a function that makes designs based on a few design parameters. Designer help researchers flexibly explore design variations. Here’s a simple designer based on our running example:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simple_designer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sample_size</span>, <span class="va">effect_size</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="va">sample_size</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">effect_size</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_estimand</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">reveal_outcomes</span><span class="op">(</span>outcome_variables <span class="op">=</span> <span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">declare_estimator</span><span class="op">(</span>
      <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, estimand <span class="op">=</span> <span class="st">"PATE"</span>
    <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>To create a single design, based on our original parameters of a 100-unit sample size and a treatment effect of <code>0.25</code>, we can run:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span> <span class="fu">simple_designer</span><span class="op">(</span>sample_size <span class="op">=</span> <span class="fl">100</span>, effect_size <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></code></pre></div>
<p>Now to simulate multiple designs, we can use the <code>DeclareDesign</code> function <code>expand_design</code>. Here we examine our simple design under several possible sample sizes, which we might want to do to conduct a minimum power analysis. We hold the effect size constant.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">designs</span> <span class="op">&lt;-</span> <span class="fu">expand_design</span><span class="op">(</span>
  <span class="va">simple_designer</span>, 
  sample_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span>, <span class="fl">1000</span><span class="op">)</span>, 
  effect_size <span class="op">=</span> <span class="fl">0.25</span>
<span class="op">)</span></code></pre></div>
<p>Our simulation and diagnosis tools can take a list of designs and simulate all of them at once, creating a column called <code>design_label</code> to keep track. For example:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">diagnose_design</span><span class="op">(</span><span class="va">designs</span><span class="op">)</span></code></pre></div>
</div>
<div id="comparing-designs" class="section level3">
<h3>
<span class="header-section-number">3.6.2</span> Comparing designs<a class="anchor" aria-label="anchor" href="#comparing-designs"><i class="fas fa-link"></i></a>
</h3>
<p>Alternatively, we can compare a pair of designs directly with the <code>compare_designs</code> function. This function is most useful for comparing the differences between a planned design and an implemented design (see Section <a href="during.html#p4reconciliation">22.4</a>).</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">compare_designs</span><span class="op">(</span><span class="va">planned_design</span>, <span class="va">implemented_design</span><span class="op">)</span></code></pre></div>
<p>Similarly, we can compare two designs on the basis of their diagnoses:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">compare_diagnoses</span><span class="op">(</span><span class="va">planned_design</span>, <span class="va">implemented_design</span><span class="op">)</span></code></pre></div>
</div>
<div id="library-of-designs" class="section level3">
<h3>
<span class="header-section-number">3.6.3</span> Library of designs<a class="anchor" aria-label="anchor" href="#library-of-designs"><i class="fas fa-link"></i></a>
</h3>
<p>In our <code>DesignLibrary</code> package, we have created a set of common designs as designers (functions that create designs from just a few parameters), so you can get started quickly.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://declaredesign.org/library/">DesignLibrary</a></span><span class="op">)</span>

<span class="va">b_c_design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DesignLibrary/man/block_cluster_two_arm_designer.html">block_cluster_two_arm_designer</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">1000</span>, N_blocks <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="further-reading-1" class="section level2">
<h2>
<span class="header-section-number">3.7</span> Further Reading<a class="anchor" aria-label="anchor" href="#further-reading-1"><i class="fas fa-link"></i></a>
</h2>
<p>This primer includes everything you need to know to read the code in this book. For much more detail and help, we recommend the following resources.</p>
<ul>
<li><a href="declaredesign.org">DeclareDesign.org</a></li>
<li><a href="https://d33wubrfki0l68.cloudfront.net/9291e8b14dc5cacd35b5921a97cc155ef3a4e5f2/fb740/wp-content/uploads/2018/06/randomizr.png">randomizr cheatsheet</a></li>
<li><a href="https://d33wubrfki0l68.cloudfront.net/0ca3fbb89405f45389248e1033ebae5db557398e/77fb0/assets/img/estimatr-400x309.png">estimatr cheatsheet</a></li>
<li><a href="https://d33wubrfki0l68.cloudfront.net/28d9240dc094e8b2923b1ef44578f9a52add5e76/32c17/assets/img/declaredesign-400x309.png">DeclareDesign cheatsheet</a></li>
<li><a href="https://r4ds.had.co.nz">R for Data Science</a></li>
<li><a href="https://rstudio.cloud/learn/primers">RStudio R primers</a></li>
<li><a href="https://sicss.io/boot_camp">Computational social science bootcamp</a></li>
</ul>
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- start post here, do not edit above -->
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="improving-research-designs.html"><span class="header-section-number">2</span> Improving research designs</a></div>
<div class="next"><a href="part-i-exercises.html"><span class="header-section-number">4</span> Part I Exercises</a></div>
</div></main><div id="on-this-page-nav" class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#primer"><span class="header-section-number">3</span> Software primer</a></li>
<li><a class="nav-link" href="#installing-r"><span class="header-section-number">3.1</span> Installing R</a></li>
<li>
<a class="nav-link" href="#building-a-step-of-a-research-design"><span class="header-section-number">3.2</span> Building a step of a research design</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#options-and-defaults"><span class="header-section-number">3.2.1</span> Options and defaults</a></li>
<li><a class="nav-link" href="#your-own-handlers"><span class="header-section-number">3.2.2</span> Your own handlers</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#research-design-steps"><span class="header-section-number">3.3</span> Research design steps</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#model"><span class="header-section-number">3.3.1</span> Model</a></li>
<li><a class="nav-link" href="#inquiry"><span class="header-section-number">3.3.2</span> Inquiry</a></li>
<li><a class="nav-link" href="#data-strategy"><span class="header-section-number">3.3.3</span> Data strategy</a></li>
<li><a class="nav-link" href="#answer-strategy"><span class="header-section-number">3.3.4</span> Answer strategy</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#building-a-design-from-design-steps"><span class="header-section-number">3.4</span> Building a design from design steps</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#order-matters"><span class="header-section-number">3.4.1</span> Order matters</a></li></ul>
</li>
<li><a class="nav-link" href="#simulating-a-research-design"><span class="header-section-number">3.5</span> Simulating a research design</a></li>
<li>
<a class="nav-link" href="#diagnosing-a-research-design"><span class="header-section-number">3.6</span> Diagnosing a research design</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#redesign-1"><span class="header-section-number">3.6.1</span> Redesign</a></li>
<li><a class="nav-link" href="#comparing-designs"><span class="header-section-number">3.6.2</span> Comparing designs</a></li>
<li><a class="nav-link" href="#library-of-designs"><span class="header-section-number">3.6.3</span> Library of designs</a></li>
</ul>
</li>
<li><a class="nav-link" href="#further-reading-1"><span class="header-section-number">3.7</span> Further Reading</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Research Design: Declare, Diagnose, Redesign</strong>" was written by Graeme Blair, Alexander Coppock, and Macartan Humphreys. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>Supported by the Laura and John Arnold Foundation and Evidence in Governance and Politics.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
