<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 14 Observational designs for descriptive inference | Research Design: Declare, Diagnose, Redesign</title>
<meta name="author" content="Graeme Blair, Jasper Cooper, Alexander Coppock, and Macartan Humphreys">
<!-- CSS --><!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.1.9000/tabs.js"></script><script src="libs/bs3compat-0.2.1.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="https://hypothes.is/embed.js" async></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Research Design: Declare, Diagnose, Redesign</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li class="book-part">Introduction</li>
<li><a class="" href="preamble.html"><span class="header-section-number">1</span> Preamble</a></li>
<li><a class="" href="improving-research-designs.html"><span class="header-section-number">2</span> Improving research designs</a></li>
<li><a class="" href="primer.html"><span class="header-section-number">3</span> Software primer</a></li>
<li><a class="" href="part-i-exercises.html"><span class="header-section-number">4</span> Part I Exercises</a></li>
<li class="book-part">Declaration, Diagnosis, Redesign</li>
<li><a class="" href="declaration.html"><span class="header-section-number">5</span> Declaration</a></li>
<li><a class="" href="specifying-the-model.html"><span class="header-section-number">6</span> Specifying the model</a></li>
<li><a class="" href="defining-the-inquiry.html"><span class="header-section-number">7</span> Defining the inquiry</a></li>
<li><a class="" href="crafting-a-data-strategy.html"><span class="header-section-number">8</span> Crafting a data strategy</a></li>
<li><a class="" href="choosing-an-answer-strategy.html"><span class="header-section-number">9</span> Choosing an answer strategy</a></li>
<li><a class="" href="p2diagnosis.html"><span class="header-section-number">10</span> Diagnosis</a></li>
<li><a class="" href="redesign-1.html"><span class="header-section-number">11</span> Redesign</a></li>
<li><a class="" href="part-ii-exercises.html"><span class="header-section-number">12</span> Part II Exercises</a></li>
<li class="book-part">Research Design Library</li>
<li><a class="" href="research-design-library.html"><span class="header-section-number">13</span> Research Design Library</a></li>
<li><a class="active" href="observational-designs-for-descriptive-inference.html"><span class="header-section-number">14</span> Observational designs for descriptive inference</a></li>
<li><a class="" href="experimental-designs-for-descriptive-inference.html"><span class="header-section-number">15</span> Experimental designs for descriptive inference</a></li>
<li><a class="" href="observational-designs-for-causal-inference.html"><span class="header-section-number">16</span> Observational designs for causal inference</a></li>
<li><a class="" href="experimental-designs-for-causal-inference.html"><span class="header-section-number">17</span> Experimental designs for causal inference</a></li>
<li><a class="" href="multi-study-designs.html"><span class="header-section-number">18</span> Multi-study designs</a></li>
<li><a class="" href="part-iii-exercises.html"><span class="header-section-number">19</span> Part III Exercises</a></li>
<li class="book-part">Research Design Lifecycle</li>
<li><a class="" href="research-design-lifecycle.html"><span class="header-section-number">20</span> Research Design Lifecycle</a></li>
<li><a class="" href="part-iv-exercises.html"><span class="header-section-number">21</span> Part IV Exercises</a></li>
<li><a class="" href="glossary.html"><span class="header-section-number">22</span> Glossary</a></li>
<li><a class="" href="references-4.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="observational-designs-for-descriptive-inference" class="section level1">
<h1>
<span class="header-section-number">14</span> Observational designs for descriptive inference<a class="anchor" aria-label="anchor" href="#observational-designs-for-descriptive-inference"><i class="fas fa-link"></i></a>
</h1>
<p>section introduction</p>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
<div id="random-sampling" class="section level2">
<h2>
<span class="header-section-number">14.1</span> Random sampling<a class="anchor" aria-label="anchor" href="#random-sampling"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-1" class="section level3">
<h3>
<span class="header-section-number">14.1.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-1"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fixed_population</span> <span class="op">&lt;-</span> <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">500</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span>

<span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>data <span class="op">=</span> <span class="va">fixed_population</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimand</span><span class="op">(</span>Y_bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"Y_bar"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag" class="section level3">
<h3>
<span class="header-section-number">14.1.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-142-1.png" width="100%"></div>
</div>
<div id="example-2" class="section level3">
<h3>
<span class="header-section-number">14.1.3</span> Example<a class="anchor" aria-label="anchor" href="#example-2"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="simple-random-sampling" class="section level3">
<h3>
<span class="header-section-number">14.1.4</span> Simple random sampling<a class="anchor" aria-label="anchor" href="#simple-random-sampling"><i class="fas fa-link"></i></a>
</h3>
<p>Often we are interested in features of a population, but data on the entire population is prohibitively expensive to collect. Instead, researchers obtain data on a small fraction of the population and use measurements taken on that sample to draw inferences about the population.</p>
<p>Imagine we seek to estimate the average political ideology of residents of the small town of Portola, California, on a left-right scale that varies from 1 (most liberal) to 7 (most conservative). We draw a simple random sample in which all residents have an equal chance of inclusion in the study. It’s a straightforward design but formally declaring it will make it easy to assess its properties.</p>
<div id="design-declaration" class="section level4">
<h4>
<span class="header-section-number">14.1.4.1</span> Design Declaration<a class="anchor" aria-label="anchor" href="#design-declaration"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>
<p><strong>M</strong>odel:</p>
<p>Even for this most basic of designs, researchers bring to bear a background model of the world. As described in Chapter 1, the three elements of a model are the signature, probability distributions over variables, and functional equations among variables. The signature here is a specification of the variable of interest, <span class="math inline">\(Y\)</span>, with a well defined domain (seven possible values between 1 and 7). In the code declaration below, we assume a uniform distribution over these 7 values. This choice is a speculation about the population distribution of <span class="math inline">\(Y\)</span>; some features of the design diagnosis will depend on the choice of distribution. The functional equations seem absent here as there is only one variable in the model. We could consider an elaboration of the model that includes three variables: the true outcome, <span class="math inline">\(Y\)</span>; the decision to measure the outcome, <span class="math inline">\(M\)</span>; and the measured outcome, <span class="math inline">\(Y^M\)</span>. We ignore this complication for now under the assumption that <span class="math inline">\(Y = Y^M\)</span>, i.e., that <span class="math inline">\(Y\)</span> is measured perfectly. Finally, the model also includes information about the size of the population. Portola, California, has a population of approximately 2100 people as of 2010, so <span class="math inline">\(N = 2100\)</span>.</p>
</li>
<li>
<p><strong>I</strong>nquiry:</p>
<p>Our inquiry is the population mean of <span class="math inline">\(Y\)</span>: <span class="math inline">\(\frac{1}{N} \sum_1^N Y_i = \bar{Y}\)</span>.</p>
</li>
<li>
<p><strong>D</strong>ata strategy:</p>
<p>In simple random sampling, we draw a random sample without replacement of size <span class="math inline">\(n\)</span>, where every member of the population has an equal probability of inclusion in the sample, <span class="math inline">\(\frac{n}{N}\)</span>. When <span class="math inline">\(N\)</span> is very large relative to <span class="math inline">\(n\)</span>, units are drawn approximately independently. In this design we measure <span class="math inline">\(Y\)</span> for <span class="math inline">\(n=100\)</span> units in the sample; the other <span class="math inline">\(N-n\)</span> units are not measured.</p>
</li>
<li>
<p><strong>A</strong>nswer strategy:</p>
<p>We estimate the population mean with the sample mean estimator: <span class="math inline">\(\widehat{\overline{Y}} = \frac{1}{n} \sum_1^n Y_i\)</span>. Even though our inquiry implies our answer should be a single number, an answer strategy typically also provides statistics that help us assess the uncertainty around that single number. To construct a 95% confidence interval around our estimate, we calculate the standard error of the sample mean, then approximate the sampling distribution of the sample mean estimator using a formula that includes a finite population correction. In particular, we approximate the estimated sampling distribution by a <span class="math inline">\(t\)</span> distribution with <span class="math inline">\(n - 1\)</span> degrees of freedom. In the code for our answer strategy, we spell out each step in turn.</p>
</li>
</ul>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fixed_population</span> <span class="op">&lt;-</span> <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">500</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span>

<span class="va">random_sampling_design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>data <span class="op">=</span> <span class="va">fixed_population</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimand</span><span class="op">(</span>Ybar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"Ybar"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">random_sampling_design</span><span class="op">)</span></code></pre></div>
</div>
<div id="takeaways" class="section level4">
<h4>
<span class="header-section-number">14.1.4.2</span> Takeaways<a class="anchor" aria-label="anchor" href="#takeaways"><i class="fas fa-link"></i></a>
</h4>
<p>With the design declared we can run a diagnosis and plot results from Monte Carlo simulations of the design:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diagnosis</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span>
  <span class="va">design</span>, sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">b_sims</span>, diagnosands <span class="op">=</span> <span class="va">diagnosands</span><span class="op">)</span> </code></pre></div>
<p>The diagnosis indicates that under simple random sampling, the sample mean estimator of the population mean is unbiased. The graph on the left shows the sampling distribution of the estimator: it’s centered directly on the true value of the inquiry. Confidence intervals <strong>also</strong> have a sampling distribution – they change depending on the idiosyncrasies of each sample we happen to draw. The figure on the right shows that the 95% of the time the confidence intervals cover the true value of the estimand, as they should. As sample size grows, the sampling distribution of the estimator gets tighter, but the coverage of the confidence intervals stays at 95% – just the properties we would want out of our answer strategy.</p>
<p>Things work well here it seems. In the exercises we suggest some small modifications of the design that point to conditions under which things might break down.</p>
</div>
</div>
<div id="stratified-and-clustered-random-sampling" class="section level3">
<h3>
<span class="header-section-number">14.1.5</span> Stratified and clustered random sampling<a class="anchor" aria-label="anchor" href="#stratified-and-clustered-random-sampling"><i class="fas fa-link"></i></a>
</h3>
<p>Researchers often cannot randomly sample at the individual level because it may, among other reasons, be too costly or logistically impractical. Instead, they may choose to randomly sample households, political precincts, or any group of individuals in order to draw inferences about the population. This strategy may be cheaper and simpler but may also introduce risks of less precise estimates.</p>
<p>Say we are interested in the average party ideology in the entire state of California. Using cluster sampling, we randomly sample counties within the state, and within each selected county, randomly sample individuals to survey.</p>
<p>Assuming enough variation in the outcome of interest, the random assignment of equal-sized clusters yields unbiased but imprecise estimates. By sampling clusters, we select groups of individuals who may share common attributes. Unlike simple random sampling, we need to take account of this intra-cluster correlation in our estimation of the standard error.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;The intra-cluster correlation coefficient (ICC) can be calculated directly and is a feature of this design.&lt;/p&gt;"><sup>20</sup></a> The higher the degree of within-cluster similarity, the more variance we observe in cluster-level averages and the more imprecise are our estimates.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;In ordinary least square (OLS) models, we assume errors are independent (error terms between individual observations are uncorrelated with each other) and homoskedastic (the size of errors is homogeneous across individuals). In reality, this is often not the case with cluster sampling.&lt;/p&gt;"><sup>21</sup></a> We address this by considering cluster-robust standard errors in our answer strategy below.</p>
<div id="design-declaration-1" class="section level4">
<h4>
<span class="header-section-number">14.1.5.1</span> Design Declaration<a class="anchor" aria-label="anchor" href="#design-declaration-1"><i class="fas fa-link"></i></a>
</h4>
<ul>
<li>
<strong>M</strong>odel:</li>
</ul>
<p>We specify the variable of interest <span class="math inline">\(Y\)</span> (political ideology, say) as a discrete variable ranging from 1 (most liberal) to 7 (most conservative). We do not define a functional model since we are interested in the population mean of <span class="math inline">\(Y\)</span>. The model also includes information about the number of sampled clusters and the number of individuals per cluster.</p>
<ul>
<li>
<strong>I</strong>nquiry:</li>
</ul>
<p>Our estimand is the population mean of political identification <span class="math inline">\(Y\)</span>. Because we employed random sampling, we can expect the value of the sample mean (<span class="math inline">\(\widehat{\overline{y}}\)</span>) to approximate the true population parameter (<span class="math inline">\(\widehat{\overline{Y}}\)</span>).</p>
<ul>
<li>
<strong>D</strong>ata strategy:</li>
</ul>
<p>Sampling follows a two-stage strategy. We first draw a random sample 30 counties in California, and in each county select 20 individuals at random. This guarantees that each county has the same probability of being included in the sample and each resident within a county the same probability of being in the sample. In this design we estimate <span class="math inline">\(Y\)</span> for n = 600 respondents.</p>
<ul>
<li>
<strong>A</strong>nswer strategy:</li>
</ul>
<p>We estimate the population mean with the sample mean estimator: <span class="math inline">\(\widehat{\overline{Y}} = \frac{1}{n} \sum_1^n Y_i\)</span>, and estimate standard errors under the assumption of independent and heteroskedastic errors as well as cluster-robust standard errors to take into account correlation of errors within clusters. Below we demonstrate the the imprecision of our estimated <span class="math inline">\(\widehat{\overline{Y}}\)</span> when we cluster standard errors and when we do not in the presence of an intracluster correlation coefficient (ICC) of 0.402.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N_blocks</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">N_clusters_in_block</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">N_i_in_cluster</span> <span class="op">&lt;-</span> <span class="fl">50</span>
<span class="va">n_clusters_in_block</span> <span class="op">&lt;-</span> <span class="fl">30</span>
<span class="va">n_i_in_cluster</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="va">icc</span> <span class="op">&lt;-</span> <span class="fl">0.402</span>

<span class="co"># M: Model</span>
<span class="va">fixed_pop</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    block <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N_blocks</span><span class="op">)</span>,
    cluster <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N_clusters_in_block</span><span class="op">)</span>,
    subject <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N_i_in_cluster</span>,
                        latent <span class="op">=</span> <span class="fu">draw_normal_icc</span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0</span>, N <span class="op">=</span> <span class="va">N</span>, clusters <span class="op">=</span> <span class="va">cluster</span>, ICC <span class="op">=</span> <span class="va">icc</span><span class="op">)</span>,
                        Y <span class="op">=</span> <span class="fu">draw_ordered</span><span class="op">(</span>x <span class="op">=</span> <span class="va">latent</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span><span class="op">(</span><span class="op">)</span>

<span class="va">cluster_sampling_design</span> <span class="op">&lt;-</span> <span class="fu">declare_population</span><span class="op">(</span>data <span class="op">=</span> <span class="va">fixed_pop</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># I: Inquiry</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>Ybar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># D: Data Strategy</span>
  <span class="fu">declare_sampling</span><span class="op">(</span>strata <span class="op">=</span> <span class="va">block</span>, 
                   clusters <span class="op">=</span> <span class="va">cluster</span>, n <span class="op">=</span> <span class="va">n_clusters_in_block</span>, 
                   sampling_variable <span class="op">=</span> <span class="st">"Cluster_Sampling_Prob"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">declare_sampling</span><span class="op">(</span>strata <span class="op">=</span> <span class="va">cluster</span>,   n <span class="op">=</span> <span class="va">n_i_in_cluster</span>, 
                   sampling_variable <span class="op">=</span> <span class="st">"Within_Cluster_Sampling_Prob"</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="co"># A: Answer Strategy</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>,
                    model <span class="op">=</span> <span class="va">lm_robust</span>,
                    clusters <span class="op">=</span> <span class="va">cluster</span>,
                    estimand <span class="op">=</span> <span class="st">"Ybar"</span>,
                    label <span class="op">=</span> <span class="st">"Clustered Standard Errors"</span><span class="op">)</span></code></pre></div>
</div>
<div id="takeaways-1" class="section level4">
<h4>
<span class="header-section-number">14.1.5.2</span> Takeaways<a class="anchor" aria-label="anchor" href="#takeaways-1"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diagnosis</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">cluster_sampling_design</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
Design Label
</th>
<th style="text-align:left;">
Estimand Label
</th>
<th style="text-align:left;">
Estimator Label
</th>
<th style="text-align:left;">
Term
</th>
<th style="text-align:left;">
N Sims
</th>
<th style="text-align:left;">
Bias
</th>
<th style="text-align:left;">
RMSE
</th>
<th style="text-align:left;">
Power
</th>
<th style="text-align:left;">
Coverage
</th>
<th style="text-align:left;">
Mean Estimate
</th>
<th style="text-align:left;">
SD Estimate
</th>
<th style="text-align:left;">
Mean Se
</th>
<th style="text-align:left;">
Type S Rate
</th>
<th style="text-align:left;">
Mean Estimand
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
cluster_sampling_design
</td>
<td style="text-align:left;">
Ybar
</td>
<td style="text-align:left;">
Clustered Standard Errors
</td>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:left;">
500
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.25
</td>
<td style="text-align:left;">
1.00
</td>
<td style="text-align:left;">
0.95
</td>
<td style="text-align:left;">
3.97
</td>
<td style="text-align:left;">
0.25
</td>
<td style="text-align:left;">
0.25
</td>
<td style="text-align:left;">
0.00
</td>
<td style="text-align:left;">
3.97
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.01)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
<td style="text-align:left;">
(0.00)
</td>
</tr>
</tbody>
</table></div>
<p>To appreciate the role of clustering better we also plot simulated values of our estimand with standard errors not clustered and with clustered standard errors. To do this we first add an additional estimator to the design that does not take account of clusters.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_design</span> <span class="op">&lt;-</span> <span class="va">cluster_sampling_design</span> <span class="op">+</span> <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>,
                                                          model <span class="op">=</span> <span class="va">lm_robust</span>,
                                                          estimand <span class="op">=</span> <span class="st">"Ybar"</span>,
                                                          label <span class="op">=</span> <span class="st">"Naive Standard Errors"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">diagnosis</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">new_design</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/plot-1.png" width="100%"></div>
<p>The figure above may give us the impression that our estimate with clustered standard errors is less precise, when in fact, it correctly accounts for the uncertainty surrounding our estimates. The blue lines in the graph demonstrate the estimates from simulations which contain our estimand. As our table and graphs show, the share of these simulations over the total number of simulations, also known as coverage, is (correctly) close to 95% in estimations with clustered standard errors and 54% in estimations without clustered standard errors. As expected, the mean estimate itself and the bias is the same in both specifications.</p>
</div>
<div id="exercises" class="section level4">
<h4>
<span class="header-section-number">14.1.5.3</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises"><i class="fas fa-link"></i></a>
</h4>
<ol style="list-style-type: decimal">
<li>Modify the declaration to change the distribution of <span class="math inline">\(Y\)</span> from being uniform to something else: perhaps imagine that more extreme ideologies are more prevalent than moderate ones. Is the sample mean estimator still unbiased? Interpret your answer.</li>
<li>Change the sampling procedure to favor units with higher values of ideology. Is the sample mean estimator still unbiased? Interpret your answer.</li>
<li>Modify the estimation function to use this formula for the standard error: <span class="math inline">\(\widehat{se} \equiv \frac{\widehat\sigma}{\sqrt{n}}\)</span>. This equation differs from the one used in our declaration (it ignores the total population size <span class="math inline">\(N\)</span>). Check that the coverage of this new design is incorrect when <span class="math inline">\(N=n\)</span>. Assess how large <span class="math inline">\(N\)</span> has to be for the difference between these procedures not to matter.</li>
</ol>
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- start post here, do not edit above -->
</div>
</div>
</div>
<div id="poststratification" class="section level2">
<h2>
<span class="header-section-number">14.2</span> Poststratification<a class="anchor" aria-label="anchor" href="#poststratification"><i class="fas fa-link"></i></a>
</h2>
<p>Poststratification is a tool for learning about a population when you have a sample whose units were drawn with unequal (and usually unknown) probabilities. In essence, if you know features of the population that you can measure in your own sample, you can reweight your sample to look like the population—at least along the dimensions you can measure. In its simplest form, poststratification just involves counting and dividing. Say you want to poststratify your sample so that, in terms of gender and age, it looks like all people in their twenties in the United States population in 2010. That gives twenty groups—one for each age and each gender—whose size you need to count in the 2010 Decennial census and in your sample. Then, simply weight each person in the sample by the size of their group in the population divided by the size of their group in the sample. As we illustrate with the declaration below, it turns out that these weights are equivalent to the inverse sampling probabilities one would obtain were one to construct the sample using groups as strata. That’s where the “stratification” in poststratification comes from—it’s “post” because the weights are constructed after the sampling has already taken place. In the online example, we illustrate how Bayesian multi-level regression poststratification (MRP) can help to deal with the fact that, as the number of group-defining features increases, the sample may contain no information at all about some of the groups defined by the combination of those features.</p>
<div id="declaration-2" class="section level3">
<h3>
<span class="header-section-number">14.2.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-2"><i class="fas fa-link"></i></a>
</h3>
<!-- 
JC comment: Original declaration doesn't have correlation between X and Y so this design works even if the estimator is just an intercept. Once I added the correlation, the design was biased. Don't quite understand the demeaning approach (doesn't appear to be using any population-level info?) so have just opted for a more conventional approach to poststratification that reweights to the population proportions. Have also called this poststratification since we are now only using MRP in the extended example. 


```r
fixed_population <- declare_population(N = 500, 
                                       X = sample(c("A", "B", "C"), N, replace = TRUE),
                                       Y = sample(1:7, N, replace = TRUE))()

design <- 
  declare_population(data = fixed_population) + 
  declare_estimand(Ybar = mean(Y)) + 
  declare_sampling(strata_prob = c(0.2, 0.1, 0.3), strata = X) + 
  declare_step(B_demeaned = (X == "B") - mean(X == "B"),
               C_demeaned = (X == "C") - mean(X == "C"), mutate) + 
  declare_estimator(Y ~ B_demeaned + C_demeaned, term = "(Intercept)", model = lm_robust, estimand = "Ybar")
```

-->
<ul>
<li><p><strong>M</strong>odel: We have a fixed, finite population comprised of two groups defined by a binary variable, <span class="math inline">\(X\)</span>. There are 100 people who have <span class="math inline">\(X = 0\)</span> and 50 who have <span class="math inline">\(X = 1\)</span>. The outcome, <span class="math inline">\(Y\)</span>, takes one of three values, 0, 1, and 2, and is a function of <span class="math inline">\(X\)</span>.</p></li>
<li><p><strong>I</strong>nquiry: The researcher wants to know the true average of <span class="math inline">\(Y\)</span> in the population.</p></li>
<li><p><strong>D</strong>ata strategy: Ten individuals from each group are included in the sample. Thus, whereas 2/3 of the population belong to the <span class="math inline">\(X = 0\)</span> group, only 1/2 of the sample does. Conversely, while only 1/3 of the population belongs to the <span class="math inline">\(X = 1\)</span> group, 1/2 of the sample does.</p></li>
<li><p><strong>A</strong>nswer strategy: The answer strategy involves taking a weighted average of <span class="math inline">\(Y\)</span> in the sample, where each unit’s weight is equal to the size of their group in the population divided by the size of their group in the sample. Specifically, those in the underrepresented group, <span class="math inline">\(X = 0\)</span>, get a weight of 100/10 = 10, while the overrepresented group, <span class="math inline">\(X = 1\)</span>, gets a weight of 50 / 10 = 5. When the poststratification groups perfectly line up with the sample strata, as they do here, the approach is equivalent to weighting by the inverse of the sampling probability: 1/(10/100) = 10 and 1/(10/50) = 5. In both cases, the weights tell us how many units in the population each unit in the sample represents.</p></li>
</ul>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fixed_population</span> <span class="op">&lt;-</span> <span class="fu">declare_population</span><span class="op">(</span>
  group <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">2</span>, X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, population_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span>,
  individual <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="va">population_n</span>, Y <span class="op">=</span> <span class="va">X</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span>

<span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>data <span class="op">=</span> <span class="va">fixed_population</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimand</span><span class="op">(</span>Ybar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_sampling</span><span class="op">(</span>strata_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>, strata <span class="op">=</span> <span class="va">X</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_step</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">group_by</span>, groups <span class="op">=</span> <span class="va">X</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_step</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">mutate</span>, 
               sample_n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>, 
               weight <span class="op">=</span> <span class="va">population_n</span> <span class="op">/</span> <span class="va">sample_n</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>, term <span class="op">=</span> <span class="st">"(Intercept)"</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, weights <span class="op">=</span> <span class="va">weight</span>, estimand <span class="op">=</span> <span class="st">"Ybar"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag-1" class="section level3">
<h3>
<span class="header-section-number">14.2.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-1"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-158-1.png" width="100%"></div>
</div>
<div id="exercises-1" class="section level3">
<h3>
<span class="header-section-number">14.2.3</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-1"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Add an unweighted estimator to the design and diagnose it. Explain why the unweighted estimator is biased, as well as the direction of the bias.</li>
<li>Remove <code>X</code> from the definition of <code>Y</code>. Explain why the bias is now equivalent in the two approaches.</li>
<li>Change the <code>strata_n</code> so that 4 people are sampled from the first group and 25 are sampled from the second group.
<ol style="list-style-type: lower-roman">
<li>Calculate the poststratification weight for each group by hand (hint: you can check your answer using <code>draw_data(design)$weight</code>).</li>
<li>Calculate the sample inclusion probability for each group by hand (hint: you can check your answer using <code>draw_data(design)$S_inclusion_prob</code>).</li>
<li>Calculate the inverse of the sampling probability for each group. These should be equal to the poststratification weights.</li>
</ol>
</li>
</ul>
</div>
<div id="example-3" class="section level3">
<h3>
<span class="header-section-number">14.2.4</span> Example<a class="anchor" aria-label="anchor" href="#example-3"><i class="fas fa-link"></i></a>
</h3>
<!-- make sure to rename the section title below -->
</div>
<div id="example-4" class="section level3">
<h3>
<span class="header-section-number">14.2.5</span> Example<a class="anchor" aria-label="anchor" href="#example-4"><i class="fas fa-link"></i></a>
</h3>
<p>You can use the global bib file via rmarkdown cites like this: <span class="citation">Imai, King, and Stuart (<a href="references-4.html#ref-imai2008" role="doc-biblioref">2008</a>)</span></p>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:right;">
district
</th>
<th style="text-align:right;">
population_size
</th>
<th style="text-align:right;">
prop_white
</th>
<th style="text-align:right;">
prop_black
</th>
<th style="text-align:right;">
prop_asian
</th>
<th style="text-align:right;">
prop_hispanic_other
</th>
<th style="text-align:right;">
prop_democrat
</th>
<th style="text-align:right;">
prop_republican
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
41995
</td>
<td style="text-align:right;">
0.6848196
</td>
<td style="text-align:right;">
0.2414573
</td>
<td style="text-align:right;">
0.0325039
</td>
<td style="text-align:right;">
0.0500774
</td>
<td style="text-align:right;">
0.5185611
</td>
<td style="text-align:right;">
0.2436329
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
41076
</td>
<td style="text-align:right;">
0.2573035
</td>
<td style="text-align:right;">
0.6714870
</td>
<td style="text-align:right;">
0.0072305
</td>
<td style="text-align:right;">
0.0904421
</td>
<td style="text-align:right;">
0.7334309
</td>
<td style="text-align:right;">
0.0992582
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
40878
</td>
<td style="text-align:right;">
0.3384706
</td>
<td style="text-align:right;">
0.5112775
</td>
<td style="text-align:right;">
0.0085376
</td>
<td style="text-align:right;">
0.2235677
</td>
<td style="text-align:right;">
0.6786992
</td>
<td style="text-align:right;">
0.1176531
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
41287
</td>
<td style="text-align:right;">
0.8557415
</td>
<td style="text-align:right;">
0.0381718
</td>
<td style="text-align:right;">
0.0790564
</td>
<td style="text-align:right;">
0.0357498
</td>
<td style="text-align:right;">
0.3469342
</td>
<td style="text-align:right;">
0.3956847
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
40722
</td>
<td style="text-align:right;">
0.8473061
</td>
<td style="text-align:right;">
0.0709199
</td>
<td style="text-align:right;">
0.0597957
</td>
<td style="text-align:right;">
0.0208732
</td>
<td style="text-align:right;">
0.3942886
</td>
<td style="text-align:right;">
0.3638110
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
41985
</td>
<td style="text-align:right;">
0.8783613
</td>
<td style="text-align:right;">
0.0674765
</td>
<td style="text-align:right;">
0.0123854
</td>
<td style="text-align:right;">
0.0431821
</td>
<td style="text-align:right;">
0.4042878
</td>
<td style="text-align:right;">
0.3675094
</td>
</tr>
</tbody>
</table></div>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># US population</span>
<span class="va">delaware_population_df</span> <span class="op">&lt;-</span> <span class="fu">fabricate</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">delaware_senate_districts_df</span>,
  individuals <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>
    N <span class="op">=</span> <span class="va">population_size</span>,
    race_white <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prop_white</span><span class="op">)</span>,
    race_black <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prop_black</span><span class="op">)</span>,
    race_asian <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prop_black</span><span class="op">)</span>,
    race_hispanic_other <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prop_hispanic_other</span><span class="op">)</span>,
    pid_republican <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prop_republican</span><span class="op">)</span>,
    pid_democrat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prop_democrat</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"prop_"</span><span class="op">)</span>, <span class="op">-</span><span class="va">population_size</span><span class="op">)</span>

<span class="co"># population weights for MRP</span>
<span class="va">mrp_weights</span> <span class="op">&lt;-</span> <span class="va">delaware_population_df</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">district</span>, <span class="va">race_white</span>, <span class="va">race_black</span>, <span class="va">race_asian</span>, <span class="va">race_hispanic_other</span>, <span class="va">pid_republican</span>, <span class="va">pid_democrat</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarize</span><span class="op">(</span>n_cell <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">district</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>proportion_cell <span class="op">=</span> <span class="va">n_cell</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_cell</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">n_cell</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="va">ungroup</span> 

<span class="va">delaware_population_df</span> <span class="op">&lt;-</span> <span class="va">mrp_weights</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">district</span>, <span class="va">proportion_cell</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">right_join</span><span class="op">(</span><span class="va">delaware_population_df</span><span class="op">)</span>

<span class="co"># Lax and Philips APSR 2009</span>
<span class="co"># Policies are coded dichotomously, 1 for the progay policy and 0 otherwise: Adoption (9 states allow second-parent adoption in all jurisdictions)</span>

<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">delaware_population_df</span>, 
    
    districts <span class="op">=</span> <span class="fu">modify_level</span><span class="op">(</span>district_effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>,
    
    individuals <span class="op">=</span> <span class="fu">modify_level</span><span class="op">(</span>
      noise <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, mean <span class="op">=</span> <span class="va">district_effect</span><span class="op">)</span>,
      policy_support <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span>
        <span class="fl">0.25</span> <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">race_white</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">race_black</span> <span class="op">-</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">race_hispanic_other</span> <span class="op">-</span> 
          <span class="fl">0.1</span> <span class="op">*</span> <span class="va">pid_democrat</span> <span class="op">+</span> <span class="fl">0.15</span> <span class="op">*</span> <span class="va">pid_republican</span> <span class="op">+</span> <span class="va">noise</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  
  <span class="fu">declare_estimand</span><span class="op">(</span>handler <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">%&gt;%</span>
      <span class="fu">group_by</span><span class="op">(</span><span class="va">district</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">summarize</span><span class="op">(</span>estimand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">policy_support</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="va">ungroup</span> <span class="op">%&gt;%</span> 
      <span class="fu">mutate</span><span class="op">(</span>estimand_label <span class="op">=</span> <span class="st">"mean_policy_support"</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">declare_sampling</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">+</span>
  
  <span class="fu">declare_estimator</span><span class="op">(</span>handler <span class="op">=</span> <span class="fu">tidy_estimator</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">data</span> <span class="op">%&gt;%</span>
      <span class="fu">group_by</span><span class="op">(</span><span class="va">district</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">summarize</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">policy_support</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"strata_means"</span>, estimand <span class="op">=</span> <span class="st">"mean_policy_support"</span><span class="op">)</span> <span class="op">+</span> 

  <span class="co"># this estimator owes code to https://timmastny.rbind.io/blog/multilevel-mrp-tidybayes-brms-stan/</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>handler <span class="op">=</span> <span class="fu">tidy_estimator</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>

    <span class="va">model_fit</span> <span class="op">&lt;-</span> <span class="fu">glmer</span><span class="op">(</span>
      formula <span class="op">=</span> <span class="va">policy_support</span> <span class="op">~</span> <span class="va">race_white</span> <span class="op">+</span> <span class="va">race_black</span> <span class="op">+</span> <span class="va">race_asian</span> <span class="op">+</span> <span class="va">race_hispanic_other</span> <span class="op">+</span>
        <span class="va">pid_democrat</span> <span class="op">+</span> <span class="va">pid_republican</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">district</span><span class="op">)</span>,
      data <span class="op">=</span> <span class="va">data</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span><span class="op">)</span>

    <span class="va">data</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>
        support_predicted <span class="op">=</span>
          <span class="fu">prediction</span><span class="op">(</span><span class="va">model_fit</span>, data <span class="op">=</span> <span class="va">.</span>, allow.new.levels <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>,
        support_predicted_weighted <span class="op">=</span> <span class="va">support_predicted</span> <span class="op">*</span> <span class="va">proportion_cell</span>
      <span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">group_by</span><span class="op">(</span><span class="va">district</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">summarize</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">support_predicted_weighted</span><span class="op">)</span><span class="op">)</span>

  <span class="op">}</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"mrp_mle"</span>, estimand <span class="op">=</span> <span class="st">"mean_policy_support"</span><span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">draw_data</span><span class="op">(</span><span class="va">design</span><span class="op">)</span>

<span class="fu">draw_estimates</span><span class="op">(</span><span class="va">design</span><span class="op">)</span>

<span class="va">sims</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">design</span>, sims <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>

<span class="va">diag</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">design</span>, sims <span class="op">=</span> <span class="fl">100</span>, diagnosands <span class="op">=</span> <span class="fu">declare_diagnosands</span><span class="op">(</span>select <span class="op">=</span> <span class="va">bias</span><span class="op">)</span>, add_grouping_variables <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span></code></pre></div>
<p>This chunk is set to <code>echo = TRUE</code> and <code>eval = do_diagnosis</code></p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simulations_pilot</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">design</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span></code></pre></div>
<p>Right after you do simulations, you want to save the simulations rds.</p>
<p>Now all that simulating, saving, and loading is done, and we can use the simulations for whatever you want.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">kable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">simulations_pilot</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
design_label
</th>
<th style="text-align:right;">
sim_ID
</th>
<th style="text-align:left;">
estimator_label
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
<th style="text-align:right;">
conf.low
</th>
<th style="text-align:right;">
conf.high
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:left;">
outcome
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.9624445
</td>
<td style="text-align:right;">
0.1705951
</td>
<td style="text-align:right;">
5.641688
</td>
<td style="text-align:right;">
0.0000002
</td>
<td style="text-align:right;">
0.6234399
</td>
<td style="text-align:right;">
1.301449
</td>
<td style="text-align:right;">
88.32465
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.9532166
</td>
<td style="text-align:right;">
0.2124610
</td>
<td style="text-align:right;">
4.486548
</td>
<td style="text-align:right;">
0.0000200
</td>
<td style="text-align:right;">
0.5315217
</td>
<td style="text-align:right;">
1.374911
</td>
<td style="text-align:right;">
96.66334
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.9674071
</td>
<td style="text-align:right;">
0.2137695
</td>
<td style="text-align:right;">
4.525468
</td>
<td style="text-align:right;">
0.0000170
</td>
<td style="text-align:right;">
0.5431863
</td>
<td style="text-align:right;">
1.391628
</td>
<td style="text-align:right;">
97.96114
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
1.0545908
</td>
<td style="text-align:right;">
0.1942247
</td>
<td style="text-align:right;">
5.429747
</td>
<td style="text-align:right;">
0.0000004
</td>
<td style="text-align:right;">
0.6690878
</td>
<td style="text-align:right;">
1.440094
</td>
<td style="text-align:right;">
96.58766
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
1.0708566
</td>
<td style="text-align:right;">
0.1897958
</td>
<td style="text-align:right;">
5.642153
</td>
<td style="text-align:right;">
0.0000002
</td>
<td style="text-align:right;">
0.6942127
</td>
<td style="text-align:right;">
1.447501
</td>
<td style="text-align:right;">
97.99051
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.7197320
</td>
<td style="text-align:right;">
0.1964379
</td>
<td style="text-align:right;">
3.663916
</td>
<td style="text-align:right;">
0.0004076
</td>
<td style="text-align:right;">
0.3297870
</td>
<td style="text-align:right;">
1.109677
</td>
<td style="text-align:right;">
95.63827
</td>
<td style="text-align:left;">
Y
</td>
</tr>
</tbody>
</table></div>
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- start post here, do not edit above -->
</div>
</div>
<div id="inference-about-unobserved-variables" class="section level2">
<h2>
<span class="header-section-number">14.3</span> Inference about unobserved variables<a class="anchor" aria-label="anchor" href="#inference-about-unobserved-variables"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-3" class="section level3">
<h3>
<span class="header-section-number">14.3.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-3"><i class="fas fa-link"></i></a>
</h3>
<!--
JC Comment: This setup seems a bit odd to me. I don't think anyone ever has the true average amount or score of democracy in mind as their inquiry, or thinks they're getting it by averaging indicators. It seems a bit trivial to show that anyone who sets out to do so gets the answer wrong if they don't anticipate an intercept in the DGP of one of the measures or make the wrong distributional assumptions. My sense is that there are two kinds of estimands people are usually interested in with designs such as these. First, do the things I measured "load" onto the underlying thing in the way I expect; second, do the relative levels stack up as they should (e.g., if Togo is truly less democratic than Benin then I want this to show up in the ordering). I've had a go at one design below that focuses on the second kind of estimand. Not entirely sure about it but I think it may be a step in the right direction and shows off DD flexibility.


```r
design <-
  declare_population(N = 100, Y_star = rnorm(N)) +
  declare_estimand(Y_bar = mean(Y_star)) + 
  declare_measurement(Y_1 = 0.1 * Y_star + rnorm(N, sd = 0.25),
                      Y_2 = Y_star + rnorm(N, sd = 0.25),
                      Y_3 = 1 + 0.5 * Y_star + rnorm(N, sd = 0.25),
                      Y_idx = (Y_1 + Y_2 + Y_3) / 3) + 
  declare_estimator(Y_idx ~ 1, model = lm_robust, estimand = "Y_bar")
```
-->
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">10</span>, Y_star <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, true_rank <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html">rank</a></span><span class="op">(</span><span class="va">Y_star</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_measurement</span><span class="op">(</span>Y_1 <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">Y_star</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,
                      Y_2 <span class="op">=</span> <span class="va">Y_star</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,
                      Y_3 <span class="op">=</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">Y_star</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,
                      Y_idx <span class="op">=</span> <span class="op">(</span><span class="va">Y_1</span> <span class="op">+</span> <span class="va">Y_2</span> <span class="op">+</span> <span class="va">Y_3</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span>, 
                      ranking <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html">rank</a></span><span class="op">(</span><span class="va">Y_idx</span><span class="op">)</span><span class="op">)</span> 

<span class="co"># simulate_design(design) %&gt;% </span>
<span class="co">#   summarize(ranking_correct = mean(true_rank == ranking))</span></code></pre></div>
</div>
<div id="dag-2" class="section level3">
<h3>
<span class="header-section-number">14.3.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-2"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-171-1.png" width="100%"></div>
</div>
<div id="example-5" class="section level3">
<h3>
<span class="header-section-number">14.3.3</span> Example<a class="anchor" aria-label="anchor" href="#example-5"><i class="fas fa-link"></i></a>
</h3>
<!-- make sure to rename the section title below -->

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
<div id="structural-estimation" class="section level2">
<h2>
<span class="header-section-number">14.4</span> Structural estimation<a class="anchor" aria-label="anchor" href="#structural-estimation"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-4" class="section level3">
<h3>
<span class="header-section-number">14.4.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-4"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="dag-3" class="section level3">
<h3>
<span class="header-section-number">14.4.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-3"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="example-6" class="section level3">
<h3>
<span class="header-section-number">14.4.3</span> Example<a class="anchor" aria-label="anchor" href="#example-6"><i class="fas fa-link"></i></a>
</h3>
<!-- make sure to rename the section title below -->

</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="research-design-library.html"><span class="header-section-number">13</span> Research Design Library</a></div>
<div class="next"><a href="experimental-designs-for-descriptive-inference.html"><span class="header-section-number">15</span> Experimental designs for descriptive inference</a></div>
</div></main><div id="on-this-page-nav" class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#observational-designs-for-descriptive-inference"><span class="header-section-number">14</span> Observational designs for descriptive inference</a></li>
<li>
<a class="nav-link" href="#random-sampling"><span class="header-section-number">14.1</span> Random sampling</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-1"><span class="header-section-number">14.1.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag"><span class="header-section-number">14.1.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-2"><span class="header-section-number">14.1.3</span> Example</a></li>
<li><a class="nav-link" href="#simple-random-sampling"><span class="header-section-number">14.1.4</span> Simple random sampling</a></li>
<li><a class="nav-link" href="#stratified-and-clustered-random-sampling"><span class="header-section-number">14.1.5</span> Stratified and clustered random sampling</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#poststratification"><span class="header-section-number">14.2</span> Poststratification</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-2"><span class="header-section-number">14.2.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-1"><span class="header-section-number">14.2.2</span> Dag</a></li>
<li><a class="nav-link" href="#exercises-1"><span class="header-section-number">14.2.3</span> Exercises</a></li>
<li><a class="nav-link" href="#example-3"><span class="header-section-number">14.2.4</span> Example</a></li>
<li><a class="nav-link" href="#example-4"><span class="header-section-number">14.2.5</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#inference-about-unobserved-variables"><span class="header-section-number">14.3</span> Inference about unobserved variables</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-3"><span class="header-section-number">14.3.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-2"><span class="header-section-number">14.3.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-5"><span class="header-section-number">14.3.3</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#structural-estimation"><span class="header-section-number">14.4</span> Structural estimation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-4"><span class="header-section-number">14.4.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-3"><span class="header-section-number">14.4.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-6"><span class="header-section-number">14.4.3</span> Example</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Research Design: Declare, Diagnose, Redesign</strong>" was written by Graeme Blair, Jasper Cooper, Alexander Coppock, and Macartan Humphreys. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>Supported by the Laura and John Arnold Foundation and Evidence in Governance and Politics.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
