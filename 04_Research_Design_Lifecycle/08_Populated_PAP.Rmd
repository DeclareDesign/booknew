---
title: "Populated Preanalysis Plan"
output: html_document
bibliography: ../bib/book.bib 
---

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # files are all relative to RStudio project home
```

```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
# load common packages, set ggplot ddtheme, etc.
source("scripts/before_chapter_script.R")
```

<!-- start post here, do not edit above -->

## Populated Preanalysis Plan {#p4populatedpap}

<!-- make sure to rename the section title below -->

```{r populated-pap, echo = FALSE, output = FALSE, purl = FALSE}
# run the diagnosis (set to TRUE) on your computer for this section only before pushing to Github. no diagnosis will ever take place on github.
do_diagnosis <- FALSE
sims <- 100
b_sims <- 20
```

```{r, echo = FALSE}
# load packages for this section here. note many (DD, tidyverse) are already available, see scripts/package-list.R
```

Inevitably, authors of pre-analysis plans fail to anticipate how, eventually, the data generated by the study will be analyzed. Many of the reasons for the discrepancy were discussed in the previous section on implementation, but other reasons intervene as well. A common reason is that PAPs promise too many analyses -- in the process of writing a paper, some analyses are dropped, others are combined, and still others are added during the writing and revision process. In the next section, we'll describe how to reconcile analyses-as-planned with analyses-as-implemented, but this present section is about what to do with your analysis plan immediately after getting the data back.

We echo proposals made in @Banerjee2020 and @alrababag_2020 that researchers should produce short reports that fulfill the promises made in their PAPs. @Banerjee2020 emphasize that writing PAPs is difficult and usually time constrained, so it is natural that the final paper will reflect further thinking about the full set of empirical approaches. A "populated PAP" serves simply to communicate the results of the promised analyses. @alrababag_2020 cite the tendency of researchers to abandon publication of studies that return null results. In order to address the resulting publication bias, they recommend "null results reports" that share the results of the pre-registered analyses. 

We recommend that authors include mock analyses in their PAPs using mock data. Doing so has the major benefit of being quite specific about the details of the answer strategy. A further benefit comes when it is time to produce a populated PAP, since the realized data can quite straightforwardly be swapped in for the mock data. Given the time invested in producing mock analyses for the PAP, writing up a populated PAP takes only as much effort as is needed to clean the data, which will need to be done in any case.

### Example

In Section \@ref(p4planning), @bonilla_tillery_2020

```{r bonilatillerypopulatedpapregressiontab, echo = FALSE, results = "asis"}
dat <- read_dta("data/bonilla_tillery_clean.dta")

dat <-
  dat %>%
  transmute(
    female = (1 - male),
    lgbtq = lgbt_mem,
    age = ageR,
    religiosity = relfreqR,
    income = incomeR,
    college = college,
    blm_familiarity = familiarity,
    linked_fate = linkedfateR,
    Z = factor(treat, 0:3, c("general", "nationalism", "feminism", "intersectional")),
    blm_support = supportR,
  )

fit_1 <- lm_robust(blm_support ~ Z, data = dat)
fit_2 <- lm_robust(blm_support ~ Z + female + lgbtq + age + religiosity + income + college + linked_fate + blm_familiarity, data = dat)
fit_3 <- lm_robust(blm_support ~ Z*linked_fate, data = dat)
fit_4 <- lm_robust(blm_support ~ Z*blm_familiarity, data = dat)

bookreg(l = list(fit_1, fit_2, fit_3, fit_4), include.ci = FALSE)
```


```{r bonilatillerypopulatedpapcoefplot, echo = FALSE, fig.cap = "Coefficient plot from Bonilla and Tillery design based on the study's realized data.", fig.width = 5, fig.height = 5}
female_df <-
  dat %>%
  group_by(female) %>%
  do(tidy(lm_robust(blm_support ~ Z, data = .))) %>%
  filter(term != "(Intercept)")

female_int <- lm_robust(blm_support  ~ Z*female, data = dat) %>% 
  tidy() %>% filter(str_detect(term, ":")) %>%
  mutate(female = 2,
         term = str_remove(term, ":female")) 

gg_df_1 <-
  female_df %>% 
  bind_rows(female_int) %>%
  mutate(facet = factor(female, 0:2, c("Men", "Women", "Difference")),
         term = str_to_sentence(str_remove(term, "Z")))

g1 <- 
  ggplot(gg_df_1, aes(estimate, term)) +
  geom_point() +
  geom_vline(xintercept = 0, color = gray(0.5), linetype = "dashed") +
  geom_linerange(aes(xmin = conf.low, xmax = conf.high)) +
  facet_wrap(~facet, ncol = 1) +
  theme(axis.title.y = element_blank())

# LGBTQ difference in intersectional treatment

lgbtq_df <-
  dat %>%
  group_by(lgbtq) %>%
  do(tidy(lm_robust(blm_support ~ Z, data = .))) %>%
  filter(term != "(Intercept)")

lgbtq_int <- lm_robust(blm_support ~ Z*lgbtq, data = dat) %>% 
  tidy() %>% 
  filter(str_detect(term, ":")) %>%
  mutate(lgbtq = 2,
         term = str_remove(term, ":lgbtq")) 

gg_df_2 <-
  lgbtq_df %>% 
  bind_rows(lgbtq_int) %>%
  mutate(facet = factor(lgbtq, 0:2, c("LGTBQ", "Non-LGBTQ", "Difference")),
         term = str_to_sentence(str_remove(term, "Z")))

g2 <- 
  ggplot(gg_df_2, aes(estimate, term)) +
  geom_point() +
  geom_vline(xintercept = 0, color = gray(0.5), linetype = "dashed") +
  geom_linerange(aes(xmin = conf.low, xmax = conf.high)) +
  facet_wrap(~facet, ncol = 1) +
  theme(axis.title.y = element_blank())



g1 + g2
```


