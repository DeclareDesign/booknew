---
title: "Pivoting"
output: html_document
bibliography: ../bib/book.bib 
---

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # files are all relative to RStudio project home
```

```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
# load common packages, set ggplot ddtheme, etc.
source("scripts/before_chapter_script.R")
```

<!-- start post here, do not edit above -->

## Pivoting

<!-- make sure to rename the section title below -->

```{r pivoting, echo = FALSE, output = FALSE, purl = FALSE}
# run the diagnosis (set to TRUE) on your computer for this section only before pushing to Github. no diagnosis will ever take place on github.
do_diagnosis <- FALSE
sims <- 100
b_sims <- 20
```

```{r, echo = FALSE}
# load packages for this section here. note many (DD, tidyverse) are already available, see scripts/package-list.R
```

-- Alex's example
-- Nollywood

Nollywood
- 215 cellphone towers randomly sampled from the universe in four states in Southeastern Nigeria; restricted sampling procedure to prevent samples with proximate towers to reduce the risk of geographic spillovers. randomization design was five conditions: two-by-two factorial treat vs placebo film X treat vs placebo SMS plus pure control with measurement cluster randomized at the tower level. 
- learned as data collection began that the SMS treatment had been misallocated, and the treatment SMS was sent to all conditions accidentally by our partner. over one hundred of the sampled towers were treated. 109 towers were untreated. 
- three dimensions of choice: continue or abandon; resample and randomize; retain or reduce number of treatments
- constraints: treatment was out there in many places and had been text message blasted to every subscriber of the major phone company in the area; the film was produced for this region and filmed in the region, so we could not switch areas with the film treatment. (the whole measurement strategy was region-specific too, in its choice of language and pretesting.)
- ultimate choice: step-wedge design for the SMS crossed with two arm trial of the film. 

```{r, eval = FALSE}
design <-
  declare_population(N = 744,
                     U = rnorm(N),
                     potential_outcomes(Y ~ 0.1 * Z + U, conditions = list(
                       Z = c(
                         "backups",
                         "pure_control",
                         "film_placebo_text_placebo",
                         "film_placebo_text_treat",
                         "film_treat_text_placebo",
                         "film_treat_text_treat"
                       )
                     ))) +
  declare_estimand(ATE = mean(Y_Z_1 - Y_Z_0)) +
  declare_sampling(n = 215) +
  declare_assignment(Z = complete_ra(
    N,
    m_each = c(15, 40, 40, 40, 40, 40),
    conditions = c(
      "backups",
      "pure_control",
      "film_placebo_text_placebo",
      "film_placebo_text_treat",
      "film_treat_text_placebo",
      "film_treat_text_treat"
    )
  ), handler = fabricate) +
  declare_measurement(Y = fabricatr::reveal_outcomes(Y ~ Z)) +
  declare_estimator(Y ~ Z, model = lm_robust)

draw_data(design)
  
```

```{r, eval = FALSE}
design <-
  declare_population(
    towers = add_level(
      N = 744,
      U_tower = rnorm(N)
    ),
    citizens = add_level(
      N = 14,
      U = rnorm(N),
      potential_outcomes(Y ~ 0.1 * Z + U + U_tower)
    )
  ) + 
  declare_sampling(clusters = towers) + 
  declare_sampling(n = 109, order_by = U_tower, handler = slice_max) + 
  declare_estimand(ATE = mean(Y_Z_1 - Y_Z_0)) + 
  declare_assignment(Z_film = cluster_ra(N, clusters = towers, prob = 0.5), handler = fabricate) + 
  declare_assignment(Z_)
declare_measurement(Y = reveal_outcomes(Y ~ Z)) + 
  declare_estimator(Y ~ Z, clusters = towers, model = lm_robust)

draw_data(design)
  
```


