<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 17 Experimental designs for causal inference | Research Design: Declare, Diagnose, Redesign</title>
<meta name="author" content="Graeme Blair, Alexander Coppock, and Macartan Humphreys">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<link href="libs/bs4_book-1.0.0/dd_imgpopup.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/bs4_book-1.0.0/dd_imgpopup.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://hypothes.is/embed.js" async></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Research Design: Declare, Diagnose, Redesign</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li class="book-part">Introduction</li>
<li><a class="" href="preamble.html"><span class="header-section-number">1</span> Preamble</a></li>
<li><a class="" href="improving-research-designs.html"><span class="header-section-number">2</span> Improving research designs</a></li>
<li><a class="" href="primer.html"><span class="header-section-number">3</span> Software primer</a></li>
<li><a class="" href="part-i-exercises.html"><span class="header-section-number">4</span> Part I Exercises</a></li>
<li class="book-part">Declaration, Diagnosis, Redesign</li>
<li><a class="" href="declaration.html"><span class="header-section-number">5</span> Declaration</a></li>
<li><a class="" href="specifying-the-model.html"><span class="header-section-number">6</span> Specifying the model</a></li>
<li><a class="" href="defining-the-inquiry.html"><span class="header-section-number">7</span> Defining the inquiry</a></li>
<li><a class="" href="crafting-a-data-strategy.html"><span class="header-section-number">8</span> Crafting a data strategy</a></li>
<li><a class="" href="choosing-an-answer-strategy.html"><span class="header-section-number">9</span> Choosing an answer strategy</a></li>
<li><a class="" href="p2diagnosis.html"><span class="header-section-number">10</span> Diagnosis</a></li>
<li><a class="" href="redesign-2.html"><span class="header-section-number">11</span> Redesign</a></li>
<li><a class="" href="part-ii-exercises.html"><span class="header-section-number">12</span> Part II Exercises</a></li>
<li class="book-part">Research Design Library</li>
<li><a class="" href="research-design-library.html"><span class="header-section-number">13</span> Research Design Library</a></li>
<li><a class="" href="observational-designs-for-descriptive-inference.html"><span class="header-section-number">14</span> Observational designs for descriptive inference</a></li>
<li><a class="" href="experimental-designs-for-descriptive-inference.html"><span class="header-section-number">15</span> Experimental designs for descriptive inference</a></li>
<li><a class="" href="observational-designs-for-causal-inference.html"><span class="header-section-number">16</span> Observational designs for causal inference</a></li>
<li><a class="active" href="experimental-designs-for-causal-inference.html"><span class="header-section-number">17</span> Experimental designs for causal inference</a></li>
<li><a class="" href="complex-designs-1.html"><span class="header-section-number">18</span> Complex designs</a></li>
<li><a class="" href="part-iii-exercises.html"><span class="header-section-number">19</span> Part III Exercises</a></li>
<li class="book-part">Research Design Lifecycle</li>
<li><a class="" href="research-design-lifecycle.html"><span class="header-section-number">20</span> Research Design Lifecycle</a></li>
<li><a class="" href="before.html"><span class="header-section-number">21</span> Before</a></li>
<li><a class="" href="during.html"><span class="header-section-number">22</span> During</a></li>
<li><a class="" href="after.html"><span class="header-section-number">23</span> After</a></li>
<li><a class="" href="part-iv-exercises.html"><span class="header-section-number">24</span> Part IV Exercises</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="experimental-designs-for-causal-inference" class="section level1">
<h1>
<span class="header-section-number">17</span> Experimental designs for causal inference<a class="anchor" aria-label="anchor" href="#experimental-designs-for-causal-inference"><i class="fas fa-link"></i></a>
</h1>
<p>An inquiry is causal if it involves a comparison of counterfactual states of the world and a data strategy is experimental if it involves explicit assignment of units to treatment conditions. Experimental designs for causal inference combine these two elements. The goal of the research is to estimate causal effects and the procedure for doing so involves actively allocating treatments.</p>
<p>The vast majority of experimental designs for causal inference in the social sciences take advantage of researcher control over the assignment of treatments to assign treatments . In the archetypal two-arm randomized trial, a group of <span class="math inline">\(N\)</span> subjects are recruited, <span class="math inline">\(m\)</span> of them are chosen at random to receive treatment and the remaining <span class="math inline">\(N-m\)</span> of them do not receive treatment and serve as controls. The inquiry is the average treatment effect, the answer strategy is the difference-in-means estimator. The strength of the design can be appreciated by analogy to random sampling. The <span class="math inline">\(m\)</span> outcomes in the treatment group represent a random sample from the treated potential outcomes among all <span class="math inline">\(N\)</span> subjects, so the sample mean in the treatment group is a good estimator of the true average treated potential outcome; an analogous claim holds for the control group.</p>
<p>The randomization of treatments to estimate average causal effects is a relatively recent human invention. While glimmers of the idea appeared earlier, it wasn’t until at least the 1920s that explicit randomization appeared in agricultural science, medicine, education, and political science <span class="citation">(Jamison <a href="references.html#ref-Jamison2019" role="doc-biblioref">2019</a>)</span>. Only a few generations of scientists have had access to this tool. Sometimes critics of experiments will charge “you can’t randomize [causal variable they care about]” – while of course there are practical constraints on what treatments researchers can control (ethical, financial, or otherwise), we think the main constraint is researcher creativity. The scientific history of randomized experiments is short – just because it hasn’t been randomized  doesn’t mean it can’t be. (Though by a similar token, just because it  be randomized doesn’t mean that it should be.)</p>
<p>Great television situation comedy shows are said to be “refillable” in the sense that the basic structure of the show can be “refilled” with a huge number of scenarios – this is how we end up with nine full seasons of Seinfeld. Unlike observational studies which require bespoke identification justifications for each new setting, the randomized experiment design is refillable. We follow a standardized algorithm – sample units, randomize treatments, measure outcomes – that reliably generates causal inferences again and again.</p>
<p>Randomized experiments are rightly praised for their desirable inferential properties, but of course they can go wrong in many ways that designers of experiments should anticipate and minimize. These problems include problems in the data strategy (randomization implementation failures, excludability violations, noncompliance, attrition, and interference between units), problems in the answer strategy (conditioning on post-treatment variables, failure to account for clustering, p-hacking), and even problems in the inquiry (estimate-estimand mismatches). Of course all these problems apply a fortiori to non experimental studies, but they are important to emphasize for experimental studies since they are often characterized as being “unbiased” without qualification.</p>
<p>The designs in this chapter proceed from the simplest experimental design – the two arm trial – up through very complex designs like the randomized saturation design. The chapter can very profitably be read alongside <span class="citation">Alan S Gerber and Green (<a href="references.html#ref-GerberGreen2012" role="doc-biblioref">2012</a>)</span>, a foundational text on experimental design.</p>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
<!-- make sure to rename the section title below -->
<div id="individually-randomized-designs" class="section level2">
<h2>
<span class="header-section-number">17.1</span> Individually-randomized designs<a class="anchor" aria-label="anchor" href="#individually-randomized-designs"><i class="fas fa-link"></i></a>
</h2>
<p>All two-arm randomized trials have in common that subjects can be randomly assigned to one of two conditions, typically, one treatment condition and one control condition. Some two-arm trials eschew the pure control condition in favor of a placebo control condition, or even a second treatment condition. The uniting feature of all these designs is that the model includes two and only two potential outcomes for each unit and that the data strategy randomly assigns which of these potential outcomes will be revealed.</p>
<p>A key choice in the design of two arm trials is the random assignment procedure. Will we use simple (coin flip, or Bernoulli) random assignment or will we use complete random assignment? Will the randomization be blocked or clustered? Will we “restrict” the randomization so that only randomizations that generate acceptable levels of balance on pre-treatment characteristic are permitted? We will explore the implications of some of these choices in the coming sections, but for the moment, the main point is that saying “treatments were assigned at random” is insufficient – we need to describe the randomization procedure in detail in order to know how to analyze the resulting experiment. See Section <a href="crafting-a-data-strategy.html#p2assignment">8.2</a> for a description of many different random assignment procedures.</p>
<p>For the remainder of this section, we’ll consider the canonical two arm-trial design described in <span class="citation">Alan S Gerber and Green (<a href="references.html#ref-GerberGreen2012" role="doc-biblioref">2012</a>)</span>. In short, the canonical design conducts complete random assignment in a fixed population, then uses difference-in-means to estimate the average treatment effect. We’ll now unpack this shorthand into the components of M, I, D, and A.</p>
<p>The model specified a fixed sample of <span class="math inline">\(N\)</span> subjects. Here we aren’t imagining that we are sampling from a larger population first – we have in mind a fixed set of units among whom we will conduct our experiment. Under our model, each unit is endowed with two latent potential outcomes: a treated potential outcome and an untreated potential outcome. The potential outcomes themselves have a correlation of <span class="math inline">\(\rho\)</span>. If units with higher untreated potential outcomes also have higher treated potential outcomes, <span class="math inline">\(\rho\)</span> will be positive. Reflecting on how treatment effects might vary from unit to unit gives another way to think about plausible values of <span class="math inline">\(rho\)</span>. If treatment effects very similar from unit to unit, <span class="math inline">\(rho\)</span> will be close to 1. In the limiting case of exactly constant effects (the difference between the treated and untreated potential outcome is exactly the same for every unit), <span class="math inline">\(rho\)</span> is equal to 1. It is difficult (but not impossible) to imagine settings in which <span class="math inline">\(rho\)</span> is negative. If the potential outcomes are negatively correlated, then units with higher treated potential outcomes have lower untreated potential outcomes (large, positive effects) and units with lower treated potential outcomes have higher untreated potential outcomes (large, negative effects).</p>
<p>Developing intuitions about <span class="math inline">\(rho\)</span> is frustrated by the fundamental problem of causal inference: since we can only ever observe a unit in its treated or untreated state (but not both), we can’t directly observe the correlation in potential outcomes. In order to make a guess about <span class="math inline">\(rho\)</span>, we need to reason about treatment effect heterogeneity. When effects are close to homogeneous, <span class="math inline">\(rho\)</span> will be positive. Some patterns of treatment effect heterogeneity will cause <span class="math inline">\(rho\)</span> to be negative, but not all. An example of this might be a “surprising” partisan cue. Imagine that in the control condition, Democratic subjects tend to support a policy (<span class="math inline">\(Y_i(0)\)</span> is high) and Republicans tend to oppose it (<span class="math inline">\(Y_i(0)\)</span> is low). The treatment is a “surprise” endorsement of the by a Republican elite: treatment group Republicans will find themselves supporting the policy (<span class="math inline">\(Y_i(1)\)</span> is high) whereas treatment group Democrats will infer from the Republican endorsement that the policy must not be a good one (<span class="math inline">\(Y_i(1)\)</span> is low.) Treatments with extreme heterogeneity like this example could in principle cause negatively correlated potential outcomes.</p>
<p>Because the model specifies a fixed sample, the inquiries are also be defined at the sample level. The most common inquiry for a two-arm trial is the sample average treatment effect, or SATE. It is equal to the average difference between the treated and untreated potential outcomes for the units in the sample: <span class="math inline">\(\mathbb{E}_{i\in N}[Y_i(1) - Y_i(0)]\)</span>. Two-arm trials can also support other inquiries like the SATE among a subgroup (called a conditional average treatment effect, or CATE), but we’ll leave those inquiries to the side for the moment.</p>
<p>The data strategy uses complete random assignment in which exactly <span class="math inline">\(m\)</span> of <span class="math inline">\(N\)</span> units are assigned to treatment (<span class="math inline">\(Z = 1\)</span>) and the remainder are assigned to control (<span class="math inline">\(Z = 0\)</span>). We measure observed outcomes in such a way that we measure the treated potential outcome in the treatment group and untreated potential outcomes in the control group: <span class="math inline">\(Y = Y_i(1) * Z + Y_i(0)*(1 - Z)\)</span>. This expression is sometimes called the “switching equation” because of the way it “switches” which potential outcome is revealed by the treatment assignment. It also embeds a crucial assumption – that indeed units reveal the potential outcomes they are assigned to. If the experiment encounters noncompliance, this assumption is violated. It’s also violated if we violate “excludability,” i.e., if something other than treatment moves with assignment to treatment. For example, if the treatment group is measured differently from the control group, excludability would be violated.</p>
<p>The answer strategy is the difference-in-means estimator with Neyman standard errors:</p>
<p><span class="math display">\[\begin{align}
\widehat{DIM} &amp;= \frac{\sum_1^mY_i}{m} - \frac{\sum_{m + 1}^NY_i}{N-m} \\
\widehat{se(DIM)} &amp;= \sqrt{\frac{\widehat{Var}(Y_i|Z = 1)}{m} - \frac{\widehat{Var}(Y_i|Z = 0)}{N-m}}\\
\end{align}\]</span></p>
<p>The estimated standard error can be used as an input for two other statistical procedures: null hypothesis significance testing via a <span class="math inline">\(t\)</span>-test and the construction of a 95% confidence interval.</p>
<p>The DAG corresponding to a two-arm randomized trial is very simple. An outcome <span class="math inline">\(Y\)</span> is affected by unknown factors <span class="math inline">\(U\)</span> and a treatment <span class="math inline">\(Z\)</span>. The measurement procedure <span class="math inline">\(Q\)</span> affects <span class="math inline">\(Y\)</span> in the sense that it measures a latent <span class="math inline">\(Y\)</span> and records it in a dataset. No arrows lead into <span class="math inline">\(Z\)</span> because it is randomly assigned. No arrow leads from <span class="math inline">\(Z\)</span> to <span class="math inline">\(Q\)</span>, because we assume no excludability violations wherein the treatment changes how units are measured. This simple DAG confirms that the average causal effect of Z on Y is nonparametrically identified because no back-door paths lead from Z to Y.</p>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-313-1.svg" width="100%"></div>
<div id="analytic-design-diagnosis" class="section level3">
<h3>
<span class="header-section-number">17.1.1</span> Analytic design diagnosis<a class="anchor" aria-label="anchor" href="#analytic-design-diagnosis"><i class="fas fa-link"></i></a>
</h3>
<p>The statistical theory for the canonical two-arm design is very well explored, so analytic expressions for many diagnosands are available.</p>
<ol style="list-style-type: decimal">
<li><p>Bias of the difference-in-means estimator. Equation 2.14 in <span class="citation">Alan S Gerber and Green (<a href="references.html#ref-GerberGreen2012" role="doc-biblioref">2012</a>)</span> demonstrates that regardless of the values (except in degenerate cases) of <span class="math inline">\(m\)</span>, <span class="math inline">\(N\)</span>, or <span class="math inline">\(rho\)</span>, the bias diagnosand is equal to zero. This is the “unbiasedness” property of many randomized experimental designs. On average, the difference-in-means estimates from the canonical design will equal the average treatment effect. As we’ll explore later in this chapter, not every experimental design yields unbiased estimates. Some (like blocked experiments with differential probabilities of assignments) require fix-ups in the answer strategy and others (like clustered experiments with unequal cluster sizes) require fix-ups in the data strategy.</p></li>
<li><p>The true standard error of the difference-in-means estimator. Equation 3.4 in <span class="citation">Alan S Gerber and Green (<a href="references.html#ref-GerberGreen2012" role="doc-biblioref">2012</a>)</span> provides an exact expression for the true standard error of the canonical two-arm trial.</p></li>
</ol>
<p><span class="math display">\[
SE(DIM)= \sqrt{\frac{1}{n-1}\left\{\frac{m\mathbb{V}(Y_i(0))}{n-m} + \frac{(N-m)\mathbb{V}(Y_i(1))}{m} + 2Cov(Y_i(0), Y_i(1))\right\}}
\]</span></p>
<p>This equation contains many design lessons. It shows how the standard error decreases as sample size (<span class="math inline">\(N\)</span>) increases and as the variances of the potential outcomes decrease. It provides a justification for “balanced” designs that assign the same proportion of subjects to treatment and control: if the variances of <span class="math inline">\(Y_i(0)\)</span> and <span class="math inline">\(Y_i(1)\)</span> are equal, then a balanced split of subjects across conditions will yield the lowest standard error. If the variances of the potential outcomes are not equal, the expression suggests allocating more units to the condition with the higher variance.</p>
<ol start="3" style="list-style-type: decimal">
<li><p>Bias of the standard error estimator. Equation 3.4 is the <em>true</em> standard error. We also learn from analytic design diagnosis that the standard error <em>estimator</em> is upwardly biased, which is to say that it is conservative. The intuition for this bias is that we can’t directly estimate the covariance term in Equation 3.4, so we bound the variance under a worst-case assumption.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;See &lt;span class="citation"&gt;Aronow, Green, and Lee (&lt;a href="references.html#ref-aronow_green_lee_2014" role="doc-biblioref"&gt;2014&lt;/a&gt;)&lt;/span&gt; for an alternative bounding procedure.&lt;/p&gt;'><sup>23</sup></a> The amount of bias in the standard error estimator depends on how wrong this worst case assumption is. When <span class="math inline">\(rho\)</span> is equal to 1, the bias goes to zero.</p></li>
<li><p>Coverage. Since the standard errors are upwardly biased – they are “too big” – the statistics that are built on them will inherit this bias as well. The 95% confidence intervals will also be “too big,” so the coverage diagnosand will be above nominal, that is, 95% confidence intervals will cover the true parameter more frequently than 95% of the time.</p></li>
<li><p>Power. Our answer strategy involves conducting a statistical significance test against the null hypothesis that the average outcome in the control group is equal to the average outcome in the treatment group. This test is also built on the estimated standard error, so the upward bias in the standard error estimator will put downward pressure on statistical power. In section <a href="p2diagnosis.html#p2analyticdiagnosis">10.1</a>, we reproduced the formula given in <span class="citation">Alan S Gerber and Green (<a href="references.html#ref-GerberGreen2012" role="doc-biblioref">2012</a>)</span> for statistical power that makes two further restrictions on the canonical design: equally-sized treatment groups and equal variances in the potential outcomes.</p></li>
</ol>
<p>Analytic design diagnosis is tremendously useful, for two reasons. First, we obtain guarantees for a large class of designs. <em>Any</em> experiment that fits into the canonical design will have these properties. Second, we learn from the analytic design diagnosis what the important design parameters are. In our model, we need to think about treatment effect heterogeneity in order to develop expectations about the variances and covariances of the potential outcomes. In our inquiry, we need to be thinking about specific average causal effects – the SATE, not the PATE or the CATE or the LATE. The data strategy in the canonical design is complete random assignment, so we need to think about how many units to assign to treatment (<span class="math inline">\(m\)</span>) relative to control (<span class="math inline">\(N-m\)</span>). The answer strategy is difference-in-means with neyman standard errors – difference in means is unbiased for the ATE, but the Neyman standard error estimator is upwardly biased. This means our coverage will be conservative and we’ll take a small hit to statistical power. We can learn all this from theory, not from simulation.</p>
</div>
<div id="design-diagnosis-through-simulation" class="section level3">
<h3>
<span class="header-section-number">17.1.2</span> Design diagnosis through simulation<a class="anchor" aria-label="anchor" href="#design-diagnosis-through-simulation"><i class="fas fa-link"></i></a>
</h3>
<p>But of course we can declare this design and conduct design diagnosis using simulation. This process will confirm the analytic results, as well as provide estimates of diagnosands for which statisticians have not yet derived analytic expressions. This code produces a “designer” that allows us to easily vary the important components of the design (which of course we only learned about by studying the statistical theory!).</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eq_3.4_designer</span> <span class="op">&lt;-</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">N</span>, <span class="va">m</span>, <span class="va">var_Y0</span>, <span class="va">var_Y1</span>, <span class="va">cov_Y0_Y1</span>, <span class="va">mean_Y0</span>, <span class="va">mean_Y1</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="va">fixed_sample</span> <span class="op">&lt;-</span>
      <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span>
        n <span class="op">=</span> <span class="va">N</span>,
        mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mean_Y0</span>, <span class="va">mean_Y1</span><span class="op">)</span>,
        Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">var_Y0</span>, <span class="va">cov_Y0_Y1</span>, <span class="va">cov_Y0_Y1</span>, <span class="va">var_Y1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,
        empirical <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># this line makes the means and variances "exact" in the sample data</span>
      <span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">set_colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Y_Z_0"</span>, <span class="st">"Y_Z_1"</span><span class="op">)</span><span class="op">)</span>
    
    <span class="fu">declare_population</span><span class="op">(</span>data <span class="op">=</span> <span class="va">fixed_sample</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">declare_assignment</span><span class="op">(</span>m <span class="op">=</span> <span class="va">m</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span>
    
  <span class="op">}</span></code></pre></div>
<p>This simulation investigates how much of the sample we should allocate to the treatment group if the treatment group variance is twice as large as the control group variance. The diagnosis confirms the bias is zero, the true standard errors are what Equation 3.4 predicts, coverage is above nominal, and that we are above the 80% power target for a middle range of <span class="math inline">\(m\)</span>. We learn that power is maximized (and the true standard error is minimized) when we allocate 60 or 70 units (of 100 total) to treatment. We also learn from this that the gains from choosing the unbalanced design (relative to a 50/50 allocation) are very small. Even when the variance in the treatment group is twice as large as the variance in the control group, we don’t lose much when sticking with the balanced design. Since we can never be sure of the relative variances of the treatment and control groups ex ante, this exercise provides further support for choosing balanced designs in many design settings.</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">designs</span> <span class="op">&lt;-</span> 
  <span class="fu">expand_design</span><span class="op">(</span>designer <span class="op">=</span> <span class="va">eq_3.4_designer</span>,
                N <span class="op">=</span> <span class="fl">100</span>,
                m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">90</span>, <span class="fl">10</span><span class="op">)</span>,
                var_Y0 <span class="op">=</span> <span class="fl">1</span>,
                var_Y1 <span class="op">=</span> <span class="fl">2</span>,
                cov_Y0_Y1 <span class="op">=</span> <span class="fl">0.5</span>,
                mean_Y0 <span class="op">=</span> <span class="fl">1.0</span>,
                mean_Y1 <span class="op">=</span> <span class="fl">1.75</span><span class="op">)</span>

<span class="va">dx</span> <span class="op">&lt;-</span> <span class="fu">diagnose_designs</span><span class="op">(</span><span class="va">designs</span>, sims <span class="op">=</span> <span class="fl">100</span>, bootstrap_sims <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">designs</span> <span class="op">&lt;-</span> 
  <span class="fu">expand_design</span><span class="op">(</span>designer <span class="op">=</span> <span class="va">eq_3.4_designer</span>,
                N <span class="op">=</span> <span class="fl">100</span>,
                m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">90</span>, <span class="fl">10</span><span class="op">)</span>,
                var_Y0 <span class="op">=</span> <span class="fl">1</span>,
                var_Y1 <span class="op">=</span> <span class="fl">2</span>,
                cov_Y0_Y1 <span class="op">=</span> <span class="fl">1</span>,
                mean_Y0 <span class="op">=</span> <span class="fl">1.0</span>,
                mean_Y1 <span class="op">=</span> <span class="fl">1.75</span><span class="op">)</span>

<span class="va">dx</span> <span class="op">&lt;-</span> <span class="fu">diagnose_designs</span><span class="op">(</span><span class="va">designs</span>, sims <span class="op">=</span> <span class="fl">200</span>, bootstrap_sims <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>##   design_label   N  m var_Y0 var_Y1 cov_Y0_Y1 mean_Y0 mean_Y1 estimand_label
## 1     design_7 100 70      1      2         1       1    1.75            ATE
##   estimator_label term        bias      rmse power coverage mean_estimate
## 1       estimator    Z -0.02187367 0.1917612   0.9        1     0.7281263
##   sd_estimate   mean_se type_s_rate mean_estimand n_sims
## 1   0.1914693 0.2470444           0          0.75    100</code></pre>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-318-1.svg" width="100%"></div>
</div>
<div id="increasing-precision-through-blocking" class="section level3">
<h3>
<span class="header-section-number">17.1.3</span> Increasing precision through blocking<a class="anchor" aria-label="anchor" href="#increasing-precision-through-blocking"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Increase precision</li>
<li>Watch out for IPW</li>
<li>Blocking on many covariates</li>
</ul>
</div>
<div id="increasing-precision-through-covariate-adjustment" class="section level3">
<h3>
<span class="header-section-number">17.1.4</span> Increasing precision through covariate adjustment<a class="anchor" aria-label="anchor" href="#increasing-precision-through-covariate-adjustment"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>“like blocking” in the answer strategy</li>
<li>Watch out for post-treatment variables</li>
<li>the Lin adjustment</li>
</ul>
</div>
<div id="simulation-comparing-blocking-to-covariate-adjustment" class="section level3">
<h3>
<span class="header-section-number">17.1.5</span> Simulation comparing blocking to covariate adjustment<a class="anchor" aria-label="anchor" href="#simulation-comparing-blocking-to-covariate-adjustment"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://declaredesign.org">DeclareDesign</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">fixed_pop</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_population.html">declare_population</a></span><span class="op">(</span>
    N <span class="op">=</span> <span class="fl">50</span>,
    X1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>,
    X2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>,
    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
  <span class="op">)</span><span class="op">(</span><span class="op">)</span>


<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_population.html">declare_population</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fixed_pop</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_potential_outcomes.html">declare_potential_outcomes</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimand.html">declare_estimand</a></span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span>
  
  
  
  <span class="va">d1</span> <span class="op">&lt;-</span>
  <span class="va">design</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span>
<span class="va">d2</span> <span class="op">&lt;-</span>
  <span class="va">design</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>blocks <span class="op">=</span> <span class="va">X1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span>
<span class="va">d3</span> <span class="op">&lt;-</span>
  <span class="va">design</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>blocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">X1</span>, <span class="va">X2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span>
<span class="va">d4</span> <span class="op">&lt;-</span>
  <span class="va">design</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X1</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span>
<span class="va">d5</span> <span class="op">&lt;-</span>
  <span class="va">design</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X1</span><span class="op">:</span><span class="va">X2</span> , model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span>

<span class="va">balance_test</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_test.html">declare_test</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">~</span> <span class="va">X1</span><span class="op">:</span><span class="va">X2</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, model_summary <span class="op">=</span> <span class="va">glance</span>, label <span class="op">=</span> <span class="st">"balance"</span><span class="op">)</span>

<span class="va">d1</span> <span class="op">&lt;-</span> <span class="va">d1</span> <span class="op">+</span> <span class="va">balance_test</span>
<span class="va">d2</span> <span class="op">&lt;-</span> <span class="va">d2</span> <span class="op">+</span> <span class="va">balance_test</span>
<span class="va">d3</span> <span class="op">&lt;-</span> <span class="va">d3</span> <span class="op">+</span> <span class="va">balance_test</span>
<span class="va">d4</span> <span class="op">&lt;-</span> <span class="va">d4</span> <span class="op">+</span> <span class="va">balance_test</span>
<span class="va">d5</span> <span class="op">&lt;-</span> <span class="va">d5</span> <span class="op">+</span> <span class="va">balance_test</span>

<span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/simulate_design.html">simulate_designs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">d1</span>, <span class="va">d2</span>, <span class="va">d3</span>, <span class="va">d4</span>, <span class="va">d5</span><span class="op">)</span><span class="op">)</span>

<span class="va">gg_df</span> <span class="op">&lt;-</span>
  <span class="va">simulations</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">design_label</span>, <span class="va">estimator_label</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>sd_estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,
            power <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">p.value</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">pivot_wider</span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">design_label</span>, names_from <span class="op">=</span> <span class="va">estimator_label</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sd_estimate</span>, <span class="va">power</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">transmute</span><span class="op">(</span><span class="va">design_label</span>, sd_estimate <span class="op">=</span> <span class="va">sd_estimate_estimator</span>, power <span class="op">=</span> <span class="va">power_estimator</span>, prop_imbalance <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">power_balance</span><span class="op">)</span>


<span class="va">simulations</span> <span class="op">&lt;-</span>
  <span class="va">simulations</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
    <span class="va">design_label</span>,
    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"design_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,
    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"Block on two covariates"</span>,
      <span class="st">"Block on one covariate"</span>,
      <span class="st">"No blocks or controls"</span>,
      <span class="st">"Control for one covariate"</span>,
      <span class="st">"Control for two covariates"</span>
    <span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>


<span class="fu">ggplot</span><span class="op">(</span><span class="va">simulations</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span> <span class="op">~</span> <span class="va">design</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
</div>
<div id="randomization-checks" class="section level3">
<h3>
<span class="header-section-number">17.1.6</span> Randomization checks<a class="anchor" aria-label="anchor" href="#randomization-checks"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Confirm the number of units in each condition</li>
<li>Check balance. Covariate by covariate. Omnibus test.</li>
<li>sub sub sub bullet point: if you’re really worried about it, you can do rerandomization, but it’s really a waste of time, just block.</li>
</ul>
</div>
<div id="what-can-go-wrong" class="section level3">
<h3>
<span class="header-section-number">17.1.7</span> What can go wrong<a class="anchor" aria-label="anchor" href="#what-can-go-wrong"><i class="fas fa-link"></i></a>
</h3>
<p>Even for the simplest two-arm trial design, many things can go wrong. Naturally, the sorts of problems can be described in terms of M, I, D, and A.</p>
<p>The most crucial assumption we made in the model is that that are exactly two potential outcomes for each unit. This is violated if there are “spillovers” between units, say between housemates. If a unit’s outcome depends on the treatment status of their housemate, we could imagine four potential outcomes for each unit: only unit <span class="math inline">\(i\)</span> is treated, only unit <span class="math inline">\(i\)</span>’s housemate is treated, both are treated, or neither is treated. If there are indeed spillovers, but they are ignored, the very definition of the inquiry is malformed. If units don’t even have clearly defined “treated” and “untreated” potential outcomes because of spillovers from others, then we can’t define the ATE in the usual way. The solution to this problem is to <em>elaborate</em> the model to account for all the potential outcomes, then to redefine the inquiry with respect to <em>those</em> potential outcomes.</p>
<p>Other ways for a two arm-trial to go wrong concern the data strategy. If you <em>think</em> you are using complete random assignment but you in fact are not, bias may creep in. A nonrandom assignment procedure might be something like “first-come, first-served.” If you assign the “first” <span class="math inline">\(m\)</span> units to treatment and the remainder to control, the assignment procedure is not randomized. Bias will occur if the potential outcomes of the first <span class="math inline">\(m\)</span> are unlike the potential outcomes of the remaining <span class="math inline">\(N-m\)</span> units.</p>
<p>Sometimes researchers do successfully conduct random assignment, but the random assignment happened to produce treatment and control groups that are unlike each other in observable ways. The unbiasedness property applies to the whole procedure – over many hypothetical iterations of the experiment, the average estimate will be equal to the value of the inquiry. But any <em>particular</em> estimate can be close or far from the true value. A solution to this problem is to change the answer strategy to adjust estimates for covariates, though we would recommend adjusting for covariates regardless of whether the treatment and control groups appear imbalanced (see the following chapters).</p>
<p>Other data strategy problems include noncompliance and attrition. Noncompliance occurs when units’ treatment status differs from their treatment assignment. This is a big enough problem that we devote an entire library entry to it (see “encouragement designs”.). Attrition occurs when we fail to measure outcomes for some units.</p>
</div>
<div id="example-10" class="section level3">
<h3>
<span class="header-section-number">17.1.8</span> Example<a class="anchor" aria-label="anchor" href="#example-10"><i class="fas fa-link"></i></a>
</h3>
<p>ON THE HUNT FOR</p>
<ul>
<li>a two arm trial with complete random assignment. No blocking, no clustering, no multiple treatment arms.</li>
</ul>
<p>[Lauren’s study?]</p>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
<div id="cluster-randomized-designs" class="section level2">
<h2>
<span class="header-section-number">17.2</span> Cluster-randomized designs<a class="anchor" aria-label="anchor" href="#cluster-randomized-designs"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-15" class="section level3">
<h3>
<span class="header-section-number">17.2.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-15"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_population.html">declare_population</a></span><span class="op">(</span>
    V <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>
      N <span class="op">=</span> <span class="fl">100</span>,
      X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">0.3</span><span class="op">)</span>,
      Q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
    <span class="op">)</span>,
    I <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">5</span>,
                  U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_potential_outcomes.html">declare_potential_outcomes</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span> <span class="op">+</span> <span class="va">Q</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimand.html">declare_estimand</a></span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">V</span>,
                     blocks <span class="op">=</span> <span class="va">X</span>,
                     block_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,
                    model <span class="op">=</span> <span class="va">difference_in_means</span>,
                    estimand <span class="op">=</span> <span class="st">"ATE"</span>,
                    label <span class="op">=</span> <span class="st">"Naive DIM"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,
    clusters <span class="op">=</span> <span class="va">V</span>,
    blocks <span class="op">=</span> <span class="va">X</span>,
    model <span class="op">=</span> <span class="va">difference_in_means</span>,
    estimand <span class="op">=</span> <span class="st">"ATE"</span>,
    label <span class="op">=</span> <span class="st">"Blocked and Clustered DIM"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,
    clusters <span class="op">=</span> <span class="va">V</span>,
    fixed_effects <span class="op">=</span> <span class="va">X</span>,
    model <span class="op">=</span> <span class="va">lm_robust</span>,
    estimand <span class="op">=</span> <span class="st">"ATE"</span>,
    label <span class="op">=</span> <span class="st">"Naive FE"</span>
  <span class="op">)</span></code></pre></div>
</div>
<div id="dag-14" class="section level3">
<h3>
<span class="header-section-number">17.2.2</span> DAG<a class="anchor" aria-label="anchor" href="#dag-14"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-325-1.svg" width="100%"></div>
</div>
<div id="example-11" class="section level3">
<h3>
<span class="header-section-number">17.2.3</span> Example<a class="anchor" aria-label="anchor" href="#example-11"><i class="fas fa-link"></i></a>
</h3>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
<!-- make sure to rename the section title below -->
</div>
</div>
<div id="treatment-effect-heterogeneity" class="section level2">
<h2>
<span class="header-section-number">17.3</span> Treatment effect heterogeneity<a class="anchor" aria-label="anchor" href="#treatment-effect-heterogeneity"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>treatment by subgroup interactions</li>
<li>multi-arm trials varying aspects of the intervention</li>
</ul>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://declaredesign.org">DeclareDesign</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape">reshape2</a></span><span class="op">)</span>

<span class="co"># Declare the design ------------------------------------------------------</span>

<span class="va">ATE</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>

<span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_population.html">declare_population</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">1000</span>,
                     binary_covariate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>,
                     normal_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># crucial step in POs: effects are not heterogeneous</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_potential_outcomes.html">declare_potential_outcomes</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">ATE</span><span class="op">*</span><span class="va">Z</span> <span class="op">+</span> <span class="va">normal_error</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># Three estimators</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, subset <span class="op">=</span> <span class="op">(</span><span class="va">binary_covariate</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"CATE_0"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, subset <span class="op">=</span> <span class="op">(</span><span class="va">binary_covariate</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"CATE_1"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">*</span><span class="va">binary_covariate</span>, 
                    model <span class="op">=</span> <span class="va">lm_robust</span>, term <span class="op">=</span> <span class="st">"Z:binary_covariate"</span>, label <span class="op">=</span> <span class="st">"interaction"</span><span class="op">)</span>


<span class="co"># Simulations -------------------------------------------------------------</span>

<span class="co"># sweep across all ATEs from 0 to 0.5</span>
<span class="va">designs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/redesign.html">redesign</a></span><span class="op">(</span><span class="va">design</span>, ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span>
<span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/simulate_design.html">simulate_design</a></span><span class="op">(</span><span class="va">designs</span>, sims <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>


<span class="co"># Summarize simulations ---------------------------------------------------</span>

<span class="va">reshaped_simulations</span> <span class="op">&lt;-</span>
  <span class="va">simulations</span> <span class="op">%&gt;%</span>
  <span class="fu">transmute</span><span class="op">(</span><span class="va">ATE</span>,
            <span class="va">sim_ID</span>,
            <span class="va">estimator_label</span>,
            <span class="va">estimate</span>,
            <span class="va">conf.high</span>,
            <span class="va">conf.low</span>,
            significant <span class="op">=</span> <span class="va">p.value</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span>measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"conf.high"</span>, <span class="st">"conf.low"</span>, <span class="st">"significant"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html">dcast</a></span><span class="op">(</span><span class="va">ATE</span> <span class="op">+</span> <span class="va">sim_ID</span>  <span class="op">~</span> <span class="va">estimator_label</span> <span class="op">+</span> <span class="va">variable</span><span class="op">)</span>


<span class="co"># Plot 1 ------------------------------------------------------------------</span>

<span class="va">gg_df</span> <span class="op">&lt;-</span> 
  <span class="va">reshaped_simulations</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">ATE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>`Significant for one group but not the other` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html">xor</a></span><span class="op">(</span><span class="va">CATE_0_significant</span>, <span class="va">CATE_1_significant</span><span class="op">)</span><span class="op">)</span>,
            `Difference in subgroup effects is significant` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">interaction_significant</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">gather</span><span class="op">(</span><span class="va">condition</span>, <span class="va">power</span>, <span class="op">-</span><span class="va">ATE</span><span class="op">)</span>

<span class="va">g1</span> <span class="op">&lt;-</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="va">gg_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">ATE</span>, <span class="va">power</span>, color <span class="op">=</span> <span class="va">condition</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_label</span><span class="op">(</span>data <span class="op">=</span> <span class="op">(</span><span class="va">.</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">ATE</span> <span class="op">==</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>,
             <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">condition</span><span class="op">)</span>,
             nudge_y <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"True constant effect size"</span>,
    y <span class="op">=</span> <span class="st">"Probability of result (akin to statistical power)"</span>,
    title <span class="op">=</span> <span class="st">"Research question: Are treatment effects different in group A versus group B?"</span>,
    subtitle <span class="op">=</span> <span class="st">"True answer: treatment effects are the same for both groups"</span>,
    caption <span class="op">=</span> <span class="st">"Code: https://gist.github.com/acoppock/803e7ca56ca1e6cbf757bdd9d46a2eb5"</span>
  <span class="op">)</span>


<span class="co"># Plot 2 ------------------------------------------------------------------</span>

<span class="va">g2</span> <span class="op">&lt;-</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="va">reshaped_simulations</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">CATE_0_estimate</span>, <span class="va">CATE_1_estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_errorbarh</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">CATE_0_conf.low</span>, xmax <span class="op">=</span> <span class="va">CATE_0_conf.high</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_errorbar</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">CATE_1_conf.low</span>, ymax <span class="op">=</span> <span class="va">CATE_1_conf.high</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>,
             color <span class="op">=</span> <span class="st">"red"</span>,
             linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>,
             color <span class="op">=</span> <span class="st">"red"</span>,
             linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span> <span class="op">~</span> <span class="va">ATE</span>, labeller <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>strip.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Effect size estimate in group A"</span>,
       y <span class="op">=</span> <span class="st">"Effect size estimate in group B"</span>,
       title <span class="op">=</span> <span class="st">"Joint distribution of subgroup treatment effect estimates under constant effects"</span>,
       caption <span class="op">=</span> <span class="st">"Code: https://gist.github.com/acoppock/803e7ca56ca1e6cbf757bdd9d46a2eb5"</span><span class="op">)</span>


<span class="co"># Save plots --------------------------------------------------------------</span>

<span class="fu">ggsave</span><span class="op">(</span>filename <span class="op">=</span> <span class="st">"het_fx_1.png"</span>, <span class="va">g1</span>, height <span class="op">=</span> <span class="fl">7</span>, width <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>
<span class="fu">ggsave</span><span class="op">(</span>filename <span class="op">=</span> <span class="st">"het_fx_2.png"</span>, <span class="va">g2</span>, height <span class="op">=</span> <span class="fl">7</span>, width <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></code></pre></div>
<div id="declaration-16" class="section level3">
<h3>
<span class="header-section-number">17.3.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-16"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="dag-15" class="section level3">
<h3>
<span class="header-section-number">17.3.2</span> DAG<a class="anchor" aria-label="anchor" href="#dag-15"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="example-12" class="section level3">
<h3>
<span class="header-section-number">17.3.3</span> Example<a class="anchor" aria-label="anchor" href="#example-12"><i class="fas fa-link"></i></a>
</h3>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
<!-- make sure to rename the section title below -->
</div>
</div>
<div id="designs-encountering-noncompliance" class="section level2">
<h2>
<span class="header-section-number">17.4</span> Designs encountering noncompliance<a class="anchor" aria-label="anchor" href="#designs-encountering-noncompliance"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>designs with noncompliance</li>
<li>encouragement designs</li>
<li>placebo-controlled design (note one part is measurement one half is causal)</li>
</ul>
<div id="declaration-17" class="section level3">
<h3>
<span class="header-section-number">17.4.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-17"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">direct_effect_of_encouragement</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>
<span class="va">proportion_defiers</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>

<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_population.html">declare_population</a></span><span class="op">(</span>
    N <span class="op">=</span> <span class="fl">100</span>,
    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span>, <span class="st">"Defier"</span><span class="op">)</span>,
      prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="fl">0.0</span><span class="op">)</span>,
      size <span class="op">=</span> <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>,
    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_potential_outcomes.html">declare_potential_outcomes</a></span><span class="op">(</span>
    <span class="va">D</span> <span class="op">~</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_potential_outcomes.html">declare_potential_outcomes</a></span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="fl">0.25</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Always-Taker"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="fl">0.75</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Defier"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="co"># Building in NO excludability violation</span>
      <span class="fl">0</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span>,
    assignment_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"Z"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimand.html">declare_estimand</a></span><span class="op">(</span>CACE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_D_1_Z_1</span> <span class="op">-</span> <span class="va">Y_D_0_Z_0</span><span class="op">)</span>,
                   subset <span class="op">=</span> <span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/reveal_outcomes.html">reveal_outcomes</a></span><span class="op">(</span><span class="va">D</span>, assignment_variable <span class="op">=</span> <span class="st">"Z"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/reveal_outcomes.html">reveal_outcomes</a></span><span class="op">(</span><span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"Z"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">|</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">iv_robust</span>, estimand <span class="op">=</span> <span class="st">"CACE"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag-16" class="section level3">
<h3>
<span class="header-section-number">17.4.2</span> DAG<a class="anchor" aria-label="anchor" href="#dag-16"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-337-1.svg" width="100%"></div>
</div>
<div id="example-13" class="section level3">
<h3>
<span class="header-section-number">17.4.3</span> Example<a class="anchor" aria-label="anchor" href="#example-13"><i class="fas fa-link"></i></a>
</h3>
<p>To do: demonstrate how violations of no defiers and excludability leads to bias.</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span>, <span class="st">"Defier"</span><span class="op">)</span>
<span class="va">direct_effect_of_encouragement</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>
<span class="va">proportion_defiers</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>

<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_population.html">declare_population</a></span><span class="op">(</span>
    N <span class="op">=</span> <span class="fl">500</span>,
    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>
      <span class="va">types</span>,
      <span class="va">N</span>,
      replace <span class="op">=</span> <span class="cn">TRUE</span>,
      prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.8</span> <span class="op">-</span> <span class="va">proportion_defiers</span>, <span class="va">proportion_defiers</span><span class="op">)</span>
    <span class="op">)</span>,
    noise <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_potential_outcomes.html">declare_potential_outcomes</a></span><span class="op">(</span>
    <span class="va">D</span> <span class="op">~</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_potential_outcomes.html">declare_potential_outcomes</a></span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="fl">0.25</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Always-Taker"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="fl">0.75</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Defier"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="va">direct_effect_of_encouragement</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">noise</span>,
    assignment_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"Z"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimand.html">declare_estimand</a></span><span class="op">(</span>CACE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">Y_D_1_Z_1</span> <span class="op">+</span> <span class="va">Y_D_1_Z_0</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">-</span>
                                 <span class="op">(</span><span class="va">Y_D_0_Z_1</span> <span class="op">+</span> <span class="va">Y_D_0_Z_0</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,
                   subset <span class="op">=</span> <span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/reveal_outcomes.html">reveal_outcomes</a></span><span class="op">(</span><span class="va">D</span>, assignment_variable <span class="op">=</span> <span class="st">"Z"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/reveal_outcomes.html">reveal_outcomes</a></span><span class="op">(</span><span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"Z"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">|</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">iv_robust</span>, estimand <span class="op">=</span> <span class="st">"CACE"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">designs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/redesign.html">redesign</a></span><span class="op">(</span>
  <span class="va">design</span>,
  proportion_defiers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span>, length.out <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,
  direct_effect_of_encouragement <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span>, length.out <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">simulations_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/simulate_design.html">simulate_design</a></span><span class="op">(</span><span class="va">designs</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-341-1.svg" width="100%"></div>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
<div id="multiperiod-designs" class="section level2">
<h2>
<span class="header-section-number">17.5</span> Multiperiod Designs<a class="anchor" aria-label="anchor" href="#multiperiod-designs"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Baseline-endline (connection to covariate control, e.g., controlling for Y_pre)</p></li>
<li>
<p>multiple rounds of post-treatment measurement.</p>
<ul>
<li>One justification is we’re interested in persistence.</li>
<li>multiple measurements decrease variance.</li>
<li>Inquiries: “persistence ratio” ATE_t2 / ATE_t1 versus “average persistence” (Y_{t2}(1) - Y_{t2}(0))/(Y_{t1}(1) - Y_{t1}(0))</li>
</ul>
</li>
<li><p>Crossover</p></li>
<li><p>Stepped Wedge</p></li>
<li><p>Downstream experimentation. add ONE MORE PERIOD!</p></li>
<li><p>Literature: “more T”, Durably reducing Transphobia. Nollywood is stepped wedge. Progressa for baseline endline?</p></li>
<li><p>massive point is that we DONT use time to infer causal effects, we still use the random assignment.</p></li>
</ul>
<p>In a stepped wedge design, individuals are randomly assigned to enter into treatment in different stages and at each stage, their outcomes are remeasured. Figure <a href="experimental-designs-for-causal-inference.html#fig:steppedwedge">17.1</a> illustrates where the study gets its name: as two units are randomly added to the treatment group in each of the three waves, the treatment group increases in “steps” while the control group diminishes.</p>
<p>Often, stepped wedge designs are vaunted for their policy appeal because they allow for everyone to be (eventually) treated in the context of an experiment. However, you could achieve the same goal in a regular two-arm trial by treating everyone after the final wave of measurement, and not all stepped wedge designs involve treating everyone. Beyond its ethical and logistical appeal, the design can squeeze more power out of a small sample by treating each wave as though it were its own study.</p>
<div id="declaration-18" class="section level3">
<h3>
<span class="header-section-number">17.5.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-18"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><strong>M</strong>odel: Eight units are randomized and remeasured at three time points. Importantly, any unit at any given point in time reveals one of only two potential outcomes — treated or untreated. Their untreated potential outcomes consist of a unit- and a unit-period-specific shock. Treated potential outcomes increase relative to the control potential outcome by a rate of 1 each period — in other words, there are bigger treatment effects in later periods.</p></li>
<li><p><strong>I</strong>nquiry: Our estimand is the average treatment effect over all units and periods in the sample. Averaged over the three periods, the ATE is (1 + 2 + 3) / 3 = 2.</p></li>
<li><p><strong>D</strong>ata strategy: Our assignment strategy adds two units (one-quarter of the total sample) to the treatment at random in each wave, leaving two units who are not treated in any wave at all—see the remaining two orange squares at the top-right corner of Figure <a href="experimental-designs-for-causal-inference.html#fig:steppedwedge">17.1</a>. Notice that, while every <em>unit</em> is assigned to a treatment wave with equal probability, each wave reveals treated and untreated potential outcomes of <em>unit-periods</em> with different probabilities. In the first wave, one-quarter of the units reveal their treated potential outcomes; in the second wave, one-half of the units reveal their treated potential outcomes, and in the final wave, three-quarters of the units reveal treated potential outcomes. In essence, our experiment is like a block-randomized trial, with unit-periods grouped into period-specific blocks that have differential probabilities of assignment.</p></li>
<li><p><strong>A</strong>nswer strategy: Just as in a block-randomized trial with differential probabilities, we need to take account of the fact that our assignment strategy “under-represents” treated potential outcomes in the first wave and “over-represents” them in the last wave. Inverse-propensity weights (IPWs) are one way to correct for such disparities. Each unit’s IPW is represented in Figure <a href="experimental-designs-for-causal-inference.html#fig:steppedwedge">17.1</a>. Using these weights, we get a “representative” estimate of the average control and treatment potential outcomes in each wave. If we didn’t apply the weights, we wouldn’t get a representative view of the unobserved potential outcomes we’re sampling, and our estimates would be biased. So what does all this buy us? We also declare a “two-arm” estimator that focuses on wave 2 only, where half of the units are in control and half in treatment. Diagnosis shows that all the remeasuring and randomizing gets us (.52 - .41) / .41 = 27% higher power.</p></li>
</ul>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_population.html">declare_population</a></span><span class="op">(</span>
    unit <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">8</span>,
                     X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>,
    period <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>
      N <span class="op">=</span> <span class="fl">3</span>,
      time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span>,
      p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">4</span><span class="op">)</span>,
      nest <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span>,
    obs <span class="op">=</span> <span class="fu">cross_levels</span><span class="op">(</span>by <span class="op">=</span> <span class="fu">join</span><span class="op">(</span><span class="va">unit</span>, <span class="va">period</span><span class="op">)</span>,
                       U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_potential_outcomes.html">declare_potential_outcomes</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>
    clusters <span class="op">=</span> <span class="va">unit</span>,
    conditions <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,
    assignment_variable <span class="op">=</span> <span class="st">"wave"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="va">wave</span><span class="op">)</span>,
                     ipw <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">p</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Z</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span>,
                     handler <span class="op">=</span> <span class="va">fabricate</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/reveal_outcomes.html">reveal_outcomes</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimand.html">declare_estimand</a></span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,
    model <span class="op">=</span> <span class="va">lm_robust</span>,
    estimand <span class="op">=</span> <span class="st">"ATE"</span>,
    label <span class="op">=</span> <span class="st">"1: Stepped Wedge"</span>,
    weights <span class="op">=</span> <span class="va">ipw</span>,
    clusters <span class="op">=</span> <span class="va">unit</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,
    model <span class="op">=</span> <span class="va">lm_robust</span>,
    estimand <span class="op">=</span> <span class="st">"ATE"</span>,
    label <span class="op">=</span> <span class="st">"2: Wave 2 Only"</span>,
    subset <span class="op">=</span> <span class="va">period</span> <span class="op">==</span> <span class="fl">2</span>
  <span class="op">)</span></code></pre></div>
<div class="figure">
<span id="fig:steppedwedge"></span>
<img src="book_files/figure-html/steppedwedge-1.svg" alt="Illustration of random assignment in a stepped-wedge design." width="100%"><p class="caption">
Figure 17.1: Illustration of random assignment in a stepped-wedge design.
</p>
</div>
</div>
<div id="dag-17" class="section level3">
<h3>
<span class="header-section-number">17.5.2</span> DAG<a class="anchor" aria-label="anchor" href="#dag-17"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-347-1.svg" width="100%"></div>
</div>
<div id="example-14" class="section level3">
<h3>
<span class="header-section-number">17.5.3</span> Example<a class="anchor" aria-label="anchor" href="#example-14"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="exercises-6" class="section level3">
<h3>
<span class="header-section-number">17.5.4</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-6"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>Add an answer strategy to the design that doesn’t include IPWs and diagnose the design.</li>
</ol>
<ol style="list-style-type: lower-roman">
<li>How does this affect the bias in the estimates? Explain your answer.</li>
<li>Now change the potential outcomes function so that the treatment effect is constant across periods. How does this affect the bias? Explain your answer.</li>
<li>How does the relative power of the stepped-wedge over the single-period, two-arm trial change when the treatment effect is restricted to be constant across periods? Explain your answer.</li>
</ol>
<ol start="2" style="list-style-type: decimal">
<li>Our design makes a subtle but crucial assumption about the potential outcomes: namely, that the treated potential outcome revealed in one period is the same irrespective of whether the unit was treated in the previous (or subsequent) periods. What would a violation of this assumption look like?</li>
</ol>
<!-- - Comparing 1 and 2, stepped wedge gives a big improvement in power, is --><!-- unbiased, and gets the coverage correct. Clearly better than just doing a --><!-- cross-section at wave 2.  --><!-- - Estimator 3 shows two pitfalls, however, that can lead us to overestimate --><!-- benefits of SW. --><!-- 1. First, it is biased: [explain how treated POs are more commonly observed in --><!-- periods when they're higher, we need to weight for this. How weights come about: --><!-- There is one way that a unit can be observed in a treated state in wave 1: they --><!-- are assigned to W1 with probability `p_W1`. There are two ways in which a unit --><!-- can be treated in wave 2: they are assigned in W1 with `p_W1` or in W2 with --><!-- `p_W2`. Because being assigned in W1 or in W2 are exclusive and independent --><!-- events, we can get the prob of being treated in any period by wave 2 by summing --><!-- the probs.] --><!-- 2. Second, standard errors are wrong. Units should be treated as clusters (draw --><!-- analogue to two-stage random assignment in saturation design?) --><!-- A natural question is how power changes as more or fewer units are assigned.  --><!-- Here, we consider variations on the stepped wedge design declared above, in  --><!-- which we hold constant at 3 the number of units assigned to the pure control,  --><!-- and shift an increasing proportion of the assignment to later waves. --><!-- ```{r} --><!-- designs <- list( --><!--   a = redesign(design, p_00 = 3/8, p_W1 =  3/8, p_W2 = 1/8, p_W3 = 1/8), --><!--   b = redesign(design, p_00 = 3/8, p_W1 =  2/8, p_W2 = 2/8, p_W3 = 1/8), --><!--   c = redesign(design, p_00 = 3/8, p_W1 =  2/8, p_W2 = 1/8, p_W3 = 2/8), --><!--   d = redesign(design, p_00 = 3/8, p_W1 =  1/8, p_W2 = 3/8, p_W3 = 1/8), --><!--   e = redesign(design, p_00 = 3/8, p_W1 =  1/8, p_W2 = 2/8, p_W3 = 2/8), --><!--   f = redesign(design, p_00 = 3/8, p_W1 =  1/8, p_W2 = 1/8, p_W3 = 3/8) --><!--   ) --><!-- ``` --><!-- ```{r, eval = do_diagnosis & !exists("do_bookdown")} --><!-- # Diagnose design --><!-- diagnoses <- diagnose_designs(designs) --><!-- ``` --><!-- ```{r, echo = FALSE, purl = FALSE} --><!-- # figure out where the dropbox path is, create the directory if it doesn't exist, and name the RDS file --><!-- rds_file_path <- paste0(get_dropbox_path("05_Stepped_Wedge_Designs.Rmd"), "/diagnoses.RDS") --><!-- if (do_diagnosis & !exists("do_bookdown")) { --><!--   write_rds(diagnoses, path = rds_file_path) --><!-- } --><!-- diagnoses <- read_rds(rds_file_path) --><!-- ``` --><!-- ```{r, echo = FALSE} --><!-- designs_data <- names(designs) %>%  --><!--   lapply(function(name) designs[[name]] %>%  --><!--            draw_data %>%  --><!--            mutate(design_id = name)) %>%  --><!--   do.call(what = rbind,args = .) %>%  --><!--   arrange(design_id,wave,i) %>%  --><!--   group_by(t,design_id) %>% --><!--   mutate(i = 1:n(), Assignment = ifelse(Z == 1, "Treatment", "Control"))  --><!-- diags <- diagnoses %>%  --><!--   get_diagnosands() %>%  --><!--   filter(estimator_label == "2: Weighted, clustered SW") %>%  --><!--   mutate( --><!--     design_name = paste0("Design ", design_label, ": W1 = ",8*p_W1, --><!--                          "; W2 = ", 8*p_W2,  --><!--                          "; W3 = ", 8*p_W3,",\nPower = ",round(power,2) --><!--                          ) --><!--   ) --><!-- designs_data <- left_join(designs_data, diags %>% select(design_name, design_label), by = c("design_id" = "design_label")) --><!-- designs_data %>%  --><!--   ggplot(aes(x = t, y = i, fill = Assignment)) + --><!--   geom_tile(color = "white") +  --><!--   scale_fill_manual(values = c(control_color, treatment_color)) + --><!--   dd_theme() + facet_wrap(~ design_name, nrow = 1) +  --><!--   scale_y_continuous("",labels = NULL) --><!-- ``` --><!-- - We see a monotonic decrease in the power as more of the sample is treated  --><!-- later. This occurs because treating units later means observing less of the --><!-- potential outcomes. The potential outcomes are more variant, so we're better --><!-- off when we observe more of them [I think!] --><!-- ### Spillovers --><!-- An important assumption is that the potential outcomes revealed are not a --><!-- function of what wave the unit entered into treatment. In other words, there are --><!-- no Show how, in case of such spillovers, you can just treat the effects as --><!-- different, but then you lose power gains (and possibly change estimand) --><!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- start post here, do not edit above -->
</div>
</div>
<div id="spillover-designs" class="section level2">
<h2>
<span class="header-section-number">17.6</span> Spillover designs<a class="anchor" aria-label="anchor" href="#spillover-designs"><i class="fas fa-link"></i></a>
</h2>
<p>two kinds of spillover designs</p>
<ul>
<li><p>“disconnected” graphs: e.g. connection within households but not across. this includes the “multilevel” design and also the “randomized saturation design”. Aronow shepherd paluck. Ichino and Scheundlin. Sinclair mcconnell green.</p></li>
<li><p>“connected” graphs: stoves, lawnsigns, twitter. Assumption about invariance “far enough” away. Worms.</p></li>
</ul>
<p>Randomized saturation designs are used to measure the diffusion of treatment effects throughout a pre-defined area or network (<span class="citation">Baird et al. (<a href="references.html#ref-bairdetal2018" role="doc-biblioref">2018</a>)</span>). The design works in two phases. First, entire areas or networks are randomly assigned to <em>saturations</em>, e.g. 0%, 25%, and 75% saturation. Then, in each network, units are individually assigned in proportions determined by the saturations: e.g., in the groups randomly assigned to 0%, none of the units are assigned to treatment, while in the groups assigned to 25% and 75%, one-quarter and three-quarters of the units are assigned to treatment, respectively. By comparing untreated units in the 0% groups to their <em>untreated</em> counterparts in the higher-saturation networks, researchers can estimate the indirect treatment effects that result from saturation-induced spillovers.</p>
<div id="declaration-19" class="section level3">
<h3>
<span class="header-section-number">17.6.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-19"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><strong>M</strong>odel: There are four networks each comprised of four units. Units’ treatment assignment is a function of their network’s saturation assignment, which in turn defines the amount of spillover they receive. The spillover is equal to the proportion of units treated in the network. Potential outcomes are thus defined in terms of <code>S</code>—the unit’s group’s saturation—and <code>Z</code>—whether or not a unit is treated.</p></li>
<li><p><strong>I</strong>nquiry: There are two inquiries. First, we want to know the spillover, defined here as the average difference in outcomes when an untreated unit is in a high versus a low saturation network: <span class="math inline">\(\mathbb{E}[Y_i(Z_i = 0, S_i = \text{high})-Y_i(Z_i = 0, S_i = \text{low})]\)</span>. We also want to know the “direct effect”–e.g. what happens to those directly treated if we disregard spillovers. Here it is defined over potential outcomes that the experiment does not reveal, since no one is treated in low-saturation constituencies: <span class="math inline">\(\mathbb{E}[Y_i(Z_i = 1, S_i = \text{low})-Y_i(Z_i = 0, S_i = \text{low})]\)</span>.</p></li>
<li><p><strong>D</strong>ata strategy: We assign entire networks to low (0%) or and high (75%) saturation. We then randomize individuals within groups to treatment or control in the proportions dictated by the saturation. Thus, the saturation is cluster-randomized, whereas treatment is block-randomized.</p></li>
<li><p><strong>A</strong>nswer strategy: We weight each individual by the inverse of the probability that they find themselves in the condition they’re in. The estimator conditions on both the saturation effect and the direct treatment effect. Note that the standard errors are clustered at the network level to account for the clustering of the saturation assignment.</p></li>
</ul>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_population.html">declare_population</a></span><span class="op">(</span>
    group <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">50</span>, X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>,
    unit <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">50</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">group</span>, conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"high"</span><span class="op">)</span>, assignment_variable <span class="op">=</span> <span class="va">S</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_step.html">declare_step</a></span><span class="op">(</span>S_prob <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"low"</span> <span class="op">~</span> <span class="fl">0.25</span>, <span class="va">S</span> <span class="op">==</span> <span class="st">"high"</span> <span class="op">~</span> <span class="fl">0.75</span><span class="op">)</span>, <span class="va">mutate</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_assignment.html">declare_assignment</a></span><span class="op">(</span>blocks <span class="op">=</span> <span class="va">group</span>, prob_unit <span class="op">=</span> <span class="va">S_prob</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_step.html">declare_step</a></span><span class="op">(</span>spillover <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">group</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>,
               handler <span class="op">=</span> <span class="va">fabricate</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_potential_outcomes.html">declare_potential_outcomes</a></span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">spillover</span> <span class="op">*</span> <span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"low"</span><span class="op">)</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">spillover</span> <span class="op">*</span> <span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"high"</span><span class="op">)</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span>,
    conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"high"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimand.html">declare_estimand</a></span><span class="op">(</span>ATE_saturation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_0_S_high</span> <span class="op">-</span> <span class="va">Y_Z_0_S_low</span><span class="op">)</span>,
                   ate_no_spill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1_S_low</span> <span class="op">-</span> <span class="va">Y_Z_0_S_low</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/reveal_outcomes.html">reveal_outcomes</a></span><span class="op">(</span><span class="va">Y</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">S</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/DeclareDesign/man/declare_estimator.html">declare_estimator</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">S</span>,
                    weights <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">S_cond_prob</span> <span class="op">*</span> <span class="va">Z_cond_prob</span><span class="op">)</span>,
                    model <span class="op">=</span> <span class="va">lm_robust</span>,
                    term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Z"</span>, <span class="st">"Shigh"</span><span class="op">)</span>,
                    estimand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ATE_saturation"</span>, <span class="st">"ate_no_spill"</span><span class="op">)</span>,
                    label <span class="op">=</span> <span class="st">"main effect"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag-18" class="section level3">
<h3>
<span class="header-section-number">17.6.2</span> DAG<a class="anchor" aria-label="anchor" href="#dag-18"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-353-1.svg" width="100%"></div>
</div>
<div id="exercises-7" class="section level3">
<h3>
<span class="header-section-number">17.6.3</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-7"><i class="fas fa-link"></i></a>
</h3>
<!-- - Increase the saturation of the "low" condition from 0% to 25% and diagnose the design. Notice how this changes the mean saturation and direct effect estimands. Now set the saturations both equal to 25%. Explain why the two estimands do or do not change. -->
<ul>
<li><p>Setting the saturations back to their original values, remove the <code>weights</code> from the estimator. What happens to the bias? Explain your answer.</p></li>
<li>
<p>In the potential outcomes declaration for <code>Y</code>, add an interaction between the high saturation condition and <code>Z</code>, and diagnose the design with the saturations set to their original values of 0 and .75.</p>
<ol style="list-style-type: decimal">
<li>Why is the estimate of the ATE of the treatment biased whereas the estimate of the saturation effect is not?</li>
<li>Why can the researcher not simply estimate the interaction in this design?</li>
<li>Now increase the low saturation to 25% and add an interaction between <code>Z</code> and <code>S</code> to the estimator. Why does this make the design unbiased again?</li>
</ol>
</li>
</ul>
<!-- ### Online Appendix Applied Example --><!-- @asunka2019, for example, wanted to know if the presence of election monitors at ballot stations would displace violence and fraud to other ballot stations. They randomized constituencies to low, medium, and high levels of saturation, and then randomized ballot stations to have election monitoring or not in low, medium, or high concentrations, depending on the randomized saturation. In the original study, the authors did not include a zero-saturation condition. Here, we declare a simplified version of their design in which a zero-saturation condition is included.  --><!-- Main points to develop: --><!-- - Randomized saturation is great when you get the model right. Though, show how IPW reduces the power to detect main effect, especially if there's no spillover. --><!-- - Randomized saturation assumes a model that may be wrong. In particular, spillovers are restricted to containers. But this might not be correct. --><!-- ### Design Declaration --><!-- - **M**odel:  --><!-- Potential outcomes are defined in terms of `S`---the saturation---and `Z`---whether or not a ballot station is treated. We model spillovers in two ways. In the first, the amount of spillover that affects a unit is determined by how many other units in its network are treated. In the second, the amount of spillover a unit receives is determined by whether that unit's geographic neighbor is treated, irrespective of whether they share a network. --><!-- - **I**nquiry:  --><!-- We want to know the effect of having high and medium levels of saturation versus low saturation in the control: $\E[Y_i(Z_i = 0, S_i = \text{high})-Y_i(Z_i = 0, S_i = \text{low})]$ and $\E[Y_i(Z_i = 0, S_i = \text{medium})-Y_i(Z_i = 0, S_i = \text{low})]$. We also want to know the "direct effect"--e.g. what happens to those directly treated if we disregard spillovers. Here it is defined over potential outcomes that the experiment does not reveal, since no one is treated in low-saturation constituencies: $\E[Y_i(Z_i = 1, S_i = \text{low})-Y_i(Z_i = 0, S_i = \text{low})]$.   --><!-- - **D**ata strategy: We assign entire groups of individual ballot stations to one of three saturations: low (0%), medium (50%), and high (75%). We then randomize individuals within groups to treatment or control in the proportions dictated by the saturation. Thus, the saturation is cluster-randomized, whereas treatment is block-randomized. --><!-- - **A**nswer strategy: We weight each individual by the inverse of the probability that they find themselves in the condition they're in. To estimate spillovers, we run one regression comparing high and one regression comparing medium to low saturation control units. To estimate the direct effect, we run a regression of the outcome on the treatment indicatior on the full sample, controlling for saturation. --><!-- ```{r} --><!-- N_individuals <- 60 --><!-- N_groups <- 15 --><!-- G_per_saturation <- c(5,5,5) --><!-- design <-  --><!--   declare_population(N = N_individuals,  --><!--                      X = 1:N,  --><!--                      U = rnorm(N), --><!--                      G = ntile(X, N_groups)) +  --><!--   declare_assignment(assignment_variable = "S",  --><!--                      clusters = G,  --><!--                      conditions = c("low","med","high"), --><!--                      m_each = G_per_saturation) + --><!--   declare_assignment(prob = 0, --><!--                      blocks = G, --><!--                      assignment_variable = "Z_S_low") + --><!--   declare_assignment(prob = .5, --><!--                      blocks = G, --><!--                      assignment_variable = "Z_S_med") + --><!--   declare_assignment(prob = .75, --><!--                      blocks = G, --><!--                      assignment_variable = "Z_S_high") + --><!--   declare_step( --><!--     spillover_low = ave(Z_S_low, G, FUN = sum) * .1, --><!--     spillover_med = ave(Z_S_med, G, FUN = sum) * .1, --><!--     spillover_high = ave(Z_S_high, G, FUN = sum) * .1, --><!--     handler = fabricate, --><!--     label = "spillover")  + --><!--   declare_potential_outcomes( --><!--     Y ~ Z * -.20 + U +  --><!--       spillover_low * (S == "low") +  --><!--       spillover_med * (S == "med") +  --><!--       spillover_high * (S == "high"), --><!--     conditions = list(Z = c(0,1), S = c("low","med","high"))) + --><!--   declare_estimand(high = mean(Y_Z_0_S_high - Y_Z_0_S_low), --><!--                    med =  mean(Y_Z_0_S_med - Y_Z_0_S_low),  --><!--                    ate_no_spill = mean(Y_Z_1_S_low - Y_Z_0_S_low)) + --><!--   reveal_outcomes(Z,S) + --><!--   declare_step( --><!--     w = 1 / (S_cond_prob * (Z_S_low_cond_prob * (S == "low") +  --><!--                    Z_S_med_cond_prob * (S == "med") +  --><!--                    Z_S_high_cond_prob * (S == "high"))), --><!--     handler = fabricate) + --><!--   reveal_outcomes(Y,c(Z, S)) + --><!--   declare_estimator(model = lm_robust,  --><!--                     formula = Y ~ S, --><!--                     subset = Z == 0 & S %in% c("high","low"),  --><!--                     estimand = "high", --><!--                     weights = w, --><!--                     label = "high vs low") + --><!--   declare_estimator(model = lm_robust,  --><!--                     formula = Y ~ S, --><!--                     subset = Z == 0 & S %in% c("med","low"),  --><!--                     weights = w, --><!--                     estimand = "med", --><!--                     label = "med vs low") + --><!--   declare_estimator(model = lm_robust,  --><!--                     formula = Y ~ Z + S, --><!--                     term = "Z",  --><!--                     weights = w, --><!--                     estimand = "ate_no_spill", --><!--                     label = "main effect") --><!-- ``` --><!-- Here's what our hypothetical country looks like: --><!-- ```{r, echo=FALSE} --><!-- draw_data(design) %>%  --><!--   ggplot(aes(x = 1, y = X, color = as.factor(G))) + --><!--   geom_point() + --><!--   scale_color_discrete("Ballot station") + --><!--   scale_y_continuous("Latitude") + --><!--   scale_x_continuous("Longitude") + --><!--   geom_hline(yintercept = seq(1, N_individuals, by = N_individuals / N_groups) - .5) --><!-- ``` --><!-- Let's diagnose --><!-- ```{r, eval = do_diagnosis & !exists("do_bookdown")} --><!-- diagnosis <- diagnose_design(design, sims = sims) --><!-- ``` --><!-- ```{r, echo = FALSE, purl = FALSE} --><!-- # figure out where the dropbox path is, create the directory if it doesn't exist, and name the RDS file --><!-- rds_file_path <- paste0(get_dropbox_path("06_Randomized_Saturation_Designs"), "/diagnosis.RDS") --><!-- if (do_diagnosis & !exists("do_bookdown")) { --><!--   write_rds(diagnosis, path = rds_file_path) --><!-- } --><!-- diagnosis <- read_rds(rds_file_path) --><!-- ``` --><!-- Our diagnosis shows this design does a pretty great job, under this model of spillovers: --><!-- ```{r} --><!-- diagnosis %>% reshape_diagnosis() %>% kable() --><!-- ``` --><!-- - It's particularly nice, since we're able to estimate the direct effect (whose constitutive POs we never observe) by partialling out spillovers. --><!-- - Show here: power tradeoffs for main effects versus spillovers, in terms of  --><!--   proportion of sample allocated to the "low" versus other conditions --><!-- - and also in terms of IPW (equivalent sample size with everyone in the .5 condition) --><!-- Now, we consider a model of spillovers in which fraud is displaced latitudinally,  --><!-- from one neighbor to the next. Say, because there are roads traveling north and  --><!-- fraudsters disregard boundaries (in reality, they are unlikely to do so). --><!-- ```{r} --><!-- distal_design <- --><!--   replace_step( --><!--     design = design, --><!--     step = "spillover", --><!--     new_step = declare_step( --><!--       next_neighbor = c(N, 1:(N - 1)), --><!--       spillover_low = Z_S_low[next_neighbor], --><!--       spillover_med = Z_S_med[next_neighbor], --><!--       spillover_high = Z_S_high[next_neighbor], --><!--       handler = fabricate --><!--     ) --><!--   ) --><!-- ``` --><!-- ```{r, eval = do_diagnosis & !exists("do_bookdown")} --><!-- distal_diagnosis <- diagnose_design(distal_design, sims = sims) --><!-- ``` --><!-- ```{r, echo = FALSE, purl = FALSE} --><!-- # figure out where the dropbox path is, create the directory if it doesn't exist, and name the RDS file --><!-- rds_file_path <- paste0(get_dropbox_path("06_Randomized_Saturation_Designs"), "/distal_diagnosis.RDS") --><!-- if (do_diagnosis & !exists("do_bookdown")) { --><!--   write_rds(distal_diagnosis, path = rds_file_path) --><!-- } --><!-- distal_diagnosis <- read_rds(rds_file_path) --><!-- ``` --><!-- - When there are next-neighbor spillovers that ignore boundaries, the estimator is biased again --><!-- ```{r} --><!-- distal_diagnosis %>% reshape_diagnosis() %>% kable() --><!-- ``` -->
</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="observational-designs-for-causal-inference.html"><span class="header-section-number">16</span> Observational designs for causal inference</a></div>
<div class="next"><a href="complex-designs-1.html"><span class="header-section-number">18</span> Complex designs</a></div>
</div></main><div id="on-this-page-nav" class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#experimental-designs-for-causal-inference"><span class="header-section-number">17</span> Experimental designs for causal inference</a></li>
<li>
<a class="nav-link" href="#individually-randomized-designs"><span class="header-section-number">17.1</span> Individually-randomized designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#analytic-design-diagnosis"><span class="header-section-number">17.1.1</span> Analytic design diagnosis</a></li>
<li><a class="nav-link" href="#design-diagnosis-through-simulation"><span class="header-section-number">17.1.2</span> Design diagnosis through simulation</a></li>
<li><a class="nav-link" href="#increasing-precision-through-blocking"><span class="header-section-number">17.1.3</span> Increasing precision through blocking</a></li>
<li><a class="nav-link" href="#increasing-precision-through-covariate-adjustment"><span class="header-section-number">17.1.4</span> Increasing precision through covariate adjustment</a></li>
<li><a class="nav-link" href="#simulation-comparing-blocking-to-covariate-adjustment"><span class="header-section-number">17.1.5</span> Simulation comparing blocking to covariate adjustment</a></li>
<li><a class="nav-link" href="#randomization-checks"><span class="header-section-number">17.1.6</span> Randomization checks</a></li>
<li><a class="nav-link" href="#what-can-go-wrong"><span class="header-section-number">17.1.7</span> What can go wrong</a></li>
<li><a class="nav-link" href="#example-10"><span class="header-section-number">17.1.8</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#cluster-randomized-designs"><span class="header-section-number">17.2</span> Cluster-randomized designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-15"><span class="header-section-number">17.2.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-14"><span class="header-section-number">17.2.2</span> DAG</a></li>
<li><a class="nav-link" href="#example-11"><span class="header-section-number">17.2.3</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#treatment-effect-heterogeneity"><span class="header-section-number">17.3</span> Treatment effect heterogeneity</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-16"><span class="header-section-number">17.3.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-15"><span class="header-section-number">17.3.2</span> DAG</a></li>
<li><a class="nav-link" href="#example-12"><span class="header-section-number">17.3.3</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#designs-encountering-noncompliance"><span class="header-section-number">17.4</span> Designs encountering noncompliance</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-17"><span class="header-section-number">17.4.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-16"><span class="header-section-number">17.4.2</span> DAG</a></li>
<li><a class="nav-link" href="#example-13"><span class="header-section-number">17.4.3</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#multiperiod-designs"><span class="header-section-number">17.5</span> Multiperiod Designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-18"><span class="header-section-number">17.5.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-17"><span class="header-section-number">17.5.2</span> DAG</a></li>
<li><a class="nav-link" href="#example-14"><span class="header-section-number">17.5.3</span> Example</a></li>
<li><a class="nav-link" href="#exercises-6"><span class="header-section-number">17.5.4</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#spillover-designs"><span class="header-section-number">17.6</span> Spillover designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-19"><span class="header-section-number">17.6.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-18"><span class="header-section-number">17.6.2</span> DAG</a></li>
<li><a class="nav-link" href="#exercises-7"><span class="header-section-number">17.6.3</span> Exercises</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="download-code" href="./experimental-designs-for-causal-inference.R"><i class="far fa-file-code"></i> Download R code</a></li>
          
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Research Design: Declare, Diagnose, Redesign</strong>" was written by Graeme Blair, Alexander Coppock, and Macartan Humphreys. </p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
