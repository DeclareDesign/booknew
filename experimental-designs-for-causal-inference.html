<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 17 Experimental designs for causal inference | Research Design: Declare, Diagnose, Redesign</title>
<meta name="author" content="Graeme Blair, Jasper Cooper, Alexander Coppock, and Macartan Humphreys">
<!-- CSS --><!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.1.9000/tabs.js"></script><script src="libs/bs3compat-0.2.1.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://hypothes.is/embed.js" async></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Research Design: Declare, Diagnose, Redesign</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li class="book-part">Introduction</li>
<li><a class="" href="preamble.html"><span class="header-section-number">1</span> Preamble</a></li>
<li><a class="" href="improving-research-designs.html"><span class="header-section-number">2</span> Improving research designs</a></li>
<li><a class="" href="software-primer.html"><span class="header-section-number">3</span> Software primer</a></li>
<li><a class="" href="part-i-exercises.html"><span class="header-section-number">4</span> Part I Exercises</a></li>
<li class="book-part">Declaration, Diagnosis, Redesign</li>
<li><a class="" href="formalizing-mida.html"><span class="header-section-number">5</span> Formalizing MIDA</a></li>
<li><a class="" href="specifying-the-model.html"><span class="header-section-number">6</span> Specifying the model</a></li>
<li><a class="" href="defining-the-inquiry.html"><span class="header-section-number">7</span> Defining the inquiry</a></li>
<li><a class="" href="crafting-a-data-strategy.html"><span class="header-section-number">8</span> Crafting a data strategy</a></li>
<li><a class="" href="choosing-an-answer-strategy.html"><span class="header-section-number">9</span> Choosing an answer strategy</a></li>
<li><a class="" href="diagnosis.html"><span class="header-section-number">10</span> Diagnosis</a></li>
<li><a class="" href="redesign-1.html"><span class="header-section-number">11</span> Redesign</a></li>
<li><a class="" href="part-ii-exercises.html"><span class="header-section-number">12</span> Part II Exercises</a></li>
<li class="book-part">Design Library</li>
<li><a class="" href="design-library.html"><span class="header-section-number">13</span> Design Library</a></li>
<li><a class="" href="observational-designs-for-descriptive-inference.html"><span class="header-section-number">14</span> Observational designs for descriptive inference</a></li>
<li><a class="" href="experimental-designs-for-descriptive-inference.html"><span class="header-section-number">15</span> Experimental designs for descriptive inference</a></li>
<li><a class="" href="observational-designs-for-causal-inference.html"><span class="header-section-number">16</span> Observational designs for causal inference</a></li>
<li><a class="active" href="experimental-designs-for-causal-inference.html"><span class="header-section-number">17</span> Experimental designs for causal inference</a></li>
<li><a class="" href="exercises-6.html"><span class="header-section-number">18</span> Exercises</a></li>
<li><a class="" href="multi-study-designs.html"><span class="header-section-number">19</span> Multi-study designs</a></li>
<li><a class="" href="part-iii-exercises.html"><span class="header-section-number">20</span> Part III Exercises</a></li>
<li class="book-part">Research Design Lifecycle</li>
<li><a class="" href="research-design-lifecycle.html"><span class="header-section-number">21</span> Research Design Lifecycle</a></li>
<li><a class="" href="planning.html"><span class="header-section-number">22</span> Planning</a></li>
<li><a class="" href="ethical-review.html"><span class="header-section-number">23</span> Ethical Review</a></li>
<li><a class="" href="partners.html"><span class="header-section-number">24</span> Partners</a></li>
<li><a class="" href="funding.html"><span class="header-section-number">25</span> Funding</a></li>
<li><a class="" href="piloting.html"><span class="header-section-number">26</span> Piloting</a></li>
<li><a class="" href="implementation.html"><span class="header-section-number">27</span> Implementation</a></li>
<li><a class="" href="populated-preanalysis-plan.html"><span class="header-section-number">28</span> Populated Preanalysis Plan</a></li>
<li><a class="" href="reconciliation.html"><span class="header-section-number">29</span> Reconciliation</a></li>
<li><a class="" href="writing.html"><span class="header-section-number">30</span> Writing</a></li>
<li><a class="" href="publication.html"><span class="header-section-number">31</span> Publication</a></li>
<li><a class="" href="archiving.html"><span class="header-section-number">32</span> Archiving</a></li>
<li><a class="" href="reanalysis.html"><span class="header-section-number">33</span> Reanalysis</a></li>
<li><a class="" href="replication.html"><span class="header-section-number">34</span> Replication</a></li>
<li><a class="" href="resolving-disputes.html"><span class="header-section-number">35</span> Resolving Disputes</a></li>
<li><a class="" href="synthesis.html"><span class="header-section-number">36</span> Synthesis</a></li>
<li><a class="" href="part-iv-exercises.html"><span class="header-section-number">37</span> Part IV Exercises</a></li>
<li class="book-part">Epilogue</li>
<li><a class="" href="epilogue.html"><span class="header-section-number">38</span> Epilogue</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="glossary.html"><span class="header-section-number">39</span> Glossary</a></li>
<li><a class="" href="references-4.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/DeclareDesign/book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="experimental-designs-for-causal-inference" class="section level1">
<h1>
<span class="header-section-number">17</span> Experimental designs for causal inference<a class="anchor" aria-label="anchor" href="#experimental-designs-for-causal-inference"><i class="fas fa-link"></i></a>
</h1>
<p>Section introduction</p>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
<div id="two-arm-trials" class="section level2">
<h2>
<span class="header-section-number">17.1</span> Two arm trials<a class="anchor" aria-label="anchor" href="#two-arm-trials"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-15" class="section level3">
<h3>
<span class="header-section-number">17.1.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-15"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag-15" class="section level3">
<h3>
<span class="header-section-number">17.1.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-15"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-352-1.png" width="100%"></div>
</div>
<div id="example-17" class="section level3">
<h3>
<span class="header-section-number">17.1.3</span> Example<a class="anchor" aria-label="anchor" href="#example-17"><i class="fas fa-link"></i></a>
</h3>
<!-- make sure to rename the section title below -->
<p>You can use the global bib file via rmarkdown cites like this: <span class="citation">Imai, King, and Stuart (<a href="references-4.html#ref-imai2008">2008</a>)</span></p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">u</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span><span class="op">)</span></code></pre></div>
<p>This chunk is set to <code>echo = TRUE</code> and <code>eval = do_diagnosis</code></p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simulations_pilot</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">design</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span></code></pre></div>
<p>Right after you do simulations, you want to save the simulations rds.</p>
<p>Now all that simulating, saving, and loading is done, and we can use the simulations for whatever you want.</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">kable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">simulations_pilot</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
design_label
</th>
<th style="text-align:right;">
sim_ID
</th>
<th style="text-align:left;">
estimator_label
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
<th style="text-align:right;">
conf.low
</th>
<th style="text-align:right;">
conf.high
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:left;">
outcome
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.9624445
</td>
<td style="text-align:right;">
0.1705951
</td>
<td style="text-align:right;">
5.641688
</td>
<td style="text-align:right;">
0.0000002
</td>
<td style="text-align:right;">
0.6234399
</td>
<td style="text-align:right;">
1.301449
</td>
<td style="text-align:right;">
88.32465
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.9532166
</td>
<td style="text-align:right;">
0.2124610
</td>
<td style="text-align:right;">
4.486548
</td>
<td style="text-align:right;">
0.0000200
</td>
<td style="text-align:right;">
0.5315217
</td>
<td style="text-align:right;">
1.374911
</td>
<td style="text-align:right;">
96.66334
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.9674071
</td>
<td style="text-align:right;">
0.2137695
</td>
<td style="text-align:right;">
4.525468
</td>
<td style="text-align:right;">
0.0000170
</td>
<td style="text-align:right;">
0.5431863
</td>
<td style="text-align:right;">
1.391628
</td>
<td style="text-align:right;">
97.96114
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
1.0545908
</td>
<td style="text-align:right;">
0.1942247
</td>
<td style="text-align:right;">
5.429747
</td>
<td style="text-align:right;">
0.0000004
</td>
<td style="text-align:right;">
0.6690878
</td>
<td style="text-align:right;">
1.440094
</td>
<td style="text-align:right;">
96.58766
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
1.0708566
</td>
<td style="text-align:right;">
0.1897958
</td>
<td style="text-align:right;">
5.642153
</td>
<td style="text-align:right;">
0.0000002
</td>
<td style="text-align:right;">
0.6942127
</td>
<td style="text-align:right;">
1.447501
</td>
<td style="text-align:right;">
97.99051
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.7197320
</td>
<td style="text-align:right;">
0.1964379
</td>
<td style="text-align:right;">
3.663916
</td>
<td style="text-align:right;">
0.0004076
</td>
<td style="text-align:right;">
0.3297870
</td>
<td style="text-align:right;">
1.109677
</td>
<td style="text-align:right;">
95.63827
</td>
<td style="text-align:left;">
Y
</td>
</tr>
</tbody>
</table></div>
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- start post here, do not edit above -->
</div>
</div>
<div id="blocked-trials" class="section level2">
<h2>
<span class="header-section-number">17.2</span> Blocked trials<a class="anchor" aria-label="anchor" href="#blocked-trials"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-16" class="section level3">
<h3>
<span class="header-section-number">17.2.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-16"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>,
                     X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">0.3</span><span class="op">)</span>,
                     U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>blocks <span class="op">=</span> <span class="va">X</span>, block_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"Naive DIM"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,
                    blocks <span class="op">=</span> <span class="va">X</span>,
                    estimand <span class="op">=</span> <span class="st">"ATE"</span>,
                    label <span class="op">=</span> <span class="st">"Blocked DIM"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag-16" class="section level3">
<h3>
<span class="header-section-number">17.2.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-16"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-363-1.png" width="100%"></div>
</div>
<div id="example-18" class="section level3">
<h3>
<span class="header-section-number">17.2.3</span> Example<a class="anchor" aria-label="anchor" href="#example-18"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="two-arm-trials-and-designs-with-blocking-and-clustering" class="section level3">
<h3>
<span class="header-section-number">17.2.4</span> Two-arm trials and designs with blocking and clustering<a class="anchor" aria-label="anchor" href="#two-arm-trials-and-designs-with-blocking-and-clustering"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    villages <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">0.3</span><span class="op">)</span>, Q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>,
    people <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">5</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span> <span class="op">+</span> <span class="va">Q</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">villages</span>, blocks <span class="op">=</span> <span class="va">X</span>, block_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"Naive DIM"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, clusters <span class="op">=</span> <span class="va">villages</span>, blocks <span class="op">=</span> <span class="va">X</span>, model <span class="op">=</span> <span class="va">difference_in_means</span>, 
    estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"Blocked DIM"</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimator</span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, clusters <span class="op">=</span> <span class="va">villages</span>, fixed_effects <span class="op">=</span> <span class="va">X</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, 
    estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"Naive FE"</span>
  <span class="op">)</span></code></pre></div>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
<div id="multiarm-designs" class="section level2">
<h2>
<span class="header-section-number">17.3</span> Multiarm Designs<a class="anchor" aria-label="anchor" href="#multiarm-designs"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-17" class="section level3">
<h3>
<span class="header-section-number">17.3.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-17"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="dag-17" class="section level3">
<h3>
<span class="header-section-number">17.3.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-17"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="example-19" class="section level3">
<h3>
<span class="header-section-number">17.3.3</span> Example<a class="anchor" aria-label="anchor" href="#example-19"><i class="fas fa-link"></i></a>
</h3>
<!-- make sure to rename the section title below -->
<p>You can use the global bib file via rmarkdown cites like this: <span class="citation">Imai, King, and Stuart (<a href="references-4.html#ref-imai2008">2008</a>)</span></p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, u <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">u</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">difference_in_means</span><span class="op">)</span></code></pre></div>
<p>This chunk is set to <code>echo = TRUE</code> and <code>eval = do_diagnosis</code></p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simulations_pilot</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">design</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span></code></pre></div>
<p>Right after you do simulations, you want to save the simulations rds.</p>
<p>Now all that simulating, saving, and loading is done, and we can use the simulations for whatever you want.</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">kable</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">simulations_pilot</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
design_label
</th>
<th style="text-align:right;">
sim_ID
</th>
<th style="text-align:left;">
estimator_label
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
<th style="text-align:right;">
conf.low
</th>
<th style="text-align:right;">
conf.high
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:left;">
outcome
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.9624445
</td>
<td style="text-align:right;">
0.1705951
</td>
<td style="text-align:right;">
5.641688
</td>
<td style="text-align:right;">
0.0000002
</td>
<td style="text-align:right;">
0.6234399
</td>
<td style="text-align:right;">
1.301449
</td>
<td style="text-align:right;">
88.32465
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.9532166
</td>
<td style="text-align:right;">
0.2124610
</td>
<td style="text-align:right;">
4.486548
</td>
<td style="text-align:right;">
0.0000200
</td>
<td style="text-align:right;">
0.5315217
</td>
<td style="text-align:right;">
1.374911
</td>
<td style="text-align:right;">
96.66334
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.9674071
</td>
<td style="text-align:right;">
0.2137695
</td>
<td style="text-align:right;">
4.525468
</td>
<td style="text-align:right;">
0.0000170
</td>
<td style="text-align:right;">
0.5431863
</td>
<td style="text-align:right;">
1.391628
</td>
<td style="text-align:right;">
97.96114
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
1.0545908
</td>
<td style="text-align:right;">
0.1942247
</td>
<td style="text-align:right;">
5.429747
</td>
<td style="text-align:right;">
0.0000004
</td>
<td style="text-align:right;">
0.6690878
</td>
<td style="text-align:right;">
1.440094
</td>
<td style="text-align:right;">
96.58766
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
1.0708566
</td>
<td style="text-align:right;">
0.1897958
</td>
<td style="text-align:right;">
5.642153
</td>
<td style="text-align:right;">
0.0000002
</td>
<td style="text-align:right;">
0.6942127
</td>
<td style="text-align:right;">
1.447501
</td>
<td style="text-align:right;">
97.99051
</td>
<td style="text-align:left;">
Y
</td>
</tr>
<tr>
<td style="text-align:left;">
design
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:left;">
estimator
</td>
<td style="text-align:left;">
Z
</td>
<td style="text-align:right;">
0.7197320
</td>
<td style="text-align:right;">
0.1964379
</td>
<td style="text-align:right;">
3.663916
</td>
<td style="text-align:right;">
0.0004076
</td>
<td style="text-align:right;">
0.3297870
</td>
<td style="text-align:right;">
1.109677
</td>
<td style="text-align:right;">
95.63827
</td>
<td style="text-align:left;">
Y
</td>
</tr>
</tbody>
</table></div>
<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book--><!-- start post here, do not edit above -->
</div>
</div>
<div id="encouragement-designs" class="section level2">
<h2>
<span class="header-section-number">17.4</span> Encouragement designs<a class="anchor" aria-label="anchor" href="#encouragement-designs"><i class="fas fa-link"></i></a>
</h2>
<div id="declaration-18" class="section level3">
<h3>
<span class="header-section-number">17.4.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-18"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">direct_effect_of_encouragement</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>
<span class="va">proportion_defiers</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>


<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    N <span class="op">=</span> <span class="fl">100</span>,
    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span>, <span class="st">"Defier"</span><span class="op">)</span>,
      prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="fl">0.0</span><span class="op">)</span>,
      size <span class="op">=</span> <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>,
    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">D</span> <span class="op">~</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="fl">0.25</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Always-Taker"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="fl">0.75</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Defier"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="co"># Building in NO excludability violation</span>
      <span class="fl">0</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span>,
    assignment_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"Z"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>CACE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_D_1_Z_1</span> <span class="op">-</span> <span class="va">Y_D_0_Z_0</span><span class="op">)</span>,
                   subset <span class="op">=</span> <span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">D</span>, assignment_variable <span class="op">=</span> <span class="st">"Z"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"Z"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">|</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">iv_robust</span>, estimand <span class="op">=</span> <span class="st">"CACE"</span><span class="op">)</span></code></pre></div>
</div>
<div id="dag-18" class="section level3">
<h3>
<span class="header-section-number">17.4.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-18"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-379-1.png" width="100%"></div>
</div>
<div id="example-20" class="section level3">
<h3>
<span class="header-section-number">17.4.3</span> Example<a class="anchor" aria-label="anchor" href="#example-20"><i class="fas fa-link"></i></a>
</h3>
<p>Idea for this one would be to show how violations of no defiers and excludability lead to bias.</p>
<!-- make sure to rename the section title below -->
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span>, <span class="st">"Defier"</span><span class="op">)</span>
<span class="va">direct_effect_of_encouragement</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>
<span class="va">proportion_defiers</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>

<span class="va">design</span> <span class="op">&lt;-</span>
  <span class="fu">declare_population</span><span class="op">(</span>
    N <span class="op">=</span> <span class="fl">500</span>,
    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>
      <span class="va">types</span>,
      <span class="va">N</span>,
      replace <span class="op">=</span> <span class="cn">TRUE</span>,
      prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.8</span> <span class="op">-</span> <span class="va">proportion_defiers</span>, <span class="va">proportion_defiers</span><span class="op">)</span>
    <span class="op">)</span>,
    noise <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">D</span> <span class="op">~</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,
      <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span>
    <span class="va">Y</span> <span class="op">~</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="fl">0.25</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Always-Taker"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="fl">0.75</span> <span class="op">*</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Defier"</span><span class="op">)</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span>
      <span class="va">direct_effect_of_encouragement</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">noise</span>,
    assignment_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"Z"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>CACE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">Y_D_1_Z_1</span> <span class="op">+</span> <span class="va">Y_D_1_Z_0</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">-</span>
                                 <span class="op">(</span><span class="va">Y_D_0_Z_1</span> <span class="op">+</span> <span class="va">Y_D_0_Z_0</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,
                   subset <span class="op">=</span> <span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">D</span>, assignment_variable <span class="op">=</span> <span class="st">"Z"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>, assignment_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"Z"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">|</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">iv_robust</span>, estimand <span class="op">=</span> <span class="st">"CACE"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">designs</span> <span class="op">&lt;-</span> <span class="fu">redesign</span><span class="op">(</span>
  <span class="va">design</span>,
  proportion_defiers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span>, length.out <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,
  direct_effect_of_encouragement <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span>, length.out <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu">simulate_design</span><span class="op">(</span><span class="va">designs</span>, sims <span class="op">=</span> <span class="va">sims</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gg_df</span> <span class="op">&lt;-</span>
  <span class="va">simulations</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">proportion_defiers</span>,
           <span class="va">direct_effect_of_encouragement</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span><span class="op">)</span>


<span class="fu">ggplot</span><span class="op">(</span><span class="va">gg_df</span>,
       <span class="fu">aes</span><span class="op">(</span>
         <span class="va">proportion_defiers</span>,
         <span class="va">bias</span>,
         group <span class="op">=</span> <span class="va">direct_effect_of_encouragement</span>,
         color <span class="op">=</span> <span class="va">direct_effect_of_encouragement</span>
       <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-383-1.png" width="100%"></div>
</div>
<div id="references-2" class="section level3">
<h3>
<span class="header-section-number">17.4.4</span> References<a class="anchor" aria-label="anchor" href="#references-2"><i class="fas fa-link"></i></a>
</h3>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
<div id="stepped-wedge-designs" class="section level2">
<h2>
<span class="header-section-number">17.5</span> Stepped wedge designs<a class="anchor" aria-label="anchor" href="#stepped-wedge-designs"><i class="fas fa-link"></i></a>
</h2>
<p>In a stepped wedge design, individuals are randomly assigned to enter into treatment in different stages and at each stage their outcomes are remeasured. Figure <a href="#fig:stepped-wedge"><strong>??</strong></a> illustrates where the study gets its name: as two units are randomly added to the treatment group in each of the three waves, the treatment group increases in “steps” while the control group diminishes.</p>
<p>Often, stepped wedge designs are vaunted for their policy appeal because they allow for everyone to be (eventually) treated in the context of an experiment. However, you could achieve the same goal in a regular two-armed trial by treating everyone after the final wave of measurement, and not all stepped wedge designs involve treating everyone. The real advantage of the stepped wedge is not in its ethical appeal: it’s the ability to squeeze more power out of a small sample by treating each wave as though it were its own study.</p>
<div id="declaration-19" class="section level3">
<h3>
<span class="header-section-number">17.5.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-19"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><strong>M</strong>odel: Eight units are randomized and remeasured at three time points. Importantly, any unit at any given point in time reveals one of only two potential outcomes—treated or untreated. Their untreated potential outcomes consist of a unit- and a unit-period-specific shock. Treated potential outcomes increase relative to control potential outcome by a rate of 1 each period—in other words, there are bigger treatment effects in later periods.</p></li>
<li><p><strong>I</strong>nquiry: Our estimand is the average treatment effect over all units and periods in the sample. Averaged over the three periods, the ATE is (1 + 2 + 3) / 3 = 2.</p></li>
<li><p><strong>D</strong>ata strategy: Our assignment strategy adds two units (one-quarter of the total sample) to the treatment at random in each wave, leaving two units who are not treated in any wave at all—see the remaining two orange squares at the top-right corner of Figure <a href="#fig:stepped-wedge"><strong>??</strong></a>. Notice that, while every <em>unit</em> is assigned to a treatment wave with equal probability, each wave reveals treated and untreated potential outcomes of <em>unit-periods</em> with different probabilities. In the first wave, one-quarter of the units reveal their treated potential outcomes; in the second wave, one-half of the units reveal their treated potential outcomes, and in the final wave, three-quarters of the units reveal treated potential outcomes. In essence, our experiment is like a block-randomized trial, with unit-periods grouped into period-specific blocks that have differential probabilities of assignment.</p></li>
<li><p><strong>A</strong>nswer strategy: Just as in a block-randomized trial with differential probabilities, we need to take account of the fact that our assignment strategy “under-represents” treated potential outcomes in the first wave and “over-represents” them in the last wave. Inverse-propensity weights (IPWs) are one way to correct for such disparities. Each unit’s IPW is represented on Figure <a href="#fig:stepped-wedge"><strong>??</strong></a>. But what do the numbers mean, and why do they change from one wave to another? In a sampling context, the IPW tells us how many units in the population each sampled unit represents. In the experimental context, the treatment assignment randomly samples units’ <em>potential outcomes</em>. So, in the first wave, the two treated units each have to stand in for four units’ treated potential outcomes (4 + 4 = 8 units). The potential outcomes revealed by the six units assigned to the control each stand in for 1.33 other units’ potential outcomes (1.33 + 1.33 + 1.33 + 1.33 + 1.33 + 1.33 = 8 units). Since the second wave is comprised of one-half treated potential outcomes and one-half control potential outcomes, each unit represents two other units’ potential outcomes. Using these weights, we get a “representative” estimate of the average control and treatment potential outcomes in each wave. If we didn’t apply the weights, we wouldn’t get a representative view of the unobserved potential outcomes we’re sampling, and our estimates would be biased. So what does all this buy us? We also declare a “two-arm” estimator that focuses on wave 2 only, where half of the units are in control and half in treatment. Diagnosis shows that all the remeasuring and randomizing gets us (.52 - .41) / .41 = 27% higher power.</p></li>
</ul>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>
    unit <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">8</span>, X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>,
    period <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">3</span>, time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span>, 
                       p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">4</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">4</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span>, 
                       nest <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
    obs <span class="op">=</span> <span class="fu">cross_levels</span><span class="op">(</span>by <span class="op">=</span> <span class="fu">join</span><span class="op">(</span><span class="va">unit</span>, <span class="va">period</span><span class="op">)</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">unit</span>, conditions <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, assignment_variable <span class="op">=</span> <span class="st">"wave"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="va">wave</span><span class="op">)</span>, ipw <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">p</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Z</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span>, handler <span class="op">=</span> <span class="va">fabricate</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimand</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"1: Stepped Wedge"</span>, weights <span class="op">=</span> <span class="va">ipw</span>, clusters <span class="op">=</span> <span class="va">unit</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"2: Wave 2 Only"</span>, subset <span class="op">=</span> <span class="va">period</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/stepped-wedge-1.png" width="100%"></div>
</div>
<div id="dag-19" class="section level3">
<h3>
<span class="header-section-number">17.5.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-19"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-389-1.png" width="100%"></div>
</div>
<div id="exercises-5" class="section level3">
<h3>
<span class="header-section-number">17.5.3</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-5"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>Add an answer strategy to the design that doesn’t include IPWs and diagnose the design.</li>
</ol>
<ol style="list-style-type: lower-roman">
<li>How does this affect the bias in the estimates? Explain your answer.</li>
<li>Now change the potential outcomes function so that the treatment effect is constant across periods. How does this affect the bias? Explain your answer.</li>
<li>How does the relative power of the stepped-wedge over the single-period, two-arm trial change when the treatment effect is restricted to be constant across periods? Explain your answer.</li>
</ol>
<ol start="2" style="list-style-type: decimal">
<li>Our design makes a subtle but crucial assumption about the potential outcomes: namely, that the treated potential outcome revealed in one period is the same irrespective of whether the unit was treated in the previous (or subsequent) periods. What would a violation of this assumption look like?</li>
</ol>
</div>
<div id="online-appendix-applied-example-1" class="section level3">
<h3>
<span class="header-section-number">17.5.4</span> Online Appendix Applied Example<a class="anchor" aria-label="anchor" href="#online-appendix-applied-example-1"><i class="fas fa-link"></i></a>
</h3>
<p>FIND AND ADD EXAMPLE.</p>
<!-- - Comparing 1 and 2, stepped wedge gives a big improvement in power, is -->
<!-- unbiased, and gets the coverage correct. Clearly better than just doing a -->
<!-- cross-section at wave 2.  -->
<!-- - Estimator 3 shows two pitfalls, however, that can lead us to overestimate -->
<!-- benefits of SW. -->
<!-- 1. First, it is biased: [explain how treated POs are more commonly observed in -->
<!-- periods when they're higher, we need to weight for this. How weights come about: -->
<!-- There is one way that a unit can be observed in a treated state in wave 1: they -->
<!-- are assigned to W1 with probability `p_W1`. There are two ways in which a unit -->
<!-- can be treated in wave 2: they are assigned in W1 with `p_W1` or in W2 with -->
<!-- `p_W2`. Because being assigned in W1 or in W2 are exclusive and independent -->
<!-- events, we can get the prob of being treated in any period by wave 2 by summing -->
<!-- the probs.] -->
<!-- 2. Second, standard errors are wrong. Units should be treated as clusters (draw -->
<!-- analogue to two-stage random assignment in saturation design?) -->
<!-- A natural question is how power changes as more or fewer units are assigned.  -->
<!-- Here, we consider variations on the stepped wedge design declared above, in  -->
<!-- which we hold constant at 3 the number of units assigned to the pure control,  -->
<!-- and shift an increasing proportion of the assignment to later waves. -->
<!-- ```{r} -->
<!-- designs <- list( -->
<!--   a = redesign(design, p_00 = 3/8, p_W1 =  3/8, p_W2 = 1/8, p_W3 = 1/8), -->
<!--   b = redesign(design, p_00 = 3/8, p_W1 =  2/8, p_W2 = 2/8, p_W3 = 1/8), -->
<!--   c = redesign(design, p_00 = 3/8, p_W1 =  2/8, p_W2 = 1/8, p_W3 = 2/8), -->
<!--   d = redesign(design, p_00 = 3/8, p_W1 =  1/8, p_W2 = 3/8, p_W3 = 1/8), -->
<!--   e = redesign(design, p_00 = 3/8, p_W1 =  1/8, p_W2 = 2/8, p_W3 = 2/8), -->
<!--   f = redesign(design, p_00 = 3/8, p_W1 =  1/8, p_W2 = 1/8, p_W3 = 3/8) -->
<!--   ) -->
<!-- ``` -->
<!-- ```{r, eval = do_diagnosis & !exists("do_bookdown")} -->
<!-- # Diagnose design -->
<!-- diagnoses <- diagnose_designs(designs) -->
<!-- ``` -->
<!-- ```{r, echo = FALSE, purl = FALSE} -->
<!-- # figure out where the dropbox path is, create the directory if it doesn't exist, and name the RDS file -->
<!-- rds_file_path <- paste0(get_dropbox_path("05_Stepped_Wedge_Designs.Rmd"), "/diagnoses.RDS") -->
<!-- if (do_diagnosis & !exists("do_bookdown")) { -->
<!--   write_rds(diagnoses, path = rds_file_path) -->
<!-- } -->
<!-- diagnoses <- read_rds(rds_file_path) -->
<!-- ``` -->
<!-- ```{r, echo = FALSE} -->
<!-- designs_data <- names(designs) %>%  -->
<!--   lapply(function(name) designs[[name]] %>%  -->
<!--            draw_data %>%  -->
<!--            mutate(design_id = name)) %>%  -->
<!--   do.call(what = rbind,args = .) %>%  -->
<!--   arrange(design_id,wave,i) %>%  -->
<!--   group_by(t,design_id) %>% -->
<!--   mutate(i = 1:n(), Assignment = ifelse(Z == 1, "Treatment", "Control"))  -->
<!-- diags <- diagnoses %>%  -->
<!--   get_diagnosands() %>%  -->
<!--   filter(estimator_label == "2: Weighted, clustered SW") %>%  -->
<!--   mutate( -->
<!--     design_name = paste0("Design ", design_label, ": W1 = ",8*p_W1, -->
<!--                          "; W2 = ", 8*p_W2,  -->
<!--                          "; W3 = ", 8*p_W3,",\nPower = ",round(power,2) -->
<!--                          ) -->
<!--   ) -->
<!-- designs_data <- left_join(designs_data, diags %>% select(design_name, design_label), by = c("design_id" = "design_label")) -->
<!-- designs_data %>%  -->
<!--   ggplot(aes(x = t, y = i, fill = Assignment)) + -->
<!--   geom_tile(color = "white") +  -->
<!--   scale_fill_manual(values = c(control_color, treatment_color)) + -->
<!--   dd_theme() + facet_wrap(~ design_name, nrow = 1) +  -->
<!--   scale_y_continuous("",labels = NULL) -->
<!-- ``` -->
<!-- - We see a monotonic decrease in the power as more of the sample is treated  -->
<!-- later. This occurs because treating units later means observing less of the -->
<!-- potential outcomes. The potential outcomes are more variant, so we're better -->
<!-- off when we observe more of them [I think!] -->
<!-- ### Spillovers -->
<!-- An important assumption is that the potential outcomes revealed are not a -->
<!-- function of what wave the unit entered into treatment. In other words, there are -->
<!-- no Show how, in case of such spillovers, you can just treat the effects as -->
<!-- different, but then you lose power gains (and possibly change estimand) -->
</div>
<div id="references-3" class="section level3">
<h3>
<span class="header-section-number">17.5.5</span> References<a class="anchor" aria-label="anchor" href="#references-3"><i class="fas fa-link"></i></a>
</h3>

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
<!-- start post here, do not edit above -->
</div>
</div>
<div id="randomized-saturation-design" class="section level2">
<h2>
<span class="header-section-number">17.6</span> Randomized Saturation Design<a class="anchor" aria-label="anchor" href="#randomized-saturation-design"><i class="fas fa-link"></i></a>
</h2>
<p>Randomized saturation designs are used to measure the diffusion of treatment effects throughout a pre-defined area or network (<span class="citation">Baird et al. (<a href="references-4.html#ref-bairdetal2018">2018</a>)</span>). The design works in two phases. First, entire areas or networks are randomly assigned to <em>saturations</em>, e.g. 0%, 25%, and 75% saturation. Then, in each network, units are individually assigned in proportions determined by the saturations: e.g., in the groups randomly assigned to 0%, none of the units are assigned to treatment, while in the groups assigned to 25% and 75%, one-quarter and three-quarters of the units are assigned to treatment, respectively. By comparing untreated units in the 0% groups to their <em>untreated</em> counterparts in the higher-saturation networks, researchers can estimate the indirect treatment effects that result from saturation-induced spillovers.</p>
<div id="declaration-20" class="section level3">
<h3>
<span class="header-section-number">17.6.1</span> Declaration<a class="anchor" aria-label="anchor" href="#declaration-20"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><strong>M</strong>odel: There are four networks each comprised of four units. Units’ treatment assignment is a function of their network’s saturation assignment, which in turn defines the amount of spillover they receive. The spillover is equal to the proportion of units treated in the network. Potential outcomes are thus defined in terms of <code>S</code>—the unit’s group’s saturation—and <code>Z</code>—whether or not a unit is treated.</p></li>
<li><p><strong>I</strong>nquiry: There are two inquiries. First, we want to know the spillover, defined here as the average difference in outcomes when an untreated unit is in a high versus a low saturation network: <span class="math inline">\(E[Y_i(Z_i = 0, S_i = \text{high})-Y_i(Z_i = 0, S_i = \text{low})]\)</span>. We also want to know the “direct effect”–e.g. what happens to those directly treated if we disregard spillovers. Here it is defined over potential outcomes that the experiment does not reveal, since no one is treated in low-saturation constituencies: <span class="math inline">\(E[Y_i(Z_i = 1, S_i = \text{low})-Y_i(Z_i = 0, S_i = \text{low})]\)</span>.</p></li>
<li><p><strong>D</strong>ata strategy: We assign entire networks to low (0%) or and high (75%) saturation. We then randomize individuals within groups to treatment or control in the proportions dictated by the saturation. Thus, the saturation is cluster-randomized, whereas treatment is block-randomized.</p></li>
<li><p><strong>A</strong>nswer strategy: We weight each individual by the inverse of the probability that they find themselves in the condition they’re in. The estimator conditions on both the saturation effect and the direct treatment effect. Note that the standard errors are clustered at the network level to account for the clustering of the saturation assignment.</p></li>
</ul>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">&lt;-</span> 
  <span class="fu">declare_population</span><span class="op">(</span>network <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, unit <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">4</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>assignment_variable <span class="op">=</span> <span class="st">"S"</span>, clusters <span class="op">=</span> <span class="va">network</span>, conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"low"</span>,<span class="st">"high"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">.25</span>, blocks <span class="op">=</span> <span class="va">network</span>, assignment_variable <span class="op">=</span> <span class="st">"Z_S_low"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_assignment</span><span class="op">(</span>prob <span class="op">=</span> <span class="fl">.75</span>, blocks <span class="op">=</span> <span class="va">network</span>, assignment_variable <span class="op">=</span> <span class="st">"Z_S_high"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_step</span><span class="op">(</span>spillover_low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">Z_S_low</span>, <span class="va">network</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>, 
               spillover_high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">Z_S_high</span>, <span class="va">network</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>,handler <span class="op">=</span> <span class="va">fabricate</span><span class="op">)</span>  <span class="op">+</span>
  <span class="fu">declare_potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">spillover_low</span> <span class="op">*</span> <span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"low"</span><span class="op">)</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">spillover_high</span> <span class="op">*</span> <span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"high"</span><span class="op">)</span> <span class="op">+</span> <span class="va">U</span>,
                             conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"low"</span>,<span class="st">"high"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_estimand</span><span class="op">(</span>ate_saturation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_0_S_high</span> <span class="op">-</span> <span class="va">Y_Z_0_S_low</span><span class="op">)</span>,
                   ate_no_spill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1_S_low</span> <span class="op">-</span> <span class="va">Y_Z_0_S_low</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Z</span>,<span class="va">S</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_step</span><span class="op">(</span>ipw <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">S_cond_prob</span> <span class="op">*</span> <span class="op">(</span><span class="va">Z_S_low_cond_prob</span> <span class="op">*</span> <span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"low"</span><span class="op">)</span> <span class="op">+</span> <span class="va">Z_S_high_cond_prob</span> <span class="op">*</span> <span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"high"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    handler <span class="op">=</span> <span class="va">fabricate</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">declare_reveal</span><span class="op">(</span><span class="va">Y</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">S</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
<span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">S</span>, clusters <span class="op">=</span> <span class="va">network</span>, model <span class="op">=</span> <span class="va">lm_robust</span>, term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Z"</span>, <span class="st">"Shigh"</span><span class="op">)</span>, 
                  estimand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ate_no_spill"</span>, <span class="st">"ate_saturation"</span><span class="op">)</span>,weight <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_files/figure-html/saturation-1.png" width="100%"></div>
<!-- 
JC Comment: I see that the previous version was far too complex but the updated version was 
misleadingly simple. The POs need to be a function of the proportion of units treated, not 
simply a fixed trait of the saturation category you're assigned to. As it was setup before, 
I could set the saturations at all sorts of crazy values and it makes no difference, it was 
basically a het-fx by blocks design. Also, the point and variance estimators were biased 
because this design requires IPWing. To me, the minimally sufficient declaration has to 
illustrate the design works in terms of bias and coverage in a DGP it was specifically
setup to handle. 
# ```{r}
# design <- 
#   declare_population(
#     group = add_level(N = 10, X = rnorm(N)),
#     unit = add_level(N = 100, U = rnorm(N))
#   ) +
#   declare_assignment(clusters = group, conditions = c("low", "high"), assignment_variable = S) +
#   declare_step(S_prob = case_when(S == "low" ~ 0.25, S == "high" ~ 0.75), mutate) +
#   declare_assignment(blocks = group, prob_unit = S_prob) + 
#   declare_potential_outcomes(
#     Y ~ Z + (S == "high") + Z*(S == "high") + X + U,
#     conditions = list(Z = c(0, 1), S = c("low", "high"))) +
#   declare_estimand(ATE_saturation = mean(Y_Z_0_S_high - Y_Z_0_S_low),
#                    ate_no_spill = mean(Y_Z_1_S_low - Y_Z_0_S_low)) +
#   declare_reveal(Y, c(Z, S)) +
#   declare_estimator(Y ~ Z + S, model = lm_robust, term = c("Z", "Shigh"), estimand = c("ATE_saturation", "ate_no_spill"), label = "main effect")
# ```
-->
</div>
<div id="dag-20" class="section level3">
<h3>
<span class="header-section-number">17.6.2</span> Dag<a class="anchor" aria-label="anchor" href="#dag-20"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-figure"><img src="book_files/figure-html/unnamed-chunk-395-1.png" width="100%"></div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="observational-designs-for-causal-inference.html"><span class="header-section-number">16</span> Observational designs for causal inference</a></div>
<div class="next"><a href="exercises-6.html"><span class="header-section-number">18</span> Exercises</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#experimental-designs-for-causal-inference"><span class="header-section-number">17</span> Experimental designs for causal inference</a></li>
<li>
<a class="nav-link" href="#two-arm-trials"><span class="header-section-number">17.1</span> Two arm trials</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-15"><span class="header-section-number">17.1.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-15"><span class="header-section-number">17.1.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-17"><span class="header-section-number">17.1.3</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#blocked-trials"><span class="header-section-number">17.2</span> Blocked trials</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-16"><span class="header-section-number">17.2.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-16"><span class="header-section-number">17.2.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-18"><span class="header-section-number">17.2.3</span> Example</a></li>
<li><a class="nav-link" href="#two-arm-trials-and-designs-with-blocking-and-clustering"><span class="header-section-number">17.2.4</span> Two-arm trials and designs with blocking and clustering</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#multiarm-designs"><span class="header-section-number">17.3</span> Multiarm Designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-17"><span class="header-section-number">17.3.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-17"><span class="header-section-number">17.3.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-19"><span class="header-section-number">17.3.3</span> Example</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#encouragement-designs"><span class="header-section-number">17.4</span> Encouragement designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-18"><span class="header-section-number">17.4.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-18"><span class="header-section-number">17.4.2</span> Dag</a></li>
<li><a class="nav-link" href="#example-20"><span class="header-section-number">17.4.3</span> Example</a></li>
<li><a class="nav-link" href="#references-2"><span class="header-section-number">17.4.4</span> References</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#stepped-wedge-designs"><span class="header-section-number">17.5</span> Stepped wedge designs</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-19"><span class="header-section-number">17.5.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-19"><span class="header-section-number">17.5.2</span> Dag</a></li>
<li><a class="nav-link" href="#exercises-5"><span class="header-section-number">17.5.3</span> Exercises</a></li>
<li><a class="nav-link" href="#online-appendix-applied-example-1"><span class="header-section-number">17.5.4</span> Online Appendix Applied Example</a></li>
<li><a class="nav-link" href="#references-3"><span class="header-section-number">17.5.5</span> References</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#randomized-saturation-design"><span class="header-section-number">17.6</span> Randomized Saturation Design</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#declaration-20"><span class="header-section-number">17.6.1</span> Declaration</a></li>
<li><a class="nav-link" href="#dag-20"><span class="header-section-number">17.6.2</span> Dag</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/DeclareDesign/book/blob/master/03_Design_Library/04_Experimental_Causal/00_Chapter_Experimental_Causal.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/DeclareDesign/book/edit/master/03_Design_Library/04_Experimental_Causal/00_Chapter_Experimental_Causal.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Research Design: Declare, Diagnose, Redesign</strong>" was written by Graeme Blair, Jasper Cooper, Alexander Coppock, and Macartan Humphreys. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
