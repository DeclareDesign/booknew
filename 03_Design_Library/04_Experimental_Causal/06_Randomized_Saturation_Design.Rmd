---
title: "Partial Population Design"
output: html_document
bibliography: ../../bib/book.bib 
---

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # files are all relative to RStudio project home
```

```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
# load common packages, set ggplot ddtheme, etc.
source("scripts/before_chapter_script.R")
```

<!-- start post here, do not edit above -->

## Randomized Saturation Design

<!-- make sure to rename the section title below -->

```{r partial_population_design, echo = FALSE, output = FALSE, purl = FALSE}
# run the diagnosis (set to TRUE) on your computer for this section only before pushing to Github. no diagnosis will ever take place on github.
do_diagnosis <- FALSE
sims <- 100
b_sims <- 20
```

```{r, echo = FALSE}
# load packages for this section here. note many (DD, tidyverse) are already available, see scripts/package-list.R
library(blockTools)
```


Partial population designs---also known as randomized saturation designs (@bairdetal2018)---

- Use Ghana study 
- Show that works great if spillovers are contained by districts
  - and reduces bias compared to when you don't address it?
- But show that it doesn't work as great when:
  - distal spillovers occur
- Are there cases where the saturation actually makes the matter worse?

```{r}

N_groups <- 10
ms <- c(0,0,N_groups,0)

spillover_1 <- declare_step(
  N_treated = ave(Z, G, FUN = sum),
  S = as.numeric(N_treated > 0),
  handler = fabricate) 

spillover_2 <- declare_step(next_neighbor = c(N,1:(N-1)),
                            S = Z[next_neighbor],
                            handler = fabricate) 

right_model <- 
  declare_population(N = 100, X = 1:N, U = rnorm(N), G = ntile(X, N_groups)) + 
  declare_assignment(assignment_variable = "saturation", 
                     clusters = G, 
                     conditions = c(0, .50, .80),
                     m_each = ms) +
  declare_assignment(blocks = G, 
                     block_prob = taepply(saturation,G,mean)) +
  spillover_1 +
  declare_potential_outcomes(
    Y ~ Z * .20 + S * .20 + U,
    conditions = list(Z = c(0,1), S = c(0,1)) +
  declare_estimand(ate = mean(Y_Z_1_S_0 - Y_Z_0_S_0)) +
  declare_reveal(Y,c(Z, S)) +
  declare_estimator(Y ~ )


draw_data(design) %>% 
  ggplot(aes(x = u, y = x, color = as.factor(g))) +
  geom_point() +
  geom_hline(yintercept = seq(1,100,by = 20) - .5)

# ONE FROM TOTAL N TREATED IN TILE
# ANOTHER FROM NEAREST NEIGHBOR IF TREATED




draw_data(design) %>% with(.,table(row, col))
  
  declare_potential_outcomes(
    Y_Z_0_S_0 = .5 < e, 
    Y_Z_1_S_0 = .5 < e + tau,
    Y_Z_0_S_1 = .5 < e + tau / 2, 
    Y_Z_1_S_1 = .5 < e + tau / 2) +
  declare_estimand(ate_S0 = mean(Y_Z_1_S_0 - Y_Z_0_S_0)) +
  declare_sampling(n = 4) +
  declare_assignment(prob = .5) +
  # MAKE THIS A DPLYER STEP
  declare_step(next_neighbor = c(N,1:(N-1)),
               S = Z[next_neighbor], 
               handler = fabricate) +
  declare_reveal(Y, c(Z, S)) +
  declare_reveal(Y, c(Z, S)) +
  declare_estimator(Y ~ Z + S, label = "DiM")   




diagnose_design(spillover_design, redesign(spillover_design, N_sampled = 100, N = 100))
```


This chunk is set to `echo = TRUE` and `eval = do_diagnosis`
```{r, eval = do_diagnosis & !exists("do_bookdown")}
simulations_pilot <- simulate_design(design, sims = sims)
```

Right after you do simulations, you want to save the simulations rds. 

```{r, echo = FALSE, purl = FALSE}
# figure out where the dropbox path is, create the directory if it doesn't exist, and name the RDS file
rds_file_path <- paste0(get_dropbox_path("section_template"), "/simulations_pilot.RDS")
if (do_diagnosis & !exists("do_bookdown")) {
  write_rds(simulations_pilot, path = rds_file_path)
}
simulations_pilot <- read_rds(rds_file_path)
```

Now all that simulating, saving, and loading is done, and we can use the simulations for whatever you want.

```{r}
kable(head(simulations_pilot))
```







