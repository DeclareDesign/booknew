---
title: "Process tracing"
output: html_document
bibliography: ../../bib/book.bib 
---

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # files are all relative to RStudio project home
```

```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
# load common packages, set ggplot ddtheme, etc.
source("scripts/before_chapter_script.R")
```



<!-- make sure to rename the section title below -->

```{r process_tracing, echo = FALSE, output = FALSE, purl = FALSE}
# run the diagnosis (set to TRUE) on your computer for this section only before pushing to Github. no diagnosis will ever take place on github.
do_diagnosis <- FALSE
sims <- 100
b_sims <- 20
```

```{r, echo = FALSE}
# load packages for this section here. note many (DD, tidyverse) are already available, see scripts/package-list.R
```



<!-- start post here, do not edit above -->

## Process tracing

### Declaration

use mutate for posterior

use declare_measurement for CPOs

use PO function for types 

maybe don't reuse pr_SIW_H for *both* dgp and estimator

```{r}
types <- c('Z_caused_Y', 'Z_caused_not_Y', 'always_Y', 'always_not_Y')

design <-
  declare_population(N = 195,
                     pr_type_Z_caused_Y = .5,
                     Z = draw_binary(prob = .3, N = N),
                     type = sample(x = types, size = N, replace = TRUE, prob = c(.2, .1, .2, .5)))  +
  declare_potential_outcomes(
    Y ~ Z * (type == "Z_caused_Y") + (1 - Z) * (type == "Z_caused_not_Y") + (type == "always_Y"),
    conditions = list(Z = c(0, 1), type = types)) +
  declare_potential_outcomes(
    pr_C_1 ~ Z * (.25 * (type == "Z_caused_Y") + .005 * (type == "always_Y")),
    conditions = list(Z = c(0, 1), type = types)) +
  declare_reveal(c(Y, pr_C_1), c(Z, type)) +
  declare_measurement(C = draw_binary(prob = pr_C_1)) +
  declare_step(handler = function(data) data %>% filter(Z==1 & Y==1) %>% sample_n(size = 1)) +
  declare_estimand(did_Z_cause_Y = type == 'Z_caused_Y') +
  declare_estimator(
    pr_C_1_type_Z_caused_Y = .25,
    pr_C_1_type_always_Y = .005,
    pr_C_type_Z_caused_Y = C * pr_C_1_type_Z_caused_Y + (1 - C) * (1 - pr_C_1_type_Z_caused_Y),
    pr_C_type_always_Y = C * pr_C_1_type_always_Y + (1 - C) * (1 - pr_C_1_type_always_Y),
    posterior =
      pr_type_Z_caused_Y * pr_C_type_Z_caused_Y / (pr_type_Z_caused_Y * pr_C_type_Z_caused_Y + pr_C_type_always_Y * (1 - pr_type_Z_caused_Y)),
    estimator_label = "Smoking Gun",
    estimand_label = "did_Z_cause_Y",
    handler = summarize) 

# diagnose_design(process_tracing_design, 
#                 diagnosands = declare_diagnosands(
#                   bias = mean(posterior - estimand),
#                   rmse = sqrt(mean((posterior - estimand) ^ 2)),
#                   mean_estimand = mean(estimand),
#                   mean_posterior = mean(posterior),
#                   keep_defaults = FALSC
#                 ), sims = 1000)

```




### Dag



```{r, echo = FALSE}
dag <- dagify(C ~ Z + type,
              Y ~ Z + type)


nodes <-
  tibble(
    name = c("Z", "type","C", "Y"),
    label = name,
    annotation = c(
      "**Cause**<br>Suspected cause of Y",
      "**Type**<br>Causal relationship<br>between Z and Y",
      "**Clue**<br>Evidence that X caused Y",
      "**Outcome**"),
    x = c(1, 1, 5, 5),
    y = c(1.5,3.5,1.5,3.5),
    nudge_direction = c("S", "N", "S", "N"),
    answer_strategy = "uncontrolled"
  )


ggdd_df <- make_dag_df(dag, nodes, design)

base_dag_plot %+% ggdd_df
```



### Example

The design itself makes use of the helper functions above in the `declare_estimator` steps.


Assumption: E can only be observed if X and Y present (e.g. militia forms around natural resources during a civil war--cannot happen if you don't have both a civil war and natural resources).


#### Exercises

- Diagnosis starts with researcher correct about prior belief of hypothesis (.5) and about clue probs (smoking gun)
- Change prior and look at bias
- Change clue probs + clue prior and look at bias
- Change clue probs 






