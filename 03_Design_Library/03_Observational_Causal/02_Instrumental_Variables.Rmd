---
title: "Instrumental variables"
output: html_document
bibliography: ../../bib/book.bib 
---

<!-- note do_bookdown is set in index.rmd, so we know if you're running just this .Rmd or compiling the book-->
```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # files are all relative to RStudio project home
```

```{r, eval = !exists("do_bookdown"), echo = FALSE, include = FALSE, purl = FALSE}
# load common packages, set ggplot ddtheme, etc.
source("scripts/before_chapter_script.R")
```

<!-- start post here, do not edit above -->

<!-- make sure to rename the section title below -->

```{r instrumental_variables, echo = FALSE, output = FALSE, purl = FALSE}
# run the diagnosis (set to TRUE) on your computer for this section only before pushing to Github. no diagnosis will ever take place on github.
do_diagnosis <- FALSE
sims <- 100
b_sims <- 20
```

```{r, echo = FALSE}
# load packages for this section here. note many (DD, tidyverse) are already available, see scripts/package-list.R
```

## Instrumental variables

### Declaration

```{r}
design <-
  declare_population(N = 100, U = rnorm(N)) +
  declare_potential_outcomes(D ~ if_else(Z + U > 0, 1, 0), assignment_variables = Z) + 
  declare_potential_outcomes(Y ~ 0.1 * D + 0.25 + U, assignment_variables = D) +
  declare_estimand(late = mean(Y_D_1[D_Z_1 == 1 & D_Z_0 == 0] - Y_D_0[D_Z_1 == 1 & D_Z_0 == 0])) +
  declare_assignment(prob = 0.5) +
  declare_reveal(D, Z) + 
  declare_reveal(Y, D) + 
  declare_estimator(Y ~ D | Z, model = iv_robust, estimand = "LATE") 
```

- explain the IV estimator is the ratio of $ITT_y^\widehat / ITT_d^\widehat$
- identical to noncompliance in an experiment

### Dag

```{r, echo = FALSE}
dag <- dagify(Y ~ D + U,
              D ~ Z + U)

nodes <-
  tibble(
    name = c("Z", "D", "U", "Y"),
    label = c("Z", "D", "U", "Y"),
    annotation = c(
      "**Exogenous variable**<br>Instrument",
      "**Endogenous variable**",
      "**Unknown heterogeneity**",
      "**Outcome**"
    ),
    x = c(1, 3, 5, 5),
    y = c(1.5, 1.5, 3.5, 1.5), 
    nudge_direction = c("S", "S", "N", "S"),
    answer_strategy = "uncontrolled"
  )

ggdd_df <- make_dag_df(dag, nodes, design)

base_dag_plot %+% ggdd_df
```

### Redesign

- excludability violations
- if you do, go $ITT_d$ and $ITT_y$

### Suggested readings

Applications
- Mo, Cecilia Hyunjung, Katherine Conn, Georgia Anderson-Nilsson. 2019. “Can National Service Activism Activate Women’s Political Ambition? Evidence from Teach For America.”  Politics, Groups, and Identities 7(4): 864-877.

Methodological literature
- Angrist and Pischke ch. 4
- Gerber and Green ch. 5 and ch. 6

### Example


